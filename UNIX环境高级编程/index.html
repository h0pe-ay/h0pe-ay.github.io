

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <meta name="google-site-verification" content="McULNauwae3fxE8yPK3QNQNAYvG6cZAJ02xx9Lpbc98" />
  <link rel="apple-touch-icon" sizes="76x76" href="/img/hope.jpg">
  <link rel="icon" href="/img/hope.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="hope">
  <meta name="keywords" content="">
  
    <meta name="description" content="UNIX环境高级编程笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="UNIX环境高级编程笔记">
<meta property="og:url" content="https://h0pe-ay.github.io/UNIX%E7%8E%AF%E5%A2%83%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/index.html">
<meta property="og:site_name" content="hope">
<meta property="og:description" content="UNIX环境高级编程笔记">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230209225704187.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221123143919618.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221123143925606.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221123145941766.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221123154536642.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221123173523830.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221123174632032.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221125105002804.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230210005801166.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230210010057022.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230210020351980.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230210020411853.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230210020520822.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230210021036552.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230210135358969.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221128145121567.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221128152516263.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221202161004903.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221202161020838.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221202163106776.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221202163122069.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221202165922105.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221202170746161.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221205153518991.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221205153647054.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221205164222088.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221205164801102.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221207165325358.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221207165629576.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221207170044044.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221207171327943.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221207172705110.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221207172748969.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221207173819203.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221207174854679.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221212233431839.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230115180638406.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230116002822460.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230117001028533.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230118235450382.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230129204719364.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230129205516099.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230129205535605.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230131132819912.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230202223826795.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230202224110468.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230202232500872.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230203200512981.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230203205833011.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230203221759223.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230204133015594.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230204133236552.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230207234736511.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230207234928683.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230208184650475.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230208184714204.png">
<meta property="og:image" content="c:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20230209010328935.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230211000205461.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230211003608390.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230225192531323.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230225194325201.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230225200104067.png">
<meta property="og:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230226202107691.png">
<meta property="article:published_time" content="2023-06-28T06:32:37.458Z">
<meta property="article:modified_time" content="2023-07-02T09:23:58.039Z">
<meta property="article:author" content="hope">
<meta property="article:tag" content="编程">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230209225704187.png">
  
  
  
  <title>UNIX环境高级编程笔记 - hope</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"h0pe-ay.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":false},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"ZqEEnP8vrF2LzEKjCt8pL5Cf-gzGzoHsz","app_key":"6Owvec9nVB4K93xxi7CKzAqh","server_url":"https://zqeenp8v.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>hope</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="UNIX环境高级编程笔记"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-06-28 14:32" pubdate>
          2023年6月28日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          189k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          1578 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">UNIX环境高级编程笔记</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="错误提示"><a href="#错误提示" class="headerlink" title="错误提示"></a>错误提示</h1><h2 id="strerror"><a href="#strerror" class="headerlink" title="strerror"></a>strerror</h2><p>打印错误整型值对应的错误信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-type">char</span> *<span class="hljs-title function_">strerror</span><span class="hljs-params">(<span class="hljs-type">int</span> errnum)</span>;<br></code></pre></td></tr></table></figure>

<ul>
<li>参数一：<code>errnum</code>，传入错误整型值</li>
<li>返回值：返回错误整型值对应的错误信息</li>
</ul>
<h2 id="perror"><a href="#perror" class="headerlink" title="perror"></a>perror</h2><p>根据<code>errno</code>值打印相应的错误信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">void</span> <span class="hljs-title function_">perror</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *msg)</span>;<br></code></pre></td></tr></table></figure>

<ul>
<li>参数一：<code>msg</code>，将<code>msg</code>添加到错误信息中</li>
</ul>
<h1 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h1><h2 id="open与openat"><a href="#open与openat" class="headerlink" title="open与openat"></a>open与openat</h2><p><code>open</code>与<code>openat</code>函数通过参数<code>fd</code>进行区分</p>
<ul>
<li>情况一：参数<code>pathname</code>为绝对路径，参数<code>fd</code>可以被忽略</li>
<li>情况二：参数<code>pathname</code>为相对路径，参数<code>fd</code>为文件描述符，此时<code>fd</code>描述符所在的文件夹为相对路径的起始位置</li>
<li>情况三：参数<code>pathname</code>为相对路径，参数<code>fd</code>为<code> AT_FDCWD</code>，此时当前目录为相对路径的起始位置，此时<code>open</code>与<code>openat</code>功能相似</li>
</ul>
<p><code>openat</code>对<code>open</code>的改进</p>
<ul>
<li>使得线程可以操作其他目录下的文件</li>
<li>防止<code>TOCTTOU</code>漏洞</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">open</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">int</span> oflag, ...)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">openat</span><span class="hljs-params">(<span class="hljs-type">int</span> fd,<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path,<span class="hljs-type">int</span> oflag,..)</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>path</code>为打开文件的路径加名称</li>
<li><code>oflag</code>为权限</li>
</ul>
<h2 id="creat"><a href="#creat" class="headerlink" title="creat"></a>creat</h2><p><code>create</code>函数用于创建只写文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">create</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path,<span class="hljs-type">mode_t</span> mode)</span>;<br><br><span class="hljs-comment">//等价于</span><br>open(path,O_WROLY | O_CREAT | O_TRHUNK,mode);<br></code></pre></td></tr></table></figure>

<h2 id="close"><a href="#close" class="headerlink" title="close"></a>close</h2><p>关闭文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">close</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span>;<br></code></pre></td></tr></table></figure>

<h2 id="lseek"><a href="#lseek" class="headerlink" title="lseek"></a>lseek</h2><p>搜索文件偏移，该函数执行记录了内核中记录文件偏移的数据，不需要执行<code>I/O</code>操作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-type">off_t</span> <span class="hljs-title function_">lseek</span><span class="hljs-params">(<span class="hljs-type">int</span> fd,<span class="hljs-type">off_t</span> offset,<span class="hljs-type">int</span> whence)</span>;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>fd</code>文件描述符</li>
<li><code>offset</code>偏移</li>
<li><code>whence</code>为指定<code>offset</code>的位置<ul>
<li><code>whence = SEEK_SET</code>，偏移从文件起始位置计算</li>
<li><code>whence = SEEK_CUR</code>，偏移从文件当前偏移开始计算</li>
<li><code>whence = SEEK_END</code>，偏移从文件末尾开始计算</li>
</ul>
</li>
</ul>
<p><code>lseek</code>函数的两个功能</p>
<p><strong>获取当前文件的偏移</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">off_t</span> currpos;<br>currpos = lseek(fd, <span class="hljs-number">0</span>, SEEK_CUR);<br></code></pre></td></tr></table></figure>

<p><strong>判断当前文件是否可以搜索偏移</strong></p>
<p><code>pipe</code>、<code>FIFO</code>以及<code>socket</code>无法使用<code>lseek</code>函数找偏移量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> <br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc,<span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (lseek(STDIN_FILENO, <span class="hljs-number">0</span>, SEEK_CUR) == <span class="hljs-number">-1</span>)<br>        	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;cannot seek\n&quot;</span>);<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;seek OK\n&quot;</span>);<br>   	<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="read"><a href="#read" class="headerlink" title="read"></a>read</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">read</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">char</span> *buf, <span class="hljs-type">unsigned</span> nbytes)</span>;<br></code></pre></td></tr></table></figure>

<p><code>read</code>函数有以下五种情况读取字节少于参数指定的字节</p>
<ul>
<li>读到文件尾，返回<code>0</code></li>
<li>从终端设备读取数据，一次只返回一行</li>
<li>从网络读取的数据大小取决于网络的缓冲区</li>
<li>从管道或<code>FIFO</code>读取数据时取决于管道内的数据大小</li>
<li>被信号所中断</li>
</ul>
<h2 id="write"><a href="#write" class="headerlink" title="write"></a>write</h2><p>将数据写入打开的文件里</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">write</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> nbytes)</span>;<br></code></pre></td></tr></table></figure>

<p>如果写入字节数超过了文件大小或者磁盘大小则会发生错误。</p>
<h2 id="I-x2F-O效率"><a href="#I-x2F-O效率" class="headerlink" title="I&#x2F;O效率"></a>I&#x2F;O效率</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;apue.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BUFFSIZE 4096</span><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br> <span class="hljs-type">int</span> n;<br><span class="hljs-type">char</span> buf[BUFFSIZE];<br><span class="hljs-keyword">while</span> ((n = read(STDIN_FILENO, buf, BUFFSIZE)) &gt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">if</span> (write(STDOUT_FILENO, buf, n) != n)<br>err_sys(<span class="hljs-string">&quot;write error&quot;</span>);<br><span class="hljs-keyword">if</span> (n &lt; <span class="hljs-number">0</span>)<br>err_sys(<span class="hljs-string">&quot;read error&quot;</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>如何选择文件输入输出的字节的大小</strong></p>
<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230209225704187.png" srcset="/img/loading.gif" lazyload alt="image-20230209225704187"></p>
<p><strong>buffsize为4096的效果最好</strong></p>
<h2 id="pread和pwrite"><a href="#pread和pwrite" class="headerlink" title="pread和pwrite"></a>pread和pwrite</h2><p><code>pread</code>与<code>pwrite</code>函数相当于先调用<code>lseek</code>函数后调用<code>write</code>和<code>read</code>函数，但是两个操作视作为原子操作并且当前的文件偏移不会改变</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">pread</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> nbytes, <span class="hljs-type">off_t</span> offset)</span>;<br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">pwrite</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> nbytes, <span class="hljs-type">off_t</span> offset)</span>;<br></code></pre></td></tr></table></figure>

<h2 id="dup和dup2"><a href="#dup和dup2" class="headerlink" title="dup和dup2"></a>dup和dup2</h2><p><code>dup</code>和<code>dup2</code>函数用于复制文件描述符，并且会清空<code>close-on-exec</code>标志位</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">dup</span><span class="hljs-params">(<span class="hljs-type">int</span> oldfd)</span>;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	dup(oldfd)</span><br><span class="hljs-comment">	fcntl(oldfd,F_DUPFD,0)</span><br><span class="hljs-comment">*/</span><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">dup2</span><span class="hljs-params">(<span class="hljs-type">int</span> oldfd,<span class="hljs-type">int</span> newfd)</span>;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	dup2(oldfd,newfd)</span><br><span class="hljs-comment">	close(oldfd)</span><br><span class="hljs-comment">	fcntl(oldfd,FDUPFD,newfd)</span><br><span class="hljs-comment">*/</span><br><span class="hljs-comment">// success, these system calls return the new descriptor.  On</span><br>       error, <span class="hljs-number">-1</span> is returned, and errno is <span class="hljs-built_in">set</span> appropriately<br></code></pre></td></tr></table></figure>

<p><code>dup</code>函数复制参数<code>fd</code>的描述符，返回最小未被使用的文件描述符</p>
<p><code>dup2</code>函数将参数<code>oldfd</code>的描述符复制到<code>newfd</code>的描述符</p>
<ul>
<li>若<code>oldfd</code>是非法文件描述符，那么<code>dup2</code>函数调用失败，<code>newfd</code>不会被关闭</li>
<li>若<code>oldfd</code>与<code>newfd</code>指向同一个文件描述符，则不会执行任何操作，并返回<code>newfd</code></li>
<li>若<code>newfd</code>已经被使用，那么<code>dup2</code>会先关闭<code>newfd</code>，然后再使用</li>
</ul>
<h2 id="sysnc、fsync和fdatasync"><a href="#sysnc、fsync和fdatasync" class="headerlink" title="sysnc、fsync和fdatasync"></a>sysnc、fsync和fdatasync</h2><p>磁盘写入需要经过内核缓存区再写入磁盘中，该行为被称之为延迟写入。为了确保缓冲区内的数据与写入磁盘内的数据一致性，因此提供了<code>sysnc</code>、<code>fsync</code>和<code>fdatasync</code>函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsync</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">fdatasync</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">sync</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>sync</code>函数只是简单的将修改后的缓冲区数据写入队列中，并不等待磁盘的写入操作</li>
<li><code>fsync</code>函数则是需要等待<code>fd</code>文件描述符指定的文件写入完后</li>
<li><code>fdatasync</code>函数与<code>fsync</code>函数类似，但是只影响数据部分</li>
</ul>
<h2 id="fcntl"><a href="#fcntl" class="headerlink" title="fcntl"></a>fcntl</h2><p>用于修改以及打开的文件属性</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fcntl</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">int</span> cmd,...<span class="hljs-comment">/* int arg */</span>)</span>;<br></code></pre></td></tr></table></figure>

<h2 id="ioctl"><a href="#ioctl" class="headerlink" title="ioctl"></a>ioctl</h2><p>上述不能操作的文件都可以使用<code>iotcl</code>函数进行操作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">ioctl</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">int</span> request, ...)</span>;<br><span class="hljs-comment">//返回值：若出错，返回-1;若成功，返回其他值</span><br></code></pre></td></tr></table></figure>

<p>每个设备驱动程序可以定义它自己专用的一组<code>ioctl</code>命令，系统则为不同种类的设备提供通用的<code>ioctl</code>命令。</p>
<table>
<thead>
<tr>
<th>类别</th>
<th>常量名</th>
<th>头文件</th>
<th>ioctl数</th>
</tr>
</thead>
<tbody><tr>
<td>盘标号</td>
<td>DIOxxx</td>
<td>&lt;sys&#x2F;disklabel.h&gt;</td>
<td>4</td>
</tr>
<tr>
<td>文件I&#x2F;O</td>
<td>FIOxxx</td>
<td>&lt;sys&#x2F;filio.h&gt;</td>
<td>14</td>
</tr>
<tr>
<td>磁盘I&#x2F;O</td>
<td>MTIOxxx</td>
<td>&lt;sys&#x2F;mtio.h&gt;</td>
<td>11</td>
</tr>
<tr>
<td>套接字I&#x2F;O</td>
<td>STOxxx</td>
<td>&lt;sys&#x2F;sockio.h&gt;</td>
<td>73</td>
</tr>
<tr>
<td>终端I&#x2F;O</td>
<td>TIOxxx</td>
<td>&lt;sys&#x2F;ttycom.h&gt;</td>
<td>43</td>
</tr>
</tbody></table>
<h1 id="文件与目录"><a href="#文件与目录" class="headerlink" title="文件与目录"></a>文件与目录</h1><h2 id="stat函数"><a href="#stat函数" class="headerlink" title="stat函数"></a>stat函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">stat</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> pathname,<span class="hljs-keyword">struct</span> stat *<span class="hljs-keyword">restrict</span> buf)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">fstat</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-keyword">struct</span> stat *buf)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">lstat</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> pathname, <span class="hljs-keyword">struct</span> stat *<span class="hljs-keyword">restrict</span> buf)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">fstatat</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> pathname,<span class="hljs-keyword">struct</span> stat *<span class="hljs-keyword">restrict</span> buf,<span class="hljs-type">int</span> flag)</span>;<br><br><span class="hljs-comment">//获取成功返回0，否则返回-1或者error</span><br></code></pre></td></tr></table></figure>

<ul>
<li>stat函数<ul>
<li>参数一：文件路径</li>
<li>参数二：存储stat结构的缓存区</li>
</ul>
</li>
<li>fstat函数<ul>
<li>参数一：文件描述符</li>
<li>参数二：存储stat结构的缓存区</li>
</ul>
</li>
<li>lstat函数<ul>
<li>参数一：文件路径</li>
<li>参数二：存储stat结构的缓存区</li>
<li>与<code>stat</code>的区别是，当<code>pathname</code>传入的是符号链接，那么会返回符号链接的信息而不是链接文件的信息</li>
</ul>
</li>
<li>fstatat函数<ul>
<li>参数一：文件描述符，若该参数使用了标志位<code>AT_FDCWD</code>，<code>pathname</code>则采用相对路径</li>
<li>参数二：<code>pathname</code>，如果该参数是绝对路径，则忽略<code>fd</code>参数</li>
<li>参数三：存储<code>stat</code>结构的缓存区</li>
<li>参数四：若该标志位设置了<code>AT_SYMLINK_NOFOLLOW</code>则<code>fstatat</code>函数返回符号链接的信息，否则返回链接的原文件</li>
</ul>
</li>
<li><code>stat</code>结构体</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> &#123;</span><br><span class="hljs-type">mode_t</span> st_mode; <span class="hljs-comment">/* file type &amp; mode (permissions) 文件类型*/</span><br><span class="hljs-type">ino_t</span> st_ino; <span class="hljs-comment">/* i-node number (serial number) 序列数字*/</span><br><span class="hljs-type">dev_t</span> st_dev; <span class="hljs-comment">/* device number (file system) 设备号*/</span><br><span class="hljs-type">dev_t</span> st_rdev; <span class="hljs-comment">/* device number for special files 设备号指定的文件*/</span><br><span class="hljs-type">nlink_t</span> st_nlink; <span class="hljs-comment">/* number of links 链接号*/</span><br><span class="hljs-type">uid_t</span> st_uid; <span class="hljs-comment">/* user ID of owner 用户ID*/</span><br><span class="hljs-type">gid_t</span> st_gid; <span class="hljs-comment">/* group ID of owner 组ID*/</span><br><span class="hljs-type">off_t</span> st_size; <span class="hljs-comment">/* size in bytes, for regular files 文件大小*/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timespec</span> <span class="hljs-title">st_atim</span>;</span> <span class="hljs-comment">/* time of last access 最后访问时间*/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timespec</span> <span class="hljs-title">st_mtim</span>;</span> <span class="hljs-comment">/* time of last modification 最后修改时间*/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timespec</span> <span class="hljs-title">st_ctim</span>;</span> <span class="hljs-comment">/* time of last file status change 文件状态修改时间*/</span><br><span class="hljs-type">blksize_t</span> st_blksize; <span class="hljs-comment">/* best I/O block size */</span><br><span class="hljs-type">blkcnt_t</span> st_blocks; <span class="hljs-comment">/* number of disk blocks allocated */</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<h2 id="文件类型"><a href="#文件类型" class="headerlink" title="文件类型"></a>文件类型</h2><ul>
<li>常规文件</li>
<li>目录文件</li>
<li>块特殊文件：每个块作为单位处理</li>
<li>字节特殊文件：每个字节作为单位处理</li>
<li>FIFO：管道文件</li>
<li>Socket：网络通信文件</li>
<li>符号链接</li>
</ul>
<p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221123143919618.png" srcset="/img/loading.gif" lazyload alt="image-20221123143919618"></p>
<p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221123143925606.png" srcset="/img/loading.gif" lazyload alt="image-20221123143925606"></p>
<h2 id="文件访问权限"><a href="#文件访问权限" class="headerlink" title="文件访问权限"></a>文件访问权限</h2><p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221123145941766.png" srcset="/img/loading.gif" lazyload alt="image-20221123145941766"></p>
<h2 id="access和faccessat函数"><a href="#access和faccessat函数" class="headerlink" title="access和faccessat函数"></a>access和faccessat函数</h2><p>用于判断当前进程对文件的权限</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">access</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname, <span class="hljs-type">int</span> mode)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">faccessat</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname, <span class="hljs-type">int</span> mode, <span class="hljs-type">int</span> flag)</span>;<br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221123154536642.png" srcset="/img/loading.gif" lazyload alt="image-20221123154536642"></p>
<ul>
<li>access函数<ul>
<li>参数一：文件路径</li>
<li>参数二：权限</li>
</ul>
</li>
<li>faccessat函数<ul>
<li>参数一：文件描述符，该参数标志了<code>AT_FDCWD</code>后，<code>pathname</code>为相对路径</li>
<li>参数二：文件路径，若该参数是绝对路径则<code>fd</code>参数忽略</li>
<li>访问权限</li>
</ul>
</li>
</ul>
<h2 id="umask"><a href="#umask" class="headerlink" title="umask"></a>umask</h2><p>设置默认创建文件的权限</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><br><span class="hljs-type">mode_t</span> <span class="hljs-title function_">umask</span><span class="hljs-params">(<span class="hljs-type">mode_t</span> cmask)</span>;<br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221123173523830.png" srcset="/img/loading.gif" lazyload alt="image-20221123173523830"></p>
<h2 id="chomd-fchmod和fchmodat"><a href="#chomd-fchmod和fchmodat" class="headerlink" title="chomd,fchmod和fchmodat"></a>chomd,fchmod和fchmodat</h2><p>用于改变文件的访问权限</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">chmod</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname, <span class="hljs-type">mode_t</span> mode)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">fchmod</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">mode_t</span> mode)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">fchmodat</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname, <span class="hljs-type">mode_t</span> mode,<span class="hljs-type">int</span> flag)</span>;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>chmod</code>函数<ul>
<li>参数一：文件路径</li>
<li>参数二：权限</li>
</ul>
</li>
<li><code>fchmod</code>函数<ul>
<li>参数一：文件描述符</li>
<li>参数二：权限</li>
<li>与<code>chmod</code>函数区别为，该函数用于修改打开了的文件</li>
</ul>
</li>
<li><code>fchmodat</code>函数<ul>
<li>参数一：文件描述符，如果<code>fd</code>含有<code>AT_FDCWD</code>，那么文件路径为相对路径</li>
<li>参数二：文件路径，如果该参数是绝对路径，则忽略<code>fd</code>参数</li>
<li>参数三：权限</li>
<li>参数四：标志位，设置<code>AT_SYMLINK_NOFOLLOW</code>则不返回符号链接</li>
</ul>
</li>
</ul>
<p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221123174632032.png" srcset="/img/loading.gif" lazyload alt="image-20221123174632032"></p>
<h2 id="chown-fchown-fchownat-和lchown"><a href="#chown-fchown-fchownat-和lchown" class="headerlink" title="chown,fchown,fchownat,和lchown"></a>chown,fchown,fchownat,和lchown</h2><p><code>chown</code>函数允许我们更改文件的用户ID和组ID</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">chown</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname, <span class="hljs-type">uid_t</span> owner, <span class="hljs-type">gid_t</span> group)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">fchown</span><span class="hljs-params">(<span class="hljs-type">int</span> fd,<span class="hljs-type">uid_t</span> owner,<span class="hljs-type">gidd_t</span> group)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">fchownat</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname,<span class="hljs-type">uid_t</span> owner, <span class="hljs-type">gid_t</span> group, <span class="hljs-type">int</span> flag)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">lchown</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname,<span class="hljs-type">uid_t</span> owner,<span class="hljs-type">gid_t</span> group)</span>;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>chown</code>函数<ul>
<li>参数一：文件路径</li>
<li>参数二：用户id</li>
<li>参数三：组id</li>
</ul>
</li>
<li><code>fchown</code>函数<ul>
<li>参数一：文件描述符</li>
<li>参数二：用户id</li>
<li>参数三：组id</li>
<li>与<code>chown</code>的区别是<code>fchown</code>函数用于修改已经打开了的文件，并且不能修改符号链接文件</li>
</ul>
</li>
<li><code>fchownat</code>函数<ul>
<li>参数一：文件描述符，若该值含有<code>AT_FDCWD</code>标志位，则<code>pathname</code>采用相对路径</li>
<li>参数二：文件路径，若该值采用绝对路径则忽略文件描述符</li>
<li>参数三：用户id</li>
<li>参数四：组id</li>
<li>参数五：标志，若该标志设置为<code>AT_SYMLINK_NOFOLLOW</code>则更改符号链接本身的所有者，否者更改符号链接指向的文件</li>
</ul>
</li>
<li><code>lchown</code>函数用于修改符号链接的文件的权限</li>
</ul>
<h2 id="truncate和ftruncate"><a href="#truncate和ftruncate" class="headerlink" title="truncate和ftruncate"></a>truncate和ftruncate</h2><p>用于截断文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">truncate</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname, <span class="hljs-type">off_t</span> length)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">ftruncate</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">off_t</span> length)</span>;<br></code></pre></td></tr></table></figure>

<h2 id="link-linkat-unlink-unlinkat-和-remove"><a href="#link-linkat-unlink-unlinkat-和-remove" class="headerlink" title="link,linkat,unlink,unlinkat,和 remove"></a>link,linkat,unlink,unlinkat,和 remove</h2><p>创建现有文件的链接</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">link</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *existingpath, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *newpath)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">linkat</span><span class="hljs-params">(<span class="hljs-type">int</span> efd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *existingpath, <span class="hljs-type">int</span> nfd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *newpath, <span class="hljs-type">int</span> flag)</span>;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>linkat</code>函数<ul>
<li><code>efd</code>与<code>existingpath</code>指出被链接的文件，<code>nfd</code>与<code>newpath</code>为链接后的文件</li>
<li>若使用绝对路径则忽略文件描述符</li>
<li>若使用相对路径，则相对于文件描述符</li>
<li>若文件描述含有<code>AT_FDCWD</code>标志，那么相当于当前目录</li>
<li>若<code>flag</code>设置为<code>AT_SYMLINK_FOLLOW</code>则链接符号链接本身，否则指向符号链接指向的文件</li>
</ul>
</li>
</ul>
<p>解除链接</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">unlink</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">unlinkat</span><span class="hljs-params">(<span class="hljs-type">int</span> fd,<span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname,<span class="hljs-type">int</span> flag)</span>;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>unlinkat</code>函数<ul>
<li><code>flag</code>参数设置了<code>AT_REMOVEDIR</code>标志后，<code>unlinkat</code>函数用于删除目录</li>
</ul>
</li>
</ul>
<p>删除文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">remove</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname)</span>;<br></code></pre></td></tr></table></figure>

<h2 id="rename-和-renameat"><a href="#rename-和-renameat" class="headerlink" title="rename 和 renameat"></a>rename 和 renameat</h2><p>修改文件或目录名称</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">rename</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *oldname, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *rewname)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">renameat</span><span class="hljs-params">(<span class="hljs-type">int</span> oldfd,<span class="hljs-type">const</span> <span class="hljs-type">char</span> *oldname,<span class="hljs-type">int</span> newfd,<span class="hljs-type">const</span> <span class="hljs-type">char</span> *newname)</span>;<br></code></pre></td></tr></table></figure>

<h2 id="symlink-和-symlinkat"><a href="#symlink-和-symlinkat" class="headerlink" title="symlink 和 symlinkat"></a>symlink 和 symlinkat</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">symlink</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *actualpath, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *sympath)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">symlinkat</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *actualpath,<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *sympath)</span>;<br></code></pre></td></tr></table></figure>

<h2 id="readlink和readlinkat"><a href="#readlink和readlinkat" class="headerlink" title="readlink和readlinkat"></a>readlink和readlinkat</h2><p>用于打开与读取符号链接本身</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">readlink</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> * <span class="hljs-keyword">restrict</span> pathname, <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> buf, <span class="hljs-type">size_t</span> bufsize)</span>;<br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">readlinkat</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> pathname, <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> buf, <span class="hljs-type">size_t</span> bufsize)</span>;<br></code></pre></td></tr></table></figure>

<h2 id="文件时间"><a href="#文件时间" class="headerlink" title="文件时间"></a>文件时间</h2><p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221125105002804.png" srcset="/img/loading.gif" lazyload alt="image-20221125105002804"></p>
<h2 id="futimens-utimensat和utimes"><a href="#futimens-utimensat和utimes" class="headerlink" title="futimens,utimensat和utimes"></a>futimens,utimensat和utimes</h2><p>用于修改文件的访问时间与修改时间</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">futimnes</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> timespec times[<span class="hljs-number">2</span>])</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">utimensat</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> timespec times[<span class="hljs-number">2</span>],<span class="hljs-type">int</span> flag)</span>;<br></code></pre></td></tr></table></figure>

<p>以秒或微妙修改文件时间</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/time.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">utimes</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> timeval times[<span class="hljs-number">2</span>])</span>;<br></code></pre></td></tr></table></figure>

<h2 id="mkdir-mkdirat和rmdir"><a href="#mkdir-mkdirat和rmdir" class="headerlink" title="mkdir,mkdirat和rmdir"></a>mkdir,mkdirat和rmdir</h2><p><code>mkdir</code>与<code>mkdriat</code>函数创建目录</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">mkdir</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname, <span class="hljs-type">mode_t</span> mode)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">mkdirt</span><span class="hljs-params">(<span class="hljs-type">int</span> fd,<span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname, <span class="hljs-type">mode_t</span> mode)</span>;<br></code></pre></td></tr></table></figure>

<p><code>rmdir</code>函数删除目录</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">rmdir</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname)</span>;<br></code></pre></td></tr></table></figure>

<h2 id="目录读写操作"><a href="#目录读写操作" class="headerlink" title="目录读写操作"></a>目录读写操作</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;dirent.h&gt;</span></span><br>DIR *<span class="hljs-title function_">opendir</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathhname)</span>;<span class="hljs-comment">//打开指定目录</span><br>DIR *<span class="hljs-title function_">fdopendir</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span>;<span class="hljs-comment">//将文件描述符转化为目录结构体</span><br><span class="hljs-comment">//两个函数返回值：若成功，返回指针；若出错，返回NULL</span><br><span class="hljs-keyword">struct</span> dirent *<span class="hljs-title function_">readdir</span><span class="hljs-params">(DIR *dp)</span>;<br><span class="hljs-comment">//返回值：若成功，返回指针；若在目录尾或出错，返回NULL</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">rewinddir</span><span class="hljs-params">(DIR *dp)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">closedir</span><span class="hljs-params">(DIR *dp)</span>;<br><span class="hljs-comment">//返回值：若成功，返回0；若出错，返回-1</span><br><span class="hljs-type">long</span> <span class="hljs-title function_">telldir</span><span class="hljs-params">(DIR *dp)</span>;<br><span class="hljs-comment">//返回值：与dp关联的目录中的当前位置</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">seekdir</span><span class="hljs-params">(DIR *dp, <span class="hljs-type">long</span> loc)</span>;<br></code></pre></td></tr></table></figure>

<p><strong>dirent</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">ino_t</span> d_ino;                      <span class="hljs-comment">//i-node数字</span><br><span class="hljs-type">char</span> d_name[];                    <span class="hljs-comment">//文件名</span><br></code></pre></td></tr></table></figure>

<h2 id="chdir和fchdir"><a href="#chdir和fchdir" class="headerlink" title="chdir和fchdir"></a>chdir和fchdir</h2><p>更改当前的工作目录</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">chdir</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname)</span>;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fchidr</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span>;<br></code></pre></td></tr></table></figure>

<h2 id="getcwd"><a href="#getcwd" class="headerlink" title="getcwd"></a>getcwd</h2><p>获取当前目录的路径</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-type">char</span> *<span class="hljs-title function_">getcwd</span><span class="hljs-params">(<span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> size)</span>;<br></code></pre></td></tr></table></figure>

<h1 id="标准I-x2F-O库"><a href="#标准I-x2F-O库" class="headerlink" title="标准I&#x2F;O库"></a>标准I&#x2F;O库</h1><h2 id="fwide"><a href="#fwide" class="headerlink" title="fwide"></a>fwide</h2><p>用于设置流的定向，流的定向绝对了流是读或写，是单字节或多字节，若流的定向已经被决定则不能修改</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;wchar.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fwide</span><span class="hljs-params">(FILE *fp, <span class="hljs-type">int</span> mode)</span>;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	返回值</span><br><span class="hljs-comment">	正数为宽字节</span><br><span class="hljs-comment">	负数为单字节</span><br><span class="hljs-comment">	0为未定向</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure>

<h2 id="Buffering"><a href="#Buffering" class="headerlink" title="Buffering"></a>Buffering</h2><p>有三种缓冲类型</p>
<ul>
<li><code>Fully buffered</code>：全缓冲，直到缓冲区满才执行<code>I/O</code>操作，可以通过<code>flush</code>函数刷新缓冲区，执行<code>I/O</code>操作</li>
<li><code>Line buffered</code>：直到遇到回车符才会执行<code>I/O</code>操作</li>
<li><code>Unbuffered</code>：不缓存，直接输出</li>
</ul>
<p><code>ISO C</code>对缓冲类型的要求</p>
<ul>
<li>标准输入与标准输出是完全缓存的，除非它们与相关设备交互</li>
<li>标准错误流是不缓存的</li>
</ul>
<h3 id="缓冲知识点扩展"><a href="#缓冲知识点扩展" class="headerlink" title="缓冲知识点扩展"></a>缓冲知识点扩展</h3><p>参考链接<a target="_blank" rel="noopener" href="https://blog.csdn.net/u014069939/article/details/84202445">不带缓存I&#x2F;O和标准I&#x2F;O(带缓存)之间的区别</a></p>
<p><strong>printf.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This Line Should be Cached...&quot;</span>);<br>	sleep(<span class="hljs-number">3</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nThis Line Should be Cached Again&quot;</span>);<br>	sleep(<span class="hljs-number">3</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This Line Should Not be Cached Agin\n&quot;</span>);<br>	sleep(<span class="hljs-number">3</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>标准输出流默认为行缓冲输出，因此只有遇到回车符时才会将缓冲区的字符打印，因此第一条输出语句不带回车符时屏幕上不会有任何信息，而是等待回车符出现后才输出到屏幕上。</p>
<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230210005801166.png" srcset="/img/loading.gif" lazyload alt="image-20230210005801166"></p>
<p>普通情况下，使用<code>printf</code>函数，不带回车符，程序也会将字符串打印在屏幕上，这是因为<code>main</code>函数会经过<code>exit</code>函数退出，<code>exit</code>函数会刷新缓冲区，使得字符串打印在屏幕上，但是通过<code>_Exit</code>函数则不会打印，则不会刷新。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This Line Should be Cached...&quot;</span>);<br>	_Exit(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230210010057022.png" srcset="/img/loading.gif" lazyload alt="image-20230210010057022"></p>
<p>当标准输出被重定向其余文件时，会从行缓冲转化为全缓存，那么只有缓冲区满或者通过<code>fflush</code>或<code>fclose</code>函数函数刷新缓冲区时才会在屏幕上打印字符串。</p>
<p><strong>FILE文件结构体</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> &#123;</span><br><span class="hljs-type">int</span> _flags;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_file_flags _flags</span><br><br><br><br><span class="hljs-type">char</span>* _IO_read_ptr; <span class="hljs-comment">//当前读的偏移</span><br><span class="hljs-type">char</span>* _IO_read_end; <span class="hljs-comment">//读缓冲区的末尾</span><br><span class="hljs-type">char</span>* _IO_read_base; <span class="hljs-comment">//读缓冲区的起始</span><br><span class="hljs-type">char</span>* _IO_write_base; <span class="hljs-comment">//写缓冲区的起始</span><br><span class="hljs-type">char</span>* _IO_write_ptr; <span class="hljs-comment">//当前写的偏移</span><br><span class="hljs-type">char</span>* _IO_write_end; <span class="hljs-comment">//写缓冲区的末尾</span><br><span class="hljs-type">char</span>* _IO_buf_base; <span class="hljs-comment">//缓冲区的起始</span><br><span class="hljs-type">char</span>* _IO_buf_end; <span class="hljs-comment">//缓冲区的末尾</span><br><br><span class="hljs-type">char</span> *_IO_save_base;<br><span class="hljs-type">char</span> *_IO_backup_base;<br><span class="hljs-type">char</span> *_IO_save_end;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_marker</span> *_<span class="hljs-title">markers</span>;</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> *_<span class="hljs-title">chain</span>;</span><br><br><span class="hljs-type">int</span> _fileno; <span class="hljs-comment">//FILE对应的文件描述符</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p><strong>FILE结构测试代码</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-type">char</span> buf[<span class="hljs-number">5</span>];<br>	<span class="hljs-type">char</span> output[<span class="hljs-number">5</span>] = <span class="hljs-string">&quot;abcd&quot;</span>;<br>	FILE *myfile = fopen(<span class="hljs-string">&quot;./test.txt&quot;</span>,<span class="hljs-string">&quot;r+&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;before reading\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;read buffer base %p\n&quot;</span>, myfile-&gt;_IO_read_base);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;read buffer length %d\n&quot;</span>, myfile-&gt;_IO_read_end - myfile-&gt;_IO_read_base);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;write buffer base %p\n&quot;</span>, myfile-&gt;_IO_write_base);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;write buffer length %d\n&quot;</span>, myfile-&gt;_IO_write_end - myfile-&gt;_IO_write_base);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;buf buffer base %p\n&quot;</span>, myfile-&gt;_IO_buf_base);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;buf length %d\n&quot;</span>, myfile-&gt;_IO_buf_end - myfile-&gt;_IO_buf_base);<br>	fgets(buf, <span class="hljs-number">5</span>, myfile);<br>	<span class="hljs-comment">//fputs(output, myfile);</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;after reading\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;before reading\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;read buffer base %p\n&quot;</span>, myfile-&gt;_IO_read_base);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;read buffer length %d\n&quot;</span>, myfile-&gt;_IO_read_end - myfile-&gt;_IO_read_base);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;write buffer base %p\n&quot;</span>, myfile-&gt;_IO_write_base);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;write buffer length %d\n&quot;</span>, myfile-&gt;_IO_write_end - myfile-&gt;_IO_write_base);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;buf buffer base %p\n&quot;</span>, myfile-&gt;_IO_buf_base);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;buf length %d\n&quot;</span>, myfile-&gt;_IO_buf_end - myfile-&gt;_IO_buf_base);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230210020351980.png" srcset="/img/loading.gif" lazyload alt="image-20230210020351980"></p>
<p>在读之前结构体还未初始化，只开辟了一段空间对<code>FILE</code>结构体进行存储</p>
<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230210020411853.png" srcset="/img/loading.gif" lazyload alt="image-20230210020411853"></p>
<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230210020520822.png" srcset="/img/loading.gif" lazyload alt="image-20230210020520822"></p>
<p>可以看到即使代码中写的是读取<code>5</code>字节，但是缓冲区中还是存在着<code>42</code>字节的数据，因此带缓存的<code>I/O</code>是一次性读取<code>1024</code>个字节大小的数据（<code>_IO_buf</code>的大小）到读缓存区中，接着从缓存区中取出<code>5</code>个字节到指定的变量中。</p>
<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230210021036552.png" srcset="/img/loading.gif" lazyload alt="image-20230210021036552"></p>
<h3 id="全缓冲"><a href="#全缓冲" class="headerlink" title="全缓冲"></a>全缓冲</h3><p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230210135358969.png" srcset="/img/loading.gif" lazyload alt="image-20230210135358969"></p>
<h2 id="setbuf和setvbuf"><a href="#setbuf和setvbuf" class="headerlink" title="setbuf和setvbuf"></a>setbuf和setvbuf</h2><p>用于设置是否缓存以及缓存的方式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">void</span> <span class="hljs-title function_">setbuf</span><span class="hljs-params">(FILE *<span class="hljs-keyword">restrict</span> fp, <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> buf)</span>; <span class="hljs-comment">//用于打开与关闭缓冲</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">setvbuf</span><span class="hljs-params">(FILE *<span class="hljs-keyword">restrict</span> fp, <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> buf, <span class="hljs-type">int</span> mode, <span class="hljs-type">size_t</span> size)</span>;<br></code></pre></td></tr></table></figure>

<p><code>setvbuf</code>函数可以指定缓存的方式，若<code>mode</code>选择<code>_IONBF</code>则采用无缓存模式</p>
<p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221128145121567.png" srcset="/img/loading.gif" lazyload alt="image-20221128145121567"></p>
<h2 id="打开流"><a href="#打开流" class="headerlink" title="打开流"></a>打开流</h2><h2 id="fopen、freopen和fdopen"><a href="#fopen、freopen和fdopen" class="headerlink" title="fopen、freopen和fdopen"></a>fopen、freopen和fdopen</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br>FILE *<span class="hljs-title function_">fopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> * <span class="hljs-keyword">restrict</span> pathname, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> type)</span>;<br>FILE *<span class="hljs-title function_">freopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> pathname, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> type, FILE *<span class="hljs-keyword">restrict</span> fp)</span>;<br>FILE *<span class="hljs-title function_">fdopen</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *type)</span>;<br>	<span class="hljs-comment">//成功返回文件指针，错误返回NULL</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>fopen</code>函数用打开指定路径的文件，与<code>open</code>函数的区别为<code>open</code>函数为系统调用而<code>fopen</code>函数为更高层的函数</li>
<li><code>freopen</code>函数为将文件描述符与指定路径的文件联系起来</li>
<li><code>fdopen</code>函数用于打开管道或者<code>socket</code>文件，因为常规的I&#x2F;O无法打开，则可以借助<code>fdopen</code>函数将上述文件描述符与标准I&#x2F;O联系起来</li>
</ul>
<p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221128152516263.png" srcset="/img/loading.gif" lazyload alt="image-20221128152516263"></p>
<h2 id="fclose"><a href="#fclose" class="headerlink" title="fclose"></a>fclose</h2><p>关闭流</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">fclose</span><span class="hljs-params">(FILE *fp)</span><br></code></pre></td></tr></table></figure>

<h2 id="对流进行读写"><a href="#对流进行读写" class="headerlink" title="对流进行读写"></a>对流进行读写</h2><ul>
<li>每次输入&#x2F;输出</li>
<li>每次读取一行</li>
<li>直接I&#x2F;O</li>
</ul>
<h2 id="一次一字符输入函数"><a href="#一次一字符输入函数" class="headerlink" title="一次一字符输入函数"></a>一次一字符输入函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">getc</span><span class="hljs-params">(FILE *fp)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">fgetc</span><span class="hljs-params">(FILE *fp)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">getchar</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>; <span class="hljs-comment">//getc(stdin);</span><br></code></pre></td></tr></table></figure>

<h2 id="ferror和feof"><a href="#ferror和feof" class="headerlink" title="ferror和feof"></a>ferror和feof</h2><p>用于判断读失败是由于到达文件末尾，还是读文件出错</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">ferror</span><span class="hljs-params">(FILE *fp)</span>; <span class="hljs-comment">//读文件错误</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">feof</span><span class="hljs-params">(FILE *fp)</span>; <span class="hljs-comment">//遇到文件末尾</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">clearerr</span><span class="hljs-params">(FILE *fp)</span>; <span class="hljs-comment">//清除错误位</span><br></code></pre></td></tr></table></figure>

<h2 id="ungetc"><a href="#ungetc" class="headerlink" title="ungetc"></a>ungetc</h2><p>用于将字符压回流中，但是只能压入一个字符</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">ungetc</span><span class="hljs-params">(<span class="hljs-type">int</span> c, FILE *fp)</span>;<br></code></pre></td></tr></table></figure>

<h2 id="一次一字符输出函数"><a href="#一次一字符输出函数" class="headerlink" title="一次一字符输出函数"></a>一次一字符输出函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">puc</span><span class="hljs-params">(<span class="hljs-type">int</span> c, FILE *fp)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">fputc</span><span class="hljs-params">(<span class="hljs-type">int</span> c,FILE *fp)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">putchar</span><span class="hljs-params">(<span class="hljs-type">int</span> c)</span>;<br></code></pre></td></tr></table></figure>

<h2 id="一次一行输入函数"><a href="#一次一行输入函数" class="headerlink" title="一次一行输入函数"></a>一次一行输入函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">char</span> *<span class="hljs-title function_">fgets</span><span class="hljs-params">(<span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> buf, <span class="hljs-type">int</span> n, FILE *<span class="hljs-keyword">restrict</span> fp)</span>;<br><span class="hljs-type">char</span> *<span class="hljs-title function_">gets</span><span class="hljs-params">(<span class="hljs-type">char</span> *buf)</span><br></code></pre></td></tr></table></figure>

<h2 id="一次一行输出函数"><a href="#一次一行输出函数" class="headerlink" title="一次一行输出函数"></a>一次一行输出函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">fputs</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> str, FILE *<span class="hljs-keyword">restrict</span> fp)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">puts</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *str)</span>;<br></code></pre></td></tr></table></figure>

<h2 id="二进制流I-x2F-O"><a href="#二进制流I-x2F-O" class="headerlink" title="二进制流I&#x2F;O"></a>二进制流I&#x2F;O</h2><p>可以每次读取&#x2F;写入一个对象</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">fread</span><span class="hljs-params">(<span class="hljs-type">void</span> *resrict ptr, <span class="hljs-type">size_t</span> size, <span class="hljs-type">size_t</span> nobj, FILE *<span class="hljs-keyword">restrict</span> fp)</span>;<br><span class="hljs-type">size_t</span> <span class="hljs-title function_">fwrite</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *<span class="hljs-keyword">restrict</span> ptr, <span class="hljs-type">size_t</span> size, <span class="hljs-type">size_t</span> nobj, FILE *<span class="hljs-keyword">restrict</span> fp)</span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">1.以类型为单位读取数组</span><br><span class="hljs-comment">float data[10];</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">if (fwrite(&amp;data[2],sizeof(float),4,fp) != 4)</span><br><span class="hljs-comment">	err_sys(&quot;fwrite error&quot;);</span><br><span class="hljs-comment">	</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">2. 读写结构体</span><br><span class="hljs-comment">struct&#123;</span><br><span class="hljs-comment">	short count;</span><br><span class="hljs-comment">	long total;</span><br><span class="hljs-comment">	char name[NAMESIZE];</span><br><span class="hljs-comment">&#125;item;</span><br><span class="hljs-comment">if (fwrite(&amp;item, sizeof(item),1,fp) != 1)</span><br><span class="hljs-comment">	err_sys(&quot;fwrite error&quot;);</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure>

<h2 id="ftell、fseek和rewind"><a href="#ftell、fseek和rewind" class="headerlink" title="ftell、fseek和rewind"></a>ftell、fseek和rewind</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">long</span> <span class="hljs-title function_">ftell</span><span class="hljs-params">(FILE *fp)</span>;<span class="hljs-comment">//返回当前流的偏移</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fseek</span><span class="hljs-params">(FILE *fp,<span class="hljs-type">long</span> offset, <span class="hljs-type">int</span> whence)</span>;<span class="hljs-comment">//设置当前流的偏移</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">rewind</span><span class="hljs-params">(FILE *fp)</span><span class="hljs-comment">//将流的偏移定位到开头</span><br></code></pre></td></tr></table></figure>

<h2 id="ftello和fseeko"><a href="#ftello和fseeko" class="headerlink" title="ftello和fseeko"></a>ftello和fseeko</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">off_t</span> <span class="hljs-title function_">ftello</span><span class="hljs-params">(FILE *fp)</span>; <span class="hljs-comment">//返回当前流的偏移</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">fseeko</span><span class="hljs-params">(FILE *fp, <span class="hljs-type">off_t</span> offset, <span class="hljs-type">int</span> whence)</span>;<span class="hljs-comment">//设置当前流的偏移</span><br></code></pre></td></tr></table></figure>

<h2 id="fgetops和fsetops"><a href="#fgetops和fsetops" class="headerlink" title="fgetops和fsetops"></a>fgetops和fsetops</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fgetspos</span><span class="hljs-params">(FILE *<span class="hljs-keyword">restrict</span> fp, <span class="hljs-type">fpos_t</span> *<span class="hljs-keyword">restrict</span> pos)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">fsetpos</span><span class="hljs-params">(FILE *fp, <span class="hljs-type">const</span> <span class="hljs-type">fpos_t</span> *pos)</span>;<br></code></pre></td></tr></table></figure>

<h2 id="格式化的输出"><a href="#格式化的输出" class="headerlink" title="格式化的输出"></a>格式化的输出</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">printf</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> format, ...)</span>; <span class="hljs-comment">//往标准输入写</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">fprintf</span><span class="hljs-params">(FILE *<span class="hljs-keyword">restrict</span> fp, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> format, ...)</span>; <span class="hljs-comment">//往指定流写</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">dprintf</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> format, ...)</span>; <span class="hljs-comment">//往指定文件描述符写</span><br>													<span class="hljs-keyword">return</span>:number of characters output <span class="hljs-keyword">if</span> OK,negative value <span class="hljs-keyword">if</span> output error<br><span class="hljs-type">int</span> <span class="hljs-built_in">sprintf</span>(<span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> buf, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> format, ...); <span class="hljs-comment">//往指定数组写，并在末尾添加截断符</span><br>													<span class="hljs-keyword">return</span>:number of characters stored in <span class="hljs-built_in">array</span> <span class="hljs-keyword">if</span> OK,negative value <span class="hljs-keyword">if</span> encoding error<br><span class="hljs-type">int</span> <span class="hljs-built_in">snprintf</span>(<span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> buf, <span class="hljs-type">size_t</span> n, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> format, ...);<span class="hljs-comment">//往指定数组写并规定了写入的字符数</span><br>													<span class="hljs-keyword">return</span>:number of characters that would have been stored in <span class="hljs-built_in">array</span> <span class="hljs-keyword">if</span> buffer was large enough,negative value <span class="hljs-keyword">if</span> encoding error<br></code></pre></td></tr></table></figure>

<p>格式化字符串的格式</p>
<p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221202161004903.png" srcset="/img/loading.gif" lazyload alt="image-20221202161004903"></p>
<p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221202161020838.png" srcset="/img/loading.gif" lazyload alt="image-20221202161020838"></p>
<p><strong>flags</strong></p>
<table>
<thead>
<tr>
<th align="left">字符</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">+</td>
<td align="left">总是表示有符号数值的’+’或’-‘号，缺省情况是忽略正数的符号。仅适用于数值类型。</td>
</tr>
<tr>
<td align="left">空格</td>
<td align="left">使得有符号数的输出如果没有正负号或者输出0个字符，则前缀1个空格。如果空格与’+’同时出现，则空格说明符被忽略。</td>
</tr>
<tr>
<td align="left">-</td>
<td align="left">左对齐。缺省情况是右对齐。</td>
</tr>
<tr>
<td align="left">#</td>
<td align="left">对于’g’与’G’，不删除尾部0以表示精度。对于’f’, ‘F’, ‘e’, ‘E’, ‘g’, ‘G’, 总是输出小数点。对于’o’, ‘x’, ‘X’, 在非0数值前分别输出前缀0, 0x, and 0X表示数制。</td>
</tr>
<tr>
<td align="left">0</td>
<td align="left">如果width选项前缀以0，则在左侧用0填充直至达到宽度要求。例如printf(“%2d”, 3)输出” 3”，而printf(“%02d”, 3)输出”03”。如果0与-均出现，则0被忽略，即左对齐依然用空格填充。</td>
</tr>
</tbody></table>
<p><strong>fldwidth</strong></p>
<p>指定宽度</p>
<p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221202163106776.png" srcset="/img/loading.gif" lazyload alt="image-20221202163106776"></p>
<p><strong>precision</strong></p>
<p>指定精度</p>
<p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221202163122069.png" srcset="/img/loading.gif" lazyload alt="image-20221202163122069"></p>
<p><strong>lenmodifier</strong></p>
<table>
<thead>
<tr>
<th align="left">字符</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">hh</td>
<td align="left">对于整数类型，printf期待一个从char提升的int尺寸的整型参数。</td>
</tr>
<tr>
<td align="left">h</td>
<td align="left">对于整数类型，printf期待一个从short提升的int尺寸的整型参数。</td>
</tr>
<tr>
<td align="left">l</td>
<td align="left">对于整数类型，printf期待一个long尺寸的整型参数。 对于浮点类型，printf期待一个double尺寸的整型参数。 对于字符串s类型，printf期待一个wchar_t指针参数。 对于字符c类型，printf期待一个wint_t型的参数。</td>
</tr>
<tr>
<td align="left">ll</td>
<td align="left">对于整数类型，printf期待一个long long尺寸的整型参数。Microsoft也可以使用I64</td>
</tr>
<tr>
<td align="left">L</td>
<td align="left">对于浮点类型，printf期待一个long double尺寸的整型参数。</td>
</tr>
<tr>
<td align="left">z</td>
<td align="left">对于整数类型，printf期待一个size_t尺寸的整型参数。</td>
</tr>
<tr>
<td align="left">j</td>
<td align="left">对于整数类型，printf期待一个intmax_t尺寸的整型参数。</td>
</tr>
<tr>
<td align="left">t</td>
<td align="left">对于整数类型，printf期待一个ptrdiff_t尺寸的整型参数。</td>
</tr>
</tbody></table>
<p><strong>convtype</strong></p>
<p>转换类型，必选字段</p>
<table>
<thead>
<tr>
<th align="left">字符</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">d,i</td>
<td align="left">有符号十进制数值int。’%d’与’%i’对于输出是同义；但对于scanf()输入二者不同，其中%i在输入值有前缀0x或0时，分别表示16进制或8进制的值。如果指定了精度，则输出的数字不足时在左侧补0。默认精度为1。精度为0且值为0，则输出为空。</td>
</tr>
<tr>
<td align="left">u</td>
<td align="left">十进制unsigned int。如果指定了精度，则输出的数字不足时在左侧补0。默认精度为1。精度为0且值为0，则输出为空。</td>
</tr>
<tr>
<td align="left">f,F</td>
<td align="left">double型输出10进制定点表示。’f’与’F’差异是表示无穷与NaN时，’f’输出’inf’, ‘infinity’与’nan’；’F’输出’INF’, ‘INFINITY’与’NAN’。小数点后的数字位数等于精度，最后一位数字四舍五入。精度默认为6。如果精度为0且没有#标记，则不出现小数点。小数点左侧至少一位数字。</td>
</tr>
<tr>
<td align="left">e,E</td>
<td align="left">double值，输出形式为10进制的([-]d.ddd e[+&#x2F;-]ddd). E版本使用的指数符号为E（而不是e）。指数部分至少包含2位数字，如果值为0，则指数部分为00。Windows系统，指数部分至少为3位数字，例如1.5e002，也可用Microsoft版的运行时函数_set_output_format 修改。小数点前存在1位数字。小数点后的数字位数等于精度。精度默认为6。如果精度为0且没有#标记，则不出现小数点。</td>
</tr>
<tr>
<td align="left">g,G</td>
<td align="left">double型数值，精度定义为全部有效数字位数。当指数部分在闭区间 [-4,精度] 内，输出为定点形式；否则输出为指数浮点形式。’g’使用小写字母，’G’使用大写字母。小数点右侧的尾数0不被显示；显示小数点仅当输出的小数部分不为0。</td>
</tr>
<tr>
<td align="left">x,X</td>
<td align="left">16进制unsigned int。’x’使用小写字母；’X’使用大写字母。如果指定了精度，则输出的数字不足时在左侧补0。默认精度为1。精度为0且值为0，则输出为空。</td>
</tr>
<tr>
<td align="left">o</td>
<td align="left">8进制unsigned int。如果指定了精度，则输出的数字不足时在左侧补0。默认精度为1。精度为0且值为0，则输出为空。</td>
</tr>
<tr>
<td align="left">s</td>
<td align="left">如果没有用l标志，输出null结尾字符串直到精度规定的上限；如果没有指定精度，则输出所有字节。如果用了l标志，则对应函数参数指向wchar_t型的数组，输出时把每个宽字符转化为多字节字符，相当于调用wcrtomb函数。</td>
</tr>
<tr>
<td align="left">c</td>
<td align="left">如果没有用l标志，把int参数转为unsigned char型输出；如果用了l标志，把wint_t参数转为包含两个元素的wchart_t数组，其中第一个元素包含要输出的字符，第二个元素为null宽字符。</td>
</tr>
<tr>
<td align="left">p</td>
<td align="left">void *型</td>
</tr>
<tr>
<td align="left">a,A</td>
<td align="left">double型的16进制表示，”[−]0xh.hhhh p±d”。其中指数部分为10进制表示的形式。例如：1025.010输出为0x1.004000p+10。’a’使用小写字母，’A’使用大写字母。（C++11流使用hexfloat输出16进制浮点数）</td>
</tr>
<tr>
<td align="left">n</td>
<td align="left">不输出字符，但是把已经成功输出的字符个数写入对应的整型指针参数所指的变量。</td>
</tr>
<tr>
<td align="left">%</td>
<td align="left">‘%’字面值，不接受任何flags, width, precision or length。</td>
</tr>
</tbody></table>
<h2 id="printf家族变体"><a href="#printf家族变体" class="headerlink" title="printf家族变体"></a>printf家族变体</h2><p>用于自定义<code>printf</code>函数的时候使用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdarg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">vprintf</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> format, va_llist arg)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">vfprintf</span><span class="hljs-params">(FILE *<span class="hljs-keyword">restrict</span> fp, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> format, va_list arg)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">vdprintf</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> buf,<span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> format, va_list arg)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">vsnprintf</span><span class="hljs-params">(<span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> buf, <span class="hljs-type">size_t</span> n,<span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> format, va_list arg)</span>;<br></code></pre></td></tr></table></figure>

<h2 id="格式化输入"><a href="#格式化输入" class="headerlink" title="格式化输入"></a>格式化输入</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">scanf</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> format, ...)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">fscanf</span><span class="hljs-params">(FILE *<span class="hljs-keyword">restrict</span> fp, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> format, ...)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">sscanf</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> r*<span class="hljs-keyword">restrict</span> buf, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> format, ...)</span>;<br><span class="hljs-comment">//return:返回输入字符数</span><br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221202165922105.png" srcset="/img/loading.gif" lazyload alt="image-20221202165922105"></p>
<p><code>*</code>：用于跳过当前的输入</p>
<p><code>fldwidth</code>：指定字段宽度</p>
<p><code>lenmodifier</code>：字段大小</p>
<p><code>convtyoe</code>：转换类型</p>
<p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221202170746161.png" srcset="/img/loading.gif" lazyload alt="image-20221202170746161"></p>
<h2 id="scanf家族变体"><a href="#scanf家族变体" class="headerlink" title="scanf家族变体"></a>scanf家族变体</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdarg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">vscanf</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> format, va_list arg)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">vfscanf</span><span class="hljs-params">(FILE *<span class="hljs-keyword">restrict</span> fp, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> format, va_list arg)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">vsscanf</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> buf, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> format, va_list arg)</span>;<br></code></pre></td></tr></table></figure>

<h2 id="fileno"><a href="#fileno" class="headerlink" title="fileno"></a>fileno</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">fileno</span><span class="hljs-params">(FILE *fp)</span>;<br>									<span class="hljs-keyword">return</span>:流相关联文件描述符<br></code></pre></td></tr></table></figure>

<h2 id="tmpname和tempfile"><a href="#tmpname和tempfile" class="headerlink" title="tmpname和tempfile"></a>tmpname和tempfile</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">char</span> *<span class="hljs-title function_">tmpname</span><span class="hljs-params">(<span class="hljs-type">char</span> *ptr)</span>; <span class="hljs-comment">//返回临时文件的路径，若ptr不为空，则将文件路径存储到ptr指向的空间中</span><br>FILE *<span class="hljs-title function_">tmpfile</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>; <span class="hljs-comment">//返回文件的指针</span><br></code></pre></td></tr></table></figure>

<h2 id="mkdtemp和mkstemp"><a href="#mkdtemp和mkstemp" class="headerlink" title="mkdtemp和mkstemp"></a>mkdtemp和mkstemp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-type">char</span> *<span class="hljs-title function_">mkdtemp</span><span class="hljs-params">(<span class="hljs-type">char</span> *template)</span>; <span class="hljs-comment">//用于创建唯一名称的目录，返回临时文件的目录名称</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">mkstemp</span><span class="hljs-params">(<span class="hljs-type">char</span> *template)</span>; <span class="hljs-comment">//用于创建唯一名称的常规文件，文件描述符，使用该函数创建的临时文件不会自动删除</span><br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">make_temp</span><span class="hljs-params">(<span class="hljs-type">char</span> *template)</span>;<br><br><span class="hljs-type">int</span> <br><span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>	<span class="hljs-type">char</span> good_template[] = <span class="hljs-string">&quot;/tmp/dirXXXXXX&quot;</span>; <span class="hljs-comment">//栈上存放的是字符串本身的值</span><br>	<span class="hljs-type">char</span> *bad_template = <span class="hljs-string">&quot;/tmp/dirXXXXXX&quot;</span>; <span class="hljs-comment">//栈上存放的是指针值</span><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;tring to create first temp file...\n&quot;</span>);<br>	make_temp(good_template);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;trying to create second temp file...\n&quot;</span>);<br>	make_temp(bad_template);<br>	<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <br><span class="hljs-title function_">make_temp</span><span class="hljs-params">(<span class="hljs-type">char</span> *template)</span><br>&#123;<br>	<span class="hljs-type">int</span> fd;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">sbuf</span>;</span><br><br>	<span class="hljs-keyword">if</span> ((fd = mkstemp(template)) &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;%s&quot;</span>,<span class="hljs-string">&quot;can&#x27;t create temp file&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;temp name = %s\n&quot;</span>,template);<br>	close(fd);<br>	<span class="hljs-keyword">if</span> (stat(template,&amp;sbuf) &lt; <span class="hljs-number">0</span>)&#123;<br>		<span class="hljs-keyword">if</span>(errno == ENOENT)<br>			<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;file doesn&#x27;t exit\n&quot;</span>);<br>		<span class="hljs-keyword">else</span><br>			<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;stat failed&quot;</span>);<br>	&#125; <span class="hljs-keyword">else</span>&#123;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;file exists\n&quot;</span>);<br>		unlink(template);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="内存流"><a href="#内存流" class="headerlink" title="内存流"></a>内存流</h2><p>用于创建内存流</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br>FILE *<span class="hljs-title function_">fmemopen</span><span class="hljs-params">(<span class="hljs-type">void</span> *<span class="hljs-keyword">restrict</span> buf, <span class="hljs-type">size_t</span> size, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> type)</span>;<br></code></pre></td></tr></table></figure>

<p>用于创建内存流</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br>FILE *<span class="hljs-title function_">open_memstream</span><span class="hljs-params">(<span class="hljs-type">char</span> **bufp, <span class="hljs-type">size_t</span> *sizep)</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;wchar.h&gt;</span></span><br>FILE *<span class="hljs-title function_">open_wmemstream</span><span class="hljs-params">(<span class="hljs-type">wchar_t</span> **bufp, <span class="hljs-type">size_t</span> *sizep)</span>;<br><br></code></pre></td></tr></table></figure>

<h1 id="密码文件"><a href="#密码文件" class="headerlink" title="密码文件"></a>密码文件</h1><p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221205153518991.png" srcset="/img/loading.gif" lazyload alt="image-20221205153518991"></p>
<p>每个成员使用冒号隔开</p>
<p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221205153647054.png" srcset="/img/loading.gif" lazyload alt="image-20221205153647054"></p>
<h2 id="getpwuid和getpwname"><a href="#getpwuid和getpwname" class="headerlink" title="getpwuid和getpwname"></a>getpwuid和getpwname</h2><p>通过用户<code>id</code>与用户名获取密码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pwd.h&gt;</span></span><br><br><span class="hljs-keyword">struct</span> passwd *<span class="hljs-title function_">getpwuid</span><span class="hljs-params">(<span class="hljs-type">uid_t</span> uid)</span>;<br><span class="hljs-keyword">struct</span> passwd *<span class="hljs-title function_">getpwnam</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span>;<br></code></pre></td></tr></table></figure>

<p>用于遍历整个密码文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pwd.h&gt;</span></span><br><br><span class="hljs-keyword">struct</span> passwd *<span class="hljs-title function_">getpwent</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>; <span class="hljs-comment">//调用getpwent返回密码文件中的下一个条目</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">setpwent</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>; <span class="hljs-comment">//将文件设置到开头位置</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">endpwent</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>; <span class="hljs-comment">//用于关闭文件</span><br></code></pre></td></tr></table></figure>

<p><strong>6-2</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pwd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-keyword">struct</span> passwd *<br><span class="hljs-title function_">getpwname</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">passwd</span> *<span class="hljs-title">ptr</span>;</span><br>	setpwent();<br>	<span class="hljs-keyword">while</span>((ptr = getpwent()) != <span class="hljs-literal">NULL</span>)<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(name, ptr-&gt;pw_name) == <span class="hljs-number">0</span>)<br>			<span class="hljs-keyword">break</span>;<br>	endpwent();<br>	<span class="hljs-keyword">return</span>(ptr);<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="影子密码文件"><a href="#影子密码文件" class="headerlink" title="影子密码文件"></a>影子密码文件</h1><p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221205164222088.png" srcset="/img/loading.gif" lazyload alt="image-20221205164222088"></p>
<p>用于获取影子密码文件的函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;shadow.h&gt;</span></span><br><br><span class="hljs-keyword">struct</span> spwd *<span class="hljs-title function_">getspname</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span>;<br><span class="hljs-keyword">struct</span> spwd *<span class="hljs-title function_">getspent</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">setspent</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">endspent</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br></code></pre></td></tr></table></figure>

<h1 id="组文件"><a href="#组文件" class="headerlink" title="组文件"></a>组文件</h1><p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221205164801102.png" srcset="/img/loading.gif" lazyload alt="image-20221205164801102"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;grp.h&gt;</span></span><br><span class="hljs-keyword">struct</span> group *<span class="hljs-title function_">getgrgid</span><span class="hljs-params">(<span class="hljs-type">gid_t</span> gid)</span>;<br><span class="hljs-keyword">struct</span> group *<span class="hljs-title function_">getgrname</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span>;<br></code></pre></td></tr></table></figure>

<p>用于遍历整个组文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;grp.h&gt;</span></span><br><span class="hljs-keyword">struct</span> group *<span class="hljs-title function_">getgrent</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">setgrent</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">endgrent</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br></code></pre></td></tr></table></figure>

<h1 id="补充组ID"><a href="#补充组ID" class="headerlink" title="补充组ID"></a>补充组ID</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">getgroups</span><span class="hljs-params">(<span class="hljs-type">int</span> gidsetsize, <span class="hljs-type">gid_t</span> grouplist[])</span>;<span class="hljs-comment">//获取目前用户所属的组ID</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;grp.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">setgroups</span><span class="hljs-params">(<span class="hljs-type">int</span> ngroups, <span class="hljs-type">const</span> <span class="hljs-type">gid_t</span> grouplist[])</span>;<br><span class="hljs-comment">//设置当前用户的补充组ID</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;grp.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">initgroups</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *username, <span class="hljs-type">gid_t</span> basegid)</span>;<span class="hljs-comment">//从组文件（/etc/group）中读取一项数据，若该组数据的成员中有参数user时，便将参数group组识别码加入到此数据中。</span><br></code></pre></td></tr></table></figure>

<h1 id="其他系统文件"><a href="#其他系统文件" class="headerlink" title="其他系统文件"></a>其他系统文件</h1><p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221207165325358.png" srcset="/img/loading.gif" lazyload alt="image-20221207165325358"></p>
<h1 id="登录记录"><a href="#登录记录" class="headerlink" title="登录记录"></a>登录记录</h1><p><code>utmp</code>用于跟踪过当前登录的所有用户</p>
<p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221207165629576.png" srcset="/img/loading.gif" lazyload alt="image-20221207165629576"></p>
<h1 id="系统识别"><a href="#系统识别" class="headerlink" title="系统识别"></a>系统识别</h1><p>获取当前主机与操作系统的信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/utsname.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">uname</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> utsname *name)</span><br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221207170044044.png" srcset="/img/loading.gif" lazyload alt="image-20221207170044044"></p>
<p>获取TCP&#x2F;IP网络上的主机名称</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">gethosstname</span><span class="hljs-params">(<span class="hljs-type">char</span> *name,<span class="hljs-type">int</span> namelen)</span>;<br></code></pre></td></tr></table></figure>

<h1 id="时间与日期"><a href="#时间与日期" class="headerlink" title="时间与日期"></a>时间与日期</h1><p>获取当前时间和日期</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><br><span class="hljs-type">time_t</span> <span class="hljs-title function_">time</span><span class="hljs-params">(<span class="hljs-type">time_t</span> *calptr)</span>;<br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221207171327943.png" srcset="/img/loading.gif" lazyload alt="image-20221207171327943"></p>
<p>用于获取指定时钟的时间</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/time.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">clock_gettime</span><span class="hljs-params">(<span class="hljs-type">clockid_t</span> clock_id, <span class="hljs-keyword">struct</span> timespec *tsp)</span>;<br></code></pre></td></tr></table></figure>

<p>用于获取指定精度时间</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/time.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">clock_getres</span><span class="hljs-params">(<span class="hljs-type">clockid_t</span> clock_id, <span class="hljs-keyword">struct</span> timespec *tsp)</span>;<br></code></pre></td></tr></table></figure>

<p>用于设置特定的时间</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/time.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">clock_settime</span><span class="hljs-params">(<span class="hljs-type">clockid_t</span> clock_id, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> timespec *tsp)</span>;<br></code></pre></td></tr></table></figure>

<p>比<code>time</code>函数更高的精度获取时间</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/time.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">gettimeofday</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> timeval *<span class="hljs-keyword">restrict</span> tp, <span class="hljs-type">void</span> *<span class="hljs-keyword">restrict</span> tzp)</span>;<br></code></pre></td></tr></table></figure>

<p>时间之间的关系</p>
<p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221207172705110.png" srcset="/img/loading.gif" lazyload alt="image-20221207172705110"></p>
<p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221207172748969.png" srcset="/img/loading.gif" lazyload alt="image-20221207172748969"></p>
<p>时间转化</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><br><span class="hljs-keyword">struct</span> tm *<span class="hljs-title function_">gmtime</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">time_t</span> *calptr)</span>;<span class="hljs-comment">//将日历时间转化为本地时间</span><br><span class="hljs-keyword">struct</span> tm*<span class="hljs-title function_">localtime</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">time_t</span> *calptr)</span><span class="hljs-comment">//将日历时间转化为UTC表示的分解时间</span><br></code></pre></td></tr></table></figure>

<p>函数mktime获取一个表示为本地时间的分解时间，并将其转换为time_t值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><br><span class="hljs-type">time_t</span> <span class="hljs-title function_">mktime</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> tm*tmptr)</span>;<br></code></pre></td></tr></table></figure>

<p>以格式化字符串的形式转换时间</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">strftime</span><span class="hljs-params">(charr *<span class="hljs-keyword">restrict</span> buf,<span class="hljs-type">size_t</span> maxsize,</span><br><span class="hljs-params">               <span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> format,<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> tm*<span class="hljs-keyword">restrict</span> tmptr)</span>;<br><span class="hljs-type">size_t</span> <span class="hljs-title function_">strftime_l</span><span class="hljs-params">(<span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> buf,<span class="hljs-type">size_t</span> maxsize,<span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> format,<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> tm*<span class="hljs-keyword">restrict</span> tmptr, <span class="hljs-type">locale_t</span> locale)</span>;<br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221207173819203.png" srcset="/img/loading.gif" lazyload alt="image-20221207173819203"></p>
<p>将字符串转化为中断时间</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><br><span class="hljs-type">char</span> *<span class="hljs-title function_">strptime</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> buf, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> format, <span class="hljs-keyword">struct</span> tm *restrct tmptr)</span>;<br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221207174854679.png" srcset="/img/loading.gif" lazyload alt="image-20221207174854679"></p>
<h1 id="Exit函数"><a href="#Exit函数" class="headerlink" title="Exit函数"></a>Exit函数</h1><h2 id="exit、-Exit和-exit函数"><a href="#exit、-Exit和-exit函数" class="headerlink" title="exit、_Exit和_exit函数"></a>exit、_Exit和<code>_exit</code>函数</h2><p><code>_exit</code>和<code>_Exit</code>会马上返回内核，而<code>exit</code>会执行清理过程再返回内核</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">exit</span><span class="hljs-params">(<span class="hljs-type">int</span> status)</span>;<br><br><span class="hljs-type">void</span> _Exit(<span class="hljs-type">int</span> status);<br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">void</span> _exit(<span class="hljs-type">int</span> status);<br></code></pre></td></tr></table></figure>

<h2 id="atexit"><a href="#atexit" class="headerlink" title="atexit"></a>atexit</h2><p>一个进程可以设置至少32个退出时自动调用的函数，通过<code>atexit</code>函数可以进行注册，调用顺序与执行顺序相反</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">atexxit</span><span class="hljs-params">(<span class="hljs-type">void</span> (*func)(<span class="hljs-type">void</span>))</span>;<br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20221212233431839.png" srcset="/img/loading.gif" lazyload alt="image-20221212233431839"></p>
<h1 id="内存分配"><a href="#内存分配" class="headerlink" title="内存分配"></a>内存分配</h1><h2 id="malloc、calloc和realloc函数"><a href="#malloc、calloc和realloc函数" class="headerlink" title="malloc、calloc和realloc函数"></a>malloc、calloc和realloc函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">void</span> *<span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span>;<br><span class="hljs-type">void</span> *<span class="hljs-title function_">calloc</span><span class="hljs-params">(<span class="hljs-type">size_t</span> nobj, <span class="hljs-type">size_t</span> size)</span>;<br><span class="hljs-type">void</span> *<span class="hljs-title function_">realloc</span><span class="hljs-params">(<span class="hljs-type">void</span> *ptr, <span class="hljs-type">size_t</span> newsize)</span>;<br></code></pre></td></tr></table></figure>

<h1 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h1><p>环境变量的形式为<code>name = value</code></p>
<h2 id="getenv"><a href="#getenv" class="headerlink" title="getenv"></a>getenv</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">char</span> *<span class="hljs-title function_">getenv</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span>;<br>	Returns value;<br></code></pre></td></tr></table></figure>

<h2 id="putenv、setenv和unsetenv"><a href="#putenv、setenv和unsetenv" class="headerlink" title="putenv、setenv和unsetenv"></a>putenv、setenv和unsetenv</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">putenv</span><span class="hljs-params">(<span class="hljs-type">char</span> *str)</span>;<span class="hljs-comment">//接受name=value的字符串形式，若存在则删除原有的</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">setenv</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *value,<span class="hljs-type">int</span> rewrite)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">unsetenv</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span>;<span class="hljs-comment">//删除任何名称的定义</span><br></code></pre></td></tr></table></figure>

<h1 id="setjmp和longjmp"><a href="#setjmp和longjmp" class="headerlink" title="setjmp和longjmp"></a>setjmp和longjmp</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;setjmp.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">setjmp</span><span class="hljs-params">(jmp_buf env)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">longjmp</span><span class="hljs-params">(jmp_buf env,<span class="hljs-type">int</span> cal)</span>;<br></code></pre></td></tr></table></figure>

<h1 id="getrlimit和setrlimit"><a href="#getrlimit和setrlimit" class="headerlink" title="getrlimit和setrlimit"></a>getrlimit和setrlimit</h1><p>通过这两个函数可以查询和设置资源限制</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/resource.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">getrlimit</span><span class="hljs-params">(<span class="hljs-type">int</span> resource, <span class="hljs-keyword">struct</span> rlimit *rlptr)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">setrlimit</span><span class="hljs-params">(<span class="hljs-type">int</span> resource, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> rlimit *rlptr)</span>;<br></code></pre></td></tr></table></figure>



<h1 id="获取进程id"><a href="#获取进程id" class="headerlink" title="获取进程id"></a>获取进程id</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">pid_t</span> <span class="hljs-title function_">getpid</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>; <span class="hljs-comment">//返回调用进程号</span><br><span class="hljs-type">pid_t</span> <span class="hljs-title function_">getppid</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>; <span class="hljs-comment">//返回调用进程的父进程</span><br><span class="hljs-type">uid_t</span> <span class="hljs-title function_">getuid</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>; <span class="hljs-comment">//返回调用进程的真实uid</span><br><span class="hljs-type">uid_t</span> <span class="hljs-title function_">geteuid</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>; <span class="hljs-comment">//返回调用进程的有效uid</span><br><span class="hljs-type">gid_t</span> <span class="hljs-title function_">getgid</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;	<span class="hljs-comment">//返回调用进程的真实组id</span><br><span class="hljs-type">gid_t</span> <span class="hljs-title function_">getegid</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>; <span class="hljs-comment">//返回调用进程的有效组id</span><br></code></pre></td></tr></table></figure>

<h1 id="fork函数"><a href="#fork函数" class="headerlink" title="fork函数"></a>fork函数</h1><p>现有进程可以通过调用fork函数来创建新进程。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">pid_t</span> <span class="hljs-title function_">fork</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br>	<span class="hljs-comment">//返回0为子进程</span><br>	<span class="hljs-comment">//返回非0则为父进程，返回值为子进程号</span><br></code></pre></td></tr></table></figure>

<h1 id="wait和waitpid"><a href="#wait和waitpid" class="headerlink" title="wait和waitpid"></a>wait和waitpid</h1><p>等待子进程完成执行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><br><span class="hljs-type">pid_t</span> <span class="hljs-title function_">wait</span><span class="hljs-params">(<span class="hljs-type">int</span> *statloc)</span>;<br><span class="hljs-type">pid_t</span> <span class="hljs-title function_">waitpid</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> pid,<span class="hljs-type">int</span> *statloc, <span class="hljs-type">int</span> options)</span>;<br>					<span class="hljs-comment">//成功返回子进程id</span><br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>宏</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>WIFEXITED(status)</td>
<td>如果子进程正常结束则返回True</td>
</tr>
<tr>
<td>WIFSIGNALED(status)</td>
<td>如果子进程异常结束则返回True,通过WTERMSIG(status)可以获取信号的序号，通过WCOREDUMP(status)可以判断是否生成core文件</td>
</tr>
<tr>
<td>WIFSTOPPED(status)</td>
<td>如果子进程被停止返回True。通过WSTOPSIG(status)可以获取导致子进程停止的信号序号</td>
</tr>
<tr>
<td>WIFCONTINUED(status)</td>
<td>如果在作业控制停止后继续的子进程返回True</td>
</tr>
</tbody></table>
<h1 id="waitid函数"><a href="#waitid函数" class="headerlink" title="waitid函数"></a>waitid函数</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">waitid</span><span class="hljs-params">(<span class="hljs-type">idtype_t</span> idtype, <span class="hljs-type">id_t</span> id, <span class="hljs-type">siginfo_t</span> *infop,<span class="hljs-type">int</span> options)</span>;<br></code></pre></td></tr></table></figure>

<h2 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h2><ul>
<li>P_PID：等待特定的进程id，id用于标识特定的进程id</li>
<li>P_GID：等待特定的进程组id，id用于标识特定的组id</li>
<li>P_ALL：等待热河子进程，id可以被忽略</li>
</ul>
<h2 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h2><ul>
<li>WCONTINUED：等待先前已停止并已继续且其状态尚未报告的进程</li>
<li>WEXITED：等待已退出的进程</li>
<li>WNOHANG：如果没有可用的子退出状态，则立即返回而不是阻止</li>
<li>WSTOPPED：等待已停止且状态尚未报告的进程</li>
</ul>
<h1 id="wait3和wait4"><a href="#wait3和wait4" class="headerlink" title="wait3和wait4"></a>wait3和wait4</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">f<br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/resource.h&gt;</span></span><br><br><span class="hljs-type">pid_t</span> <span class="hljs-title function_">wait3</span><span class="hljs-params">(<span class="hljs-type">int</span> *statloc,<span class="hljs-type">int</span> options, <span class="hljs-keyword">struct</span> rusage *resage)</span>;<br><span class="hljs-type">pid_t</span> <span class="hljs-title function_">wait4</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> pid,<span class="hljs-type">int</span> *statloc,<span class="hljs-type">int</span> options, <span class="hljs-keyword">struct</span> rusage *rusage)</span>;<br></code></pre></td></tr></table></figure>

<h1 id="exec函数"><a href="#exec函数" class="headerlink" title="exec函数"></a>exec函数</h1><p>exec用磁盘上的一个新程序替换了当前进程</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	exec为执行进程的函数</span><br><span class="hljs-comment">	l代表参数列表,使用空指针作为末尾</span><br><span class="hljs-comment">	v代表参数向量</span><br><span class="hljs-comment">	e代表环境变量</span><br><span class="hljs-comment">	p代表文件名</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">execl</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *arg0, ...)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">execv</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname,<span class="hljs-type">char</span> *<span class="hljs-type">const</span> argv[])</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">execle</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *arg0,...)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">execve</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> r*pathname,<span class="hljs-type">char</span> *<span class="hljs-type">const</span> argv[],<span class="hljs-type">char</span> *<span class="hljs-type">const</span> envp[])</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">execlp</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename,<span class="hljs-type">const</span> <span class="hljs-type">char</span>*arg0,...)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">execvp</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename, <span class="hljs-type">char</span> *<span class="hljs-type">const</span> argv[])</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">fexecve</span><span class="hljs-params">(<span class="hljs-type">int</span> fd,<span class="hljs-type">char</span> *consst argv[],<span class="hljs-type">char</span> *<span class="hljs-type">const</span> envp[])</span>;<br></code></pre></td></tr></table></figure>

<h1 id="system函数"><a href="#system函数" class="headerlink" title="system函数"></a>system函数</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">system</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *cmdstring)</span>;<br></code></pre></td></tr></table></figure>

<h1 id="用户识别"><a href="#用户识别" class="headerlink" title="用户识别"></a>用户识别</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-type">char</span> *<span class="hljs-title function_">getlogin</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br></code></pre></td></tr></table></figure>

<h1 id="进程调度"><a href="#进程调度" class="headerlink" title="进程调度"></a>进程调度</h1><p>获取调度优先级</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">nice</span><span class="hljs-params">(<span class="hljs-type">int</span> incr)</span>;<br></code></pre></td></tr></table></figure>

<p>获取一组进程的调度优先级</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/resource.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">getpriority</span><span class="hljs-params">(<span class="hljs-type">int</span> which, <span class="hljs-type">id_t</span> who)</span>;<br></code></pre></td></tr></table></figure>

<p>设置进程的调用优先级</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/resource.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">setpriority</span><span class="hljs-params">(<span class="hljs-type">int</span> which, <span class="hljs-type">id_t</span> who, <span class="hljs-type">int</span> value)</span>;<br></code></pre></td></tr></table></figure>

<h1 id="进程时间"><a href="#进程时间" class="headerlink" title="进程时间"></a>进程时间</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/times.h&gt;</span></span><br><span class="hljs-type">clock_t</span> <span class="hljs-title function_">times</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> tms *buf)</span>;<br></code></pre></td></tr></table></figure>

<h1 id="进程组"><a href="#进程组" class="headerlink" title="进程组"></a>进程组</h1><p>获取进程组id</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">pid_t</span> <span class="hljs-title function_">getpgrp</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>; <span class="hljs-comment">//返回调用进程的进程组id</span><br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">pid_t</span> <span class="hljs-title function_">getpgid</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> pid)</span>; <span class="hljs-comment">//pid为0则代表当前进程</span><br></code></pre></td></tr></table></figure>

<p>加入或创建组</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">setpgid</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> pid,<span class="hljs-type">pid_t</span> pgid)</span>;<br></code></pre></td></tr></table></figure>

<h1 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h1><h2 id="setsid"><a href="#setsid" class="headerlink" title="setsid"></a>setsid</h2><p>建立会话</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">pid_t</span> <span class="hljs-title function_">setsid</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>; <span class="hljs-comment">//返回进程组ID</span><br></code></pre></td></tr></table></figure>

<h2 id="getsid"><a href="#getsid" class="headerlink" title="getsid"></a>getsid</h2><p>获取会话id</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-type">pid_t</span> <span class="hljs-title function_">getsid</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> pid)</span>; <span class="hljs-comment">//返回会话领导的进程组ID</span><br></code></pre></td></tr></table></figure>

<h2 id="tcgetpgrp-tcsetpgrp-and-tcgetsid"><a href="#tcgetpgrp-tcsetpgrp-and-tcgetsid" class="headerlink" title="tcgetpgrp,tcsetpgrp and tcgetsid"></a>tcgetpgrp,tcsetpgrp and tcgetsid</h2><p>获取前台进程</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-type">pid_t</span> <span class="hljs-title function_">tcgetpgrp</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span>; <span class="hljs-comment">//返回与打开终端返回的fd描述符相关的前台进程组</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">tcsetpgrp</span><span class="hljs-params">(<span class="hljs-type">int</span> fd,<span class="hljs-type">pid_t</span> pgrpid)</span>;<span class="hljs-comment">//设置控制终端的进程组ID</span><br></code></pre></td></tr></table></figure>

<p>通过<code>TTY</code>文件获取会话负责人的进程组ID</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;termios.h&gt;</span></span><br><span class="hljs-type">pid_t</span> <span class="hljs-title function_">tcgetsid</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span>; <span class="hljs-comment">//返回会话领导人的进程组ID</span><br></code></pre></td></tr></table></figure>

<h1 id="信号"><a href="#信号" class="headerlink" title="信号"></a>信号</h1><p>信号处理函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-type">void</span> (*signal(<span class="hljs-type">int</span> signo, <span class="hljs-type">void</span> (*func)(<span class="hljs-type">int</span>)))(<span class="hljs-type">int</span>);<br></code></pre></td></tr></table></figure>

<ul>
<li>参数<code>func</code><ul>
<li><code>SIG_IGN</code>忽略信号</li>
<li><code>SIG_DFL</code>默认值操作</li>
<li>函数地址，自定义操作</li>
</ul>
</li>
</ul>
<h1 id="kill和raise"><a href="#kill和raise" class="headerlink" title="kill和raise"></a>kill和raise</h1><p><code>kill</code>函数用于给进程与进程组发送信号</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">kill</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> pid,<span class="hljs-type">int</span> signo)</span>;<br><span class="hljs-meta">#raise = kill(getpid(),signo);</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">raise</span><span class="hljs-params">(<span class="hljs-type">int</span> signo)</span>;<br>		<span class="hljs-comment">//若成功，返回0; 若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>pid &gt; 0</code>，发送的进程<code>ID</code>为<code>pid</code></li>
<li><code>pid == 0</code>，向该进程组所有进程发送信号</li>
<li><code>pid &lt; 0</code>，向指定的进程组发送信号</li>
<li><code>pid == -1</code>，向系统所有进程发送信号</li>
</ul>
<h1 id="alarm和pause"><a href="#alarm和pause" class="headerlink" title="alarm和pause"></a>alarm和pause</h1><p><code>alarm</code>允许设置一个计时器，当计时器到期时，生成<code>SIGALRM</code>信号。默认操作是终止进程。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">alarm</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> seconds)</span>;<br></code></pre></td></tr></table></figure>

<p><code>pause</code>函数暂停调用过程，直到捕捉到信号。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pause</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br></code></pre></td></tr></table></figure>

<h1 id="信号设置"><a href="#信号设置" class="headerlink" title="信号设置"></a>信号设置</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">sigemptyset</span><span class="hljs-params">(<span class="hljs-type">sigset_t</span> *<span class="hljs-built_in">set</span>)</span>; <span class="hljs-comment">//清空信号集</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">sigfillset</span><span class="hljs-params">(<span class="hljs-type">sigset_t</span> *<span class="hljs-built_in">set</span>)</span>; <span class="hljs-comment">//初始化信号集</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">sigaddset</span><span class="hljs-params">(<span class="hljs-type">sigset_t</span> *<span class="hljs-built_in">set</span>,<span class="hljs-type">int</span> signo)</span>;<span class="hljs-comment">//添加单个信号</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">sigdelset</span><span class="hljs-params">(<span class="hljs-type">sigset_t</span> *<span class="hljs-built_in">set</span>,<span class="hljs-type">int</span> signo)</span>;<span class="hljs-comment">//删除单个信号</span><br>						<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>:<span class="hljs-keyword">if</span> OK, <span class="hljs-number">-1</span> on error<br><span class="hljs-type">int</span> sigismember(conset <span class="hljs-type">sigset_t</span> *<span class="hljs-built_in">set</span>,<span class="hljs-type">int</span> signo);<span class="hljs-comment">//判断signo信号是否被设置，是返回1，否返回0</span><br></code></pre></td></tr></table></figure>

<h2 id="sigprocmask"><a href="#sigprocmask" class="headerlink" title="sigprocmask"></a>sigprocmask</h2><p>用于修改信号掩码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">sigprocmask</span><span class="hljs-params">(<span class="hljs-type">int</span> how,<span class="hljs-type">const</span> <span class="hljs-type">sigset_t</span> *<span class="hljs-keyword">restrict</span> <span class="hljs-built_in">set</span>, <span class="hljs-type">sigset_t</span> *<span class="hljs-keyword">restrict</span> oset)</span>;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>oset</code>用于存储当前进程的信号掩码</li>
<li><code>set</code>若不为空，则<code>how</code>参数指示当前信号掩码如何修改</li>
<li><code>how</code>参数选项如下<ul>
<li><code>SIG_BLOCK</code>：<code>set</code>指向需要阻塞的信号</li>
<li><code>SIG_UNBLOCK</code>：<code>set</code>指向需要解除的信号</li>
<li><code>SIG_SETMASK</code>：新信号的掩码被<code>set</code>替换</li>
</ul>
</li>
</ul>
<h2 id="sigpending"><a href="#sigpending" class="headerlink" title="sigpending"></a>sigpending</h2><p><code>sigpending</code>函数用于返回被阻塞的信号或者等待被调用的信号集，返回的信号集存放在<code>set</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">sigpending</span><span class="hljs-params">(<span class="hljs-type">sigset_t</span> *<span class="hljs-built_in">set</span>)</span>;<br>								Ruturns:<span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK, <span class="hljs-number">-1</span> on error<br></code></pre></td></tr></table></figure>

<p><strong>例子</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">sig_quit</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span>;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-type">sigset_t</span> newmask, oldmask, pendmask;<br>	<span class="hljs-keyword">if</span> (signal(SIGQUIT, sig_quit) == SIG_ERR) <span class="hljs-comment">//注册信号</span><br>	&#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;can&#x27;t catch SIGQUIT&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>	&#125;<br>	sigemptyset(&amp;newmask); <span class="hljs-comment">//清空信号集</span><br>	sigaddset(&amp;newmask, SIGQUIT); <span class="hljs-comment">//增加SIGQUIT信号</span><br>	<span class="hljs-keyword">if</span> (sigprocmask(SIG_BLOCK, &amp;newmask, &amp;oldmask) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//阻止newmask中的信号集，当前进程的信号集存放在oldmask中</span><br>	&#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;SIG_BLOCK error&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>	&#125;<br>	sleep(<span class="hljs-number">5</span>);<br>	<span class="hljs-keyword">if</span> (sigpending(&amp;pendmask) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//捕获被挂起的信号集，得到的信号集存放在pendmask中</span><br>	&#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;sigpending error&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>	&#125;<br>	<span class="hljs-keyword">if</span> (sigismember(&amp;pendmask, SIGQUIT)) <span class="hljs-comment">//确定SIGQUIT在pendmask中</span><br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nSIGQUIT pending\n&quot;</span>);<br>	<span class="hljs-keyword">if</span> (sigprocmask(SIG_SETMASK, &amp;oldmask, <span class="hljs-literal">NULL</span>) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//将信号集还原为oldmask</span><br>	&#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;SIG_SETMASK error&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>	&#125;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;SIGQUIT unblocked\n&quot;</span>);<br>	sleep(<span class="hljs-number">5</span>);<br>	<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">sig_quit</span><span class="hljs-params">(<span class="hljs-type">int</span> signo)</span><br>&#123;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;caught SIGQUIT\n&quot;</span>);<br>	<span class="hljs-keyword">if</span> (signal(SIGQUIT, SIG_DFL) == SIG_ERR)<br>	&#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;can&#x27;t reset SIGQUIT&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="sigaction"><a href="#sigaction" class="headerlink" title="sigaction"></a>sigaction</h2><p>用于检查或修改特定信号相关动作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">sigaction</span><span class="hljs-params">(<span class="hljs-type">int</span> signo, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> sigaction *<span class="hljs-keyword">restrict</span> act,<span class="hljs-keyword">struct</span> sigaction *<span class="hljs-keyword">restrict</span> oact)</span>;<br>						Retruns:<span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK, <span class="hljs-number">-1</span> on error<br></code></pre></td></tr></table></figure>

<ul>
<li><code>signo</code>为正在检查或修改动作的信号</li>
<li><code>act</code>为修改的动作</li>
<li><code>oact</code>为原先的动作</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigaction</span>&#123;</span><br>	<span class="hljs-type">void</span> (*sa_handler)(<span class="hljs-type">int</span>); <span class="hljs-comment">//信号处理函数</span><br>    <span class="hljs-type">sigset_t</span> sa_mask; <span class="hljs-comment">//需要处理的信号集</span><br>    <span class="hljs-type">int</span> sa_flags;<br>    <span class="hljs-type">void</span> (*sa_sigaction)(<span class="hljs-type">int</span>, <span class="hljs-type">siginfo_t</span> *, <span class="hljs-type">void</span> *);<br>&#125;;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">siginfo</span> &#123;</span><br><span class="hljs-type">int</span> si_signo; <span class="hljs-comment">/* signal number */</span><br><span class="hljs-type">int</span> si_errno; <span class="hljs-comment">/* if nonzero, errno value from errno.h */</span><br><span class="hljs-type">int</span> si_code; <span class="hljs-comment">/* additional info (depends on signal) */</span><br><span class="hljs-type">pid_t</span> si_pid; <span class="hljs-comment">/* sending process ID */</span><br><span class="hljs-type">uid_t</span> si_uid; <span class="hljs-comment">/* sending process real user ID */</span><br><span class="hljs-type">void</span> *si_addr; <span class="hljs-comment">/* address that caused the fault */</span><br><span class="hljs-type">int</span> si_status; <span class="hljs-comment">/* exit value or signal number */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">sigval</span> <span class="hljs-title">si_value</span>;</span> <span class="hljs-comment">/* application-specific value */</span><br><span class="hljs-comment">/* possibly other fields also */</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">ucontext_t</span> *uc_link; <span class="hljs-comment">/* pointer to context resumed when */</span><br><span class="hljs-comment">/* this context returns */</span><br><span class="hljs-type">sigset_t</span> uc_sigmask; <span class="hljs-comment">/* signals blocked when this context */</span><br><span class="hljs-comment">/* is active */</span><br><span class="hljs-type">stack_t</span> uc_stack; <span class="hljs-comment">/* stack used by this context */</span><br><span class="hljs-type">mcontext_t</span> uc_mcontext; <span class="hljs-comment">/* machine-specific representation of */</span><br><span class="hljs-comment">/* saved context */</span><br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><br>Sigfunc *<br>    <span class="hljs-title function_">signal</span><span class="hljs-params">(<span class="hljs-type">int</span> signo, Sigfunc *func)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigaction</span> <span class="hljs-title">act</span>, <span class="hljs-title">oact</span>;</span><br>    act.sa_handler = func;<br>    sigemptyset(&amp;act.sa_mask);<br>    act.sa_flags = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (signo == SIGALRM)&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> SA_INTERRUPT</span><br>        act.ssa_flags |= SA_IINTERRUPT;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        act.sa_flags |= SA_RESTART;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (sigaction(signo,&amp;act, &amp;ocat) &lt; <span class="hljs-number">0</span>)<br>        	<span class="hljs-keyword">return</span>(SIG_ERR);<br>    retuurn(ocat.sa_handler);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;singal.h&gt;</span></span><br><br>Sigfunc *<br>    <span class="hljs-title function_">signal_intr</span><span class="hljs-params">(<span class="hljs-type">int</span> signo, Sigfunc *func)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigaction</span> <span class="hljs-title">act</span>, <span class="hljs-title">oact</span>;</span><br>    act.sa_handler = func;<br>    sigemptyset(&amp;act.sa_mask);<br>    act.sa_flags = <span class="hljs-number">0</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> SA_INTERRUPT</span><br>    act.sa_flags |= SA_INTERRUPT;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>   	<span class="hljs-keyword">if</span> (sigaction(signo, &amp;act, &amp;oact) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>(SIG_ERR);<br>    <span class="hljs-keyword">return</span>(oact.sa_handler);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="sigsetjmp和siglongjmp"><a href="#sigsetjmp和siglongjmp" class="headerlink" title="sigsetjmp和siglongjmp"></a>sigsetjmp和siglongjmp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;setjmp.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">sigsetjmp</span><span class="hljs-params">(sigjmp_buf env,<span class="hljs-type">int</span> savemask)</span>;<br>		Returns:<span class="hljs-number">0</span> <span class="hljs-keyword">if</span> called directly,nonzero <span class="hljs-keyword">if</span> returning from a call to siglong jmp<br><span class="hljs-type">void</span> <span class="hljs-title function_">siglongjmp</span><span class="hljs-params">(sigjmp_buf env,<span class="hljs-type">int</span> val)</span>;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;setjmp.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">sig_usr1</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">sig_alrm</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span>;<br><span class="hljs-type">static</span> sigjmp_buf jmpbuf;<br><span class="hljs-type">static</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">sig_atomic_t</span> canjump;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-keyword">if</span> (signal(SIGUSR1, sig_usr1) == SIG_ERR)<br>	&#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;signal(SIGUSR1) error&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>	&#125;<br>	<span class="hljs-keyword">if</span> (signal(SIGALRM, sig_alrm) == SIG_ERR)<br>	&#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;signal(SIGALRM) error&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>	&#125;<br>	<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;starting main: &quot;</span>);<br>	<span class="hljs-keyword">if</span> (sigsetjmp(jmpbuf,<span class="hljs-number">1</span>))&#123;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ending main: &quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>	&#125;<br>	canjump = <span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span> ( ; ; )<br>		pause();<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">sig_usr1</span><span class="hljs-params">(<span class="hljs-type">int</span> signo)</span><br>&#123;<br>	<span class="hljs-type">time_t</span> starttime;<br>	<span class="hljs-keyword">if</span> (canjump == <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">return</span>;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;starting sig_usr1: &quot;</span>);<br>	alarm(<span class="hljs-number">3</span>);<br>	starttime = time(<span class="hljs-literal">NULL</span>);<br>	<span class="hljs-keyword">for</span>( ; ; )<br>		<span class="hljs-keyword">if</span> (time(<span class="hljs-literal">NULL</span>) &gt; starttime + <span class="hljs-number">5</span>)<br>			<span class="hljs-keyword">break</span>;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;finishing sig_ussr1: &quot;</span>);<br>	canjump = <span class="hljs-number">0</span>;<br>	siglongjmp(jmpbuf, <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">sig_alrm</span><span class="hljs-params">(<span class="hljs-type">int</span> signo)</span><br>&#123;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;in sig_alrm: &quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="sigsuspend"><a href="#sigsuspend" class="headerlink" title="sigsuspend"></a>sigsuspend</h2><p>恢复信号掩码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">sigsuspend</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">sigset_t</span> *sigmask)</span>;<br>					Returns:<span class="hljs-number">-1</span> with errno <span class="hljs-built_in">set</span> to EINTR<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-keyword">volatile</span> <span class="hljs-type">sig_atomic_t</span> quitflag;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">sig_int</span><span class="hljs-params">(<span class="hljs-type">int</span> signo)</span><br>&#123;<br>	<span class="hljs-keyword">if</span> (signo == SIGINT)<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\ninterrupt\n&quot;</span>);<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (signo == SIGQUIT)<br>		quitflag = <span class="hljs-number">1</span>;<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-type">sigset_t</span> newmask, oldmask, zeromask;<br>	<span class="hljs-keyword">if</span> (signal(SIGINT, sig_int) == SIG_ERR)<br>	&#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;signal(SIGINT) error&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>	&#125;<br>	<span class="hljs-keyword">if</span> (signal(SIGQUIT, sig_int) == SIG_ERR)<br>	&#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;signal(SIGQUIT) error&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>	&#125;<br>	sigemptyset(&amp;zeromask);<br>	sigemptyset(&amp;newmask);<br>	sigaddset(&amp;newmask, SIGQUIT);<br>	<span class="hljs-keyword">if</span> (sigprocmask(SIG_BLOCK, &amp;newmask, &amp;oldmask) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//此时阻塞SIGINT信号</span><br>	&#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;SIG_BLOCK error&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>	&#125;<br>	<span class="hljs-keyword">while</span> (quitflag == <span class="hljs-number">0</span>)<br>		sigsuspend(&amp;zeromask);<span class="hljs-comment">//此时阻塞zeromask里的信号，并挂起进程，等待信号到来唤醒进程</span><br>	quitflag = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">if</span> (sigprocmask(SIG_SETMASK, &amp;oldmask, <span class="hljs-literal">NULL</span>))<br>	&#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;SIG_SETMASK error&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>	&#125;<br>	<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="abort"><a href="#abort" class="headerlink" title="abort"></a>abort</h2><p>终止函数会导致程序异常退出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-type">void</span> <span class="hljs-title function_">abort</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">abort</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">sigset_t</span> mask;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigaction</span> <span class="hljs-title">action</span>;</span><br>    sigaction(SIGABRT,<span class="hljs-literal">NULL</span>,&amp;action);<br>    <span class="hljs-keyword">if</span>(action.sa_handler == SIG_IGN)&#123;<br>        action.sa_handler = SIG_DFL;<br>        sigaction(SIGABRT,&amp;action,<span class="hljs-literal">NULL</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (action.sa_handler == SIG_DFL)<br>        fflush(<span class="hljs-literal">NULL</span>);<br>    sigfillset(&amp;mask);<br>    sigdelset(&amp;mask,SIGABRT);<br>    sigprocmask(SIG_SETMASK,&amp;mask,<span class="hljs-literal">NULL</span>);<br>    kill(getpid(),SIGABRT);<br>    <br>    fflush(<span class="hljs-literal">NULL</span>);<br>    action.sa_handler = SIG_DFL;<br>    sigaction(SIGABRT, &amp;action, <span class="hljs-literal">NULL</span>);<br>    sigprocmask(SIG_SETMASK, &amp;mask, <span class="hljs-literal">NULL</span>);<br>    kill(getpid(), SIGABRT);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="sleep，nanosleep和clock-nanosleep"><a href="#sleep，nanosleep和clock-nanosleep" class="headerlink" title="sleep，nanosleep和clock_nanosleep"></a>sleep，nanosleep和clock_nanosleep</h2><p>暂停当前进程</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">sleep</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> seconds)</span>;<br>	Returns:<span class="hljs-number">0</span> or number of unslept seconds<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">sig_alrm</span><span class="hljs-params">(<span class="hljs-type">int</span> signo)</span><br>&#123;<br>	<br>&#125;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">sleep</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> seconds)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigaction</span> <span class="hljs-title">newact</span>, <span class="hljs-title">oldact</span>;</span><br>	<span class="hljs-type">sigset_t</span> newmask, oldmask, suspmask;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> unslept;<br><br>	newcat.sa_handler = sig_alrm;<br>	sigemptyset(&amp;newact.sa_mask);<br>	newact.sa_flags = <span class="hljs-number">0</span>;<br>	sigaction(SIGALRM, &amp;newact, &amp;oldact);<br><br>	sigemptyset(&amp;newmask);<br>	sigaddset(&amp;newmask, SIGALRM);<br>	sigprocmask(SIG_BLOCK, &amp;newmask, &amp;oldmask);<br>	alarm(seconds);<br>	suspmask = oldmask;<br>	sigdelset(&amp;suspmask, SIGALRM);<br>	sigsuspend(&amp;suspmask);<br>	unslept = alarm(<span class="hljs-number">0</span>);<br>	sigaction(SIGALRM, &amp;oldact, <span class="hljs-literal">NULL</span>);<br>	sigprocmask(SIG_SETMASK, &amp;oldmask, <span class="hljs-literal">NULL</span>);<br>	<span class="hljs-keyword">return</span>(unslept);<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>纳秒级别休眠</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">nanosleep</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> timespec *reqtp, <span class="hljs-keyword">struct</span> timespec *remtp)</span>;<br>				Returns: <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> slept <span class="hljs-keyword">for</span> requested time or <span class="hljs-number">-1</span> on error<br></code></pre></td></tr></table></figure>

<ul>
<li><code>reqtp</code>为休眠时间</li>
<li><code>remtp</code>为剩余的休眠时间</li>
</ul>
<p>指定时间类型的休眠函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">clock_nanosleep</span><span class="hljs-params">(<span class="hljs-type">clockid_t</span> clock_id, <span class="hljs-type">int</span> flags, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> timespec *reqtp, <span class="hljs-keyword">struct</span> timespec *remtp)</span>;<br>			Returns: <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> slept <span class="hljs-keyword">for</span> requeested time or error number on failure<br></code></pre></td></tr></table></figure>

<ul>
<li><code>clock_id</code>用于指定计算时间延迟所依据的时钟。</li>
<li><code>flags</code>用于标记是绝对延迟还是相对延迟<ul>
<li>相对时间：想要休眠多长时间，0为相对时间</li>
<li>绝对时间：休眠到哪个时间点</li>
</ul>
</li>
</ul>
<h2 id="sigqueue"><a href="#sigqueue" class="headerlink" title="sigqueue"></a>sigqueue</h2><p>用于排序的信号</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">sigqueue</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> pid,<span class="hljs-type">int</span> signo, <span class="hljs-type">const</span> <span class="hljs-keyword">union</span> sigval value)</span><br>    						Returns: 0 <span class="hljs-keyword">if</span> OK, -1 on error<br></code></pre></td></tr></table></figure>

<p>使用排队信号的条件</p>
<ul>
<li>使用<code>sigaction</code>函数时，需要使用<code>SA_SIGINFO</code>标志</li>
<li><code>sigaction</code>结构需要使用<code>sa_sigation</code>成员中提供信号处理程序</li>
<li>使用<code>sigqueue</code>函数发送信号</li>
</ul>
<h2 id="psignal和psiginfo"><a href="#psignal和psiginfo" class="headerlink" title="psignal和psiginfo"></a>psignal和psiginfo</h2><p>打印信号对应的字符串</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-type">void</span> <span class="hljs-title function_">psignal</span><span class="hljs-params">(<span class="hljs-type">int</span> signo, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *msg)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">psiginfo</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">siginfo_t</span> *info,<span class="hljs-type">const</span> <span class="hljs-type">char</span> *msg)</span><br></code></pre></td></tr></table></figure>

<p>返回信号对应的字符串，不打印</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-type">char</span> *<span class="hljs-title function_">strsignal</span><span class="hljs-params">(<span class="hljs-type">int</span> signo)</span>;<br></code></pre></td></tr></table></figure>

<p>将信号与字符串进行映射</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">sig2str</span><span class="hljs-params">(<span class="hljs-type">int</span> signo, <span class="hljs-type">char</span> *str)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">str2sig</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *str, <span class="hljs-type">int</span> *signop)</span>;<br></code></pre></td></tr></table></figure>

<h1 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h1><h2 id="pthread-equal"><a href="#pthread-equal" class="headerlink" title="pthread_equal"></a>pthread_equal</h2><p>比较线程<code>id</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_equal</span><span class="hljs-params">(<span class="hljs-type">pthread_t</span> tid1, <span class="hljs-type">pthread_t</span> tid2)</span>;<br>						<span class="hljs-comment">//返回，0则相等，不为0则不相等</span><br></code></pre></td></tr></table></figure>

<h2 id="pthread-self"><a href="#pthread-self" class="headerlink" title="pthread_self"></a>pthread_self</h2><p>获取线程<code>id</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">pthread_t</span> <span class="hljs-title function_">pthread_self</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br></code></pre></td></tr></table></figure>

<h2 id="pthread-create"><a href="#pthread-create" class="headerlink" title="pthread_create"></a>pthread_create</h2><p>线程创建</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_create</span><span class="hljs-params">(<span class="hljs-type">pthread_t</span> *<span class="hljs-keyword">restrict</span> tidp,</span><br><span class="hljs-params">                  <span class="hljs-type">const</span> <span class="hljs-type">pthread_attr_t</span> *<span class="hljs-keyword">restrict</span> attr,</span><br><span class="hljs-params">                  <span class="hljs-type">void</span> *(*start_rtn)(<span class="hljs-type">void</span> *),</span><br><span class="hljs-params">                  <span class="hljs-type">void</span> *<span class="hljs-keyword">restrict</span> arg)</span>;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>tidp</code>被分配的线程<code>ID</code></li>
<li><code>attr</code>自定义各种线程属性</li>
<li><code>start_trn</code>，函数地址</li>
<li><code>arg</code>运行的参数</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">pthread_t</span> ntid;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">printids</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *s)</span><br>&#123;<br>	<span class="hljs-type">pid_t</span> pid;<br>	<span class="hljs-type">pthread_t</span> tid;<br>	pid = getpid();<br>	tid = pthread_self();<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s pid %lu tid %lu (0x%lx)\n&quot;</span>,s,(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)pid,(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)tid,(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)tid);<br>&#125;<br><br><span class="hljs-type">void</span> *<br><span class="hljs-title function_">thr_fn</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>	printids(<span class="hljs-string">&quot;new thread: &quot;</span>);<br>	<span class="hljs-keyword">return</span> ((<span class="hljs-type">void</span> *)<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-type">int</span> err;<br>	err = pthread_create(&amp;ntid, <span class="hljs-literal">NULL</span>, thr_fn, <span class="hljs-literal">NULL</span>);<br>	<span class="hljs-keyword">if</span> (err != <span class="hljs-number">0</span>)<br>	&#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;can&#x27;t create thread&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);	<br>	&#125;<br>	printids(<span class="hljs-string">&quot;main thread:&quot;</span>);<br>	sleep(<span class="hljs-number">1</span>);<br>	<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="pthread-exit"><a href="#pthread-exit" class="headerlink" title="pthread_exit"></a>pthread_exit</h2><p>线程退出函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">pthread_exit</span><span class="hljs-params">(<span class="hljs-type">void</span> *rval_ptr)</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>rval_ptr</code>包含返回代码</li>
</ul>
<h2 id="pthread-join"><a href="#pthread-join" class="headerlink" title="pthread_join"></a>pthread_join</h2><p>用于等待线程的结束</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_join</span><span class="hljs-params">(<span class="hljs-type">pthread_t</span> thread, <span class="hljs-type">void</span> **rval_ptr)</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>thread</code>等待的线程<code>id</code></li>
<li><code>rval_ptr</code>用于存储线程的返回值</li>
</ul>
<h2 id="pthread-cancel"><a href="#pthread-cancel" class="headerlink" title="pthread_cancel"></a>pthread_cancel</h2><p>取消线程</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_cancel</span><span class="hljs-params">(<span class="hljs-type">pthread_t</span> tid)</span>;<br></code></pre></td></tr></table></figure>

<h2 id="pthread-cleanup-push和pthread-cleanup-pop"><a href="#pthread-cleanup-push和pthread-cleanup-pop" class="headerlink" title="pthread_cleanup_push和pthread_cleanup_pop"></a>pthread_cleanup_push和pthread_cleanup_pop</h2><p>线程的清理处理函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">void</span> <span class="hljs-title function_">pthread_cleanup_push</span><span class="hljs-params">(<span class="hljs-type">void</span> (*rtn)(<span class="hljs-type">void</span> *),<span class="hljs-type">void</span> *arg)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">pthread_cleanup_pop</span><span class="hljs-params">(<span class="hljs-type">int</span> execute)</span>;<span class="hljs-comment">//execute = 0则不清理</span><br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">cleanup</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;cleanup: %s\n&quot;</span>, (<span class="hljs-type">char</span> *)arg);<br>&#125;<br><span class="hljs-type">void</span> *<br><span class="hljs-title function_">thr_fn1</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;thread 1 start\n&quot;</span>);<br>	pthread_cleanup_push(cleanup,<span class="hljs-string">&quot;thread 1 first handler&quot;</span>);<br>	pthread_cleanup_push(cleanup,<span class="hljs-string">&quot;thread 1 second handler&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;thread 1 push complete\n&quot;</span>);<br>	<span class="hljs-keyword">if</span> (arg)<br>		<span class="hljs-keyword">return</span> ((<span class="hljs-type">void</span> *)<span class="hljs-number">1</span>);<br>	pthread_cleanup_pop(<span class="hljs-number">0</span>);<br>	pthread_cleanup_pop(<span class="hljs-number">0</span>);<br>	<span class="hljs-keyword">return</span>((<span class="hljs-type">void</span> *)<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">void</span> *<br><span class="hljs-title function_">thr_fn2</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;thread 2 start\n&quot;</span>);<br>	pthread_cleanup_push(cleanup,<span class="hljs-string">&quot;thread 2 first handler&quot;</span>);<br>	pthread_cleanup_push(cleanup,<span class="hljs-string">&quot;thread 2 second handler&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;thread 2 push complete\n&quot;</span>);<br>	<span class="hljs-keyword">if</span> (arg)<br>		pthread_exit((<span class="hljs-type">void</span> *)<span class="hljs-number">2</span>);<br>	pthread_cleanup_pop(<span class="hljs-number">0</span>);<br>	pthread_cleanup_pop(<span class="hljs-number">0</span>);<br>	pthread_exit((<span class="hljs-type">void</span> *)<span class="hljs-number">2</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-type">int</span> err;<br>	<span class="hljs-type">pthread_t</span> tid1, tid2;<br>	<span class="hljs-type">void</span> *tret;<br>	<br>	err = pthread_create(&amp;tid1, <span class="hljs-literal">NULL</span>, thr_fn1,(<span class="hljs-type">void</span> *)<span class="hljs-number">1</span>);<br>	<span class="hljs-keyword">if</span> (err != <span class="hljs-number">0</span>)<br>	&#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;can&#x27;t create thread 1&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>	&#125;<br>	err = pthread_create(&amp;tid2, <span class="hljs-literal">NULL</span>, thr_fn2, (<span class="hljs-type">void</span> *)<span class="hljs-number">1</span>);<br>	<span class="hljs-keyword">if</span> (err != <span class="hljs-number">0</span>)<br>	&#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;can&#x27;t create thread 2&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>	&#125;<br>	err = pthread_join(tid1, &amp;tret);<br>	<span class="hljs-keyword">if</span> (err != <span class="hljs-number">0</span>)<br>	&#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;can&#x27;t join thread 1&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>	&#125;<br>	err = pthread_join(tid2,&amp;tret);<br>	<span class="hljs-keyword">if</span> (err != <span class="hljs-number">0</span>)<br>	&#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;can&#x27;t join thread 2&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>	&#125;<br>	<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="pthread-detach"><a href="#pthread-detach" class="headerlink" title="pthread_detach"></a>pthread_detach</h2><p>分离线程</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_detach</span><span class="hljs-params">(<span class="hljs-type">pthread_t</span> tid)</span>;<br></code></pre></td></tr></table></figure>

<h1 id="线程互斥锁"><a href="#线程互斥锁" class="headerlink" title="线程互斥锁"></a>线程互斥锁</h1><h2 id="pthread-mutex-init和pthread-mutex-destroy"><a href="#pthread-mutex-init和pthread-mutex-destroy" class="headerlink" title="pthread_mutex_init和pthread_mutex_destroy"></a>pthread_mutex_init和pthread_mutex_destroy</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_mutext_init</span><span class="hljs-params">(<span class="hljs-type">pthread_mutex_t</span> *<span class="hljs-keyword">restrict</span> mutex,<span class="hljs-type">const</span> <span class="hljs-type">pthreaad_mutexattr_t</span> *retrict attr)</span>; <span class="hljs-comment">//初始化互斥变量</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_mutext_destroy</span><span class="hljs-params">(<span class="hljs-type">pthread_mutex_t</span> *mutex)</span>;<span class="hljs-comment">//销毁互斥变量</span><br>							Both <span class="hljs-keyword">return</span>: <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OKk, error number on failure<br></code></pre></td></tr></table></figure>

<ul>
<li><code>mutex</code>：互斥变量</li>
<li><code>attr</code>：互斥属性</li>
</ul>
<h2 id="锁定互斥锁"><a href="#锁定互斥锁" class="headerlink" title="锁定互斥锁"></a>锁定互斥锁</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_mutex_loc</span><span class="hljs-params">(<span class="hljs-type">pthread_mutex_t</span> *mutex)</span>; <span class="hljs-comment">//锁定互斥锁</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_mutex_trylock</span><span class="hljs-params">(<span class="hljs-type">pthread_mutex_t</span> *mutex)</span>;<span class="hljs-comment">//有条件地锁定互斥锁</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_mutex_unlock</span><span class="hljs-params">(<span class="hljs-type">pthread_mutex_t</span> *mutex)</span>; <span class="hljs-comment">//解除互斥锁</span><br>							All <span class="hljs-keyword">return</span>:<span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK, error number on failure<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">foo</span>&#123;</span><br>    <span class="hljs-type">int</span> f_count;<br>    <span class="hljs-type">pthread_mutex_t</span> f_lock;<br>    <span class="hljs-type">int</span> f_id;<br>&#125;;<br><br><span class="hljs-keyword">struct</span> foo *<br><span class="hljs-title function_">foo_alloc</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">foo</span> *<span class="hljs-title">fp</span>;</span><br>    <span class="hljs-keyword">if</span> ((fp = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> foo))) != <span class="hljs-literal">NULL</span>)&#123;<br>        fp-&gt;f_count = <span class="hljs-number">1</span>;<br>        fp-&gt;f_id = id;<br>        <span class="hljs-keyword">if</span> (pthread_mutex_init(&amp;foo-&gt;f_lock,<span class="hljs-literal">NULL</span>) != <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-built_in">free</span>(fp);<br>            <span class="hljs-keyword">return</span>(<span class="hljs-literal">NULL</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span>(fp);<br>&#125;<br><br><span class="hljs-type">void</span> <br><span class="hljs-title function_">foo_hold</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> foo *fp)</span><br>&#123;<br>    pthread_mutex_lock(&amp;fp-&gt;f_lock);<br>    fp-&gt;f_count++;<br>    pthread_mutex_unlock(&amp;fp-&gt;f_lock);<br>&#125;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">foo_rele</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> foo *fp)</span><br>&#123;<br>    pthread_mutex_lock(&amp;fp-&gt;f_lock);<br>    <span class="hljs-keyword">if</span> (--fp-&gt;f_count == <span class="hljs-number">0</span>)&#123;<br>        pthread_mutex_unlock(&amp;fp-&gt;f_lock);<br>        pthread_mutex_destroy(&amp;fp-&gt;f_lock);<br>        <span class="hljs-built_in">free</span>(fp);<br>        fp =  <span class="hljs-literal">NULL</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        pthread_mutex_unlock(&amp;fp-&gt;f_lock);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NHASH 29</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HASH(id) ((((unsigned long)id)%NHASH) <span class="hljs-comment">//生成HASH值</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">foo</span> *<span class="hljs-title">fh</span>[<span class="hljs-title">NHASH</span>];</span><br><br><span class="hljs-type">pthread_mutext_t</span> hashlock = PTHREAD_MUTEX_INITALIZER; <span class="hljs-comment">//初始化互斥锁</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">foo</span> &#123;</span><br>    <span class="hljs-type">int</span> f_count;<br>    <span class="hljs-type">pthread_mutext_t</span> f_lock;<br>    <span class="hljs-type">int</span> f_id;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">foo</span> *<span class="hljs-title">f_next</span>;</span><br>&#125;;<br><br><span class="hljs-keyword">struct</span> foo *<br><span class="hljs-title function_">foo_alloc</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">foo</span> *<span class="hljs-title">fp</span>;</span><br>    <span class="hljs-type">int</span> idx;<br><br>    <span class="hljs-keyword">if</span> ((fp = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> foo))) != <span class="hljs-literal">NULL</span>)&#123;<br>        fp-&gt;f_count = <span class="hljs-number">1</span>;<br>        fp-&gt;f_id = id;<br>        <span class="hljs-keyword">if</span> (pthread_mutext_init(&amp;fp-&gt;f_lock, <span class="hljs-literal">NULL</span>)  != <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-built_in">free</span>(fp);<br>            <span class="hljs-keyword">return</span>(<span class="hljs-literal">NULL</span>);<br>        &#125;<br>        idx = HASH(id);<br>        pthread_mutex_lock(&amp;hashlock);<br>        fp-&gt;f_next = fh[idx];<br>        fh[idx] = fp; <span class="hljs-comment">//头插入法</span><br>        pthread_mutext_lock(&amp;fp-&gt;f_lock);<br>        pthread_mutext_unlock(&amp;hashlock);<br>        pthread_mutext_unlock(&amp;fp-&gt;f_lock);<br>    &#125;<br>    <span class="hljs-keyword">return</span>(fp);<br>&#125;<br><br><span class="hljs-type">void</span> <br><span class="hljs-title function_">foo_hold</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> foo *fp)</span><br>&#123;<br>    pthread_mutex_lock(&amp;fp-&gt;f_lock);<br>    fp-&gt;f_count++;<br>    pthread_mutext_unlock(&amp;fp-&gt;f_lock);<br>&#125;<br><br><span class="hljs-keyword">struct</span> foo *<br><span class="hljs-title function_">foo_find</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">foo</span> *<span class="hljs-title">fp</span>;</span><br>    pthread_mutex_lock(&amp;hashlock);<br>    <span class="hljs-keyword">for</span> (fp = fh[HASH(id)]; fp != <span class="hljs-literal">NULL</span>; fp = fp-&gt;f_next)&#123;<br>            <span class="hljs-keyword">if</span> (fp-&gt;f_id == id)&#123;<br>                foo_hold(fp);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>    &#125;<br>    pthread_mutext_unlock(&amp;hashlock);<br>    <span class="hljs-keyword">return</span>(fp);<br>&#125;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">foo_rele</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> foo *fp)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">foo</span> *<span class="hljs-title">tfp</span>;</span><br>    <span class="hljs-type">int</span> idx;<br><br>    pthread_mutex_lock(&amp;fp-&gt;f_lock);<br>    <span class="hljs-keyword">if</span> (fp-&gt;f_count == <span class="hljs-number">1</span>)&#123;<br>        pthread_mutext_unlock(&amp;fp-&gt;f_lock);<br>        pthread_mutex_lock(&amp;hashlock);<br>        pthread_mutext_lock(&amp;fp-&gt;f_lock);<br>        <span class="hljs-keyword">if</span> (fp-&gt;f_count != <span class="hljs-number">1</span>)&#123;<br>            fp-&gt;f_count--;<br>            pthread_mutext_unlock(&amp;fp-&gt;f_lock);<br>            pthread_mutext_unlock(&amp;hashlock);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        idx = HASH(fp-&gt;f_id);<br>        tfp = fh[idx];<br>        <span class="hljs-keyword">if</span> (tfp == fp)&#123;<br>            fh[idx] = fp-&gt;f_next;<br>        &#125; <span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">while</span> (tfp-&gt;f_next != fp)<br>                tfp = tfp-&gt;f_next;<br>            tfp-&gt;f_next = fp-&gt;f_next;<br>        &#125;<br>        pthread_mutext_unlock(&amp;hashlock);<br>        pthread_mutext_unlock(&amp;fp-&gt;f_lock);<br>        pthread_mutext_destroy(&amp;fp-&gt;f_lock);<br>        <span class="hljs-built_in">free</span>(fp);<br>    &#125; <span class="hljs-keyword">else</span>&#123;<br>        fp-&gt;f_count--;<br>        pthread_mutext_unlock(&amp;fp-&gt;f_lock);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NHASH 29</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HASH(id) (((unsigned long)id) %NHASH))</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">foo</span> *<span class="hljs-title">fh</span>[<span class="hljs-title">NHASH</span>];</span><br><span class="hljs-type">pthread_mutext_t</span> hashlock = PTHREAD_MUTEX_INITALIZER;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">foo</span> &#123;</span><br>    <span class="hljs-type">int</span> f_count;<br>    <span class="hljs-type">pthread_mutext_t</span> f_lock;<br>    <span class="hljs-type">int</span> f_id;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">foo</span> *<span class="hljs-title">f_next</span>;</span><br>&#125;;<br><br><span class="hljs-keyword">struct</span> foo *<br><span class="hljs-title function_">foo_alloc</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">foo</span> *<span class="hljs-title">fp</span>;</span><br>    <span class="hljs-type">int</span> idx;<br><br>    <span class="hljs-keyword">if</span> ((fp = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> foo))) != <span class="hljs-literal">NULL</span>)&#123;<br>        fp-&gt;f_count = <span class="hljs-number">1</span>;<br>        fp-&gt;f_id = id;<br>        <span class="hljs-keyword">if</span> (pthread_mutext_init(&amp;fp-f_lock, <span class="hljs-literal">NULL</span>) != <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-built_in">free</span>(fp);<br>            <span class="hljs-keyword">return</span>(<span class="hljs-literal">NULL</span>);<br>        &#125;<br>        idx = HASH(id);<br>        pthread_mutex_lock(&amp;hashlock);<br>        fp-&gt;f_next = fh[idx];<br>        fh[idx] = fp;<br>        pthread_mutext_lock(&amp;fp-&gt;f_lock);<br>        pthread_mutext_unlock(&amp;hashlock);<br>        pthread_mutext_unlock(&amp;fp-&gt;f_lock);<br>    &#125;<br>    <span class="hljs-keyword">return</span>(fp);<br>&#125;<br><br><span class="hljs-type">void</span> <br><span class="hljs-title function_">foo_rele</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> foo *fp)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">foo</span> *<span class="hljs-title">tfp</span>;</span><br>    <span class="hljs-type">int</span> idx;<br><br>    pthread_mutex_lock(&amp;hashlock);<br>    <span class="hljs-keyword">if</span> (--fp-&gt;f_count == <span class="hljs-number">0</span>)&#123;<br>        idx = HASH(fp-&gt;f_id);<br>        tfp = fh[idx];<br>        <span class="hljs-keyword">if</span> (tfp == fp)&#123;<br>            fh[idx] = fp-&gt;f_next;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">while</span> (tfp-&gt;f_next != fp)<br>                tfp = tfp-&gt;f_next;<br>            tfp-&gt;f_next = fp-&gt;f_next;<br>        &#125;<br>        pthread_mutext_unlock(&amp;hashlock);<br>        pthread_mutext_destroy(&amp;fp-&gt;f_lock);<br>        <span class="hljs-built_in">free</span>(fp);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        pthread_mutext_unlock(&amp;hashlock);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="pthread-mutex-tiimedlock"><a href="#pthread-mutex-tiimedlock" class="headerlink" title="pthread_mutex_tiimedlock"></a>pthread_mutex_tiimedlock</h2><p>等待指定时间在加锁</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_mutex_timedlock</span><span class="hljs-params">(<span class="hljs-type">pthread_mutex_t</span> *<span class="hljs-keyword">restrict</span> mutex,<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> timespec *<span class="hljs-keyword">restrict</span> tsptr)</span>;<br>												Returns:<span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK, error number on failure<br></code></pre></td></tr></table></figure>

<h2 id="读写器锁"><a href="#读写器锁" class="headerlink" title="读写器锁"></a>读写器锁</h2><p>初始化读写器锁</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_rwlock_init</span><span class="hljs-params">(<span class="hljs-type">pthread_rwlock_t</span> *<span class="hljs-keyword">restrict</span> rwlock,<span class="hljs-type">const</span> <span class="hljs-type">pthread_rwlockattr_t</span> *<span class="hljs-keyword">restrict</span> attr)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_rwlock_destroy</span><span class="hljs-params">(<span class="hljs-type">pthread_rwlock_t</span> *rwlock)</span>;<br>											  Both <span class="hljs-keyword">return</span>: <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK, error number on failure<br>												<br></code></pre></td></tr></table></figure>

<p>锁读写器锁</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_rwlock_rdlock</span><span class="hljs-params">(<span class="hljs-type">pthread_rwlock_t</span> *rwlock)</span>; <span class="hljs-comment">//用于读</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_rwlock_wrlock</span><span class="hljs-params">(<span class="hljs-type">pthread_rwlock_t</span> *rwlock)</span>; <span class="hljs-comment">//用于写</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_rwlock_unlock</span><span class="hljs-params">(<span class="hljs-type">pthread_rwlock_t</span> *rwlock)</span>; <span class="hljs-comment">//解锁</span><br>											All <span class="hljs-keyword">return</span>: <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK, error number on failure<br></code></pre></td></tr></table></figure>

<p>读写器锁定原语的条件版本</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_rwlock_tryrdlock</span><span class="hljs-params">(<span class="hljs-type">pthread_rwlock_t</span> *rwlock)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_rwlock_trywrlock</span><span class="hljs-params">(<span class="hljs-type">pthread_rwlock_t</span> *rwlock)</span>;<br>											Both <span class="hljs-keyword">return</span>: <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK, error number on failure<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">job</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">job</span> *<span class="hljs-title">j_next</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">job</span> *<span class="hljs-title">j_prev</span>;</span><br>    <span class="hljs-type">pthread_t</span> j_id;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">queue</span>&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">job</span> *<span class="hljs-title">q_head</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">job</span> *<span class="hljs-title">q_tail</span>;</span><br>    <span class="hljs-type">pthread_rwlock_t</span> q_lock;<br>&#125;;<br><br><span class="hljs-type">int</span> <br><span class="hljs-title function_">queue_init</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">queue</span> *qp)</span><br>&#123;<br>    <span class="hljs-type">int</span> err;<br><br>    qp-&gt;q_head = <span class="hljs-literal">NULL</span>;<br>    qp-&gt;q_tail = <span class="hljs-literal">NULL</span>;<br>    err = pthread_rwlock_init(&amp;qb-&gt;q_lock,<span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">if</span> (err != <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>(err);<br>    <span class="hljs-keyword">return</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">job_insert</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">queue</span> *qp, <span class="hljs-keyword">struct</span> job *jp)</span> <span class="hljs-comment">//队头插入</span><br>&#123;<br>    pthread_rwlock_wrlock(&amp;qb-&gt;q_lock); <span class="hljs-comment">//写锁</span><br>    jp-&gt;j_next = qp-&gt;q_head;<br>    jp-&gt;j_prev = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">if</span> (qb-&gt;q_head != <span class="hljs-literal">NULL</span>) <span class="hljs-comment">//空队列</span><br>        qb-&gt;q_head-&gt;j_prev = jp;<br>    <span class="hljs-keyword">else</span><br>        qb-&gt;q_tail = jp;<br>    qb-&gt;q_head = jp;<br>    pthread_rwlock_unlock(&amp;qb-&gt;q_lock);<br>&#125;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">job_append</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">queue</span> *qp, <span class="hljs-keyword">struct</span> job *jp)</span> <span class="hljs-comment">//队尾插入</span><br>&#123;<br>    pthread_rwlock_wrlock(&amp;qb-&gt;q_lock);<br>    jp-&gt;j_next = <span class="hljs-literal">NULL</span>;<br>    jp-&gt;j_prev = qp-&gt;q_tail;<br>    <span class="hljs-keyword">if</span> (qp-&gt;q_tail != <span class="hljs-literal">NULL</span>)<br>        qp-&gt;q_tail-&gt;j_next = jp;<br>    <span class="hljs-keyword">else</span><br>        qp-&gt;q_head = jp;<br>    qp-&gt;q_tail = jp;<br>    pthread_rwlock_unlock(&amp;qb-&gt;q_lock);<br>&#125;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">job_remove</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">queue</span> *qp,<span class="hljs-keyword">struct</span> job *jp)</span><br>&#123;<br>    pthread_rwlock_wrlock(&amp;qb-&gt;q_lock);<br>    <span class="hljs-keyword">if</span> (jp == qb-&gt;q_head)&#123;<br>        qp-&gt;q_head = jp-&gt;j_next;<br>        <span class="hljs-keyword">if</span>(qp-&gt;q_tail == jp)<br>            qp-&gt;q_tail = <span class="hljs-literal">NULL</span>;<br>        <span class="hljs-keyword">else</span><br>            jp-&gt;j_next-&gt;j_prev = jp-&gt;j_prev;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (jp == qb-&gt;q_tail)&#123;<br>        qp-&gt;q_tail = jp-&gt;j_prev;<br>        jp-&gt;j_prev-&gt;j_next = jp-&gt;j_next;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        jp-&gt;j_prev-&gt;j_next = jp-&gt;j_next;<br>        jp-&gt;j_next-&gt;j_prev = jp-&gt;j_prev;<br>    &#125;<br>    pthread_rwlock_unlock(&amp;qb-&gt;q_lock);<br>&#125;<br><br><span class="hljs-keyword">struct</span> job *<br><span class="hljs-title function_">job_find</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">queue</span> *qp, <span class="hljs-type">pthread_t</span> id)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">job</span> *<span class="hljs-title">jp</span>;</span><br>    <span class="hljs-keyword">if</span> (pthread_rwlock_rdlock(&amp;qp-&gt;q_lock) != <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>(<span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">for</span> (jp = qp-&gt;q_head; jp != <span class="hljs-literal">NULL</span>; jp = jp-&gt;j_next)<br>        <span class="hljs-keyword">if</span> (pthread_equal(jp-&gt;j_id, id))<br>            <span class="hljs-keyword">break</span>;<br>    pthread_rwlock_unlock(&amp;qp-&gt;q_lock);<br>    <span class="hljs-keyword">return</span>(jp);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="指定时间阻塞锁定读写器"><a href="#指定时间阻塞锁定读写器" class="headerlink" title="指定时间阻塞锁定读写器"></a>指定时间阻塞锁定读写器</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_rwlock_timedrdlock</span><span class="hljs-params">(<span class="hljs-type">pthread_rwlock_t</span> *<span class="hljs-keyword">restrict</span> rwlock, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> timespec *<span class="hljs-keyword">restrict</span> tsptr)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_rwlock_timedwrlock</span><span class="hljs-params">(<span class="hljs-type">pthread_rwlock_t</span> *<span class="hljs-keyword">restrict</span> rwlock, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> timespec *<span class="hljs-keyword">restrict</span> tsptr)</span>;<br>												Both <span class="hljs-keyword">return</span>: <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK, error number on failure<br></code></pre></td></tr></table></figure>

<h2 id="状态变量"><a href="#状态变量" class="headerlink" title="状态变量"></a>状态变量</h2><p>利用状态加锁</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_cond_init</span><span class="hljs-params">(<span class="hljs-type">pthread_cont_t</span> *<span class="hljs-keyword">restrict</span> cond, <span class="hljs-type">const</span> <span class="hljs-type">pthread_condattr_t</span> *<span class="hljs-keyword">restrict</span> attr)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_cond_destroy</span><span class="hljs-params">(<span class="hljs-type">pthread_cond_t</span> *cond)</span>;<br>												Both <span class="hljs-keyword">return</span>: <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK, error number on failure<br></code></pre></td></tr></table></figure>

<p>状态等待</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_cond_wait</span><span class="hljs-params">(<span class="hljs-type">pthread_cond_t</span> *<span class="hljs-keyword">restrict</span> cond, <span class="hljs-type">pthread_mutex_t</span> *<span class="hljs-keyword">restrict</span> mutex)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_cond_timedwait</span><span class="hljs-params">(<span class="hljs-type">pthread_cond_t</span> *restricct cond, <span class="hljs-type">pthread_mutex_t</span> *<span class="hljs-keyword">restrict</span> mutex,<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> timespec *<span class="hljs-keyword">restrict</span> tsptr)</span>;<br>												Both <span class="hljs-keyword">return</span>: <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK, error number on failure<br></code></pre></td></tr></table></figure>

<p>获取超时的绝对时间</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">maketimeout</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> timespec *tsp, <span class="hljs-type">long</span> minutes)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timeval</span> <span class="hljs-title">now</span>;</span><br>    gettimeofday(&amp;now, <span class="hljs-literal">NULL</span>);<br>    tsp-&gt;tv_sec = now.tv_sec;<br>    tsp-&gt;tv_nsec = now.tv_usec * <span class="hljs-number">1000</span>;<br>    tsp-&gt;tv_sec += minutes * <span class="hljs-number">60</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>唤醒线程</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_cond_signal</span><span class="hljs-params">(<span class="hljs-type">pthread_cond_t</span> *cond)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_cond_broadcast</span><span class="hljs-params">(<span class="hljs-type">pthread_cont_t</span> *cond)</span>;<br>									Both <span class="hljs-keyword">return</span>:<span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK, error number on failure<br></code></pre></td></tr></table></figure>

<h2 id="自旋锁"><a href="#自旋锁" class="headerlink" title="自旋锁"></a>自旋锁</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_spin_init</span><span class="hljs-params">(<span class="hljs-type">pthread_spinlock_t</span> *lock, <span class="hljs-type">int</span> pshared)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_spin_destroy</span><span class="hljs-params">(<span class="hljs-type">pthread_spinlock_t</span> *lock)</span>;<br>									Both <span class="hljs-keyword">return</span>:<span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK, error number on failure<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#inlucde <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_spin_lock</span><span class="hljs-params">(<span class="hljs-type">pthread_spinlock_t</span> *lock)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_spin_trylock</span><span class="hljs-params">(<span class="hljs-type">pthread_spinlock_t</span> *lock)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_spin_unlock</span><span class="hljs-params">(<span class="hljs-type">pthread_spinlock_t</span> *lock)</span>;<br>									All <span class="hljs-keyword">return</span>: <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK, error number on failure<br></code></pre></td></tr></table></figure>

<h2 id="屏障"><a href="#屏障" class="headerlink" title="屏障"></a>屏障</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_barrier_init</span><span class="hljs-params">(<span class="hljs-type">pthread_barrier_t</span> *<span class="hljs-keyword">restrict</span> barrier, <span class="hljs-type">const</span> <span class="hljs-type">pthread_barrierattr_t</span> *<span class="hljs-keyword">restrict</span> attr,<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> count)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_barrier_destory</span><span class="hljs-params">(<span class="hljs-type">pthread_barrier_t</span> *barrier)</span>;<br>									Both <span class="hljs-keyword">return</span>: <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK, error number on failure<br></code></pre></td></tr></table></figure>

<p>等待其他线程</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_barrier_wait</span><span class="hljs-params">(<span class="hljs-type">pthread_barrier_t</span> *barrier)</span>;<br>	Returns:<span class="hljs-number">0</span> or PTHREAD_BARRIER_SERIAL_THREAD <span class="hljs-keyword">if</span> OK, error number on failure<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;limits.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NTHR 8</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NUMNUM 8000000L</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TNUM (NUMNUM/NTHR) <span class="hljs-comment">//一百万</span></span><br><br><br><span class="hljs-type">long</span> nums[NUMNUM];<br><span class="hljs-type">long</span> snums[NUMNUM];<br><br><span class="hljs-type">pthread_barrier_t</span> b; <span class="hljs-comment">//屏障变量</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> SOLARIS</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> heapsort qsort</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-keyword">extern</span> <span class="hljs-type">int</span> <span class="hljs-title function_">heapsort</span><span class="hljs-params">(<span class="hljs-type">void</span> *, <span class="hljs-type">size_t</span>, <span class="hljs-type">size_t</span>,</span><br><span class="hljs-params">                    <span class="hljs-type">int</span> (*)(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *))</span>; <span class="hljs-comment">//堆排序</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">complong</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *arg1, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *arg2)</span> <span class="hljs-comment">//比较</span><br>&#123;<br>    <span class="hljs-type">long</span> l1 = *(<span class="hljs-type">long</span> *)arg1;<br>    <span class="hljs-type">long</span> l2 = *(<span class="hljs-type">long</span> *)arg2;<br>    <span class="hljs-keyword">if</span> (l1 == l2)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (l1 &lt; l2)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">else</span>    <br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br><br><span class="hljs-type">void</span> *<br><span class="hljs-title function_">thr_fn</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    <span class="hljs-type">long</span> idx = (<span class="hljs-type">long</span>)arg;<br>    heapsort(&amp;nums[idx], TNUM, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), complong); <span class="hljs-comment">//堆排序一百万个数据</span><br>    pthread_barrier_wait(&amp;b);<br>    <span class="hljs-keyword">return</span>((<span class="hljs-type">void</span> *)<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">merge</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">long</span> idx[NTHR];<br>    <span class="hljs-type">long</span> i, minidx, sidx, num;<br><br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; NTHR; i++)<br>        idx[i] = i *TNUM; <span class="hljs-comment">//八百万数据</span><br>    <span class="hljs-keyword">for</span> (sidx = <span class="hljs-number">0</span>; sidx &lt; NUMNUM; sidx++)&#123; <span class="hljs-comment">//每次比较八个百万数组中的值，获得最小值放到snums数组中</span><br>        num = LONG_MAX; <span class="hljs-comment">//最大值</span><br>        <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; NTHR; i++)&#123;<br>            <span class="hljs-keyword">if</span> ((idx[i] &lt; (i+<span class="hljs-number">1</span>)*TNUM) &amp;&amp; (nums[idx[i]] &lt; num))&#123;<br>                num = nums[idx[i]];<br>                minidx = i;<br>            &#125;<br>        &#125;<br>        snums[sidx] = nums[idx[minidx]];<br>        idx[minidx]++;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <br><span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> i;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timeval</span> <span class="hljs-title">start</span>, <span class="hljs-title">end</span>;</span><br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> startusec, endusec;<br>    <span class="hljs-type">double</span> elapsed;<br>    <span class="hljs-type">int</span> err;<br>    <span class="hljs-type">pthread_t</span> tid;<br><br>    srandom(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; NUMNUM; i++)<br>        nums[i] = random(); <span class="hljs-comment">//生成八百万个随机的数据</span><br><br>    gettimeofday(&amp;start, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">//获取时间</span><br>    pthread_barrier_init(&amp;b, <span class="hljs-literal">NULL</span>, NTHR+<span class="hljs-number">1</span>); <span class="hljs-comment">//初始化屏障锁</span><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; NTHR; i++)&#123;<br>        err = pthread_create(&amp;tid, <span class="hljs-literal">NULL</span>, thr_fn, (<span class="hljs-type">void</span> *)(i * TNUM)); <span class="hljs-comment">//启动八个线程进行堆排序</span><br>        <span class="hljs-keyword">if</span> (err != <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;can&#x27;t create thread&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>    &#125;<br>    pthread_barrier_wait(&amp;b); <span class="hljs-comment">//八个线程都准备就绪</span><br>    merge(); <span class="hljs-comment">//合并八个线程的数据</span><br>    gettimeofday(&amp;end,<span class="hljs-literal">NULL</span>);<br>    startusec = start.tv_sec * <span class="hljs-number">1000000</span> + start.tv_usec;<br>    endusec = end.tv_sec * <span class="hljs-number">1000000</span> + end.tv_usec;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;sort took %.4f seconds \n&quot;</span>,elapsed);<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; NUMNUM; i++)<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%ld\n&quot;</span>,snums[i]);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="线程控制"><a href="#线程控制" class="headerlink" title="线程控制"></a>线程控制</h1><h2 id="线程属性"><a href="#线程属性" class="headerlink" title="线程属性"></a>线程属性</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_attr_init</span><span class="hljs-params">(<span class="hljs-type">pthread_attr_t</span> *attr)</span>;<span class="hljs-comment">//用于初始化pathread_attr_t结构体，并使得属性都为默认值</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_attr_destroy</span><span class="hljs-params">(<span class="hljs-type">pthread_attr_t</span> *attr)</span>;<span class="hljs-comment">//销毁属性结构体</span><br>						<span class="hljs-comment">//Both return:0 if OK, error number on failure</span><br></code></pre></td></tr></table></figure>

<h2 id="获取线程的分离状态"><a href="#获取线程的分离状态" class="headerlink" title="获取线程的分离状态"></a>获取线程的分离状态</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_attr_getdetachstate</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">pthread_attr_t</span> *<span class="hljs-keyword">restrict</span> attr, <span class="hljs-type">int</span> *detachstate)</span>;<span class="hljs-comment">//获取detachstate属性，属性值为PTHREAD_CREATE_DETACHED或PTHREAD_CREATE_JOINABLE</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_attr_setdetachstate</span><span class="hljs-params">(<span class="hljs-type">pthread_attr_t</span> *attr, <span class="hljs-type">int</span> detachstate)</span>;<br>						<span class="hljs-comment">//Both return:0 if OK,error number on failure</span><br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">makethread</span><span class="hljs-params">(<span class="hljs-type">void</span> *(*fn)(<span class="hljs-type">void</span> *), <span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    <span class="hljs-type">int</span> err;<br>    <span class="hljs-type">pthread_t</span>  tid;<br>    <span class="hljs-type">pthread_attr_t</span> attr;<br><br>    err = pthread_attr_init(&amp;attr);<br>    <span class="hljs-keyword">if</span> (err != <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>(err);<br>    err = pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED);<br>    <span class="hljs-keyword">if</span> (err == <span class="hljs-number">0</span>)<br>        err = pthread_create(&amp;tid, &amp;attr, fn, arg);<br>    pthread_attr_destroy(&amp;attr);<br>    <span class="hljs-keyword">return</span>(err);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="线程堆栈属性"><a href="#线程堆栈属性" class="headerlink" title="线程堆栈属性"></a>线程堆栈属性</h2><p>设置线程的堆栈</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_attr_getstack</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">pthread_attr_t</span> *<span class="hljs-keyword">restrict</span> attr,</span><br><span class="hljs-params">                         <span class="hljs-type">void</span> **<span class="hljs-keyword">restrict</span> stackaddr,</span><br><span class="hljs-params">                         <span class="hljs-type">size_t</span> *<span class="hljs-keyword">restrict</span> stacksize)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_attr_setstack</span><span class="hljs-params">(<span class="hljs-type">pthread_attr_t</span> *attr,</span><br><span class="hljs-params">                         <span class="hljs-type">void</span> *stackaddr,</span><br><span class="hljs-params">                         <span class="hljs-type">size_t</span> stacksize)</span>;<br>						<span class="hljs-comment">//Both return:0 if OK,error number on failure</span><br></code></pre></td></tr></table></figure>

<p>获取与设置堆栈大小</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_attr_getstacksize</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">pthread_attr_t</span> *<span class="hljs-keyword">restrict</span> attr,<span class="hljs-type">size_t</span> *<span class="hljs-keyword">restrict</span> stacksize)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_attr_setstacksize</span><span class="hljs-params">(<span class="hljs-type">pthread_attr_t</span>, <span class="hljs-type">size_t</span> stacksize)</span>;<br>					<span class="hljs-comment">//Both return:0 if OK,error number on failure</span><br></code></pre></td></tr></table></figure>

<p>设置与获取<code>guardsize</code>，<code>guardsize</code>用于设置保护缓存区大小</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_attr_getguardsize</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">pthread_attr_t</span> *<span class="hljs-keyword">restrict</span> attr,<span class="hljs-type">size_t</span> *<span class="hljs-keyword">restrict</span> guaradsize)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_attr_setguardsize</span><span class="hljs-params">(<span class="hljs-type">pthread_attr_t</span> *attr, <span class="hljs-type">size_t</span> guardsize)</span>;<br>				<span class="hljs-comment">//Both return:0 if OK,error number on failure</span><br></code></pre></td></tr></table></figure>

<h2 id="同步属性"><a href="#同步属性" class="headerlink" title="同步属性"></a>同步属性</h2><h3 id="锁属性"><a href="#锁属性" class="headerlink" title="锁属性"></a>锁属性</h3><p><strong>初始化锁属性</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_mutextattr_init</span><span class="hljs-params">(<span class="hljs-type">pthread_mutexattr_t</span> *attr)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_mutexattr_destroy</span><span class="hljs-params">(<span class="hljs-type">pthread_mutexattr_t</span> *attr)</span>;<br>				<span class="hljs-comment">//Both return:0 if OK, error number on failure</span><br></code></pre></td></tr></table></figure>

<p><strong>获取锁共享属性</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_mutexattr_getpshared</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">pthread_mutexattr_t</span> *</span><br><span class="hljs-params">                                 <span class="hljs-keyword">restrict</span> attr,</span><br><span class="hljs-params">                                 <span class="hljs-type">int</span> *<span class="hljs-keyword">restrict</span> pshared)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_mutexattr_setpshared</span><span class="hljs-params">(<span class="hljs-type">pthread_mutexattr_t</span> *attr,</span><br><span class="hljs-params">                                 <span class="hljs-type">int</span> pshared)</span>;<br>								<span class="hljs-comment">//Both return:0 if OK, error number on failure</span><br></code></pre></td></tr></table></figure>

<p><strong>获取健壮互斥体属性</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_mutexattr_getrobust</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">pthread_mutexattr_t</span> *</span><br><span class="hljs-params">                                 <span class="hljs-keyword">restrict</span> attr,</span><br><span class="hljs-params">                               	 <span class="hljs-type">int</span> *<span class="hljs-keyword">restrict</span> robust)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_mmutexattr_setrobust</span><span class="hljs-params">(<span class="hljs-type">pthread_mutexattr_t</span> *attr,</span><br><span class="hljs-params">                                	<span class="hljs-type">int</span> robust)</span>;<br>								<span class="hljs-comment">//Both return: 0 if OK, error number in failure</span><br></code></pre></td></tr></table></figure>

<p><strong>保持互斥锁的状态</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span>c</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_mutex_consistent</span><span class="hljs-params">(<span class="hljs-type">pthread_mutex_t</span> * mutex)</span>;<br>								<span class="hljs-comment">//Reutns:0 if OK, error number on failure</span><br></code></pre></td></tr></table></figure>

<p><strong>mutex类型的可选值</strong></p>
<ul>
<li><code>PTHREAD_MUTEX_NORMAL</code>：标准互斥类型，不进行任何特殊的错误检查或死锁检测</li>
<li><code>PTHREAD_MUTEX_ERRORCHECK</code>：提供错误检查的互斥类型</li>
<li><code>PTHREAD_MUTEX_RECURSIVE</code>：一种互斥锁类型，允许同一线程在不首先解锁的情况下多次锁定它。递归互斥锁保持一个锁计数，直到它被锁定的次数相同时才被释放。因此，如果您锁定递归互斥锁两次，然后解锁它，则互斥锁将保持锁定状态，直到第二次解锁。</li>
<li><code>PTHREAD_MUTEX_DEFAULT</code>：提供默认特性和行为的互斥类型。实现可以自由地将其映射到其他互斥类型之一</li>
</ul>
<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230115180638406.png" srcset="/img/loading.gif" lazyload alt="image-20230115180638406"></p>
<p><strong>获取与更改锁属性</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_mutexattr_gettype</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">pthread_mutexattr_t</span> *</span><br><span class="hljs-params">                             <span class="hljs-keyword">restrict</span> attr, <span class="hljs-type">int</span> *<span class="hljs-keyword">restrict</span> type)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_mutexattr_settype</span><span class="hljs-params">(<span class="hljs-type">pthread_mutexattr_t</span> *attr, <span class="hljs-type">int</span> type)</span>;<br>							<span class="hljs-comment">//Both return:0 if OK,error number on failure</span><br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">makethread</span><span class="hljs-params">(<span class="hljs-type">void</span> *(*)(<span class="hljs-type">void</span> *), <span class="hljs-type">void</span> *)</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">to_info</span>&#123;</span><br>    <span class="hljs-type">void</span> (*to_fn)(<span class="hljs-type">void</span> *); <span class="hljs-comment">//函数指针</span><br>    <span class="hljs-type">void</span> *to_arg; <span class="hljs-comment">//函数的参数</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timespec</span> <span class="hljs-title">to_wait</span>;</span> <span class="hljs-comment">//等待时间</span><br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECTONSEC 1000000000</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> !defined(CLOCK_REALTIME) || defined(BSD)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> clock_nanosleep(ID, FL, REQ, REM) nanosleep((REQ), (REM))</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CLOCK_REALTIME</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CLOCK_REALTIME 0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USECTONSEC 1000</span><br><span class="hljs-type">void</span><br><span class="hljs-title function_">clock_gettime</span><span class="hljs-params">(<span class="hljs-type">int</span> id, <span class="hljs-keyword">struct</span> timespec *tsp)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timeval</span> <span class="hljs-title">tv</span>;</span><br><br>    gettimeofday(&amp;tv, <span class="hljs-literal">NULL</span>);<br>    tsp-&gt;tv_sec = tv.tv_sec;<br>    tsp-&gt;tv_nsec = tv.tv_usec * USECTONSEC;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">makethread</span><span class="hljs-params">(<span class="hljs-type">void</span> *(*fn)(<span class="hljs-type">void</span> *), <span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    <span class="hljs-type">int</span> err;<br>    <span class="hljs-type">pthread_t</span>  tid;<br>    <span class="hljs-type">pthread_attr_t</span> attr;<br><br>    err = pthread_attr_init(&amp;attr); <span class="hljs-comment">//初始化属性</span><br>    <span class="hljs-keyword">if</span> (err != <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>(err);<br>    err = pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED); <span class="hljs-comment">//将线程的状态设置为分离</span><br>    <span class="hljs-keyword">if</span> (err == <span class="hljs-number">0</span>)<br>        err = pthread_create(&amp;tid, &amp;attr, fn, arg);<br>    pthread_attr_destroy(&amp;attr);<br>    <span class="hljs-keyword">return</span>(err);<br>&#125;<br><br><br><span class="hljs-type">void</span> *<br><span class="hljs-title function_">timeout_helper</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">to_info</span> *<span class="hljs-title">tip</span>;</span><br><br>    tip = (<span class="hljs-keyword">struct</span> to_info *)arg;<br>    clock_nanosleep(CLOCK_REALTIME, <span class="hljs-number">0</span>, &amp;tip-&gt;to_wait, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">//纳秒级别休眠</span><br>    (*tip-&gt;to_fn)(tip-&gt;to_arg);<br>    <span class="hljs-built_in">free</span>(arg);<br>    <span class="hljs-keyword">return</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">timeout</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> timespec *when, <span class="hljs-type">void</span> (*func)(<span class="hljs-type">void</span> *), <span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timespec</span> <span class="hljs-title">now</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">to_info</span> *<span class="hljs-title">tip</span>;</span><br>    <span class="hljs-type">int</span> err;<br><br>    clock_gettime(CLOCK_REALTIME, &amp;now);<br>    <span class="hljs-keyword">if</span> ((when-&gt;tv_sec &gt; now.tv_sec) ||<br>    (when-&gt;tv_sec == now.tv_sec &amp;&amp; when-&gt;tv_nsec &gt; now.tv_nsec))&#123;<br>        tip = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> to_info));<br>        <span class="hljs-keyword">if</span> (tip != <span class="hljs-literal">NULL</span>)&#123;<br>            tip-&gt;to_fn = func;<br>            tip-&gt;to_arg = arg;<br>            tip-&gt;to_wait.tv_sec = when-&gt;tv_sec - now.tv_sec;<br>            <span class="hljs-keyword">if</span> (when-&gt;tv_nsec &gt;= now.tv_nsec)&#123;<br>                tip-&gt;to_wait.tv_nsec = when-&gt;tv_nsec - now.tv_nsec;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                tip-&gt;to_wait.tv_sec--;<br>                tip-&gt;to_wait.tv_nsec = SECTONSEC - now.tv_nsec + when-&gt;tv_nsec;<br>            &#125;<br>            err = makethread(timeout_helper, (<span class="hljs-type">void</span> *)tip);<br>            <span class="hljs-keyword">if</span> (err == <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span>;<br>            <span class="hljs-keyword">else</span><br>                <span class="hljs-built_in">free</span>(tip);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">pthread_mutexattr_t</span> attr;<br><span class="hljs-type">pthread_mutex_t</span> mutex;<br><br><span class="hljs-type">void</span> <br><span class="hljs-title function_">retry</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    pthread_mutex_lock(&amp;mutex);<br>    pthread_mutex_unlock(&amp;mutex);<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> err, condition, arg;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timespec</span> <span class="hljs-title">when</span>;</span><br><br>    <span class="hljs-keyword">if</span> ((err = pthread_mutexattr_init(&amp;attr)) != <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;pthread_mutexattr_init failed&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> ((err = pthread_mutexattr_settype(&amp;attr, PTHREAD_MUTEX_RECURSIVE)) != <span class="hljs-number">0</span>) <span class="hljs-comment">//在同一个线程中可以多次获取同一把锁。并且不会死锁</span><br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t set recursive type&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> ((err = pthread_mutex_init(&amp;mutex, &amp;attr)) != <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t create recursive mutex&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    pthread_mutex_lock(&amp;mutex);<br><br>    <span class="hljs-keyword">if</span> (condition) &#123;<br>        clock_gettime(CLOCK_REALTIME, &amp;when);<br>        when.tv_sec += <span class="hljs-number">10</span>;<br>        timeout(&amp;when, retry, (<span class="hljs-type">void</span> *)((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)arg));<br>    &#125;<br><br>    pthread_mutex_unlock(&amp;mutex);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="读写锁属性"><a href="#读写锁属性" class="headerlink" title="读写锁属性"></a>读写锁属性</h3><p><strong>读写锁属性初始化</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_rwlockattr_init</span><span class="hljs-params">(<span class="hljs-type">pthread_rwlockattr_t</span> *attr)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_rwlockattr_destroy</span><span class="hljs-params">(<span class="hljs-type">pthread_rwlockattr_t</span> *attr)</span>;<br>												<span class="hljs-comment">//Both return:0 if OK, error number on failure</span><br></code></pre></td></tr></table></figure>

<p><strong>获取读写锁共享属性</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_rwlockattr_getpshared</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">pthread_rwlockattr_t</span> *</span><br><span class="hljs-params">                                 <span class="hljs-keyword">restrict</span> attr,</span><br><span class="hljs-params">                                 <span class="hljs-type">int</span> *<span class="hljs-keyword">restrict</span> pshared)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_rwlockattr_setpshared</span><span class="hljs-params">(<span class="hljs-type">pthread_rwlockattr_t</span> *attr,</span><br><span class="hljs-params">                                 <span class="hljs-type">int</span> pshared)</span>;<br>								<span class="hljs-comment">//Both return:0 if OK, error number on failure</span><br></code></pre></td></tr></table></figure>

<h2 id="状态变量属性"><a href="#状态变量属性" class="headerlink" title="状态变量属性"></a>状态变量属性</h2><p><strong>状态变量属性初始化</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_condattr_init</span><span class="hljs-params">(<span class="hljs-type">pthread_condattr_t</span> *attr)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_condattr_destroy</span><span class="hljs-params">(<span class="hljs-type">pthread_condattr_t</span> *attr)</span>;<br>							<span class="hljs-comment">//Both return:0 if OK, error number on failure</span><br></code></pre></td></tr></table></figure>

<p><strong>共享属性</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_condattr_getpshared</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">pthread_condattr_t</span> *</span><br><span class="hljs-params">                               <span class="hljs-keyword">restrict</span> attr,</span><br><span class="hljs-params">                               <span class="hljs-type">int</span> *<span class="hljs-keyword">restrict</span> pshared)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_condattr_setpshared</span><span class="hljs-params">(<span class="hljs-type">pthread_condattr_t</span> *attr,</span><br><span class="hljs-params">                               <span class="hljs-type">int</span> pshared)</span>;<br>							<span class="hljs-comment">// Both return:0 if OK, error number on failure</span><br></code></pre></td></tr></table></figure>

<p><strong>获取时钟</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_condattr_getclock</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">pthread_condattr_t</span> *</span><br><span class="hljs-params">                             <span class="hljs-keyword">restrict</span> attr,</span><br><span class="hljs-params">                             <span class="hljs-type">clockid_t</span> *<span class="hljs-keyword">restrict</span> clock_id)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_condattr_setclock</span><span class="hljs-params">(<span class="hljs-type">pthread_condattr_t</span> *attr,</span><br><span class="hljs-params">                             <span class="hljs-type">clockid_t</span> clock_id)</span>;<br>							<span class="hljs-comment">//Both return:0 if OK, error number on failure</span><br></code></pre></td></tr></table></figure>

<h2 id="围栏属性"><a href="#围栏属性" class="headerlink" title="围栏属性"></a>围栏属性</h2><p><strong>初始化属性</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_barrierattr_init</span><span class="hljs-params">(<span class="hljs-type">pthread_barrierattr_t</span> *attr)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_barrierattr_destroy</span><span class="hljs-params">(<span class="hljs-type">pthread_barrierattr_t</span> *attr)</span>;<br>							<span class="hljs-comment">//Both return:0 if OK, error number on failure</span><br></code></pre></td></tr></table></figure>

<p><strong>获取共享属性</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_barrierattr_getpshared</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">pthread_barrierattr_t</span> *</span><br><span class="hljs-params">                                  <span class="hljs-keyword">restrict</span> aattr,</span><br><span class="hljs-params">                                  <span class="hljs-type">int</span> *reestrict pshared)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_barrierattr_setpshared</span><span class="hljs-params">(<span class="hljs-type">pthread_barrierattr_t</span> *attr,</span><br><span class="hljs-params">                                  <span class="hljs-type">int</span> pshared)</span>;<br>								<span class="hljs-comment">//Both return:0 if OK,error number on failure</span><br></code></pre></td></tr></table></figure>

<h2 id="flockfile和ftrylockfile"><a href="#flockfile和ftrylockfile" class="headerlink" title="flockfile和ftrylockfile"></a>flockfile和ftrylockfile</h2><p>线程安全方式管理<code>FILE</code>对象的方法，<code>flockfile</code>和<code>ftrylockfile</code>用于获取与给定<code>FILE</code>对象关联的锁</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">ftrylockfile</span><span class="hljs-params">(FILE *fp)</span>;<br>							<span class="hljs-comment">//Returns:0 if OK, nonzero if lock can&#x27;t be acquired</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">flockfile</span><span class="hljs-params">(FILE *fp)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">funlockfile</span><span class="hljs-params">(FILE *fp)</span>;<br></code></pre></td></tr></table></figure>

<h2 id="字符锁"><a href="#字符锁" class="headerlink" title="字符锁"></a>字符锁</h2><p>基于字符的标准<code>I/O</code>例程的锁</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">getchar_unlocked</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">getc_unlocked</span><span class="hljs-params">(FIILE *fp)</span>;<br>							<span class="hljs-comment">//Both return:the next character if OK,EOF on end of file or error</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">putchar_unlocked</span><span class="hljs-params">(<span class="hljs-type">int</span> c)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">putc_unlocked</span><span class="hljs-params">(<span class="hljs-type">int</span> c, FILE *fp)</span>;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-type">char</span> **environ;<br><span class="hljs-type">pthread_mutex_t</span> env_mutex;<br><span class="hljs-type">static</span> <span class="hljs-type">phtread_once_t</span> init_done = PTHREAD_ONCE_INIT;<br><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <br><span class="hljs-title function_">thread_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">pthread_mutexattr_t</span> attr;<br>    pthread_mutexattr_init(&amp;attr);<br>    pthread_mutexattr_settype(&amp;attr, PTHREAD_MUTEX_RECURSIVE); <span class="hljs-comment">//可以反复加锁</span><br>    pthread_mutex_init(&amp;env_mutex, &amp;attr);<br>    pthread_mutexattr_destroy(&amp;attr);<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">getenv_r</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">char</span> *buf, <span class="hljs-type">int</span> buflen)</span><br>&#123;<br>    <span class="hljs-type">int</span> i, len, olen;<br>    pthread_once(&amp;init_done, thread_init); <span class="hljs-comment">//只执行一次</span><br>    len = <span class="hljs-built_in">strlen</span>(name);<br>    pthread_mutex_lock(&amp;env_mutex);<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; environ[i] = <span class="hljs-literal">NULL</span>; i++)&#123;<br>        <span class="hljs-keyword">if</span> ((<span class="hljs-built_in">strncmp</span>(name, environ[i], len) == <span class="hljs-number">0</span>) &amp;&amp;<br>        (environ[i][len] == <span class="hljs-string">&#x27;=&#x27;</span>))&#123;<br>            olen = <span class="hljs-built_in">strlen</span>(&amp;environ[i][len+<span class="hljs-number">1</span>]);<br>            <span class="hljs-keyword">if</span> (olen &gt;= buflen)&#123;<br>                pthread_mutex_unlock(&amp;env_mutex);<br>                <span class="hljs-keyword">return</span>(ENOSPC);<br>            &#125;<br>            <span class="hljs-built_in">strcpy</span>(buf, &amp;environ[i][len+<span class="hljs-number">1</span>]);<br>            pthread_mutex_unlock(&amp;env_mutex);<br>            <span class="hljs-keyword">return</span>(<span class="hljs-number">0</span>);<br>        &#125;<br>    &#125;<br>    pthread_mutex_unlock(&amp;env_mutex);<br>    <span class="hljs-keyword">return</span>(ENOENT);<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="线程特定数据"><a href="#线程特定数据" class="headerlink" title="线程特定数据"></a>线程特定数据</h2><p><strong>创建数据关联的键</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_key_create</span><span class="hljs-params">(<span class="hljs-type">pthread_key_t</span> *keyp, <span class="hljs-type">void</span> (*destructor)(<span class="hljs-type">void</span> *))</span>;<br>					<span class="hljs-comment">//Returns:0 if OK,error number on failure</span><br></code></pre></td></tr></table></figure>

<p><strong>删除键的关联</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_key_delete</span><span class="hljs-params">(<span class="hljs-type">pthread_key_t</span> key)</span>;<br>					<span class="hljs-comment">//Returns:0 if OK,error number on failure</span><br></code></pre></td></tr></table></figure>

<p><strong>一次初始化</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">pthread_once_t</span> initflag = PTHREAD_ONCE_INIT;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_once</span><span class="hljs-params">(<span class="hljs-type">phtread_once_t</span> *initflag, <span class="hljs-type">void</span> (*initfn)(<span class="hljs-type">void</span>))</span>;<br></code></pre></td></tr></table></figure>

<p><strong>特定数据与键关联</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">void</span> *<span class="hljs-title function_">pthread_getspecific</span><span class="hljs-params">(<span class="hljs-type">pthread_key_t</span> key)</span>;<br>					Returns:thread-specific data value or <span class="hljs-literal">NULL</span> <span class="hljs-keyword">if</span> no value has benn associated with the key<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_setspecific</span><span class="hljs-params">(<span class="hljs-type">pthread_key_t</span> key, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *value)</span>;<br>					Returns:<span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK,error nnumber on failure<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;limits.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAXSTRINGSZ 4096</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">pthread_key_t</span> key;<br><span class="hljs-type">static</span> <span class="hljs-type">pthread_once_t</span> init_done = PTHREAD_ONCE_INIT;<br><span class="hljs-type">pthread_mutex_t</span> env_mutex = PTHREAD_MUTEX_INITIALIZER;<br><br><span class="hljs-keyword">extern</span> <span class="hljs-type">char</span> **environ;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">thread_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    pthread_key_create(&amp;key, <span class="hljs-built_in">free</span>);<br>&#125;<br><br><span class="hljs-type">char</span> *<br><span class="hljs-title function_">getenv</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span><br>&#123;<br>    <span class="hljs-type">int</span> i, len;<br>    <span class="hljs-type">char</span> *envbuf;<br><br>    pthread_once(&amp;init_done, thread_init);<br>    pthread_mutex_lock(&amp;env_mutex);<br>    envbuf = (<span class="hljs-type">char</span> *)pthread_getspecific(key);<br>    <span class="hljs-keyword">if</span> (envbuf == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        envbuf = <span class="hljs-built_in">malloc</span>(MAXSTRINGSZ);<br>        <span class="hljs-keyword">if</span> (envbuf == <span class="hljs-literal">NULL</span>)&#123;<br>            pthread_mutex_unlock(&amp;env_mutex);<br>            <span class="hljs-keyword">return</span>(<span class="hljs-literal">NULL</span>);<br>        &#125;<br>        pthread_setspecific(key, envbuf);<br>    &#125;<br>    len = <span class="hljs-built_in">strlen</span>(name);<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; environ[i] != <span class="hljs-literal">NULL</span>; i++)&#123;<br>        <span class="hljs-keyword">if</span> ((<span class="hljs-built_in">strncmp</span>(name, environ[i], len) == <span class="hljs-number">0</span>) &amp;&amp;<br>        (environ[i][len] == <span class="hljs-string">&#x27;=&#x27;</span>))&#123;<br>            <span class="hljs-built_in">strncpy</span>(envbuf, &amp;environ[i][len+<span class="hljs-number">1</span>], MAXSTRINGSZ<span class="hljs-number">-1</span>);<br>            pthread_mutex_unlock(&amp;env_mutex);<br>            <span class="hljs-keyword">return</span>(envbuf);<br>        &#125;<br>    &#125;<br>    pthread_mutex_unlock(&amp;env_mutex);<br>    <span class="hljs-keyword">return</span>(<span class="hljs-literal">NULL</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="取消选项"><a href="#取消选项" class="headerlink" title="取消选项"></a>取消选项</h2><p><code>pthread_attr_t</code>结构中不包含两个线程属性，需要通过<code>pthread_cancel</code>函数进行设置</p>
<ul>
<li>可取消状态<ul>
<li><code>PTHREAD_CANCEL_ENABLE</code></li>
<li><code>PTHREAD_CANCEL_DISABLE</code></li>
</ul>
</li>
<li>可取消类型</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_setcancelstate</span><span class="hljs-params">(<span class="hljs-type">int</span> state, <span class="hljs-type">int</span> *oldstate)</span>;<br>		<span class="hljs-comment">//Returns:0 if OK, error number on failure</span><br></code></pre></td></tr></table></figure>

<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230116002822460.png" srcset="/img/loading.gif" lazyload alt="image-20230116002822460"></p>
<h3 id="设置取消点"><a href="#设置取消点" class="headerlink" title="设置取消点"></a>设置取消点</h3><p>自定义取消点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">void</span> <span class="hljs-title function_">pthread_testcancel</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br></code></pre></td></tr></table></figure>

<h3 id="设置取消类型"><a href="#设置取消类型" class="headerlink" title="设置取消类型"></a>设置取消类型</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_setcanceltype</span><span class="hljs-params">(<span class="hljs-type">int</span> type, <span class="hljs-type">int</span> *oldtype)</span>;<br>		<span class="hljs-comment">//Returns:0 if OK, error number on failure</span><br></code></pre></td></tr></table></figure>

<h2 id="线程与信号"><a href="#线程与信号" class="headerlink" title="线程与信号"></a>线程与信号</h2><p><strong>修改进程的信号阻塞行为</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_sigmask</span><span class="hljs-params">(<span class="hljs-type">int</span> how, <span class="hljs-type">const</span> <span class="hljs-type">sigset_t</span> *<span class="hljs-keyword">restrict</span> <span class="hljs-built_in">set</span>, <span class="hljs-type">sigset_t</span> *<span class="hljs-keyword">restrict</span> oset)</span>;<br>			<span class="hljs-comment">//Returns:0 if OK,error number on failure</span><br></code></pre></td></tr></table></figure>

<p><strong>等待信号</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">sigwait</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">sigset_t</span> *<span class="hljs-keyword">restrict</span> <span class="hljs-built_in">set</span>, <span class="hljs-type">int</span> *<span class="hljs-keyword">restrict</span> signop)</span>;<br>			<span class="hljs-comment">//Returns:0 if OK,error number on failure</span><br></code></pre></td></tr></table></figure>

<p><strong>发送信号</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_kill</span><span class="hljs-params">(<span class="hljs-type">pthread_t</span> thread, <span class="hljs-type">int</span> signo)</span>;<br>			<span class="hljs-comment">//Returns:0 if OK, error number on failure</span><br></code></pre></td></tr></table></figure>

<h2 id="线程与fork"><a href="#线程与fork" class="headerlink" title="线程与fork"></a>线程与fork</h2><p>线程的<code>fork</code>函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_atfork</span><span class="hljs-params">(<span class="hljs-type">void</span> (*prepare)(<span class="hljs-type">void</span>), <span class="hljs-type">void</span> (*parent)(<span class="hljs-type">void</span>), <span class="hljs-type">void</span>(*child)(<span class="hljs-type">void</span>))</span>;<br><span class="hljs-comment">//Returns:0 if OK,error number on failure</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>prepare</code>：获取父级定义的所有锁</li>
<li><code>parent</code>：在父进程中，解锁<code>preparefork</code>获取的锁</li>
<li><code>child</code>：在子进程中，解锁<code>prepparefork</code>获取的锁</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">pthread_mutex_t</span> lock1 = PTHREAD_MUTEX_INITIALIZER;<br><span class="hljs-type">pthread_mutex_t</span> lock2 = PTHREAD_MUTEX_INITIALIZER;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">prepare</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> err;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;preparing locks...\n&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> ((err = pthread_mutex_lock(&amp;lock1)) != <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t lock lock1 in prepare handler&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> ((err = pthread_mutex_lock(&amp;lock2)) != <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t lock lock2 in prepare handler&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <br>&#125;<br><br><span class="hljs-type">void</span> <br><span class="hljs-title function_">parent</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> err;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;parent unlocking locks...\n&quot;</span>);<br>    <span class="hljs-keyword">if</span> ((err = pthread_mutex_unlock(&amp;lock1)) != <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;can&#x27;t unlock lock1 in parent handler&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> ((err = pthread_mutex_unlock(&amp;lock2)) != <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;can&#x27;t unlock lock2 in parent handler&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">child</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> err;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;child unlocking locks...\n&quot;</span>);<br>    <span class="hljs-keyword">if</span> ((err = pthread_mutex_unlock(&amp;lock1)) != <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t unlock lock1 in child handler&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> ((err = pthread_mutex_unlock(&amp;lock2)) != <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t unlock lock2 in child handler&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> *<br><span class="hljs-title function_">thr_fn</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;thread started...\n&quot;</span>);<br>    pause();<br>    <span class="hljs-keyword">return</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>    <span class="hljs-type">int</span> err;<br>    <span class="hljs-type">pid_t</span> pid;<br>    <span class="hljs-type">pthread_t</span> tid;<br><br>    <span class="hljs-keyword">if</span> ((err = pthread_atfork(prepare, parent, child)) != <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t install fork handlers&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> ((err = pthread_create(&amp;tid, <span class="hljs-literal">NULL</span>, thr_fn, <span class="hljs-number">0</span>)) != <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t create thread&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    sleep(<span class="hljs-number">2</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;parent about to fork...\n&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> ((pid = fork()) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;fork failed&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;child returned from fork\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;parent returned from fork\n&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230117001028533.png" srcset="/img/loading.gif" lazyload alt="image-20230117001028533"></p>
<h2 id="线程与I-x2F-O"><a href="#线程与I-x2F-O" class="headerlink" title="线程与I&#x2F;O"></a>线程与I&#x2F;O</h2><p><strong>pread与pwrite</strong>用于处理线程间读写</p>
<h1 id="守护进程"><a href="#守护进程" class="headerlink" title="守护进程"></a>守护进程</h1><p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230118235450382.png" srcset="/img/loading.gif" lazyload alt="image-20230118235450382"></p>
<p><strong>读取日志信息的函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;syslog.h&gt;</span></span><br><span class="hljs-type">void</span> <span class="hljs-title function_">openlog</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *ident, <span class="hljs-type">int</span> option, <span class="hljs-type">int</span> facility)</span>; <span class="hljs-comment">//打开日志文件</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	ident:通常为添加到日志文件中的程序名</span><br><span class="hljs-comment">	option:用于指定各种选项的掩码</span><br><span class="hljs-comment">	facility:用途</span><br><span class="hljs-comment">	</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">syslog</span><span class="hljs-params">(<span class="hljs-type">int</span> priority, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *format, ...)</span>;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	priority:优先级</span><br><span class="hljs-comment">	format:格式化字符串参数	</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">closelog</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>; <span class="hljs-comment">//关闭用于与syslogd守护进程通信的描述符</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">setlogmask</span><span class="hljs-params">(<span class="hljs-type">int</span> maskpri)</span>; <span class="hljs-comment">//设置进程的日志优先级掩码</span><br>																		<span class="hljs-comment">//Returns:previous log priority mask value</span><br></code></pre></td></tr></table></figure>

<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230129204719364.png" srcset="/img/loading.gif" lazyload alt="image-20230129204719364"></p>
<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230129205516099.png" srcset="/img/loading.gif" lazyload alt="image-20230129205516099"></p>
<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230129205535605.png" srcset="/img/loading.gif" lazyload alt="image-20230129205535605"></p>
<p><strong>自定义的日志打印函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;syslog.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdarg.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">vsyslog</span><span class="hljs-params">(<span class="hljs-type">int</span> priority, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *format, va_list arg)</span>;<br></code></pre></td></tr></table></figure>

<h2 id="单独实例守护进程"><a href="#单独实例守护进程" class="headerlink" title="单独实例守护进程"></a>单独实例守护进程</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;syslog.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOCKFILE <span class="hljs-string">&quot;/var/run/daemon.pid&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOCKMODE (S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH)</span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-type">int</span> <span class="hljs-title function_">lockfile</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span>;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">already_running</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> fd;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">16</span>];<br>    fd = open(LOCKFILE, O_RDWR | O_CREAT, LOCKMODE);<br>    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>)&#123;<br>        syslog(LOG_ERR, <span class="hljs-string">&quot;can&#x27;t open %s: %s&quot;</span>, LOCKFILE, strerror(errno));<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (lockfile(fd) &lt; <span class="hljs-number">0</span>)&#123; <span class="hljs-comment">//锁定文件</span><br>        <span class="hljs-keyword">if</span> (errno == EACCES || errno == EAGAIN)&#123;<br>            close(fd);<br>            <span class="hljs-keyword">return</span>(<span class="hljs-number">1</span>);<br>        &#125;<br>        syslog(LOG_ERR,<span class="hljs-string">&quot;can&#x27;t lock %s: %s&quot;</span>, LOCKFILE, strerror(errno));<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    ftruncate(fd, <span class="hljs-number">0</span>); <span class="hljs-comment">//截断文件</span><br>    <span class="hljs-built_in">sprintf</span>(buf, <span class="hljs-string">&quot;%ld&quot;</span>, (<span class="hljs-type">long</span>)getpid());<br>    write(fd, buf, <span class="hljs-built_in">strlen</span>(buf)+<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">return</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>守护进程重读配置文件</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;syslog.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">sigset_t</span> mask;<br><br><span class="hljs-keyword">extern</span> <span class="hljs-type">int</span> <span class="hljs-title function_">already_runniing</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">reread</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><br>&#125;<br><br><span class="hljs-type">void</span> *<br><span class="hljs-title function_">thr_fn</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    <span class="hljs-type">int</span> err, signo;<br>    <span class="hljs-keyword">for</span> (;;)&#123;<br>        err = sigwait(&amp;mask, &amp;signo); <span class="hljs-comment">//等到信号</span><br>        <span class="hljs-keyword">if</span> (err != <span class="hljs-number">0</span>)&#123;<br>            syslog(LOG_ERR, <span class="hljs-string">&quot;sigwait failed&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>        &#125;<br>        <span class="hljs-keyword">switch</span> (signo)<br>        &#123;<br>        <span class="hljs-keyword">case</span> SIGHUP:<br>            syslog(LOG_INFO, <span class="hljs-string">&quot;Re-reading configuration file&quot;</span>);<br>            reread();<br>            <span class="hljs-comment">/* code */</span><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> SIGTERM:<br>            syslog(LOG_INFO, <span class="hljs-string">&quot;got SIGTERM; exiting&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">default</span>:<br>            syslog(LOG_INFO, <span class="hljs-string">&quot;unexpected signal %d\n&quot;</span>, signo);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>    <span class="hljs-type">int</span> err;<br>    <span class="hljs-type">pthread_t</span> tid;<br>    <span class="hljs-type">char</span> *cmd;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigaction</span> <span class="hljs-title">sa</span>;</span><br><br>    <span class="hljs-keyword">if</span> ((cmd = <span class="hljs-built_in">strrchr</span>(argv[<span class="hljs-number">0</span>], <span class="hljs-string">&#x27;/&#x27;</span>) == <span class="hljs-literal">NULL</span>))<br>        cmd = argv[<span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">else</span><br>        cmd++;<br>    daemonize(cmd);<br>    <span class="hljs-keyword">if</span> (already_runniing())&#123;<br>        syslog(LOG_ERR, <span class="hljs-string">&quot;daemon already running&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    sa.sa_handler = SIG_DFL;<br>    sigemptyset(&amp;sa.sa_mask);<br>    sa.sa_flags = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (sigaction(SIGHUP, &amp;sa, <span class="hljs-literal">NULL</span>) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t restore SIGHUP default&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    sigfillset(&amp;mask);<br>    <span class="hljs-keyword">if</span> ((err = pthread_sigmask(SIG_BLOCK, &amp;mask, <span class="hljs-literal">NULL</span>)) != <span class="hljs-number">0</span>) <span class="hljs-comment">//阻塞所有信号</span><br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;SIG_BLOCK error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    err = pthread_create(&amp;tid, <span class="hljs-literal">NULL</span>, thr_fn, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (err != <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;can&#x27;t create thread&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">set_cloexec</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-type">int</span> val;<br><br>    <span class="hljs-keyword">if</span> ((val = fcntl(fd, F_GETFD, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    val |= FD_CLOEXEC; <span class="hljs-comment">//使用exec执行时，关闭该文件描述符</span><br><br>    <span class="hljs-keyword">return</span>(fcntl(fd, F_SETFD,val));<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="高级I-x2F-O"><a href="#高级I-x2F-O" class="headerlink" title="高级I&#x2F;O"></a>高级I&#x2F;O</h1><h2 id="非阻塞I-x2F-O"><a href="#非阻塞I-x2F-O" class="headerlink" title="非阻塞I&#x2F;O"></a>非阻塞I&#x2F;O</h2><ul>
<li>调用<code>open</code>函数时使用<code>O_NONBLOCK</code>标志</li>
<li>对于已经打开的文件，可以使用<code>fcntl</code>函数打开<code>O_NONBLOCK</code>标志</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">char</span> buf[<span class="hljs-number">500000</span>];<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> ntowrite, nwrite;<br>    <span class="hljs-type">char</span> *ptr;<br><br>    ntowrite = read(STDIN_FILENO, buf, <span class="hljs-keyword">sizeof</span>(buf));<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;read %d bytes\n&quot;</span>, ntowrite);<br><br>    set_fl(STDOUT_FILENO, O_NONBLOCK);<br><br>    ptr = buf;<br>    <span class="hljs-keyword">while</span> (ntowrite &gt; <span class="hljs-number">0</span>)&#123;<br>        errno = <span class="hljs-number">0</span>;<br>        nwrite = write(STDOUT_FILENO, ptr, ntowrite);<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;nwrite = %d, errno = %d\n&quot;</span>, nwrite, errno);<br><br>        <span class="hljs-keyword">if</span> (nwrite &gt; <span class="hljs-number">0</span>)&#123;<br>            ptr += nwrite;<br>            ntowrite -= nwrite;<br>        &#125;<br>    &#125;<br><br>    clr_fl(STDERR_FILENO, O_NONBLOCK);<br><br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="记录锁"><a href="#记录锁" class="headerlink" title="记录锁"></a>记录锁</h2><p><strong>fcntl Record Locking</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fcntl</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">int</span> cmd, ... <span class="hljs-comment">/*struct flock *flockptr*/</span>)</span><br>    			Returns:depends on cmd <span class="hljs-keyword">if</span> <span class="hljs-title function_">OK</span><span class="hljs-params">(see follwing)</span>, -1 on error<br></code></pre></td></tr></table></figure>

<p>对于记录锁，<code>cmd</code>的取值为：<code>F_GETLK</code>、<code>F_SETLK</code>或<code>F_SETLKW</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">flock</span> &#123;</span><br>    <span class="hljs-type">short</span> l_type;<span class="hljs-comment">/*F_RDLCK:分享读锁, F_WRLCK:独占写锁, or F_UNLCK:解锁区域*/</span><br>    <span class="hljs-type">short</span> l_whence;<span class="hljs-comment">/*SEEK_SET, SEEK_CUR, or SEEK_END*/</span><br>    <span class="hljs-type">off_t</span> l_start;<span class="hljs-comment">/*offset in bytes, relative to l_whence*/</span><br>    <span class="hljs-type">off_t</span> l_len;<span class="hljs-comment">/*length, in bytes; 0 means lock to EOF*/</span><br>    <span class="hljs-type">pid_t</span> l_pid;<span class="hljs-comment">/*returned with F_GETLK*/</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230131132819912.png" srcset="/img/loading.gif" lazyload alt="image-20230131132819912"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">#define read_lock(fd, offset, whence, len) \</span><br><span class="hljs-comment">lock_reg((fd), F_SETLK, F_RDLCK, (offset), (whence), (len))</span><br><span class="hljs-comment">#define readw_lock(fd, offset, whence, len) \</span><br><span class="hljs-comment">lock_reg((fd), F_SETLKW, F_RDLCK, (offset), (whence), (len))</span><br><span class="hljs-comment">#define write_lock(fd, offset, whence, len) \</span><br><span class="hljs-comment">lock_reg((fd), F_SETLK, F_WRLCK, (offset), (whence), (len))</span><br><span class="hljs-comment">#define writew_lock(fd, offset, whence, len) \</span><br><span class="hljs-comment">lock_reg((fd), F_SETLKW, F_WRLCK, (offset), (whence), (len))</span><br><span class="hljs-comment">#define un_lock(fd, offset, whence, len) \</span><br><span class="hljs-comment">lock_reg((fd), F_SETLK, F_UNLCK, (offset), (whence), (len))</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">lock_reg</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">int</span> cmd, <span class="hljs-type">int</span> type, <span class="hljs-type">off_t</span> offset, <span class="hljs-type">int</span> whence, <span class="hljs-type">off_t</span> len)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">flock</span> <span class="hljs-title">lock</span>;</span><br><br>    lock.l_type = type;<br>    lock.l_start = offset;<br>    lock.l_whence = whence;<br>    lock.l_len = len;<br><br>    <span class="hljs-keyword">return</span>(fcntl(fd, cmd, &amp;lock));<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">#define is_read_lockable(fd, offset, whence, len) \</span><br><span class="hljs-comment">(lock_test((fd), F_RDLCK, (offset), (whence), (len)) == 0)</span><br><span class="hljs-comment">#define is_write_lockable(fd, offset, whence, len) \</span><br><span class="hljs-comment">(lock_test((fd), F_WRLCK, (offset), (whence), (len)) == 0)</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">pid_t</span><br><span class="hljs-title function_">lock_test</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">int</span> type, <span class="hljs-type">off_t</span> offset, <span class="hljs-type">int</span> whence, <span class="hljs-type">off_t</span> len)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">flock</span> <span class="hljs-title">lock</span>;</span><br>    lock.l_type = type;<br>    lock.l_start = offset;<br>    lock.l_whence = whence;<br>    lock.l_len = len;<br><br>    <span class="hljs-keyword">if</span> (fcntl(fd, F_GETLK, &amp;lock) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//申请锁</span><br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;fcntl error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (lock.l_type == F_UNLCK)<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">return</span>(lock.l_pid);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;apue.h&quot;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">lockabyte</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">int</span> fd, <span class="hljs-type">off_t</span> offset)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (writew_lock(fd, offset, SEEK_SET, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%s: writew_lock error&quot;</span>, name);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s: got the lock, byte %lld\n&quot;</span>,name, (<span class="hljs-type">long</span> <span class="hljs-type">long</span>)offset);<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> fd;<br>    <span class="hljs-type">pid_t</span> pid;<br><br>    <span class="hljs-keyword">if</span> ((fd = creat(<span class="hljs-string">&quot;templock&quot;</span>, FILE_MODE)) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//创建一个名为templock的文件</span><br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;creat error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (write(fd, <span class="hljs-string">&quot;ab&quot;</span>, <span class="hljs-number">2</span>) != <span class="hljs-number">2</span>) <span class="hljs-comment">//往文件里写入ab</span><br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;write error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    TELL_WAIT();<br><br>    <span class="hljs-keyword">if</span>((pid = fork()) &lt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;fork error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>)&#123;<br>        lockabyte(<span class="hljs-string">&quot;child&quot;</span>, fd, <span class="hljs-number">0</span>); <span class="hljs-comment">//加锁</span><br>        TELL_PARENT(getppid());<br>        WAIT_PARENT();<br>        lockabyte(<span class="hljs-string">&quot;child&quot;</span>, fd, <span class="hljs-number">1</span>);<br>    &#125;<span class="hljs-keyword">else</span> &#123;<br>        lockabyte(<span class="hljs-string">&quot;parent&quot;</span>, fd, <span class="hljs-number">1</span>);<br>        TELL_CHILD(pid);<br>        WAIT_CHILD();<br>        lockabyte(<span class="hljs-string">&quot;parent&quot;</span>, fd, <span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-type">int</span> <br><span class="hljs-title function_">lockfile</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span>  <span class="hljs-title">flock</span> <span class="hljs-title">fl</span>;</span><br>    fl.l_type = F_WRLCK;<br>    fl.l_start = <span class="hljs-number">0</span>;<br>    fl.l_whence = SEEK_SET;<br>    fl.l_len = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">return</span>(fcntl(fd, F_SETLK, &amp;fl));<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="强制锁"><a href="#强制锁" class="headerlink" title="强制锁"></a>强制锁</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>	FILE_MODE	(S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGHUP		 1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGINT		 2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGQUIT		 3</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGILL		 4</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGTRAP		 5</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGABRT		 6</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGIOT		 6</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGBUS		 7</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGFPE		 8</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGKILL		 9</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGUSR1		10</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGSEGV		11</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGUSR2		12</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGPIPE		13</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGALRM		14</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGTERM		15</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGSTKFLT	16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGCHLD		17</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGCONT		18</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGSTOP		19</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGTSTP		20</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGTTIN		21</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGTTOU		22</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGURG		23</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGXCPU		24</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGXFSZ		25</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGVTALRM	26</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGPROF		27</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGWINCH	28</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIGIO		29</span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> read_lock(fd, offset, whence, len) \</span><br><span class="hljs-meta">lock_reg((fd), F_SETLK, F_RDLCK, (offset), (whence), (len))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> readw_lock(fd, offset, whence, len) \</span><br><span class="hljs-meta">lock_reg((fd), F_SETLKW, F_RDLCK, (offset), (whence), (len))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> write_lock(fd, offset, whence, len) \</span><br><span class="hljs-meta">lock_reg((fd), F_SETLK, F_WRLCK, (offset), (whence), (len))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> writew_lock(fd, offset, whence, len) \</span><br><span class="hljs-meta">lock_reg((fd), F_SETLKW, F_WRLCK, (offset), (whence), (len))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> un_lock(fd, offset, whence, len) \</span><br><span class="hljs-meta">lock_reg((fd), F_SETLK, F_UNLCK, (offset), (whence), (len))</span><br><br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">lock_reg</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">int</span> cmd, <span class="hljs-type">int</span> type, <span class="hljs-type">off_t</span> offset, <span class="hljs-type">int</span> whence, <span class="hljs-type">off_t</span> len)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">flock</span> <span class="hljs-title">lock</span>;</span><br><br>    lock.l_type = type;<br>    lock.l_start = offset;<br>    lock.l_whence = whence;<br>    lock.l_len = len;<br><br>    <span class="hljs-keyword">return</span>(fcntl(fd, cmd, &amp;lock));<br>&#125;<br><br><br><br><br><span class="hljs-type">static</span> <span class="hljs-type">sigset_t</span> newmask, oldmask, zeromask;<br><span class="hljs-type">static</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">sig_atomic_t</span> sigflag;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">sig_usr</span><span class="hljs-params">(<span class="hljs-type">int</span> signo)</span>	<span class="hljs-comment">/* one signal handler for SIGUSR1 and SIGUSR2 */</span><br>&#123;<br>	sigflag = <span class="hljs-number">1</span>;<br>&#125;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">TELL_WAIT</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-keyword">if</span> (signal(SIGUSR1, sig_usr) == SIG_ERR)<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;signal(SIGUSR1) error&quot;</span>);<br>	<span class="hljs-keyword">if</span> (signal(SIGUSR2, sig_usr) == SIG_ERR)<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;signal(SIGUSR2) error&quot;</span>);<br>	sigemptyset(&amp;zeromask);<br>	sigemptyset(&amp;newmask);<br>	sigaddset(&amp;newmask, SIGUSR1);<br>	sigaddset(&amp;newmask, SIGUSR2);<br><br>	<span class="hljs-comment">/* Block SIGUSR1 and SIGUSR2, and save current signal mask */</span><br>	<span class="hljs-keyword">if</span> (sigprocmask(SIG_BLOCK, &amp;newmask, &amp;oldmask) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//阻塞SIGUSR1和SIGUSR2</span><br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;SIG_BLOCK error&quot;</span>);<br>&#125;<br><br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">TELL_PARENT</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> pid)</span><br>&#123;<br>	kill(pid, SIGUSR2);		<span class="hljs-comment">/* tell parent we&#x27;re done */</span><br>&#125;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">WAIT_PARENT</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-keyword">while</span> (sigflag == <span class="hljs-number">0</span>)<br>		sigsuspend(&amp;zeromask);	<span class="hljs-comment">/* and wait for parent */</span> <span class="hljs-comment">//清空阻塞，接收信号</span><br>	sigflag = <span class="hljs-number">0</span>;<br><br>	<span class="hljs-comment">/* Reset signal mask to original value */</span><br>	<span class="hljs-keyword">if</span> (sigprocmask(SIG_SETMASK, &amp;oldmask, <span class="hljs-literal">NULL</span>) &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;SIG_SETMASK error&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">TELL_CHILD</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> pid)</span><br>&#123;<br>	kill(pid, SIGUSR1);			<span class="hljs-comment">/* tell child we&#x27;re done */</span><br>&#125;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">WAIT_CHILD</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-keyword">while</span> (sigflag == <span class="hljs-number">0</span>)<br>		sigsuspend(&amp;zeromask);	<span class="hljs-comment">/* and wait for child */</span><br>	sigflag = <span class="hljs-number">0</span>;<br><br>	<span class="hljs-comment">/* Reset signal mask to original value */</span><br>	<span class="hljs-keyword">if</span> (sigprocmask(SIG_SETMASK, &amp;oldmask, <span class="hljs-literal">NULL</span>) &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;SIG_SETMASK error&quot;</span>);<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_fl</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">int</span> flags)</span> <span class="hljs-comment">/* flags are file status flags to turn on */</span><br>&#123;<br>    <span class="hljs-type">int</span>        val;<br><br>    <span class="hljs-keyword">if</span> ( (val = fcntl(fd, F_GETFL, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fcntl F_GETFL error&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>        &#125;<br><br>    val |= flags;        <span class="hljs-comment">/* turn on flags */</span><br><br>    <span class="hljs-keyword">if</span> (fcntl(fd, F_SETFL, val) &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fcntl F_SETFL error&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>        &#125;<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>    <span class="hljs-type">int</span> fd;<br>    <span class="hljs-type">pid_t</span> pid;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">5</span>];    <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">statbuf</span>;</span><br><br>    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">2</span>)&#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;usage: %s filename\n&quot;</span>, argv[<span class="hljs-number">0</span>]);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> ((fd = open(argv[<span class="hljs-number">1</span>], O_RDWR | O_CREAT | O_TRUNC, FILE_MODE)) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;open error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (write(fd, <span class="hljs-string">&quot;abcdef&quot;</span>, <span class="hljs-number">6</span>) != <span class="hljs-number">6</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;write error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (fstat(fd, &amp;statbuf) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;fstat error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-comment">//强制锁定</span><br>    <span class="hljs-keyword">if</span> (fchmod(fd, (statbuf.st_mode &amp; ~S_IXGRP) | S_ISGID) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//删除组执行，将进程的有效组ID设置为文件的组所有者ID</span><br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;fchmod error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    TELL_WAIT();<br><br>    <span class="hljs-keyword">if</span> ((pid = fork()) &lt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;fork error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid &gt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">//父进程</span><br>        <span class="hljs-keyword">if</span> (write_lock(fd, <span class="hljs-number">0</span>, SEEK_SET, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//添加写锁</span><br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;write_lock error&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        TELL_CHILD(pid);<span class="hljs-comment">//唤醒子进程</span><br><br>        <span class="hljs-keyword">if</span>(waitpid(pid, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>)&#123; <span class="hljs-comment">//等待子进程发送信号</span><br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;waitpid error&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        WAIT_PARENT();<span class="hljs-comment">//判断父进程是否有发送下信号</span><br>        set_fl(fd, O_NONBLOCK); <span class="hljs-comment">//将文件修改为不阻塞</span><br>        <span class="hljs-keyword">if</span> (read_lock(fd, <span class="hljs-number">0</span>, SEEK_SET, <span class="hljs-number">0</span>) != <span class="hljs-number">-1</span>) <span class="hljs-comment">//增加读锁</span><br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;child: read_lock succeeded&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;read_lock of already-locked region returns %d\n&quot;</span>,errno);<br><br>        <span class="hljs-keyword">if</span> (lseek(fd, <span class="hljs-number">0</span>, SEEK_SET) == <span class="hljs-number">-1</span>)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;lseek error&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (read(fd, buf, <span class="hljs-number">2</span>) &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;read failed (mandatory locking works)&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;read OK (o mandatory locking), buf = %2.2s\n&quot;</span>,buf);<br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="IO多路复用"><a href="#IO多路复用" class="headerlink" title="IO多路复用"></a>IO多路复用</h2><p>从一个文件描述符中读取数据，并写入到另一个文件描述符中,通过阻塞<code>I/O</code>实现</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">while</span> ((n = read(STDIN_FILENO, buf, BUFSIZE)) &gt; <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">if</span> (write(STDOUT_FILENO, buf, n) != n)<br>        err_sys(<span class="hljs-string">&quot;write error&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>上述实现方法不能应用于从两个文件描述符当中读取数据，因为我们没有办法同时阻塞两个<code>read</code></p>
<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230202223826795.png" srcset="/img/loading.gif" lazyload alt="image-20230202223826795"></p>
<p>使用两个不同进程分别进行读与写能够解决上述情况，但是当父子进程被终止时需要相互使用信号进行通知，会增加程序的复杂性</p>
<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230202224110468.png" srcset="/img/loading.gif" lazyload alt="image-20230202224110468"></p>
<p>使用同个进程两个不同线程进行处理，但是需要同步两个线程之间的信息。</p>
<ul>
<li>轮询：读取文件描述符，若无数据直接返回，等一段时间再进行读取<ul>
<li>缺点：浪费CPU时间</li>
<li>应该避免在多任务系统上进行使用</li>
</ul>
</li>
<li>同步<code>I/O</code>：当从文件描述符通过<code>I/O</code>读取时，内核需要通知用户<ul>
<li>缺点：兼容性不高、单一的信号无法标记所有的文件描述符</li>
</ul>
</li>
<li><code>I/O</code>复用：通过构建描述符列表，并调用一个函数，直到其中一个描述符准备好<code>I/O</code>时才返回</li>
</ul>
<h3 id="select-和-pselect函数"><a href="#select-和-pselect函数" class="headerlink" title="select 和 pselect函数"></a>select 和 pselect函数</h3><p><code>select</code>函数实现<code>I/O</code>复用，参数指明</p>
<ul>
<li>哪个文件描述符我们感兴趣</li>
<li>文件描述符的哪个状态我们感兴趣</li>
<li>我们需要等待多长时间</li>
</ul>
<p><code>return</code></p>
<ul>
<li>总共有多少个文件描述符已就绪</li>
<li>三个条件（读、写和异常）中的每一个都准备好了哪些描述符</li>
</ul>
<p>总的来说，<code>select</code>函数用于获取我们对某个文件描述符感兴趣的状态</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/select.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">select</span><span class="hljs-params">(<span class="hljs-type">int</span> maxfdp1, <span class="hljs-comment">//最大的文件描述符的个数加一，可以设置为FD_SETSIZE，在&lt;sys/select.h&gt;头文件中</span></span><br><span class="hljs-params">           fd_set *<span class="hljs-keyword">restrict</span> readfds, <span class="hljs-comment">//感兴趣的读文件描述符</span></span><br><span class="hljs-params">          fd_set *<span class="hljs-keyword">restrict</span> writefds, <span class="hljs-comment">//感兴趣的写文件描述符</span></span><br><span class="hljs-params">           fd_set *<span class="hljs-keyword">restrict</span> exceptfds, <span class="hljs-comment">//感兴趣的异常的描述符</span></span><br><span class="hljs-params">          <span class="hljs-keyword">struct</span> timeval *restricct tvptr)</span>;<br><br><span class="hljs-comment">//Returns:count of ready deescriptors, 0 on timeout, -1 on error</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>tvptr == NULL</code><ul>
<li>无限制的等待。当描述符就绪以及被信号中断则返回。若被信号中断则<code>select</code>返回<code>-1</code>以及<code>errno</code>被设置为<code>EINTR</code></li>
</ul>
</li>
<li><code>tvptr-&gt;tv_sec == 0 &amp;&amp; tvptr-&gt;tv_usec == 0</code><ul>
<li>不等待。测试所有指定的描述符，并立即返回。</li>
</ul>
</li>
<li><code>tvptr-&gt;tv_sec != 0 || tvptr-&gt;tv_usec != 0</code><ul>
<li>等待指定秒数或毫秒数。当指定的描述符之一就绪或超时返回。</li>
</ul>
</li>
</ul>
<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230202232500872.png" srcset="/img/loading.gif" lazyload alt="image-20230202232500872"></p>
<p><strong>fd_set数据类型的操作</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/select.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">FD_ISSET</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, fd_set *fdset)</span>;<br>									Returns:nonzero <span class="hljs-keyword">if</span> fd is in <span class="hljs-built_in">set</span>,<span class="hljs-number">0</span> otherwise<br><span class="hljs-type">void</span> <span class="hljs-title function_">FD_CLR</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, fd_set *fdset)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">FD_SET</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, fd_set *fdset)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">FD_ZERO</span><span class="hljs-params">(fd_set *fd_set)</span>;<br></code></pre></td></tr></table></figure>

<p><strong>example1</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">fd_set rset;<br><span class="hljs-type">int</span> fd;<br><br>FD_ZERO(&amp;rset);<br>FD_SET(fd, &amp;rset);<br>FD_SET(STDIN_FILENO, &amp;rset);<br><br><span class="hljs-keyword">if</span> (FD_ISSET(fd, &amp;rset))&#123;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>example2</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">fd_set readset, writeset;<br><br>FD_ZERO(&amp;readset);<br>FD_ZERO(&amp;writeset);<br>FD_SET(<span class="hljs-number">0</span>, &amp;readset);<br>FD_SET(<span class="hljs-number">3</span>, &amp;readset);<br>FD_SET(<span class="hljs-number">1</span>, &amp;writeset);<br>FD_SET(<span class="hljs-number">2</span>, &amp;WRITESET);<br>select(<span class="hljs-number">4</span>, &amp;readset, &amp;writeset, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br></code></pre></td></tr></table></figure>

<p>返回值可能的情况</p>
<ul>
<li>返回值为-1意味着错误发生。例如被信号中断</li>
<li>返回值为0，意味着等待超时，此时所有的描述符集会被清空</li>
<li>非负数，意味着对应的描述符已经就绪。该值是三个集合中所有描述符的总和。</li>
</ul>
<p><strong>pselect</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/select.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pselect</span><span class="hljs-params">(<span class="hljs-type">int</span> maxfdp1, </span><br><span class="hljs-params">            fd_set *<span class="hljs-keyword">restrict</span> readfds,</span><br><span class="hljs-params">            fd_set *<span class="hljs-keyword">restrict</span> writefds,</span><br><span class="hljs-params">            fd_set *<span class="hljs-keyword">restrict</span> exceptfds,</span><br><span class="hljs-params">            <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> timespec *<span class="hljs-keyword">restrict</span> tsptr,</span><br><span class="hljs-params">            <span class="hljs-type">const</span> <span class="hljs-type">sigset_t</span> *<span class="hljs-keyword">restrict</span> sigmask)</span>;<br>Returns:count of ready descriptors, <span class="hljs-number">0</span> on timeout, <span class="hljs-number">-1</span> on error<br></code></pre></td></tr></table></figure>

<p><strong>与select区别</strong></p>
<ul>
<li>时间采用<code>timespec</code>结构体，提供了秒与纳米级别的粒度</li>
<li>提供了信号集，可以指定安装对应的信号掩码</li>
</ul>
<h3 id="poll"><a href="#poll" class="headerlink" title="poll"></a>poll</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">poll</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pollfd fdarray[], <span class="hljs-type">nfds_t</span> nfds, <span class="hljs-type">int</span> timeout)</span>;<br>Returns:count of ready descriptors, <span class="hljs-number">0</span> on timeout, <span class="hljs-number">-1</span> on error<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> &#123;</span><br>	<span class="hljs-type">int</span> fd;<br>    <span class="hljs-type">short</span> events;<br>    <span class="hljs-type">short</span> revents;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230203200512981.png" srcset="/img/loading.gif" lazyload alt="image-20230203200512981"></p>
<ul>
<li><code>timeout == -1</code><ul>
<li>一直等待。如果捕获到信号，轮询将返回-1，errno设置为EINTR</li>
</ul>
</li>
<li><code>timeout == 0</code><ul>
<li>不等待。所有描述符都将被测试并且立即返回。这是一种<code>poll</code>找出多个描述符状态的方法，而不会阻塞轮询调用。</li>
</ul>
</li>
<li><code>timeout &gt; 0</code><ul>
<li>等到指定的毫秒数。当指定描述符就绪或者超时则返回。超时时返回0。</li>
</ul>
</li>
</ul>
<h2 id="异步I-x2F-O"><a href="#异步I-x2F-O" class="headerlink" title="异步I&#x2F;O"></a>异步I&#x2F;O</h2><p>异步操作可能产生的错误</p>
<ul>
<li>操作提交相关</li>
<li>操作本身</li>
<li>确定异步状态的函数</li>
</ul>
<h3 id="System-V-异步I-x2F-O"><a href="#System-V-异步I-x2F-O" class="headerlink" title="System V 异步I&#x2F;O"></a>System V 异步I&#x2F;O</h3><p>在流设备与流管道上工作。</p>
<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230203205833011.png" srcset="/img/loading.gif" lazyload alt="image-20230203205833011"></p>
<h3 id="BSD异步I-x2F-O"><a href="#BSD异步I-x2F-O" class="headerlink" title="BSD异步I&#x2F;O"></a>BSD异步I&#x2F;O</h3><p><code>BSD</code>驱动系统需要结合两个信号</p>
<ul>
<li><code>SIGIO</code>：通常为异步信号</li>
<li><code>SIGURG</code>：用于通知进程带外数据已到达网络连接</li>
</ul>
<p>为了接收<code>SIGIO</code>信号，需要执行三个步骤</p>
<ol>
<li>建立基于<code>SIGIO</code>的信号处理函数</li>
<li>设置进程ID或进程组ID为了接收 信号的描述符通过函数<code>fcntl</code>并设置参数<code>F_SETOWN</code></li>
<li>通过<code>fcntl</code>设置<code>O_ASYNC</code>文件状态标志，启用描述符上的异步<code>I/O</code></li>
</ol>
<h3 id="POSIX异步I-x2F-O"><a href="#POSIX异步I-x2F-O" class="headerlink" title="POSIX异步I&#x2F;O"></a>POSIX异步I&#x2F;O</h3><p><code>POSIX</code>的异步<code>I/O</code>接口使用<code>AIO</code>块去描述<code>I/O</code>操作</p>
<p><code>AIO</code>块通过<code>aiocb</code>结构体定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">aiocb</span>&#123;</span><br>    <span class="hljs-type">int</span> aio_fildes; <span class="hljs-comment">//文件描述符</span><br>    <span class="hljs-type">off_t</span> aio_offset; <span class="hljs-comment">//基于I/O的文件偏移</span><br>    <span class="hljs-keyword">volatile</span> <span class="hljs-type">void</span> *aio_buf; <span class="hljs-comment">//I/O buffer</span><br>    <span class="hljs-type">size_t</span> aio_nbytes; <span class="hljs-comment">//需要转换为字节数</span><br>    <span class="hljs-type">int</span> aio_reqprio <span class="hljs-comment">//优先级</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigevent</span> <span class="hljs-title">aio_sigevent</span>;</span> <span class="hljs-comment">//信号的信息   </span><br>    <span class="hljs-type">int</span> aio_lio_opcode; <span class="hljs-comment">//操作列表I/O</span><br>&#125;;<br><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigevent</span>&#123;</span><br>  <span class="hljs-type">int</span> sigev_notify; <span class="hljs-comment">//通知类型</span><br>  <span class="hljs-type">int</span> sigev_signo; <span class="hljs-comment">//信号数字</span><br>  <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">sigval</span> <span class="hljs-title">sigev_value</span>;</span> <span class="hljs-comment">//通知参数</span><br>  <span class="hljs-type">void</span> (*sigev_notify_function)(<span class="hljs-keyword">union</span> sigval); <span class="hljs-comment">//通知函数</span><br>  <span class="hljs-type">pthread_attr_t</span> *sigev_notify_attributes; <span class="hljs-comment">//通知属性</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p><code>sigev_notify</code>类型有三个值可选</p>
<ul>
<li><code>SIGEV_NONE</code>：异步<code>I/O</code>请求完成时不会通知进程</li>
<li><code>SIGEV_SIGNAL</code>：当异步<code>I/O</code>请求完成时，将生成<code>sigev_signo</code>字段指定的信号</li>
<li><code>SIGEV_THREAD</code>：当异步<code>I/O</code>请求完成时，调用<code>sigev_notify_function</code>字段指定的函数。传递<code>sigev_value</code>字段作为其唯一参数。除非<code>sigev_notify_attributes</code>字段设置为<code>pthread</code>属性结构的地址，否则该函数将在分离状态的单独线程中执行</li>
</ul>
<p>在执行异步<code>I/O</code>前，需要初始化<code>AIO</code>控制块，并调用<code>AIO_read</code>函数进行异步读取，或者调用<code>AIO_write</code>函数进行非同步写入</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;aio.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">aio_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> aiocb *aiocb)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">aio_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> aiocb *aiocb)</span>;<br><br>Both <span class="hljs-keyword">return</span>:<span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK, <span class="hljs-number">-1</span> on error<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;aio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">aio_fsync</span><span class="hljs-params">(<span class="hljs-type">int</span> op, <span class="hljs-keyword">struct</span> aiocb *aiocb)</span>;<br><br>Returns:<span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK, <span class="hljs-number">-1</span> on error<br></code></pre></td></tr></table></figure>

<ul>
<li><code>op</code>设置为<code>O_DSYNC</code>类似于<code>fdatasync</code>的调用</li>
<li><code>op</code>设置为<code>O_SYNC</code>类似于<code>fsync</code>的调用，需要你在入参的位置上传递给他一个<code>fd</code>，然后系统调用就会对这个<code>fd</code>指向的文件起作用。<code>fsync</code>会确保一直到写磁盘操作结束才会返回。</li>
</ul>
<p>为了确定异步读、写或同步操作的完成状态，则通过<code>aio_error</code>函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;aio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">aio_error</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> aiocb *aiocb)</span>;<br><br>Returns:(see following)<br></code></pre></td></tr></table></figure>

<p><strong>返回值</strong></p>
<ul>
<li>0，异步操作已完成，需要通过<code>aio_return</code>函数从操作中获取返回值</li>
<li>-1，异步操作失败，<code>errno</code>中存储了原因</li>
<li><code>EINPROGRESS</code>，异步读取、写入或同步仍处于挂起状态</li>
<li>其他值，任何其他返回值都会为我们提供与失败的异步操作相对应的错误代码。</li>
</ul>
<p>通过<code>aio_return</code>获取操作的返回值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;atio.h&gt;</span></span><br><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">aio_return</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> aiocb *aiocb)</span>;<br><br>Returns:(see following)<br></code></pre></td></tr></table></figure>

<ul>
<li>-1，设置<code>errno</code>则返回错误</li>
<li>返回异步操作的结果</li>
</ul>
<p>当完成其他处理但仍然有其他异步操作未完成时，调用<code>aio_suspend</code>函数进行阻塞</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;aio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">aio_suspend</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> aiocb *<span class="hljs-type">const</span> <span class="hljs-built_in">list</span>[], <span class="hljs-type">int</span> nent,</span><br><span class="hljs-params">               <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> timespec *timeout)</span>;<br>Returns:<span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK, <span class="hljs-number">-1</span> on error<br></code></pre></td></tr></table></figure>

<ul>
<li>当被信号中断时，返回-1且将<code>errno</code>设置为<code>EINTR</code></li>
<li>超时，返回-1且将<code>errno</code>设置为<code>EAGAIN</code></li>
<li>如果异步操作完成，则返回0</li>
<li>如果在调用<code>aio_suspend</code>时所有异步<code>I/O</code>操作都已完成，那么<code>aio_susend</code>将返回而不会阻塞</li>
</ul>
<p>取消异步操作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;aio.h&gt;</span></span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">fd指定想要取消的未完成异步操作的I/O，若aiocb为NULL则取消所有异步操作</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">aio_cancel</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-keyword">struct</span> aiocb *aiocb)</span>;<br>Returns:(see following)<br></code></pre></td></tr></table></figure>

<ul>
<li><p><code>AIO_ALLDONE</code>：所有操作在取消前已经全部完成</p>
</li>
<li><p><code>AIO_CANCELED</code>：所有请求的操作都已经被取消</p>
</li>
<li><p><code>AIO_NOTCANCELED</code>：至少有一个请求未被取消</p>
</li>
<li><p>-1：调用<code>aio_cancel</code>函数失败，错误代码被存在<code>errno</code></p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;aio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">lio_listio</span><span class="hljs-params">(<span class="hljs-type">int</span> mode,  <span class="hljs-comment">//判断I/O是否为真正异步</span></span><br><span class="hljs-params">               <span class="hljs-keyword">struct</span> aiocb *<span class="hljs-keyword">restrict</span> <span class="hljs-type">const</span> <span class="hljs-built_in">list</span>[<span class="hljs-keyword">restrict</span>],<span class="hljs-comment">//需要执行的I/O操作的AIO控制块列表</span></span><br><span class="hljs-params">              <span class="hljs-type">int</span> nent, <span class="hljs-comment">//元素的个数</span></span><br><span class="hljs-params">              <span class="hljs-keyword">struct</span> sigevent *<span class="hljs-keyword">restrict</span> sigev <span class="hljs-comment">//通知的补充，当所有I/O操作完成时发送</span></span><br><span class="hljs-params">              )</span>;<br>Returns:<span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK, <span class="hljs-number">-1</span> on error<br></code></pre></td></tr></table></figure>

<p>此函数可以控制一个<code>AIO</code>控制块列表来描述<code>IO</code>请求</p>
<p><strong>mode</strong></p>
<ul>
<li><code>LIO_WAIT</code>：直到<code>list</code>指定的所有操作完成时才会返回，<code>sigev</code>参数将会被忽略</li>
<li><code>LIO_NOWAIT</code>：当<code>I/O</code>请求排队时，<code>lio_listio</code>函数立即返回。根据<code>sigev</code>参数的指定，当所有<code>I/O</code>操作完成时，将异步通知进程。不想通知时，<code>sigev</code>可以被设置为<code>NULL</code></li>
</ul>
<p><code>AIO</code>控制块中的<code>aio_lio_opcoded</code>区域制定了操作是否为读、写或者忽略。读被认为是传入<code>aio_read</code>函数，写被认为是传入<code>aio_write</code>函数</p>
<p>以下是限制允许执行的异步<code>I/O</code>操作的数量</p>
<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230203221759223.png" srcset="/img/loading.gif" lazyload alt="image-20230203221759223"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ctype.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;aio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BSZ 4096</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NBUF 8</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>	FILE_MODE	(S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH)</span><br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">rwop</span> &#123;</span><br>    UNUSERD = <span class="hljs-number">0</span>,<br>    READ_PENDING = <span class="hljs-number">1</span>,<br>    WRITE_PENDING = <span class="hljs-number">2</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span>&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">rwop</span> <span class="hljs-title">op</span>;</span> <span class="hljs-comment">//操作码</span><br>    <span class="hljs-type">int</span> last;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">aiocb</span> <span class="hljs-title">aiocb</span>;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> data[BSZ];<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> <span class="hljs-title">bufs</span>[<span class="hljs-title">NBUF</span>];</span><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span><br><span class="hljs-title function_">translate</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> c)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isalpha</span>(c))&#123;<br>        <span class="hljs-keyword">if</span> (c &gt;= <span class="hljs-string">&#x27;n&#x27;</span>)<br>            c -= <span class="hljs-number">13</span>;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c &gt;= <span class="hljs-string">&#x27;a&#x27;</span>)<br>            c += <span class="hljs-number">13</span>;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c &gt;= <span class="hljs-string">&#x27;N&#x27;</span>)<br>            c -= <span class="hljs-number">13</span>;<br>        <span class="hljs-keyword">else</span> <br>            c += <span class="hljs-number">13</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span>(c);<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>* argv[])</span><br>&#123;<br>    <span class="hljs-type">int</span> ifd, ofd, i, j, n, err, numop;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">sbuf</span>;</span><br>    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">aiocb</span> *<span class="hljs-title">aiolist</span>[<span class="hljs-title">NBUF</span>];</span><br>    <span class="hljs-type">off_t</span> off = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">3</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;usage: rot13 infile outfile&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> ((ifd = open(argv[<span class="hljs-number">1</span>], O_RDONLY)) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t open %s&quot;</span>, argv[<span class="hljs-number">1</span>]); <br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> ((ofd = open(argv[<span class="hljs-number">2</span>], O_RDWR | O_CREAT | O_TRUNC, FILE_MODE)) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t create %s&quot;</span>, argv[<span class="hljs-number">2</span>]);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (fstat(ifd, &amp;sbuf) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//获取读入文件的状态</span><br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;fstat failed&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>;i &lt; NBUF; i++)&#123; <span class="hljs-comment">//初始化</span><br>        bufs[i].op = UNUSERD;<br>        bufs[i].aiocb.aio_buf = bufs[i].data;<br>        bufs[i].aiocb.aio_sigevent.sigev_notify = SIGEV_NONE; <span class="hljs-comment">//异步`I/O`请求完成时不会通知进程</span><br>        aiolist[i] = <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>    numop = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (;;)&#123;<br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; NBUF; i++)&#123;<br>            <span class="hljs-keyword">switch</span> (bufs[i].op)<br>            &#123;<br>                <br>            <span class="hljs-keyword">case</span> UNUSERD: <span class="hljs-comment">//初始状态</span><br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;UNUSERD\n&quot;</span>);<br>                <br>                <span class="hljs-keyword">if</span> (off &lt; sbuf.st_size) <span class="hljs-comment">//偏移小于文件大小</span><br>                &#123;<br>                    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,sbuf.st_size);<br>                    bufs[i].op = READ_PENDING; <span class="hljs-comment">//挂起</span><br>                    bufs[i].aiocb.aio_fildes = ifd;<br>                    bufs[i].aiocb.aio_offset = off;<br>                    off += BSZ; <span class="hljs-comment">//每次读取BSZ大小</span><br>                    <span class="hljs-keyword">if</span> (off &gt;= sbuf.st_size)<br>                        bufs[i].last = <span class="hljs-number">1</span>; <span class="hljs-comment">//到达文件末尾</span><br>                    bufs[i].aiocb.aio_nbytes = BSZ;<br>                    <span class="hljs-keyword">if</span> (aio_read(&amp;bufs[i].aiocb) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//异步读</span><br>                    &#123;<br>                        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;aio_read failed&quot;</span>);<br>                        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>                    &#125;<br>                    aiolist[i] = &amp;bufs[i].aiocb;<br>                    numop++;<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> READ_PENDING:<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;READ\n&quot;</span>);<br>                <span class="hljs-keyword">if</span> ((err = aio_error(&amp;bufs[i].aiocb)) == EINPROGRESS) <span class="hljs-comment">//异步读取、写入或同步仍处于挂起状态</span><br>                    <span class="hljs-keyword">continue</span>;<br>                <span class="hljs-keyword">if</span> (err != <span class="hljs-number">0</span>)&#123;<br>                    <span class="hljs-keyword">if</span> (err == <span class="hljs-number">-1</span>)<br>                    &#123;<br>                        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;aio_error failed&quot;</span>);<br>                        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>                    &#125;<br>                    <span class="hljs-keyword">else</span><br>                    &#123;<br>                        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;read failed&quot;</span>);<br>                        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">if</span> ((n = aio_return(&amp;bufs[i].aiocb)) &lt; <span class="hljs-number">0</span>)<br>                &#123;<br>                    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;aio_return failed&quot;</span>);<br>                    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>                &#125;<br>                <span class="hljs-keyword">if</span> ( n != BSZ &amp;&amp; !bufs[i].last) <span class="hljs-comment">//若读取的长度不是BSZ则没读全</span><br>                &#123;<br>                    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;short read (%d/%d)&quot;</span>,n, BSZ);<br>                    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>                &#125;<br>                <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>                    bufs[i].data[j] = translate(bufs[i].data[j]);<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>,bufs[i].data);<br>                bufs[i].op = WRITE_PENDING;<br>                bufs[i].aiocb.aio_fildes = ofd;<br>                bufs[i].aiocb.aio_nbytes = n;<br>                <span class="hljs-keyword">if</span> (aio_write(&amp;bufs[i].aiocb) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//异步写</span><br>                &#123;<br>                    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;aio_write failed&quot;</span>);<br>                    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> WRITE_PENDING:<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;WRITE\n&quot;</span>);<br>                <span class="hljs-keyword">if</span> ((err = aio_error(&amp;bufs[i].aiocb)) == EINPROGRESS)<br>                    <span class="hljs-keyword">continue</span>;<br>                <span class="hljs-keyword">if</span> (err != <span class="hljs-number">0</span>)&#123;<br>                    <span class="hljs-keyword">if</span> (err == <span class="hljs-number">-1</span>)<br>                    &#123;<br>                        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;aio_error faiiled&quot;</span>);<br>                        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>                    &#125;<br>                    <span class="hljs-keyword">else</span><br>                    &#123;<br>                        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;write failed&quot;</span>);<br>                        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> ((n = aio_return(&amp;bufs[i].aiocb)) &lt; <span class="hljs-number">0</span>)<br>                &#123;<br>                    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;aio_return failed&quot;</span>);<br>                    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>                &#125;<br>                <span class="hljs-keyword">if</span> (n != bufs[i].aiocb.aio_nbytes)<br>                &#123;<br>                    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;short write (%d/%d)&quot;</span>,n , BSZ);<br>                    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>                &#125;<br>                aiolist[i] = <span class="hljs-literal">NULL</span>;<br>                bufs[i].op = UNUSERD;<br>                numop--;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (numop == <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">if</span> (off &gt;= sbuf.st_size)<br>                <span class="hljs-keyword">break</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (aio_suspend(aiolist, NBUF, <span class="hljs-literal">NULL</span>) &lt; <span class="hljs-number">0</span>)<br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;aio_suspend failed&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>    bufs[<span class="hljs-number">0</span>].aiocb.aio_fildes = ofd;<br>    <span class="hljs-keyword">if</span> (aio_fsync(O_SYNC, &amp;bufs[<span class="hljs-number">0</span>].aiocb) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;aio_fsync failed&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="readn和writen"><a href="#readn和writen" class="headerlink" title="readn和writen"></a>readn和writen</h3><p>管道、FIFOs和一些设备，特别是终端和网络，会有两个特点</p>
<ul>
<li>读取的数据会比要求的少，这不是错误，而需要继续读</li>
<li>写的数据比预期的少，造成这样的原因是写缓冲区已经满了，需要继续写剩余的数据。导致这样的原因通常是不阻塞的文件描述符以及捕获了信号。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;apue.h&quot;</span></span><br><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">readn</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">void</span> *buf <span class="hljs-type">size_t</span> nbytes)</span>;<br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">writen</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> nbytes)</span>;<br><br>Both returns:number of bytes read or written, <span class="hljs-number">-1</span> on error<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">ssize_t</span><br><span class="hljs-title function_">readn</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">void</span> *ptr, <span class="hljs-type">size_t</span> n)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> nleft;<br>    <span class="hljs-type">ssize_t</span> nread;<br><br>    nleft = n; <span class="hljs-comment">//剩余需要读的字节数</span><br>    <span class="hljs-keyword">while</span>(nleft &gt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-keyword">if</span> ((nread = read(fd, ptr, nleft)) &lt; <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">if</span> (nleft == n)<br>                <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>            <span class="hljs-keyword">else</span><br>                <span class="hljs-keyword">break</span>;<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        nleft -= nread;<br>        ptr += nread;<br>    &#125;<br>    <span class="hljs-keyword">return</span>(n - nleft);<br>&#125;<br><br><span class="hljs-type">ssize_t</span><br><span class="hljs-title function_">writen</span><span class="hljs-params">(<span class="hljs-type">int</span> fd,<span class="hljs-type">const</span> <span class="hljs-type">void</span> *ptr, <span class="hljs-type">size_t</span> n)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> nleft;<br>    <span class="hljs-type">ssize_t</span> nwritten;<br><br>    nleft = n;<br>    <span class="hljs-keyword">while</span> (nleft &gt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-keyword">if</span> ((nwritten = write(fd, ptr, nleft)) &lt; <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">if</span> (nleft == n)<br>                <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>            <span class="hljs-keyword">else</span><br>                <span class="hljs-keyword">break</span>;<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nwritten == <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        nleft -= nwritten;<br>        ptr += nwritten;<br>    &#125;<br>    <span class="hljs-keyword">return</span>(n - nleft);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Memory-Mapped-I-x2F-O"><a href="#Memory-Mapped-I-x2F-O" class="headerlink" title="Memory-Mapped I&#x2F;O"></a>Memory-Mapped I&#x2F;O</h3><h4 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h4><p>内存映射<code>I/O</code>允许我们将磁盘上的文件映射到内存中的缓冲区，当从缓存区获取字节时，文件的相应字节就会被读取。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mmanh&gt;</span></span><br><br><span class="hljs-type">void</span> *<span class="hljs-title function_">mmap</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr, <span class="hljs-type">size_t</span> len, <span class="hljs-type">int</span> prot, <span class="hljs-type">int</span> flag, <span class="hljs-type">int</span> fd, <span class="hljs-type">off_t</span> off)</span>;<br>Returns:starting address of mapped region <span class="hljs-keyword">if</span> OK,MAP_FAILED on error<br></code></pre></td></tr></table></figure>

<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230204133015594.png" srcset="/img/loading.gif" lazyload alt="image-20230204133015594"></p>
<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230204133236552.png" srcset="/img/loading.gif" lazyload alt="image-20230204133236552"></p>
<p><code>flag</code>可选值</p>
<ul>
<li><code>MAP_FIXED</code>：返回值必须等于<code>addr</code></li>
<li><code>MAP_SHARED</code>：对映射内存的操作会同步到文件中</li>
<li><code>MAP_PRIVATE</code>：对映射内存的操作会同步到私有副本中</li>
</ul>
<p><code>addr</code>与<code>off</code>的值需要与页对齐</p>
<p>有两个信号常用于映射区域</p>
<ul>
<li><code>SIGSEGV</code>：试图访问对我们不可用的内存</li>
<li><code>SIGBUS</code>：访问没有意义的部分内存</li>
</ul>
<p>内存映射区域可以通过<code>fork</code>继承，但是不会通过<code>exec</code>继承</p>
<h4 id="mprotect"><a href="#mprotect" class="headerlink" title="mprotect"></a>mprotect</h4><p>可以通过<code>mprotect</code>函数修改现存的映射区域的权限</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">mprotect</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr, <span class="hljs-type">size_t</span> len, <span class="hljs-type">int</span> prot)</span>;<br><br>Returns:<span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK,<span class="hljs-number">-1</span> on error<br></code></pre></td></tr></table></figure>

<p><code>prot</code>参数与<code>mmap</code>的一样，<code>addr</code>需要与页对齐</p>
<h4 id="msync"><a href="#msync" class="headerlink" title="msync"></a>msync</h4><p>用于将映射区域内的数据同步到文件中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">msync</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr, <span class="hljs-type">size_t</span> len, <span class="hljs-type">int</span> flags)</span>;<br><br>Returns:<span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK, <span class="hljs-number">-1</span> on error<br></code></pre></td></tr></table></figure>

<p><code>flag</code>参数</p>
<ul>
<li><code>MS_ASYNC</code>简单地安排要写入的页面</li>
<li><code>MS_SYNC</code>在返回之前等待写入完成</li>
<li>可选标志<code>MS_INVALIDATE</code>允许告诉操作系统丢弃与底层存储不同步的任何页面。</li>
</ul>
<h4 id="munmap"><a href="#munmap" class="headerlink" title="munmap"></a>munmap</h4><p>取消映射</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">munmap</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr, <span class="hljs-type">size_t</span> len)</span>;<br><br>Returns:<span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK, <span class="hljs-number">-1</span> on error<br></code></pre></td></tr></table></figure>

<p><strong>example</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>	FILE_MODE	(S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COPYINCR (1024*1024*1024)</span><br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>    <span class="hljs-type">int</span> fdin, fdout;<br>    <span class="hljs-type">void</span> *src, *dst;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">sbuf</span>;</span><br>    <span class="hljs-type">size_t</span> copysz;<br>    <span class="hljs-type">off_t</span> fsz = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">3</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;usage: %s &lt;froomfiile&gt; &lt;tofiile&gt;&quot;</span>,argv[<span class="hljs-number">0</span>]);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> ((fdin = open(argv[<span class="hljs-number">1</span>], O_RDONLY)) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t create %s for writing&quot;</span>, argv[<span class="hljs-number">2</span>]);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> ((fdout = open(argv[<span class="hljs-number">2</span>], O_RDWR | O_CREAT | O_TRUNC, FILE_MODE))&lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t create %s for writing&quot;</span>,argv[<span class="hljs-number">2</span>]);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (fstat(fdin, &amp;sbuf) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;fstat error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (ftruncate(fdout, sbuf.st_size) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//用于截断文件</span><br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;ftruncate error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">while</span> (fsz &lt; sbuf.st_size)&#123;<br>        <span class="hljs-keyword">if</span> ((sbuf.st_size - fsz) &gt; COPYINCR)<br>            copysz = COPYINCR;<br>        <span class="hljs-keyword">else</span><br>            copysz = sbuf.st_size - fsz;<br>        <span class="hljs-keyword">if</span> ((src = mmap(<span class="hljs-number">0</span>, copysz, PROT_READ, MAP_SHARED, fdin, fsz)) == MAP_FAILED)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;mmap error for input&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> ((dst = mmap(<span class="hljs-number">0</span>, copysz, PROT_READ | PROT_WRITE,MAP_SHARED,fdout,fsz)) == MAP_FAILED)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;mmap error for output&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br><br>        <span class="hljs-built_in">memcpy</span>(dst, src, copysz);<br>        munmap(src, copysz);<br>        munmap(dst, copysz);<br>        fsz += copysz;<br>        <br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);    <br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="进程间通信（IPC）"><a href="#进程间通信（IPC）" class="headerlink" title="进程间通信（IPC）"></a>进程间通信（IPC）</h1><h2 id="pipe"><a href="#pipe" class="headerlink" title="pipe"></a>pipe</h2><p>管道有两个限制</p>
<ul>
<li>半双工通信，数据流只有一个方向</li>
<li>管道只能在具有共同祖先的进程之间使用</li>
</ul>
<p><code>FIFOs</code>绕过了第二个限制，而<code>Socket</code>绕过了上诉两个限制</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pipe</span><span class="hljs-params">(<span class="hljs-type">int</span> fd[<span class="hljs-number">2</span>])</span>;<br><br>Returns: <span class="hljs-keyword">if</span> OK, <span class="hljs-number">-1</span> on error<br></code></pre></td></tr></table></figure>

<p><code>fstat</code>函数针对管道文件返回<code>FIFO</code>类型，可以通过<code>S_ISFIFP</code>宏获取。</p>
<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230207234736511.png" srcset="/img/loading.gif" lazyload alt="image-20230207234736511"></p>
<p>父进程关闭<code>fd[0]</code>读管道，子进程关闭<code>fd[1]</code>写管道，则父进程只往管道中写，而子进程只从管道中读数据。</p>
<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230207234928683.png" srcset="/img/loading.gif" lazyload alt="image-20230207234928683"></p>
<p>两个应用于管道的规则</p>
<ol>
<li>当写管道关闭时，读管道会读到文件末尾，并返回已经读了的数据。</li>
<li>当读管道关闭时，写管道往管道中写会发出<code>SIGPIPE</code>信号。默认的信号处理为返回<code>-1</code>并设置<code>errno</code>为<code>EPIPE</code></li>
</ol>
<p><code>PIPE_BUF</code>为管道缓冲区的常量值，写入少于该值时不会覆盖其他管道的缓冲区，但是超过该值则会覆盖其余管道的缓冲区。</p>
<p><strong>父进程传字符串到子进程</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAXLINE 1024</span><br><br><span class="hljs-type">int</span> <br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> n;<br>    <span class="hljs-type">int</span> fd[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">pid_t</span> pid;<br>    <span class="hljs-type">char</span> line[MAXLINE];<br><br>    <span class="hljs-keyword">if</span> (pipe(fd) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;pipe error!\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> ((pid = fork()) &lt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;fork error!\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid &gt; <span class="hljs-number">0</span>)&#123;<br>        close(fd[<span class="hljs-number">0</span>]); <span class="hljs-comment">//父进程写</span><br>        write(fd[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;hello world\n&quot;</span>,<span class="hljs-number">12</span>);<br>    &#125;<span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-comment">/* code */</span><br>        close(fd[<span class="hljs-number">1</span>]);<span class="hljs-comment">//子进程读</span><br>        n = read(fd[<span class="hljs-number">0</span>], line, MAXLINE);<br>        write(STDOUT_FILENO, line, n);<br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>实现管道功能，读指定文件并输入到more程序中</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DEF_PAGE <span class="hljs-string">&quot;/bin/more&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAXLINE 1024</span><br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>    <span class="hljs-type">int</span> n;<br>    <span class="hljs-type">int</span> fd[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">pid_t</span> pid;<br>    <span class="hljs-type">char</span> *pager, *argv0;<br>    <span class="hljs-type">char</span> line[MAXLINE];<br>    FILE *fp;<br><br>    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">2</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;usgae: a.out &lt;pathname&gt;&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> ((fp = fopen(argv[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;r&quot;</span>)) == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t open %s&quot;</span>, argv[<span class="hljs-number">1</span>]);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (pipe(fd) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;pipe error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> ((pid = fork()) &lt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;fork error!\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid &gt; <span class="hljs-number">0</span>)&#123; <br>        close(fd[<span class="hljs-number">0</span>]);<span class="hljs-comment">//父进程写</span><br>        <span class="hljs-keyword">while</span>  (fgets(line, MAXLINE, fp) != <span class="hljs-literal">NULL</span>)&#123; <span class="hljs-comment">//从文件中逐行读取内容</span><br>            n = <span class="hljs-built_in">strlen</span>(line); <span class="hljs-comment">// 获取字符长度</span><br>            <span class="hljs-keyword">if</span> (write(fd[<span class="hljs-number">1</span>], line, n) != n) <span class="hljs-comment">//写进管道内</span><br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;write error to pipe&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br>        &#125;<br>            <span class="hljs-keyword">if</span> (ferror(fp))<br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;fgets error&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br>            close(fd[<span class="hljs-number">1</span>]); <span class="hljs-comment">//写完关闭写管道</span><br>            <span class="hljs-keyword">if</span> (waitpid(pid, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//等待子进程</span><br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;waitpid error&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        close(fd[<span class="hljs-number">1</span>]); <span class="hljs-comment">//子进程读管道</span><br>        <span class="hljs-keyword">if</span> (fd[<span class="hljs-number">0</span>] != STDIN_FILENO) <br>        &#123;<br>            <span class="hljs-keyword">if</span> (dup2(fd[<span class="hljs-number">0</span>], STDIN_FILENO) != STDIN_FILENO)<span class="hljs-comment">//将管道描述符复制给STDIN_FILENO,然后close(fd[0])</span><br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;dup2 error!\n&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br>            close(fd[<span class="hljs-number">0</span>]);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> ((pager = getenv(<span class="hljs-string">&quot;PAGER&quot;</span>) == <span class="hljs-literal">NULL</span>))<br>            pager = DEF_PAGE;<br>        <span class="hljs-keyword">if</span> ((argv0 = <span class="hljs-built_in">strrchr</span>(pager, <span class="hljs-string">&#x27;/&#x27;</span>)) != <span class="hljs-literal">NULL</span>) <span class="hljs-comment">//从后往前搜索&#x27;/&#x27;</span><br>            argv0++;<br>        <span class="hljs-keyword">else</span><br>            argv0 = pager;<br>        <span class="hljs-keyword">if</span> (execl(pager, argv0, (<span class="hljs-type">char</span> *)<span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;execl error for %s&quot;</span>, pager);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br><br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>利用管道实现父子进程信号同步</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> pfd1[<span class="hljs-number">2</span>], pfd2[<span class="hljs-number">2</span>];<br><br><span class="hljs-type">void</span> <br><span class="hljs-title function_">TELL_WAIT</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(pipe(pfd1) &lt; <span class="hljs-number">0</span> || pipe(pfd2) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//初始化两个管道</span><br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;pipe error!\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//pfd2父进程写，子进程读</span><br><span class="hljs-type">void</span><br><span class="hljs-title function_">TELL_PARENT</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> pid)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (write(pfd2[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;c&quot;</span>, <span class="hljs-number">1</span>) != <span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;write error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <br><span class="hljs-title function_">WAIT_PARENT</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> c;<br>    <span class="hljs-keyword">if</span> (read(pfd1[<span class="hljs-number">0</span>], &amp;c, <span class="hljs-number">1</span>) != <span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;read error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (c != <span class="hljs-string">&#x27;p&#x27;</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;WAIT_PARENT: incorrect data&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//pfd1为子进程写，父进程读</span><br><span class="hljs-type">void</span> <br><span class="hljs-title function_">TELL_CHILD</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> pid)</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(write(pfd1[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;p&quot;</span>, <span class="hljs-number">1</span>) != <span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;write error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">WAIT_CHILD</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> c;<br>    <span class="hljs-keyword">if</span> (read(pfd2[<span class="hljs-number">0</span>], &amp;c, <span class="hljs-number">1</span>) != <span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;read error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (c != <span class="hljs-string">&#x27;c&#x27;</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-string">&quot;WAIT_CHILD: incorrect data&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="popen-和-pclose"><a href="#popen-和-pclose" class="headerlink" title="popen 和 pclose"></a>popen 和 pclose</h2><p><code>popen</code>用于创建管道、<code>fork</code>子管道、关闭管道未使用的端、执行<code>shell</code>命令以及等待命令终止。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br>FILE *<span class="hljs-title function_">popen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *cmdstring, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *type)</span>;<br>Returns:file pointer <span class="hljs-keyword">if</span> OK, <span class="hljs-literal">NULL</span> on error<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pclose</span><span class="hljs-params">(FILE *fp)</span>;<br>Returns:termination status of cmdstring, or <span class="hljs-number">-1</span> on error<br></code></pre></td></tr></table></figure>

<ul>
<li><code>type = r</code>则父进程连接子进程的标准输出流</li>
</ul>
<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230208184650475.png" srcset="/img/loading.gif" lazyload alt="image-20230208184650475"></p>
<ul>
<li><code>type = w</code>则父进程连接子进程的标准输入流</li>
</ul>
<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230208184714204.png" srcset="/img/loading.gif" lazyload alt="image-20230208184714204"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGER <span class="hljs-string">&quot;$&#123;PAGER:-more&#125;&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAXLINE 1024</span><br><br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>    <span class="hljs-type">char</span> line[MAXLINE];<br>    FILE  *fpin, *fpout;<br><br>    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">2</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;usage: a.out &lt;pathname&gt;&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> ((fpin = fopen(argv[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;r&quot;</span>)) == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t open %s&quot;</span>, argv[<span class="hljs-number">1</span>]);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> ((fpout = popen(PAGER, <span class="hljs-string">&quot;w&quot;</span>)) == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;popen error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">while</span> (fgets(line, MAXLINE, fpin) != <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">fputs</span>(line, fpout) == EOF)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;fputs error to pipe&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (ferror(fpin))<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;fgets error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (pclose(fpout) == <span class="hljs-number">-1</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;pclose error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>使用管道实现字符大小写转换</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//gcc -o myuclc 15-14.c</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ctype.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> c;<br><br>    <span class="hljs-keyword">while</span> ((c = getchar()) != EOF)&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isupper</span>(c))<br>            c = <span class="hljs-built_in">tolower</span>(c);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">putchar</span>(c) == EOF)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;output error\n&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (c == <span class="hljs-string">&#x27;\n&#x27;</span>)<br>            fflush(<span class="hljs-built_in">stdout</span>);<br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//gcc -o 15-15 15-15.c</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAXLINE 1024</span><br><br><span class="hljs-type">int</span> <br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> line[MAXLINE];<br>    FILE *fpin;<br>    <span class="hljs-keyword">if</span> ((fpin = popen(<span class="hljs-string">&quot;./myuclc&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>)) == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;popen error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span>(;;)&#123;<br>        <span class="hljs-built_in">fputs</span>(<span class="hljs-string">&quot;prompt&gt; &quot;</span>,<span class="hljs-built_in">stdout</span>);<br>        fflush(<span class="hljs-built_in">stdout</span>);<br>        <span class="hljs-keyword">if</span> (fgets(line, MAXLINE, fpin) == <span class="hljs-literal">NULL</span>)<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">fputs</span>(line, <span class="hljs-built_in">stdout</span>) == EOF)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;fputs error to pipe&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (pclose(fpin) == <span class="hljs-number">-1</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;pclose error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;\n&#x27;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="协作进程"><a href="#协作进程" class="headerlink" title="协作进程"></a>协作进程</h2><p><img src="C:\Users\39738\AppData\Roaming\Typora\typora-user-images\image-20230209010328935.png" srcset="/img/loading.gif" lazyload alt="image-20230209010328935"></p>
<p><strong>使用协作进程实现加法</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAXLINE 1024</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> n, int1, int2;<br>    <span class="hljs-type">char</span> line[MAXLINE];<br><br>    <span class="hljs-keyword">while</span> ((n = read(STDIN_FILENO, line, MAXLINE)) &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>        line[n] = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sscanf</span>(line, <span class="hljs-string">&quot;%d%d&quot;</span>, &amp;int1, &amp;int2) == <span class="hljs-number">2</span>)&#123;<br>            <span class="hljs-built_in">sprintf</span>(line, <span class="hljs-string">&quot;%d\n&quot;</span>, int1 + int2);<br>            n = <span class="hljs-built_in">strlen</span>(line);<br>            <span class="hljs-keyword">if</span> (write(STDOUT_FILENO, line, n) != n)<br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;write error&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125; <br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">if</span> (write(STDOUT_FILENO, <span class="hljs-string">&quot;invalid args\n&quot;</span>,<span class="hljs-number">13</span>) != <span class="hljs-number">13</span>)<br>                &#123;<br>                    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;write error&quot;</span>);<br>                    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>                &#125;<br>            &#125;<br>        <br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAXLINE 1024</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">sig_pipe</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span>;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> n, fd1[<span class="hljs-number">2</span>], fd2[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">pid_t</span> pid;<br>    <span class="hljs-type">char</span> line[MAXLINE];<br><br>    <span class="hljs-keyword">if</span> (signal(SIGPIPE, sig_pipe) == SIG_ERR) <span class="hljs-comment">//注册信号处理</span><br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;signal error!\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (pipe(fd1) &lt; <span class="hljs-number">0</span> || pipe(fd2) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//建立两个管道</span><br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;fork error!\n&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> ((pid = fork()) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;fork error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125; <br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid &gt; <span class="hljs-number">0</span>)&#123; <span class="hljs-comment">//父进程</span><br>        close(fd1[<span class="hljs-number">0</span>]); <span class="hljs-comment">//fd1写</span><br>        close(fd2[<span class="hljs-number">1</span>]); <span class="hljs-comment">//fd2读</span><br><br>        <span class="hljs-keyword">while</span> (fgets(line, MAXLINE, <span class="hljs-built_in">stdin</span>) != <span class="hljs-literal">NULL</span>)&#123;<br>            n = <span class="hljs-built_in">strlen</span>(line);<br>            <span class="hljs-keyword">if</span> (write(fd1[<span class="hljs-number">1</span>], line, n) != n) <span class="hljs-comment">//向管道中写数据</span><br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;write error to pipe\n&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br>            <span class="hljs-keyword">if</span> ((n = read(fd2[<span class="hljs-number">0</span>], line, MAXLINE)) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//从管道中读数据</span><br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;read error from pipe&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (n == <span class="hljs-number">0</span>) <span class="hljs-comment">//管道被关闭</span><br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;child closed pipe&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            line[n] = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">fputs</span>(line, <span class="hljs-built_in">stdout</span>) == EOF)<br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;fputs error&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (ferror(<span class="hljs-built_in">stdin</span>))<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;fgets error on stdin&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">//子进程</span><br>        close(fd1[<span class="hljs-number">1</span>]); <span class="hljs-comment">//fd1为读</span><br>        close(fd2[<span class="hljs-number">0</span>]); <span class="hljs-comment">//fd2为写</span><br>        <span class="hljs-keyword">if</span> (fd1[<span class="hljs-number">0</span>] != STDIN_FILENO) &#123;<br>            <span class="hljs-keyword">if</span> (dup2(fd1[<span class="hljs-number">0</span>], STDIN_FILENO) != STDIN_FILENO)<br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;dup2 error to stdin&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br>            close(fd1[<span class="hljs-number">0</span>]);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (fd2[<span class="hljs-number">1</span>] != STDOUT_FILENO)&#123;<br>            <span class="hljs-keyword">if</span> (dup2(fd2[<span class="hljs-number">1</span>], STDOUT_FILENO) != STDOUT_FILENO)<br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;dup2 error to stdout&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br>            close(fd2[<span class="hljs-number">1</span>]);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (execl(<span class="hljs-string">&quot;./add2&quot;</span>, <span class="hljs-string">&quot;add2&quot;</span>, (<span class="hljs-type">char</span> *)<span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;execl error&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;  <br>    &#125;<br>     <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">sig_pipe</span><span class="hljs-params">(<span class="hljs-type">int</span> signo)</span><br>&#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;SIGPIPE caught\n&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>改写add2文件，使用标准I&#x2F;O库函数实现对管道的读写，会造成死锁</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAXLINE 1024</span><br><br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> int1, int2;<br>    <span class="hljs-type">char</span> line[MAXLINE];<br><br>    <span class="hljs-keyword">while</span> (fgets(line, MAXLINE, <span class="hljs-built_in">stdin</span>) != <span class="hljs-literal">NULL</span>)&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sscanf</span>(line, <span class="hljs-string">&quot;%d%d&quot;</span>, &amp;int1, &amp;int2) == <span class="hljs-number">2</span>)&#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>, int1 + int2) == EOF)<br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;printf error!\n&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;invalid args\n&quot;</span>) == EOF)<br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;printf error&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>采用fgets函数从标准输入流中读取数据，由于标准输入流指向管道，因此在Linux下会默认为全缓冲，那么调用fgets函数时会进行阻塞，等到管道中的数据被填充满时才进行数据的读取，在父进程中同样通过fgets函数进行数据读取，同样为全缓冲，那么造成父进程也在等到管道中的数据被填满后才读取数据，导致了父子进程互相等待的局面，从而导致了死锁</strong></p>
<p><strong>改进方法，将标准输入输出流修改为行缓冲或无缓冲模式</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAXLINE 1024</span><br><br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> int1, int2;<br>    <span class="hljs-type">char</span> line[MAXLINE];<br>    <span class="hljs-comment">/*无缓冲</span><br><span class="hljs-comment">	if (setvbuf(stdin, NULL, _IONBF, 0) != 0)</span><br><span class="hljs-comment">	&#123;</span><br><span class="hljs-comment">        fprintf(stderr, &quot;setvbuf error\n&quot;);</span><br><span class="hljs-comment">        exit(-1);</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment">	if (setvbuf(stdout, NULL, _IONBF, 0) != 0)</span><br><span class="hljs-comment">	&#123;</span><br><span class="hljs-comment">        fprintf(stderr, &quot;setvbuf error\n&quot;);</span><br><span class="hljs-comment">        ex</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-comment">//行缓冲</span><br>	<span class="hljs-keyword">if</span> (setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>, _IOLBF, <span class="hljs-number">0</span>) != <span class="hljs-number">0</span>)<br>	&#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;setvbuf error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>	<span class="hljs-keyword">if</span> (setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>, _IOLBF, <span class="hljs-number">0</span>) != <span class="hljs-number">0</span>)<br>	&#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;setvbuf error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">while</span> (fgets(line, MAXLINE, <span class="hljs-built_in">stdin</span>) != <span class="hljs-literal">NULL</span>)&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sscanf</span>(line, <span class="hljs-string">&quot;%d%d&quot;</span>, &amp;int1, &amp;int2) == <span class="hljs-number">2</span>)&#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>, int1 + int2) == EOF)<br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;printf error!\n&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;invalid args\n&quot;</span>) == EOF)<br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;printf error&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="FIFOs"><a href="#FIFOs" class="headerlink" title="FIFOs"></a>FIFOs</h2><p><code>FIFOs</code>有时也被称之为命名管道。未命名管道只能是相关的进程间进行数据交互，即由共同祖先创造的子进程之间。但是命名管道可以使得不相关的进程之间也交换数据。</p>
<p><strong>创建FIFO文件</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">mkfifo</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">mode_t</span> mode)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">mkfifoat</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">mode_t</span> mode)</span>;<br>Both <span class="hljs-keyword">return</span>: <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK, <span class="hljs-number">-1</span> on error<br></code></pre></td></tr></table></figure>

<ul>
<li>如果<code>path</code>为绝对路径，则忽略<code>fd</code>参数，此时<code>mkfifoat</code>与<code>mkfifo</code>行为类似</li>
<li><code>path</code>如果为相对路径，并且<code>fd</code>指向合法的被打开的目录文件描述符，那么<code>path</code>则相对于<code>fd</code>指向目录进行寻址</li>
<li>如果<code>fd</code>的值为<code>AT_FDCWD</code>，那么<code>path</code>则相对于当前目录进行寻址</li>
</ul>
<p><code>O_NONBLOCK</code>标志会影响<code>FIFO</code>文件的行为</p>
<ul>
<li>如果为设置该标志，那么以只读方式打开<code>FIFO</code>文件会进行阻塞直到有以只写方式打开<code>FIFO</code>文件的进程出现，相反以只写方式打开<code>FIFO</code>文件的进程也会等到只读形式打开<code>FIFO</code>文件的进程出现。</li>
</ul>
<p><code>FIFOs</code>可以用于以下两个场景</p>
<ul>
<li><code>FIFOs</code>被用于<code>shell</code>从一个管道传递数据给另一个，并且不需要创建中间的临时文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkfifo fifo1<br>prog3 &lt; fifo1 &amp;<br>prog1 &lt; infile | tee fifo1 | prog2<br></code></pre></td></tr></table></figure>

<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230211000205461.png" srcset="/img/loading.gif" lazyload alt="image-20230211000205461"></p>
<ul>
<li><code>FIFOs</code>被用于客户-服务应用程序中传递数据的中间集合点</li>
</ul>
<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230211003608390.png" srcset="/img/loading.gif" lazyload alt="image-20230211003608390"></p>
<p><strong>客户</strong>经过<code>FIFO</code>发送请求给<strong>服务</strong>，并且<code>FIFO</code>的路径是所有客户都知道的。</p>
<p>但是为了使得服务能够给每个客户发送回应包，客户在给服务发送请求包时需要携带自己的进程号，便于让服务识别。当客户关闭<code>FIFO</code>时会给服务发送<code>SIGPIPE</code>的信号，因此服务必须处理该信号。</p>
<h2 id="XSI-IPC"><a href="#XSI-IPC" class="headerlink" title="XSI IPC"></a>XSI IPC</h2><p>有三种类型的进程间通信被称之为<code>XSI IPC</code></p>
<ul>
<li>信息队列</li>
<li>信号量</li>
<li>共享队列</li>
</ul>
<h3 id="Identifiers与Keys"><a href="#Identifiers与Keys" class="headerlink" title="Identifiers与Keys"></a>Identifiers与Keys</h3><p><code>Identifiers</code>用于内核空间使用，用于标记<code>IPC</code>对象</p>
<p><code>Keys</code>用于用户空间使用</p>
<p>有许多方法可以使得服务与客户使用相同的<code>IPC</code>结构</p>
<ul>
<li>使用<code>IPC_PRIVATE</code>的键值新建<code>IPC</code>的结构，并且会返回<code>identifiers</code>给客户，但是该方法的缺陷为客户需要利用文件操作去读取<code>identifiers</code></li>
<li>服务与客户使用相同的键值，但是该方法的问题是键值可能已经被使用</li>
<li>服务与客户通过文件名与对象<code>ID</code>生成键值，然后使用上述第二个方法。</li>
</ul>
<p><strong>通过路径与id值生成键</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><br><span class="hljs-type">key_t</span> <span class="hljs-title function_">ftok</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">int</span> id)</span>;<br><br>Returns:key <span class="hljs-keyword">if</span> OK, (<span class="hljs-type">key_t</span>)<span class="hljs-number">-1</span> on error<br></code></pre></td></tr></table></figure>

<h3 id="Permission-Structure"><a href="#Permission-Structure" class="headerlink" title="Permission Structure"></a>Permission Structure</h3><p><code>ipc_perm</code>结构与每个<code>IPC</code>相关联的。这个结构定义了权限和拥有者。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_perm</span> &#123;</span><br><span class="hljs-type">uid_t</span> uid; <span class="hljs-comment">/* owner’s effective user ID */</span><br><span class="hljs-type">gid_t</span> gid; <span class="hljs-comment">/* owner’s effective group ID */</span><br><span class="hljs-type">uid_t</span> cuid; <span class="hljs-comment">/* creator’s effective user ID */</span><br><span class="hljs-type">gid_t</span> cgid; <span class="hljs-comment">/* creator’s effective group ID */</span><br><span class="hljs-type">mode_t</span> mode; <span class="hljs-comment">/* access modes */</span><br>...<br>&#125;;<br></code></pre></td></tr></table></figure>

<h2 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h2><p>消息队列是存储在内核中并被链表链接的信息，通过<code>identified</code>识别队列，也称之为<code>queue ID</code></p>
<p>消息队列相关的结构体<code>msqid_ds</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msqid_ds</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_perm</span> <span class="hljs-title">msg_perm</span>;</span> <span class="hljs-comment">/* see Section 15.6.2 */</span><br><span class="hljs-type">msgqnum_t</span> msg_qnum; <span class="hljs-comment">/* # of messages on queue */</span><br><span class="hljs-type">msglen_t</span> msg_qbytes; <span class="hljs-comment">/* max # of bytes on queue */</span><br><span class="hljs-type">pid_t</span> msg_lspid; <span class="hljs-comment">/* pid of last msgsnd() */</span><br><span class="hljs-type">pid_t</span> msg_lrpid; <span class="hljs-comment">/* pid of last msgrcv() */</span><br><span class="hljs-type">time_t</span> msg_stime; <span class="hljs-comment">/* last-msgsnd() time */</span><br><span class="hljs-type">time_t</span> msg_rtime; <span class="hljs-comment">/* last-msgrcv() time */</span><br><span class="hljs-type">time_t</span> msg_ctime; <span class="hljs-comment">/* last-change time */</span><br>...<br>&#125;;<br></code></pre></td></tr></table></figure>

<h3 id="msgget"><a href="#msgget" class="headerlink" title="msgget"></a>msgget</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">msgget</span><span class="hljs-params">(<span class="hljs-type">key_t</span> key, <span class="hljs-type">int</span> flag)</span>;<br>Returns:meessage <span class="hljs-built_in">queue</span> ID <span class="hljs-keyword">if</span> OK, <span class="hljs-number">-1</span> on error<br></code></pre></td></tr></table></figure>

<p>当队列被创建完毕后，<code>msqid_ds</code>的成员会进行初始化</p>
<ul>
<li><code>ipc_perm</code>结构体将被初始化，并且权限相关的标志位将会被设置。</li>
<li><code>msg_qnum</code>、<code>msg_lspid</code>、<code>msg_stime</code>和<code>msg_rtime</code>被设置为0</li>
<li><code>msg_ctime</code>被设置为当前时间</li>
<li><code>msg_qbytes</code>被设置为系统的限制</li>
</ul>
<h3 id="msgctl"><a href="#msgctl" class="headerlink" title="msgctl"></a>msgctl</h3><p>针对消息队列执行操作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">msgctl</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">int</span> cmd, <span class="hljs-keyword">struct</span> msqid_ds *buf)</span>;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>IPC_STAT</code>：获取<code>msqid_ds</code>结构体信息</li>
<li><code>IPC_SET</code>：将<code>buf</code>指向的<code>msg_perm.uid</code>、<code>msg_perm.gid</code>、<code>msg_prerm.mode</code>和<code>msg_gbytes</code>拷贝到与消息队列相关的<code>msqid_ds</code>结构</li>
<li><code>IPC_RMID</code>：从系统中删除消息队列以及队列中所有数据</li>
</ul>
<h3 id="msgsnd"><a href="#msgsnd" class="headerlink" title="msgsnd"></a>msgsnd</h3><p>将数据放入消息队列中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">msgnd</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *ptr, <span class="hljs-type">size_t</span> nbytes, <span class="hljs-type">int</span> flag)</span>;<br></code></pre></td></tr></table></figure>

<p>如果发送的最大数据为512字节，则可以使用下面的结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mymesg</span>&#123;</span><br>	<span class="hljs-type">long</span> mtype; <span class="hljs-comment">//消息类型</span><br>    <span class="hljs-type">char</span> mtext[<span class="hljs-number">512</span>]; <span class="hljs-comment">//消息数据，长度为n字节</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<h3 id="msgrcv"><a href="#msgrcv" class="headerlink" title="msgrcv"></a>msgrcv</h3><p>检索消息队列中的消息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">msgrcv</span><span class="hljs-params">(<span class="hljs-type">int</span> msgid, <span class="hljs-type">void</span> *ptr, <span class="hljs-type">size_t</span> nbytes, <span class="hljs-type">long</span> type, <span class="hljs-type">int</span> flag)</span>;<br><br>Returns:size of data portion of message <span class="hljs-keyword">if</span> OK, <span class="hljs-number">-1</span> on error<br></code></pre></td></tr></table></figure>

<p><code>type</code>参数指定需要返回哪个参数</p>
<ul>
<li><code>type == 0</code>：队列中的第一个消息返回</li>
<li><code>type &gt; 0</code>：返回与<code>type</code>一致的消息</li>
<li><code>type &lt; 0</code>：第一个小于或等于<code>type</code>绝对值的消息</li>
</ul>
<h2 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h2><p>为了获得共享资源，进程需要做以下操作</p>
<ul>
<li>测试控制资源的信号量</li>
<li>如果信号量的值是正数，则进程获得该资源，并且把信号量的值减去一</li>
<li>如果信号量的值为0，则进程需要休眠等待直到信号量的的值大于一，当进程被唤醒，重复操作一</li>
</ul>
<p><strong>信号量结构体semid_ds</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">semid_ds</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_perm</span> <span class="hljs-title">sem_perm</span>;</span> <span class="hljs-comment">/* see Section 15.6.2 */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> sem_nsems; <span class="hljs-comment">/* # of semaphores in set */</span><br><span class="hljs-type">time_t</span> sem_otime; <span class="hljs-comment">/* last-semop() time */</span><br><span class="hljs-type">time_t</span> sem_ctime; <span class="hljs-comment">/* last-change time */</span><br>...<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>每个信号量由至少包含以下成员的匿名结构表示</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> semval; <span class="hljs-comment">/* semaphore value, always &gt;= 0 */</span><br><span class="hljs-type">pid_t</span> sempid; <span class="hljs-comment">/* pid for last operation */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> semncnt; <span class="hljs-comment">/* # processes awaiting semval&gt;curval */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> semzcnt; <span class="hljs-comment">/* # processes awaiting semval==0 */</span><br>...<br>&#125;;<br></code></pre></td></tr></table></figure>

<h3 id="semget"><a href="#semget" class="headerlink" title="semget"></a>semget</h3><p><strong>获取信号量的id值</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">semget</span><span class="hljs-params">(<span class="hljs-type">key_t</span> key, <span class="hljs-type">int</span> nsems, <span class="hljs-type">int</span> flag)</span>;<br>Returns:semaphore ID <span class="hljs-keyword">if</span> OK, <span class="hljs-number">-1</span> on error<br></code></pre></td></tr></table></figure>

<h3 id="semctl"><a href="#semctl" class="headerlink" title="semctl"></a>semctl</h3><p><strong>操作信号量</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">semctl</span><span class="hljs-params">(<span class="hljs-type">int</span> semid, <span class="hljs-type">int</span> semnum, <span class="hljs-type">int</span> cmd, ...)</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">Returns:(see following)</span><br><span class="hljs-comment">For all the GET commands other than GETALL, the function returns the corresponding</span><br><span class="hljs-comment">value. For the remaining commands, the return value is 0 if the call succeeds. On error,</span><br><span class="hljs-comment">the semctl function sets errno and returns −1</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure>

<p><strong>第四个为可选参数，若存在则为senum类型</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">semun</span> &#123;</span><br><span class="hljs-type">int</span> val; <span class="hljs-comment">/* for SETVAL */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">semid_ds</span> *<span class="hljs-title">buf</span>;</span> <span class="hljs-comment">/* for IPC_STAT and IPC_SET */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> *<span class="hljs-built_in">array</span>; <span class="hljs-comment">/* for GETALL and SETALL */</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p><code>cmd</code>为执行的命令，命令选择如下</p>
<ul>
<li><p><code>IPC_STAT</code>：获取此集合的<code>semid_ds</code>结构，将其存储在<code>arg.buf</code>指向的结构中。</p>
</li>
<li><p><code>IPC_SET</code>：从与此集关联的<code>semid_ds</code>结构中<code>arg.buf</code>指向的结构中设置<code>sem_perm.uid</code>、<code>sem_perm.gid</code>和<code>sem_perm.mode</code>字段。此命令只能由有效用户ID等于<code>sem_perm.cuid</code>或<code>sem_perm.uid</code>的进程或具有超级用户权限的进程执行</p>
</li>
<li><p><code>IPC_RMID</code>：从系统中删除信号量集。此删除是立即的。任何其他仍在使用该信号量的进程在其下一次尝试对该信号量进行操作时都会收到<code>EIDRM</code>错误。</p>
<p>此命令只能由有效用户<code>ID</code>等于<code>sem_perm.cuid</code>或<code>sem_perm.uid</code>的进程或具有超级用户权限的进程执行。</p>
</li>
<li><p><code>GETVAL</code>：返回成员<code>semnum</code>的<code>semval</code>值</p>
</li>
<li><p><code>SETVAL</code>：设置成员<code>semnum</code>的<code>semval</code>值。该值由<code>arg.val</code>指定</p>
</li>
<li><p><code>GETPID</code>：返回成员<code>semnum</code>的<code>sempid</code>值</p>
</li>
<li><p><code>GETNCNT</code>：返回成员<code>semnum</code>的<code>semncnt</code>值</p>
</li>
<li><p><code>GETZCNT</code>：返回成员<code>semnum</code>的<code>semzcnt</code>值</p>
</li>
<li><p><code>GETALL</code>：获取集合中的所有信号量值。这些值存储在<code>arg.array</code>指向的数组中</p>
</li>
<li><p><code>SETALL</code>：将集合中的所有信号量值设置为<code>arg.array</code>指向的值</p>
</li>
</ul>
<h3 id="semop"><a href="#semop" class="headerlink" title="semop"></a>semop</h3><p><strong>原子地对信号集执行一系列操作</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">semop</span><span class="hljs-params">(<span class="hljs-type">int</span> semid, <span class="hljs-keyword">struct</span> sembuf semoparray[], <span class="hljs-type">size_t</span> nops)</span>;<br>Returns: <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK, −<span class="hljs-number">1</span> on error<br></code></pre></td></tr></table></figure>

<p><code>semoparray</code>参数是指向信号量操作数组的指针，由<code>sembuf</code>结构表示</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sembuf</span> &#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> sem_num; <span class="hljs-comment">/* member # in set (0, 1, ..., nsems-1) */</span><br><span class="hljs-type">short</span> sem_op; <span class="hljs-comment">/* operation (negative, 0, or positive) */</span><br><span class="hljs-type">short</span> sem_flg; <span class="hljs-comment">/* IPC_NOWAIT, SEM_UNDO */</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>结构体<code>sembuf</code>中地<code>sem_op</code>变量定义了对信号集的操作</p>
<ul>
<li><code>sem_op</code>为正值，则对应的进程归还资源。<code>sem_op</code>的值被加到信号量的值上。如果指定<code>undo</code>标志，则还将该进程的信号量调整值减去<code>sem_op</code></li>
<li><code>sem_op</code>为负值，希望获得信号量控制的资源。则从信号量值中减去<code>sem_op</code>绝对值。这保证了生成的信号量值大于或等于0。如果指定了<code>undo</code>标志，则<code>sem_op</code>的绝对值也会添加到此进程的信号量调整值中。<ul>
<li>如果信号量的值小于<code>sem_op</code>的绝对值，则以下条件使用<ul>
<li>指定了<code>IPC_NOWAIT</code>，则<code>semop</code>返回错误<code>EAGAIN</code></li>
<li>未指定<code>IPC_NOWAIT</code>，则信号量的<code>semncnt</code>值递增，并且调用过程暂停，直到出现以下情况<ul>
<li>信号量的值大于或等于<code>sem_op</code>的绝对值，此时信号量的<code>semncnt</code>值减少，并且从信号量的值中减去<code>sem_op</code>的绝对值。如果指定了<code>undo</code>标志，则<code>sem_op</code>的绝对值也会添加到此进程的信号量调整值中。</li>
<li>信号量从系统中被移除。函数返回<code>EIDRM</code></li>
<li>信号被捕捉，信号量中的<code>semncnt</code>值递减，并且函数返回<code>EINTR</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><code>sem_op</code>值为0，代表进程需要等待直到信号量的值为0<ul>
<li>如果信号量的值当前为0，则函数立即返回</li>
<li>如果信号量的值是非零，则发生以下的情况<ul>
<li>如果<code>IPC_NOWAIT</code>被指定，则<code>error</code>被标记为<code>EAGIN</code></li>
<li>如果<code>IPC_NOWAIT</code>被指定，则<code>semzcnt</code>的值递增，并且调用进程悬挂直到以下的情况发生<ul>
<li>信号量的值变为0。信号量的<code>semzcnt</code>递减</li>
<li>信号量从系统中被移除。函数返回并将<code>error</code>设置为<code>EIDRM</code></li>
<li>信号被捕捉。信号量的<code>semzcnt</code>递减，并且函数返回并将<code>error</code>设置为<code>EINTR</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="共享内存"><a href="#共享内存" class="headerlink" title="共享内存"></a>共享内存</h2><p>共享内存允许两个或多个进程共享给定的内存区域。</p>
<p><strong>共享内存的结构体</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shmid_ds</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_perm</span> <span class="hljs-title">shm_perm</span>;</span> <span class="hljs-comment">/* see Section 15.6.2 */</span><br><span class="hljs-type">size_t</span> shm_segsz; <span class="hljs-comment">/* size of segment in bytes */</span><br><span class="hljs-type">pid_t</span> shm_lpid; <span class="hljs-comment">/* pid of last shmop() */</span><br><span class="hljs-type">pid_t</span> shm_cpid; <span class="hljs-comment">/* pid of creator */</span><br><span class="hljs-type">shmatt_t</span> shm_nattch; <span class="hljs-comment">/* number of current attaches */</span><br><span class="hljs-type">time_t</span> shm_atime; <span class="hljs-comment">/* last-attach time */</span><br><span class="hljs-type">time_t</span> shm_dtime; <span class="hljs-comment">/* last-detach time */</span><br><span class="hljs-type">time_t</span> shm_ctime; <span class="hljs-comment">/* last-change time */</span><br>...<br>&#125;;<br></code></pre></td></tr></table></figure>

<h3 id="shmget"><a href="#shmget" class="headerlink" title="shmget"></a>shmget</h3><p><strong>获取共享内存的identifier</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/shm.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">shmget</span><span class="hljs-params">(<span class="hljs-type">key_t</span> key, <span class="hljs-type">size_t</span> size, <span class="hljs-type">int</span> flag)</span>;<br>Returns:shared memory ID <span class="hljs-keyword">if</span> OK, <span class="hljs-number">-1</span> on error<br></code></pre></td></tr></table></figure>

<h3 id="shmctl"><a href="#shmctl" class="headerlink" title="shmctl"></a>shmctl</h3><p><strong>操作共享内存</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/shm.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">shmctl</span><span class="hljs-params">(<span class="hljs-type">int</span> shmid, <span class="hljs-type">int</span> cmd, <span class="hljs-keyword">struct</span> shmid_ds *buf)</span>;<br><br>Returns:<span class="hljs-number">0</span> <span class="hljs-keyword">if</span> OK, <span class="hljs-number">-1</span> on error<br></code></pre></td></tr></table></figure>

<p><code>cmd</code>指示了操作的行为</p>
<ul>
<li><code>IPC_STAT</code>：从段中获取<code>shmid_ds</code>结构体，并且将这个结构存入<code>buf</code></li>
<li><code>IPC_SET</code>：从与此共享内存段关联的<code>shmid_ds</code>结构中<code>buf</code>指向的结构中设置以下三个字段：<code>shm_perm.uid</code>、<code>shm_perm_gid</code>和<code>shm_perm.mode</code>。此命令只能由有效用户ID等于<code>shm_permcuid</code>或<code>shm_perk.uid</code>的进程或具有超级用户权限的进程执行。</li>
<li><code>IPC_RMID</code>：从系统中删除共享内存段集。由于为共享内存段（<code>shmid_ds</code>结构中的<code>shm_attch</code>字段）保留了一个附加计数，因此在使用该段的最后一个进程终止或分离该段之前，不会删除该段。无论该段是否仍在使用，都会立即删除该段的标识符，以便<code>shmat</code>不再附加该段。此命令只能由有效用户<code>ID</code>等于<code>shm_perm.uid</code>或<code>shm_perm.uid</code>的进程或具有超级用户权限的进程执行。</li>
</ul>
<p><strong>LINUX额外增加的命令</strong></p>
<ul>
<li><code>SHM_LOCK</code>：将共享内存段锁定在内存中。此命令只能由超级用户执行。</li>
<li><code>SHM_UNLOCK</code>：解锁共享内存段。此命令只能由超级用户执行。</li>
</ul>
<h3 id="shmat"><a href="#shmat" class="headerlink" title="shmat"></a>shmat</h3><p>共享存储段连接到调用进程的哪个地址上与<code>addr</code>参数以及<code>flag</code>中是否制定<code>SHM_RND</code>位有关</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/shm.h&gt;</span></span><br><br><span class="hljs-type">void</span> *<span class="hljs-title function_">shmat</span><span class="hljs-params">(<span class="hljs-type">int</span> shmid, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *addr, <span class="hljs-type">int</span> flag)</span>;<br><span class="hljs-comment">//Returns: pointer to shared memory segment if OK, -1 on error</span><br></code></pre></td></tr></table></figure>

<ul>
<li><p><code>addr</code>为0：则此段链接到由内核选择的第一个可用地址上。</p>
</li>
<li><p><code>addr</code>非0并且<code>SHM_RND</code>没被指定，该段被附着的地址为<code>addr</code></p>
</li>
<li><p><code>addr</code>非0并且指定<code>SHM_RND</code>，该段被附着的地址为<code>addr</code>-（<code>addr</code> % <code>SHMLBA</code>）.<code>SHM_RND</code>为取整。</p>
</li>
<li><p>若<code>flag</code>的指定了<code>SHM_RDONLY</code>位，则以只读形式连接此段，否则以读写形式连接此段。</p>
</li>
</ul>
<h3 id="shmdt"><a href="#shmdt" class="headerlink" title="shmdt"></a>shmdt</h3><p>使用<code>shmdt</code>函数可以将地址从共享存储段中分离。并不是<strong>删除</strong>，直到带<code>IPC_RMID</code>命令的调用<code>shmctl</code>特地删除。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/shm.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">shmdt</span><span class="hljs-params">(<span class="hljs-type">const</span> vidd *addr)</span>;<br><span class="hljs-comment">//返回值：成功返回0，出错，返回-1</span><br></code></pre></td></tr></table></figure>

<p><strong>example1</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/shm.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ARRAY_SIZE 40000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MALLOC_SIZE 100000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SHM_SIZE 1000000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SHM_MODE 0600</span><br><br><span class="hljs-type">char</span> <span class="hljs-built_in">array</span>[ARRAY_SIZE];<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> shmid;<br>    <span class="hljs-type">char</span> *ptr, *shmptr;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;array[] from %p to %p\n&quot;</span>,(<span class="hljs-type">void</span> *)&amp;<span class="hljs-built_in">array</span>[<span class="hljs-number">0</span>], (<span class="hljs-type">void</span> *)&amp;<span class="hljs-built_in">array</span>[ARRAY_SIZE]);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;stack around %p\n&quot;</span>,(<span class="hljs-type">void</span> *)&amp;shmid);<br><br>    <span class="hljs-keyword">if</span> ((ptr = <span class="hljs-built_in">malloc</span>(MALLOC_SIZE)) == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;malloc error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;malloced from %p to %p\n&quot;</span>, (<span class="hljs-type">void</span> *)ptr, (<span class="hljs-type">void</span> *)ptr+MALLOC_SIZE);<br><br>    <span class="hljs-keyword">if</span> ((shmid = shmget(IPC_PRIVATE, SHM_SIZE, SHM_MODE)) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;shmget error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> ((shmptr = shmat(shmid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)) == (<span class="hljs-type">void</span> *)<span class="hljs-number">-1</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;shmat error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;shared memory attached from %p to %p\n&quot;</span>, (<span class="hljs-type">void</span> *)shmptr, (<span class="hljs-type">void</span> *)shmptr+SHM_SIZE);<br><br>    <span class="hljs-keyword">if</span> (shmctl(shmid, IPC_RMID, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;shmctl error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>example2</strong></p>
<p>使用<code>/dev/zero</code>设备使得两个相关进程共享一段匿名内存</p>
<p>使用<code>/dev/zero</code>设备的好处</p>
<ul>
<li>创建一个未命名的存储区，长度为<code>mmap</code>的第二个参数，页对齐</li>
<li>存储区都初始化为0</li>
<li>若指定了<code>MAP_SHARED</code>则进程共享此区域</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NLOOPS 1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIZE sizeof(long)</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> pfd1[<span class="hljs-number">2</span>], pfd2[<span class="hljs-number">2</span>];<br><br><span class="hljs-type">void</span> <br><span class="hljs-title function_">TELL_WAIT</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(pipe(pfd1) &lt; <span class="hljs-number">0</span> || pipe(pfd2) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//初始化两个管道</span><br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;pipe error!\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//pfd2父进程写，子进程读</span><br><span class="hljs-type">void</span><br><span class="hljs-title function_">TELL_PARENT</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> pid)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (write(pfd2[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;c&quot;</span>, <span class="hljs-number">1</span>) != <span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;write error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <br><span class="hljs-title function_">WAIT_PARENT</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> c;<br>    <span class="hljs-keyword">if</span> (read(pfd1[<span class="hljs-number">0</span>], &amp;c, <span class="hljs-number">1</span>) != <span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;read error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (c != <span class="hljs-string">&#x27;p&#x27;</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;WAIT_PARENT: incorrect data&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//pfd1为子进程写，父进程读</span><br><span class="hljs-type">void</span> <br><span class="hljs-title function_">TELL_CHILD</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> pid)</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(write(pfd1[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;p&quot;</span>, <span class="hljs-number">1</span>) != <span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;write error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">WAIT_CHILD</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> c;<br>    <span class="hljs-keyword">if</span> (read(pfd2[<span class="hljs-number">0</span>], &amp;c, <span class="hljs-number">1</span>) != <span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;read error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (c != <span class="hljs-string">&#x27;c&#x27;</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-string">&quot;WAIT_CHILD: incorrect data&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">update</span><span class="hljs-params">(<span class="hljs-type">long</span> *ptr)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> ((*ptr)++);<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> fd, i, counter;<br>    <span class="hljs-type">pid_t</span> pid;<br>    <span class="hljs-type">void</span> *area;<br><br>    <span class="hljs-keyword">if</span> ((fd = open(<span class="hljs-string">&quot;/dev/zero&quot;</span>, O_RDWR)) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;open error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> ((area = mmap(<span class="hljs-number">0</span>, SIZE, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="hljs-number">0</span>)) == MAP_FAILED) <span class="hljs-comment">//将/dev/zero文件映射到内存中</span><br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;mmap error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    close(fd);<br><br>    TELL_WAIT(); <span class="hljs-comment">//注册管道</span><br><br>    <span class="hljs-keyword">if</span> ((pid = fork()) &lt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;fork error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid &gt; <span class="hljs-number">0</span>)&#123; <span class="hljs-comment">//父进程</span><br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; NLOOPS; i += <span class="hljs-number">2</span>)&#123;<br>            <span class="hljs-keyword">if</span> ((counter = update((<span class="hljs-type">long</span> *)area)) != i)<br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;parent: expected %d, got %d&quot;</span>,i, counter);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br><br>            TELL_CHILD(pid);<br>            WAIT_CHILD();<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt; NLOOPS + <span class="hljs-number">1</span>; i += <span class="hljs-number">2</span>)&#123;<br>            WAIT_PARENT();<br><br>            <span class="hljs-keyword">if</span> ((counter = update((<span class="hljs-type">long</span> *)area)) != i)<br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;child: expected %d, got %d&quot;</span>, i, counter);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br><br>            TELL_PARENT(getppid());<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="匿名映射"><a href="#匿名映射" class="headerlink" title="匿名映射"></a>匿名映射</h3><p><code>MAP_ANON</code>为建立匿名映射区域</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">mmap(<span class="hljs-number">0</span>, SIZE, PROT_READ | PROT_WRITE, MAP_ANON | MAP_SHARED, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure>

<h2 id="POSIX信号量"><a href="#POSIX信号量" class="headerlink" title="POSIX信号量"></a>POSIX信号量</h2><p><code>POSX</code>信号量分为命名信号量与匿名信号量</p>
<h3 id="sem-open"><a href="#sem-open" class="headerlink" title="sem_open"></a>sem_open</h3><p>创建和使用命名信号量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><br><span class="hljs-type">sem_t</span> *<span class="hljs-title function_">sem_open</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">int</span> oflag, <span class="hljs-type">mode_t</span> mode, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> value)</span>;<br><span class="hljs-comment">//返回值：成功，返回指向信号量的指针；若出错，返回SEM_FAILED</span><br></code></pre></td></tr></table></figure>

<ul>
<li>当使用现有的信号量时，只需要指定<code>name</code>和<code>oflag</code>参数为0即可。</li>
<li>当使用<code>oflag</code>为<code>O_CREAT</code>标志时，若信号量不存在则会创建，若存在则直接使用<ul>
<li>需要额外指定两个参数<ul>
<li><code>mode</code>：谁可以访问该信号量</li>
<li><code>value</code>：指定信号量的初始化值，范围为<code>0-SEM_VALUE_MAX</code></li>
</ul>
</li>
</ul>
</li>
<li>若想确保信号量为新建，则可以指定<code>oflag</code>为<code>O_CREAT|O_EXCL</code>，若信号量已存在则会导致<code>sem_open</code>失败</li>
</ul>
<h3 id="sem-close"><a href="#sem-close" class="headerlink" title="sem_close"></a>sem_close</h3><p>关闭信号量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">sem_close</span><span class="hljs-params">(<span class="hljs-type">sem_t</span> *sem)</span>;<br><span class="hljs-comment">//返回值：若成功，返回0；若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<h3 id="sem-unlink"><a href="#sem-unlink" class="headerlink" title="sem_unlink"></a>sem_unlink</h3><p>销毁命名信号量，若没有对信号量的引用则直接销毁，若存在则等待到没引用时进行销毁。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">sem_unlink</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span>;<br><br><span class="hljs-comment">//返回值：若成功，返回0；若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<h3 id="sem-wait和sem-trywait"><a href="#sem-wait和sem-trywait" class="headerlink" title="sem_wait和sem_trywait"></a>sem_wait和sem_trywait</h3><p>对信号量进行减一操作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">sem_trywait</span><span class="hljs-params">(<span class="hljs-type">sem_t</span> *sem)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">sem_wait</span><span class="hljs-params">(<span class="hljs-type">sem_t</span> *sem)</span>;<br><br><span class="hljs-comment">//两个函数的返回值：若成功，返回0；若出错则返回-1</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>sem_wait</code>，若信号量为0会阻塞</li>
<li><code>sem_trywait</code>，若信号量为0不会阻塞，而是直接返回-1并且将<code>errno</code>设置为<code>EAGAIN</code></li>
</ul>
<h3 id="sem-timedwait"><a href="#sem-timedwait" class="headerlink" title="sem_timedwait"></a>sem_timedwait</h3><p>阻塞一段时间</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">sem_timedwait</span><span class="hljs-params">(<span class="hljs-type">sem_t</span> *<span class="hljs-keyword">restrict</span> sem,<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> timespec *<span class="hljs-keyword">restrict</span> tsptr)</span>;<br><span class="hljs-comment">//返回值：若成功，返回0；若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<ul>
<li>若超时则直接返回-1，将<code>errno</code>设置为<code>ETIMEDOUT</code></li>
</ul>
<h3 id="sem-post"><a href="#sem-post" class="headerlink" title="sem_post"></a>sem_post</h3><p>将信号量值增加1</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">sem_post</span><span class="hljs-params">(<span class="hljs-type">sem_t</span> *sem)</span>;<br><br><span class="hljs-comment">//返回值：若成功，返回0;若出错,返回-1</span><br></code></pre></td></tr></table></figure>

<h3 id="sem-init"><a href="#sem-init" class="headerlink" title="sem_init"></a>sem_init</h3><p>创建未命名的信号量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">sem_init</span><span class="hljs-params">(<span class="hljs-type">sem_t</span> *sem, <span class="hljs-type">int</span> pshared, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> value)</span>;<br><span class="hljs-comment">//返回值：若成功，返回0；若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>pshared</code>：表明是否再多个进程中使用变量<ul>
<li>是，非零值</li>
</ul>
</li>
<li><code>value</code>：指定了信号量的初始值</li>
</ul>
<h3 id="sem-destory"><a href="#sem-destory" class="headerlink" title="sem_destory"></a>sem_destory</h3><p>用于丢弃信号量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">sem_destroy</span><span class="hljs-params">(<span class="hljs-type">sem_t</span> *sem)</span>;<br><br><span class="hljs-comment">//返回值：若成功，返回0；若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<h3 id="sem-getvalue"><a href="#sem-getvalue" class="headerlink" title="sem_getvalue"></a>sem_getvalue</h3><p>检索信号量值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">sem_getvalue</span><span class="hljs-params">(<span class="hljs-type">sem_t</span> *<span class="hljs-keyword">restrict</span> sem, <span class="hljs-type">int</span> *<span class="hljs-keyword">restrict</span> valp)</span>;<br><span class="hljs-comment">//返回值：若成功，返回0；若出错，返回-1.</span><br></code></pre></td></tr></table></figure>

<ul>
<li>函数执行成功后，值会被填充到<code>valp</code>中</li>
</ul>
<p><strong>15-35.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slock</span>&#123;</span><br>    <span class="hljs-type">sem__t</span> *semp;<br>    <span class="hljs-type">char</span> name[_POSIX_NAME_MAX];<br>&#125;;<br><br><span class="hljs-keyword">struct</span> slock *<br><span class="hljs-title function_">s_alloc</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slock</span> *<span class="hljs-title">sp</span>;</span><br>    <span class="hljs-type">static</span> <span class="hljs-type">int</span> cnt;<br><br>    <span class="hljs-keyword">if</span> ((sp = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> slock))) == <span class="hljs-literal">NULL</span>)<br>        <span class="hljs-keyword">return</span>(<span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">do</span>&#123;<br>        <span class="hljs-built_in">snprintf</span>(sp-&gt;name, <span class="hljs-keyword">sizeof</span>(sp-&gt;name), <span class="hljs-string">&quot;/%ld.%d&quot;</span>, (<span class="hljs-type">long</span>)getpid(), cnt++); <span class="hljs-comment">//记录信号量的名字</span><br>        sp-&gt;semp = sem_open(sp-&gt;name, O_CREAT|O_EXCL, S_IRWXU, <span class="hljs-number">1</span>); <span class="hljs-comment">//打开了信号量</span><br>    &#125; <span class="hljs-keyword">while</span> (((sp-&gt;semp == SEM_FAILED) &amp;&amp; (errno == EEXIST));<br>    <span class="hljs-keyword">if</span> (sp-&gt;semp == SEM_FAILED)&#123;<br>        <span class="hljs-built_in">free</span>(sp);<br>        <span class="hljs-keyword">return</span>(<span class="hljs-literal">NULL</span>);<br>    &#125;<br>    sem_unlink(sp-&gt;name);<br>    <span class="hljs-keyword">return</span>(sp);<br>&#125;<br><br><span class="hljs-type">void</span> <br>s_free(<span class="hljs-keyword">struct</span> slock *sp)<br>&#123;<br>    sem_close(sp-&gt;semp);<br>    <span class="hljs-built_in">free</span>(sp);<br>&#125;<br><br><span class="hljs-type">int</span><br>s_lock(<span class="hljs-keyword">struct</span> slock *sp)<br>&#123;<br>    <span class="hljs-keyword">return</span>(sem_wait(sp-&gt;semp));<br>&#125;<br><br><span class="hljs-type">int</span><br>s_trylock(<span class="hljs-keyword">struct</span> slock *sp)<br>&#123;<br>    <span class="hljs-keyword">return</span>(sem_trywait(sp-&gt;semp));<br>&#125;<br><br><span class="hljs-type">int</span><br>s_unlock(<span class="hljs-keyword">struct</span> slock *sp)<br>&#123;<br>    <span class="hljs-keyword">return</span>(sem_post(sp-&gt;semp));<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="网络IPC：套接字"><a href="#网络IPC：套接字" class="headerlink" title="网络IPC：套接字"></a>网络IPC：套接字</h1><h2 id="socket"><a href="#socket" class="headerlink" title="socket"></a>socket</h2><p>套接字是一个端点的抽象</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">socket</span><span class="hljs-params">(<span class="hljs-type">int</span> domain, <span class="hljs-type">int</span> type, <span class="hljs-type">int</span> protocol)</span>;<br><br><span class="hljs-comment">//返回值：若成功，返回文件（套接字）描述符；若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>domain</code>：通信的特性，包括地址格式，各个域的常数以<code>AF_</code>开头，表示地址族<ul>
<li><code>AF_INET</code>：<code>IPv4</code>因特尔域</li>
<li><code>AF_INET6</code>：<code>IPv6</code>因特尔域</li>
<li><code>AF_UNIX</code>：<code>UNIX</code>域</li>
<li><code>AF_UNSPEC</code>：未指定</li>
</ul>
</li>
<li><code>type</code>：套接字类型<ul>
<li><code>SOCK_DGRAM</code>：固定长度、无连接的、不可靠的报文传递</li>
<li><code>SOCK_RAW</code>：<code>IP</code>协议的数据报接口</li>
<li><code>SOCK_SEQPACKET</code>：固定长度的、有序的、可靠的、面向连接的报文传递</li>
<li><code>SOCK_STREAM</code>：有序的、可靠的、双向的、面向连接的字节流</li>
</ul>
</li>
<li><code>protocol</code>：协议类型，若为0则使用默认协议<ul>
<li><code>IPPROTO_IP</code>：<code>IPv4</code>网际协议</li>
<li><code>IPPROTO_IPV6</code>：<code>IPv6</code>网际协议</li>
<li><code>IPPROTO_ICMP</code>：控制报文协议</li>
<li><code>IPPROTO_TCP</code>：传输控制协议</li>
<li><code>IPPROTO_UDP</code>：用户数据包协议</li>
</ul>
</li>
</ul>
<p>在<code>Linux</code>内部，套接字被视为文件描述符，但是并不是所有对文件的操作都可以应用在套接字上</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>使用套接字时的行为</th>
</tr>
</thead>
<tbody><tr>
<td>close</td>
<td>释放套接字</td>
</tr>
<tr>
<td>Dup和dup2</td>
<td>和一般文件描述符一样复制</td>
</tr>
<tr>
<td>fchdir</td>
<td>失败，并且将<code>errno</code>设置为<code>ENOTDIR</code></td>
</tr>
<tr>
<td>fchomod</td>
<td>未指定</td>
</tr>
<tr>
<td>fchown</td>
<td>由实现定义</td>
</tr>
<tr>
<td>fcntl</td>
<td>支持一些命令，包括F_DUPFD、F_DUPFD_CLOEXEC、F_GETFD、F_GETEFL、F_GETOWN、F_SETFD、F_SETFL和F_SETOWN</td>
</tr>
<tr>
<td>Fdatasync和fsync</td>
<td>由实现定义</td>
</tr>
<tr>
<td>fstat</td>
<td>支持部分stat结构体成员，具体由实现定义</td>
</tr>
<tr>
<td>ftruncate</td>
<td>未指定</td>
</tr>
<tr>
<td>ioctl</td>
<td>支持部分命令，依赖于底层设备驱动</td>
</tr>
<tr>
<td>lseek</td>
<td>由实现的定义（通常失败时会将errno设为ESPIPE）</td>
</tr>
<tr>
<td>mmap</td>
<td>未指定</td>
</tr>
<tr>
<td>poll</td>
<td>正常工作</td>
</tr>
<tr>
<td>Pread和Pwrite</td>
<td>失败是会将errno设为ESPIPE</td>
</tr>
<tr>
<td>read和readv</td>
<td>与没有任何标志位的recv等价</td>
</tr>
<tr>
<td>select</td>
<td>正常工作</td>
</tr>
<tr>
<td>write和writev</td>
<td>与没有任何标志位的send等价</td>
</tr>
</tbody></table>
<h2 id="shutdown"><a href="#shutdown" class="headerlink" title="shutdown"></a>shutdown</h2><p>用来禁止一个套接字的<code>I/O</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd, <span class="hljs-type">int</span> how)</span>;<br><span class="hljs-comment">//返回值：若成功，返回0；若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>how</code>：用于指定禁止的行为<ul>
<li><code>SHUT_RD</code>：关闭读端，无法从套接字读取数据 </li>
<li><code>SHUT_WR</code>：关闭写端，无法从套接字发送数据</li>
<li><code>SHUT_RDWR</code>：关闭读写端，即无法从套接字发送数据也无法读取数据</li>
</ul>
</li>
</ul>
<h2 id="字节序转换"><a href="#字节序转换" class="headerlink" title="字节序转换"></a>字节序转换</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arpa/inet.h&gt;</span></span><br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">htonl</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> hostint32)</span>;<br><span class="hljs-comment">//返回值：以网络字节序表示的32位整数</span><br><span class="hljs-type">uint16_t</span> <span class="hljs-title function_">htons</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> hostint16)</span>;<br><span class="hljs-comment">//返回值：以网络字节序表示的16位整数</span><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">ntohl</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> netint32)</span>;<br><span class="hljs-comment">//返回值：以主机字节序表示的32位整数</span><br><span class="hljs-type">uint16_t</span> <span class="hljs-title function_">ntohs</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> netint16)</span>;<br><span class="hljs-comment">//返回值：以主机字节序表示的16位整数</span><br></code></pre></td></tr></table></figure>

<h2 id="地址格式"><a href="#地址格式" class="headerlink" title="地址格式"></a>地址格式</h2><p>为了使不同的地址都能够传入<code>socket</code>中，<code>Linux</code>使用相同的结构体管理地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr</span> &#123;</span><br>    <span class="hljs-type">sa_family_t</span> sa_family; <span class="hljs-comment">//地址族</span><br>    <span class="hljs-type">char</span> sa_data[<span class="hljs-number">14</span>]; <span class="hljs-comment">//地址长度</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>IPv4</code>因特网域，套接字使用<code>sockaddr_in</code>表示</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">in_addr</span>&#123;</span><br>	<span class="hljs-type">in_addr_t</span> s_addr; <span class="hljs-comment">//IPv4地址</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> &#123;</span><br>    <span class="hljs-type">sa_family_t</span> sin_family; <span class="hljs-comment">//地址族</span><br>    <span class="hljs-type">in_port_t</span> sin_port; <span class="hljs-comment">//端口号</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">in_addr</span> <span class="hljs-title">sin_addr</span>;</span> <span class="hljs-comment">//IPv4地址</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p><code>IPv6</code>因特网域，套接字使用<code>sockaddr_in6</code>表示</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">struct_in6_addr&#123;<br>	<span class="hljs-type">uint8_t</span> sa_addr[<span class="hljs-number">16</span>];<br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in6</span>&#123;</span><br>  <span class="hljs-type">sa_faimly_t</span> sin6_family; <span class="hljs-comment">//地址族</span><br>  <span class="hljs-type">in_port_t</span> sin6_port; <span class="hljs-comment">//端口号</span><br>  <span class="hljs-type">uint32_t</span> sin6_flowinfo; <span class="hljs-comment">//流信息相关，暂时未实现</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">in6_addr</span> <span class="hljs-title">sin6_addr</span>;</span> <span class="hljs-comment">//IPv6的地址</span><br>  <span class="hljs-type">uint32_t</span> sin6_scope_id; <span class="hljs-comment">//范围接口集</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>在<code>Linux</code>中，<code>sockaddr_in</code>的定义如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> &#123;</span><br>    <span class="hljs-type">sa_family_t</span> sin_family; <span class="hljs-comment">//地址族</span><br>    <span class="hljs-type">in_port_t</span> sin_port; <span class="hljs-comment">//端口号</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">in_addr</span> <span class="hljs-title">sin_addr</span>;</span> <span class="hljs-comment">//IPv4地址</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> sin_zero[<span class="hljs-number">8</span>]; <span class="hljs-comment">//填充字段</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<h2 id="inet-ntop和inet-pton"><a href="#inet-ntop和inet-pton" class="headerlink" title="inet_ntop和inet_pton"></a>inet_ntop和inet_pton</h2><p>用于二进制地址格式与点分十进制字符表示之间的相互转换</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arpa/inet.h&gt;</span></span><br><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">inet_ntop</span><span class="hljs-params">(<span class="hljs-type">int</span> domain, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *<span class="hljs-keyword">restrict</span> addr,</span><br><span class="hljs-params">                     <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> str, <span class="hljs-type">socklen_t</span> size)</span>;<br><span class="hljs-comment">//返回值：若成功，返回地址字符串指针；若出错，返回NULL</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">inet_pton</span><span class="hljs-params">(<span class="hljs-type">int</span> domain, <span class="hljs-type">const</span> <span class="hljs-type">char</span> * <span class="hljs-keyword">restrict</span> str, <span class="hljs-type">void</span> *<span class="hljs-keyword">restrict</span> addr)</span>;<br><span class="hljs-comment">//返回值：若成功，返回1；若格式无效，返回0；若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<h2 id="gethostent"><a href="#gethostent" class="headerlink" title="gethostent"></a>gethostent</h2><p>网络配置信息被存放在许多地方，例如在静态文件中<code>/etc/hosts</code>和<code>/etc/services</code>，名字服务管理，如域名系统或者网络信息服务。通过<code>gethostent</code>，都可以找到给定计算机系统的主机信息。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netdb.h&gt;</span></span><br><br><span class="hljs-keyword">struct</span> hostent *<span class="hljs-title function_">gethostent</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-comment">//返回值：若成功，返回指针；若出错，返回NULL</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">sethostent</span><span class="hljs-params">(<span class="hljs-type">int</span> stayopen)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">endhostent</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br></code></pre></td></tr></table></figure>

<p><code>hostent</code>结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">hostent</span>&#123;</span><br>    <span class="hljs-type">char</span> *h_name, <span class="hljs-comment">//主机名</span><br>    <span class="hljs-type">char</span> **h_aliases; <span class="hljs-comment">//别名</span><br>    <span class="hljs-type">int</span> h_addrtype; <span class="hljs-comment">//地址类型</span><br>    <span class="hljs-type">int</span> h_length; <span class="hljs-comment">//地址长度</span><br>    <span class="hljs-type">char</span> **h_addr_list; <span class="hljs-comment">//指向网络地址数组</span><br>    ...<br>&#125;;<br></code></pre></td></tr></table></figure>

<h2 id="getnetbyaddr和getnetbyname"><a href="#getnetbyaddr和getnetbyname" class="headerlink" title="getnetbyaddr和getnetbyname"></a>getnetbyaddr和getnetbyname</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netdb.h&gt;</span></span><br><br><span class="hljs-keyword">struct</span> netent *<span class="hljs-title function_">getnetbyaddr</span> <span class="hljs-params">(<span class="hljs-type">uint32_t</span> net, <span class="hljs-type">int</span> type)</span>;<br><span class="hljs-keyword">struct</span> netent *<span class="hljs-title function_">getnetbyname</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span>;<br><br><span class="hljs-keyword">struct</span> netent *<span class="hljs-title function_">getnetent</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">setnetent</span><span class="hljs-params">(<span class="hljs-type">int</span> stayopen)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">endnetent</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-comment">//若成功返回指针， 若出错返回NULL</span><br></code></pre></td></tr></table></figure>

<p><code>netent</code>结构包含以下字段</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">netent</span> &#123;</span><br>	<span class="hljs-type">char</span> *n_name;<br>	<span class="hljs-type">char</span> **n_aliases;<br>	<span class="hljs-type">int</span> n_addrtype;<br>	<span class="hljs-type">uint32_t</span> n_net;<br>	...<br>&#125;;<br></code></pre></td></tr></table></figure>

<h2 id="协议名字和协议编号之间映射"><a href="#协议名字和协议编号之间映射" class="headerlink" title="协议名字和协议编号之间映射"></a>协议名字和协议编号之间映射</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netdb.h&gt;</span></span><br><br><span class="hljs-keyword">struct</span> protoent *<span class="hljs-title function_">getprotobyname</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span>;<br><span class="hljs-keyword">struct</span> protoent *<span class="hljs-title function_">getprotobynumber</span><span class="hljs-params">(<span class="hljs-type">int</span> proto)</span>;<br><span class="hljs-keyword">struct</span> protoent *<span class="hljs-title function_">getprotoent</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-comment">//若成功，返回指针；若出错，返回NULL</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">setprotoent</span><span class="hljs-params">(<span class="hljs-type">int</span> stayopen)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">endprotoent</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br></code></pre></td></tr></table></figure>

<p><code>protoent</code>结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">protoent</span>&#123;</span><br>    <span class="hljs-type">char</span> *p_name; <span class="hljs-comment">//协议名</span><br>    <span class="hljs-type">char</span> **p_aliases; <span class="hljs-comment">//别名</span><br>    <span class="hljs-type">int</span> p_proto; <span class="hljs-comment">//协议号</span><br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="端口与服务映射"><a href="#端口与服务映射" class="headerlink" title="端口与服务映射"></a>端口与服务映射</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netdb.h&gt;</span></span><br><br><span class="hljs-keyword">struct</span> servent *<span class="hljs-title function_">getservbyname</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *proto)</span>;<br><span class="hljs-keyword">struct</span> servent *<span class="hljs-title function_">getserbyport</span><span class="hljs-params">(<span class="hljs-type">int</span> port, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *proto)</span>;<br><span class="hljs-keyword">struct</span> servent *<span class="hljs-title function_">getsetvent</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-comment">//若成功，返回指针，若出错，返回NULL</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">setservent</span><span class="hljs-params">(<span class="hljs-type">int</span> stayopen)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">endservent</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br></code></pre></td></tr></table></figure>

<p><code>servent</code>结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">servent</span>&#123;</span><br>    <span class="hljs-type">char</span> *s_name; <span class="hljs-comment">//服务名</span><br>    <span class="hljs-type">char</span> **s_aliases; <span class="hljs-comment">//别名</span><br>    <span class="hljs-type">int</span> s_port; <span class="hljs-comment">//端口号</span><br>    <span class="hljs-type">char</span> *s_proto; <span class="hljs-comment">//协议名</span><br>    ...<br>&#125;;<br></code></pre></td></tr></table></figure>

<h2 id="getaddrinfo"><a href="#getaddrinfo" class="headerlink" title="getaddrinfo"></a>getaddrinfo</h2><p><code>getaddrinfo</code>函数允许将一个主机名和一个服务名映射到一个地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netdb.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">getaddrinfo</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> host,</span><br><span class="hljs-params">               <span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> service,</span><br><span class="hljs-params">               <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> addrinfo *<span class="hljs-keyword">restrict</span> hint,</span><br><span class="hljs-params">               <span class="hljs-keyword">struct</span> addrinfo **<span class="hljs-keyword">restrict</span> res)</span>;<br><span class="hljs-comment">//返回值：若成功，返回0；若出错，返回非0错误码</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">freeaddrinfo</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> addrinfo *ai)</span>;<br></code></pre></td></tr></table></figure>

<p><code>getaddrinfo</code>函数返回一个链表结构<code>addrinfo</code>。可以用<code>freeaddrinfo</code>来释放一个或多个这种结构，取决于用<code>ai_next</code>字段链接起来的结构有多少。</p>
<p><code>addrinfo</code>结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">addrinfo</span>&#123;</span><br>    <span class="hljs-type">int</span> ai_flags; <span class="hljs-comment">//自定义行为</span><br>    <span class="hljs-type">int</span> ai_family; <span class="hljs-comment">//地址族</span><br>    <span class="hljs-type">int</span> ai_socktype; <span class="hljs-comment">//socket的类型</span><br>    <span class="hljs-type">int</span> ai_protocol; <span class="hljs-comment">//协议</span><br>    <span class="hljs-type">socklen_t</span> ai_addrlen; <span class="hljs-comment">//地址长度</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr</span> *<span class="hljs-title">ai_addr</span>;</span> <span class="hljs-comment">//地址</span><br>    <span class="hljs-type">char</span> *ai_canonname; <span class="hljs-comment">//主机的规范名称</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">addrinfo</span> *<span class="hljs-title">ai_next</span>;</span> <span class="hljs-comment">//链表的下一个</span><br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>hint</code>：用于过滤地址的模板</li>
</ul>
<table>
<thead>
<tr>
<th>标志</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>AI_ADDRCONFIG</td>
<td>查询配置的地址类型（IPv4或IPv6）</td>
</tr>
<tr>
<td>AI_ALL</td>
<td>查询IPv4和IPv6地址</td>
</tr>
<tr>
<td>AI_CANONNAME</td>
<td>需要一个规范的名字</td>
</tr>
<tr>
<td>AI_NUMERICHOST</td>
<td>以数字格式指定主机地址，不翻译</td>
</tr>
<tr>
<td>AI_NUMERICSERV</td>
<td>将服务指定为数字端口号，不翻译</td>
</tr>
<tr>
<td>AI_PASSIVE</td>
<td>套接字地址用于监听绑定</td>
</tr>
<tr>
<td>AI_V4MAPPED</td>
<td>如没有找到IPv6地址，返回映射到IPv6格式的IPv4地址</td>
</tr>
</tbody></table>
<h2 id="gai-strerror"><a href="#gai-strerror" class="headerlink" title="gai_strerror"></a>gai_strerror</h2><p>用于打印<code>getaddrinfo</code>的失败消息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netdb.h&gt;</span></span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">gai_strerror</span><span class="hljs-params">(<span class="hljs-type">int</span> error)</span>;<br><span class="hljs-comment">//返回值：指向描述错误的字符串的指针</span><br></code></pre></td></tr></table></figure>

<h2 id="getnameinfo"><a href="#getnameinfo" class="headerlink" title="getnameinfo"></a>getnameinfo</h2><p><code>getnameinfo</code>函数将一个地址转换成一个主机名和一个服务名</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netdb.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">getnameinfo</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> sockaddr *<span class="hljs-keyword">restrict</span> addr, <span class="hljs-type">socklen_t</span> alen,</span><br><span class="hljs-params">               <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> host, <span class="hljs-type">socklen_t</span> hostlen,</span><br><span class="hljs-params">               <span class="hljs-type">char</span> *<span class="hljs-keyword">restrict</span> service, <span class="hljs-type">socklen_t</span> servlen, <span class="hljs-type">int</span> flags)</span>;<br><span class="hljs-comment">//返回值：若成功，返回0；若出错，返回非0值</span><br></code></pre></td></tr></table></figure>

<p><code>flag</code>参数提供了控制翻译的方式</p>
<table>
<thead>
<tr>
<th>标志</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>NI_DGRAM</td>
<td>服务基于数据包而非基于流</td>
</tr>
<tr>
<td>NI_NAMEREQD</td>
<td>如果找不到主机名，将其作为一个错误对待</td>
</tr>
<tr>
<td>NI_NOFQDN</td>
<td>对于本地主机，仅返回全限定域名的节点名部分</td>
</tr>
<tr>
<td>NI_NUMERICHOST</td>
<td>返回主机地址的数字形式</td>
</tr>
<tr>
<td>NI_NUMERICSCOPE</td>
<td>对于IPv6，返回范围ID的数字形式</td>
</tr>
<tr>
<td>NI_NUMERICSERV</td>
<td>返回服务地址的数字形式，即端口号</td>
</tr>
</tbody></table>
<p><strong>16-9.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(SOLARIS)</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/in.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netdb.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arpa/inet.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(BSD)</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/in.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">void</span> <br><span class="hljs-title function_">print_family</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> addrinfo *aip)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; family \n&quot;</span>);<br>    <span class="hljs-keyword">switch</span>(aip-&gt;ai_family)&#123;<br>        <span class="hljs-keyword">case</span> AF_INET:<br>            <span class="hljs-comment">//IPv4</span><br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;inet\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> AF_INET6:<br>            <span class="hljs-comment">//IPv6</span><br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;inet6\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> AF_UNIX:<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;unix\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> AF_UNSPEC:<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;unspecified\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;unknown\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">print_type</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> addrinfo *aip)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; type \n&quot;</span>);<br>    <span class="hljs-keyword">switch</span> (aip-&gt;ai_socktype)&#123;<br>        <span class="hljs-keyword">case</span> SOCK_STREAM:<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;stream\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> SOCK_DGRAM:<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;datagram\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> SOCK_SEQPACKET:<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;seqpacket\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> SOCK_RAW:<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;raw\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;unknow (%d)\n&quot;</span>, aip-&gt;ai_socktype);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">print_protocol</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> addrinfo *aip)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; protocol \n&quot;</span>);<br>    <span class="hljs-keyword">switch</span> (aip-&gt;ai_protocol)<br>    &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;default\n&quot;</span>);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> IPPROTO_TCP:<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;TCP\n&quot;</span>);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> IPPROTO_UDP:<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;UDP\n&quot;</span>);<br>    <span class="hljs-keyword">case</span> IPPROTO_RAW:<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;raw\n&quot;</span>);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;unknow (%d)\n&quot;</span>, aip-&gt;ai_protocol);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">print_flags</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> addrinfo *aip)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;flags\n&quot;</span>);<br>    <span class="hljs-keyword">if</span> (aip-&gt;ai_flags == <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; 0&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (aip-&gt;ai_flags &amp; AI_PASSIVE)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; passive\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (aip-&gt;ai_flags &amp; AI_CANONNAME)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; cannon\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (aip-&gt;ai_flags &amp; AI_NUMERICHOST)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; numhost\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (aip-&gt;ai_flags &amp; AI_NUMERICSERV)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; numserv\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (aip-&gt;ai_flags &amp; AI_V4MAPPED)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; v4mapped\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (aip-&gt;ai_flags &amp; AI_ALL)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; all\n&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">addrinfo</span> *<span class="hljs-title">ailist</span>, *<span class="hljs-title">aip</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">addrinfo</span> <span class="hljs-title">hint</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> *<span class="hljs-title">sinp</span>;</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *addr;<br>    <span class="hljs-type">int</span> err;<br>    <span class="hljs-type">char</span> abuf[INET_ADDRSTRLEN];<br><br>    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">3</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;usage: %s nodename service&quot;</span>, argv[<span class="hljs-number">0</span>]);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    hint.ai_flags = AI_CANONNAME;<br>    hint.ai_family = <span class="hljs-number">0</span>;<br>    hint.ai_socktype = <span class="hljs-number">0</span>;<br>    hint.ai_protocol = <span class="hljs-number">0</span>;<br>    hint.ai_addrlen = <span class="hljs-number">0</span>;<br>    hint.ai_canonname = <span class="hljs-literal">NULL</span>;<br>    hint.ai_addr = <span class="hljs-literal">NULL</span>;<br>    hint.ai_next = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">if</span> ((err = getaddrinfo(argv[<span class="hljs-number">1</span>], argv[<span class="hljs-number">2</span>], &amp;hint, &amp;ailist)) != <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;getaddrinfo erro: %s&quot;</span>, gai_strerror(err));<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span> (aip = ailist; aip != <span class="hljs-literal">NULL</span>; aip = aip-&gt;ai_next)&#123;<br>        print_flags(aip);<br>        print_family(aip);<br>        print_type(aip);<br>        print_protocol(aip);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n\thost %s&quot;</span>, aip-&gt;ai_canonname ? aip-&gt;ai_canonname:<span class="hljs-string">&quot;-&quot;</span>);<br>        <span class="hljs-keyword">if</span> (aip-&gt;ai_family == AF_INET) &#123;<br>            sinp = (<span class="hljs-keyword">struct</span>  sockaddr_in *)aip-&gt;ai_addr;<br>            addr = inet_ntop(AF_INET, &amp;sinp-&gt;sin_addr, abuf, INET_ADDRSTRLEN);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; address %s&quot;</span>, addr?addr:<span class="hljs-string">&quot;unknown&quot;</span>);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; port %d&quot;</span>, ntohs(sinp-&gt;sin_port));<br>        &#125;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="bind"><a href="#bind" class="headerlink" title="bind"></a>bind</h2><p>服务器使用<code>bind</code>函数关联地址与套接字，服务器通常选择保留一个地址并且注册在<code>/etc/setvices</code>或者某个名字服务中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">bind</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> sockaddr *addr, <span class="hljs-type">socklen_t</span> len)</span>;<br><span class="hljs-comment">//返回值：若成功，返回0；若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<h2 id="getsockname"><a href="#getsockname" class="headerlink" title="getsockname"></a>getsockname</h2><p>调用<code>getsockname</code>函数来发现绑定到套接字上的地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">getsockname</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd, <span class="hljs-keyword">struct</span> sockaddr *<span class="hljs-keyword">restrict</span> addr, <span class="hljs-type">socklen_t</span> *<span class="hljs-keyword">restrict</span> alenp)</span>;<br><br><span class="hljs-comment">//返回值：若成功，返回0；若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>alenp</code>：指向整数指针，里面存放着缓冲区<code>sockaddr</code>的长度，若成功执行则将返回长度存放到该整数中</li>
</ul>
<h2 id="getpeername"><a href="#getpeername" class="headerlink" title="getpeername"></a>getpeername</h2><p>若与对等方建立了连接，那么通过<code>getpeername</code>函数可以获得对方绑定的地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">getpeername</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd, <span class="hljs-keyword">struct</span> sockaddr *<span class="hljs-keyword">restrict</span> addr, <span class="hljs-type">socklen_t</span> *<span class="hljs-keyword">restrict</span> alenp)</span>;<br></code></pre></td></tr></table></figure>

<h2 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h2><p><code>connect</code>函数用于需要建立客户端与服务器之间的连接，例如<code>SOCK_STREAM</code>或<code>SOCK_SEQPACKET</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">connect</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> sockaddr *addr, <span class="hljs-type">socklen_t</span> len)</span>;<br><span class="hljs-comment">//返回值：若成功，返回0；若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>sockfd</code>：本地的套接字</li>
<li><code>addr</code>：需要建立连接的远程地址</li>
</ul>
<p><strong>16-10.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAXSLEEP 128</span><br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">connect_retry</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> sockaddr *addr, <span class="hljs-type">socklen_t</span> alen)</span> <span class="hljs-comment">//重连</span><br>&#123;<br>    <span class="hljs-type">int</span> numsec;<br><br>    <span class="hljs-keyword">for</span> (numsec = <span class="hljs-number">1</span>; numsec &lt;= MAXSLEEP; numsec &lt;&lt;= <span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-keyword">if</span> (connect(sockfd, addr, alen) == <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">//连接出错</span><br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (numsec &lt;= MAXSLEEP/<span class="hljs-number">2</span>)<br>            sleep(numsec); <span class="hljs-comment">//休眠时间 1 2 4 8.....64 65 66 ....128</span><br>    &#125;<br>    <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>16-11.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAXSLEEP 128    </span><br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">connect_retry</span><span class="hljs-params">(<span class="hljs-type">int</span> domain, <span class="hljs-type">int</span> type, <span class="hljs-type">int</span> protocol, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> sockaddr *addr, <span class="hljs-type">socklen_t</span> alen)</span><br>&#123;<br>    <span class="hljs-type">int</span> numsec, fd;<br>    <span class="hljs-keyword">for</span> (numsec = <span class="hljs-number">1</span>; numsec &lt;= MAXSLEEP; numsec &lt;&lt;= <span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-keyword">if</span> ((fd = socket(domain, type, protocol)) &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>        <span class="hljs-keyword">if</span> (connect(fd, addr, alen) == <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span>(fd);<br>        &#125;<br>        close(fd);<br><br>        <span class="hljs-keyword">if</span> (numsec &lt;= MAXSLEEP/<span class="hljs-number">2</span>)<br>            sleep(numsec);<br>    &#125;<br>    <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="listen"><a href="#listen" class="headerlink" title="listen"></a>listen</h2><p>服务器调用<code>listen</code>函数表示愿意接受请求</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">listen</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd, <span class="hljs-type">int</span> backlog)</span>;<br><span class="hljs-comment">//返回值：若成功，返回0；若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>backlog</code>：提供提示，用于指示系统该进程所要入队的未完成连接请求数量</li>
</ul>
<h2 id="accept"><a href="#accept" class="headerlink" title="accept"></a>accept</h2><p>服务器用于接收连接</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">accpet</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd, <span class="hljs-keyword">struct</span> sockaddr *<span class="hljs-keyword">restrict</span> addr, <span class="hljs-type">socklen_t</span> *<span class="hljs-keyword">restrict</span> len)</span>;<br><span class="hljs-comment">//返回值：若成功，返回文件描述符；若出错返回-1</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>addr</code>：用于存储客户端的地址，不需要时可以设置为<code>NULL</code></li>
<li><code>len</code>：缓冲区的长度</li>
</ul>
<p><strong>16-12.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">initserver</span><span class="hljs-params">(<span class="hljs-type">int</span> type, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> sockaddr *addr, <span class="hljs-type">socklen_t</span> alen, <span class="hljs-type">int</span> qlen)</span><br>&#123;<br>    <span class="hljs-type">int</span> fd;<br>    <span class="hljs-type">int</span> err = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> ((fd = socket(addr-&gt;sa_family, type, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (bind(fd, addr, alen) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">goto</span> errout;<br>    <span class="hljs-keyword">if</span> (type == SOCK_STREAM || type == SOCK_SEQPACKET)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (listen(fd, qlen) &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">goto</span> errout;<br>    &#125;<br>    <span class="hljs-keyword">return</span>(fd);<br>    errout:<br>        err = errno;<br>        close(fd);<br>        errno  = err;<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="send"><a href="#send" class="headerlink" title="send"></a>send</h2><p>用于网络套接字发送数据，才使用这个函数之前，连接已经建立完毕</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">send</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> nbytes, <span class="hljs-type">int</span> flags)</span>;<br><span class="hljs-comment">//返回值：若成功，返回发送的字节数，若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230225192531323.png" srcset="/img/loading.gif" lazyload alt="image-20230225192531323"></p>
<h2 id="sendto"><a href="#sendto" class="headerlink" title="sendto"></a>sendto</h2><p>与<code>send</code>函数的唯一区别是该函数可以携带地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">sendto</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> nbytes, <span class="hljs-type">int</span> flags, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> sockaddr *destaddr, <span class="hljs-type">socklen_t</span> destlen)</span>;<br><span class="hljs-comment">//返回值：若成功，返回发送的字节数；若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<h2 id="sendmsg"><a href="#sendmsg" class="headerlink" title="sendmsg"></a>sendmsg</h2><p>与上两个发送函数的区别，信息以<code>msghdr</code>结构体携带</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">sendmsg</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> msghdr *msg, <span class="hljs-type">int</span> flags)</span>;<br><br><span class="hljs-comment">//返回值：若成功，返回发送的字节数；若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<p><strong>msghdr</strong>结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msghdr</span> &#123;</span><br><span class="hljs-type">void</span> *msg_name; <span class="hljs-comment">/* optional address */</span><br><span class="hljs-type">socklen_t</span> msg_namelen; <span class="hljs-comment">/* address size in bytes */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> *<span class="hljs-title">msg_iov</span>;</span> <span class="hljs-comment">/* array of I/O buffers */</span><br><span class="hljs-type">int</span> msg_iovlen; <span class="hljs-comment">/* number of elements in array */</span><br><span class="hljs-type">void</span> *msg_control; <span class="hljs-comment">/* ancillary data */</span><br><span class="hljs-type">socklen_t</span> msg_controllen; <span class="hljs-comment">/* number of ancillary bytes */</span><br><span class="hljs-type">int</span> msg_flags; <span class="hljs-comment">/* flags for received message */</span><br>...<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="recv"><a href="#recv" class="headerlink" title="recv"></a>recv</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">recv</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd, <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> nbytes, <span class="hljs-type">int</span> flags)</span>;<br><span class="hljs-comment">//返回值：返回数据的字节长度；若无可用数据或对等方已经按序结束，返回0；若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230225194325201.png" srcset="/img/loading.gif" lazyload alt="image-20230225194325201"></p>
<h2 id="recvfrom"><a href="#recvfrom" class="headerlink" title="recvfrom"></a>recvfrom</h2><p><code>recvfrom</code>函数与<code>recv</code>函数的区别在于可以接收发送信息方的地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">recvfrom</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd, <span class="hljs-type">void</span> *<span class="hljs-keyword">restrict</span> buf,<span class="hljs-type">size_t</span> len, <span class="hljs-type">int</span> flags, <span class="hljs-keyword">struct</span> sockaddr *<span class="hljs-keyword">restrict</span> addr, <span class="hljs-type">socklen_t</span> *<span class="hljs-keyword">restrict</span> addrlen)</span>;<br><span class="hljs-comment">//返回值：返回数据的字节长度；若无可用数据或对等方已经按序结束，返回0；若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<h2 id="recvmsg"><a href="#recvmsg" class="headerlink" title="recvmsg"></a>recvmsg</h2><p>使用<code>msghdr</code>结构体接收信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">recvmsg</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd, <span class="hljs-keyword">struct</span> msghdr *msg, <span class="hljs-type">int</span> flags)</span>;<br><span class="hljs-comment">//返回值：返回数据的字节长度；若无可用数据或对等方已经按序结束，返回0：若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230225200104067.png" srcset="/img/loading.gif" lazyload alt="image-20230225200104067"></p>
<p><strong>16-16.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netdb.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BUFLEN 128  </span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-type">int</span> <span class="hljs-title function_">connect_retry</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">int</span>, <span class="hljs-type">int</span>, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> sockaddr *, <span class="hljs-type">socklen_t</span>)</span>;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">print_uptime</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd)</span><br>&#123;<br>    <span class="hljs-type">int</span> n;<br>    <span class="hljs-type">char</span> buf[BUFLEN];<br><br>    <span class="hljs-keyword">while</span> ((n = recv(sockfd, buf, BUFLEN, <span class="hljs-number">0</span>)) &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;writing\n&quot;</span>);<br>        write(STDOUT_FILENO, buf, n);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (n &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;recv error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">addrinfo</span> *<span class="hljs-title">ailist</span>, *<span class="hljs-title">aip</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">addrinfo</span> <span class="hljs-title">hint</span>;</span><br>    <span class="hljs-type">int</span> sockfd, err;<br><br>    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">2</span>)OP[E]<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;usage: ruptime hostname&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(&amp;hint, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(hint));<br>    hint.ai_socktype = SOCK_STREAM; <span class="hljs-comment">//TCP连接</span><br>    hint.ai_canonname = <span class="hljs-literal">NULL</span>;<br>    hint.ai_addr = <span class="hljs-literal">NULL</span>;<br>    hint.ai_next = <span class="hljs-literal">NULL</span>;   <br>    <span class="hljs-keyword">if</span> ((err = getaddrinfo(argv[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;ruptime&quot;</span>, &amp;hint, &amp;ailist)) != <span class="hljs-number">0</span>) <span class="hljs-comment">//获取服务器名与服务对应的地址和端口</span><br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;getaddrinfo error: %s&quot;</span>, gai_strerror(err));<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span> (aip = ailist; aip != <span class="hljs-literal">NULL</span>; aip = aip-&gt;ai_next)&#123;<br>        <span class="hljs-keyword">if</span> ((sockfd = connect_retry(aip-&gt;ai_family, SOCK_STREAM, <span class="hljs-number">0</span>, aip-&gt;ai_addr, aip-&gt;ai_addrlen)) &lt; <span class="hljs-number">0</span>)&#123;<br>            err = errno;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            print_uptime(sockfd);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t connect to %s&quot;</span>,argv[<span class="hljs-number">1</span>]);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>16-17.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netdb.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BUFLEN 1024</span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-type">int</span> <span class="hljs-title function_">connect_retry</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">int</span>, <span class="hljs-type">int</span>, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> sockaddr *, <span class="hljs-type">socklen_t</span>)</span>;<br><br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">print_uptime</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd)</span><br>&#123;<br>    <span class="hljs-type">int</span> n;<br>    <span class="hljs-type">char</span> buf[BUFLEN];<br><br>    <span class="hljs-keyword">while</span> ((n = recv(sockfd, buf, BUFLEN, <span class="hljs-number">0</span>)) &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;writing\n&quot;</span>);<br>        write(STDOUT_FILENO, buf, n);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (n &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;recv error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">addrinfo</span> *<span class="hljs-title">ailist</span>, *<span class="hljs-title">aip</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">addrinfo</span> <span class="hljs-title">hint</span>;</span><br>    <span class="hljs-type">int</span> sockfd, err;<br><br>    <span class="hljs-built_in">memset</span>(&amp;hint, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(hint));<br>    hint.ai_socktype = SOCK_STREAM;<br>    hint.ai_canonname = <span class="hljs-literal">NULL</span>;<br>    hint.ai_addr = <span class="hljs-literal">NULL</span>;<br>    hint.ai_next = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-keyword">if</span> ((err = getaddrinfo(argv[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;ruptimed&quot;</span>, &amp;hint, &amp;ailist)) != <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;getaddrinfo error: %s&quot;</span>, gai_strerror(err));<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span> (aip = ailist; aip != <span class="hljs-literal">NULL</span>; aip = aip-&gt;ai_next)&#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;ai_canonname:%s&quot;</span>,aip-&gt;ai_canonname);<br>        <span class="hljs-keyword">if</span>((sockfd = connect_retry(aip-&gt;ai_family, SOCK_STREAM, <span class="hljs-number">0</span>, aip-&gt;ai_addr, aip-&gt;ai_addrlen)) &lt; <span class="hljs-number">0</span>)&#123;<br>            err = errno;<br>        &#125;<span class="hljs-keyword">else</span><br>        &#123;<br>            print_uptime(sockfd);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;can&#x27;t connect to %s&quot;</span>,argv[<span class="hljs-number">1</span>]);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>16-18.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netdb.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;syslog.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/resource.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> QLEN 10</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> HOST_NAME_MAX</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HOST_NAME_MAX 256</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-type">int</span> <span class="hljs-title function_">initserver</span><span class="hljs-params">(<span class="hljs-type">int</span> type, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> sockaddr *addr, <span class="hljs-type">socklen_t</span> alen, <span class="hljs-type">int</span> qlen)</span>;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">set_cloexec</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-type">int</span> val;<br><br>    <span class="hljs-keyword">if</span> ((val = fcntl(fd, F_GETFD, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    val |= FD_CLOEXEC; <span class="hljs-comment">//使用exec执行时，关闭该文件描述符</span><br><br>    <span class="hljs-keyword">return</span>(fcntl(fd, F_SETFD,val));<br>&#125;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">daemonize</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *cmd)</span><br>&#123;<br>	<span class="hljs-type">int</span>					i, fd0, fd1, fd2;<br>	<span class="hljs-type">pid_t</span>				pid;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rlimit</span>		<span class="hljs-title">rl</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigaction</span>	<span class="hljs-title">sa</span>;</span><br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Clear file creation mask.</span><br><span class="hljs-comment">	 */</span><br>	umask(<span class="hljs-number">0</span>);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Get maximum number of file descriptors.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (getrlimit(RLIMIT_NOFILE, &amp;rl) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;%s: can&#x27;t get file limit&quot;</span>, cmd);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Become a session leader to lose controlling TTY.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> ((pid = fork()) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;%s: can&#x27;t fork&quot;</span>, cmd);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid != <span class="hljs-number">0</span>) <span class="hljs-comment">/* parent */</span><br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>	setsid();<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Ensure future opens won&#x27;t allocate controlling TTYs.</span><br><span class="hljs-comment">	 */</span><br>	sa.sa_handler = SIG_IGN;<br>	sigemptyset(&amp;sa.sa_mask);<br>	sa.sa_flags = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">if</span> (sigaction(SIGHUP, &amp;sa, <span class="hljs-literal">NULL</span>) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;%s: can&#x27;t ignore SIGHUP&quot;</span>, cmd);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>	<span class="hljs-keyword">if</span> ((pid = fork()) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;%s: can&#x27;t fork&quot;</span>, cmd);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid != <span class="hljs-number">0</span>) <span class="hljs-comment">/* parent */</span><br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Change the current working directory to the root so</span><br><span class="hljs-comment">	 * we won&#x27;t prevent file systems from being unmounted.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (chdir(<span class="hljs-string">&quot;/&quot;</span>) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;%s: can&#x27;t change directory to /&quot;</span>, cmd);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Close all open file descriptors.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (rl.rlim_max == RLIM_INFINITY)<br>		rl.rlim_max = <span class="hljs-number">1024</span>;<br>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; rl.rlim_max; i++)<br>		close(i);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Attach file descriptors 0, 1, and 2 to /dev/null.</span><br><span class="hljs-comment">	 */</span><br>	fd0 = open(<span class="hljs-string">&quot;/dev/null&quot;</span>, O_RDWR);<br>	fd1 = dup(<span class="hljs-number">0</span>);<br>	fd2 = dup(<span class="hljs-number">0</span>);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Initialize the log file.</span><br><span class="hljs-comment">	 */</span><br>	openlog(cmd, LOG_CONS, LOG_DAEMON);<br>	<span class="hljs-keyword">if</span> (fd0 != <span class="hljs-number">0</span> || fd1 != <span class="hljs-number">1</span> || fd2 != <span class="hljs-number">2</span>) &#123;<br>		syslog(LOG_ERR, <span class="hljs-string">&quot;unexpected file descriptors %d %d %d&quot;</span>,<br>		  fd0, fd1, fd2);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br>&#125;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">serve</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd)</span><br>&#123;<br>    <span class="hljs-type">int</span> clfd, status;<br>    <span class="hljs-type">pid_t</span> pid;<br><br>    set_cloexec(sockfd);<br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-keyword">if</span> ((clfd = accept(sockfd, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>)) &lt; <span class="hljs-number">0</span>)&#123;<br>            syslog(LOG_ERR, <span class="hljs-string">&quot;ruptimed: accept error: %s&quot;</span>, strerror(errno));<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>((pid = fork()) &lt; <span class="hljs-number">0</span>)&#123;<br>            syslog(LOG_ERR, <span class="hljs-string">&quot;ruptimed: fork error: %s&quot;</span>,strerror(errno));<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">if</span>(dup2(clfd, STDOUT_FILENO) != STDOUT_FILENO ||<br>                dup2(clfd, STDERR_FILENO) != STDERR_FILENO) &#123;<br>                    syslog(LOG_ERR, <span class="hljs-string">&quot;ruptimed: unexpected error&quot;</span>);<br>                    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>                &#125;<br>        close(clfd);<br>        execl(<span class="hljs-string">&quot;/usr/bin/uptime&quot;</span>, <span class="hljs-string">&quot;uptime&quot;</span>, (<span class="hljs-type">char</span> *)<span class="hljs-number">0</span>);<br>        syslog(LOG_ERR, <span class="hljs-string">&quot;ruptimed: uunexpecred return from exec: %s&quot;</span>, strerror(errno));<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            close(clfd);<br>            waitpid(pid, &amp;status, <span class="hljs-number">0</span>);<br>        &#125;<br>    &#125; <br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">addrinfo</span> *<span class="hljs-title">ailist</span>, *<span class="hljs-title">aip</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">addrinfo</span> <span class="hljs-title">hint</span>;</span><br>    <span class="hljs-type">int</span> sockfd, err, n;<br>    <span class="hljs-type">char</span> *host;<br>    <br>    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;usgae: ruptimed&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> ((n = sysconf(_SC_HOST_NAME_MAX)) &lt; <span class="hljs-number">0</span>)<br>        n = HOST_NAME_MAX;<br>    <span class="hljs-keyword">if</span> ((host = <span class="hljs-built_in">malloc</span>(n)) == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;malloc error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (gethostname(host, n) &lt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;gethostname error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    daemonize(<span class="hljs-string">&quot;ruptimed&quot;</span>);<br>    <span class="hljs-built_in">memset</span>(&amp;hint, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(hint));<br>    hint.ai_flags = AI_CANONNAME;<br>    hint.ai_socktype = SOCK_STREAM;<br>    hint.ai_canonname = <span class="hljs-literal">NULL</span>;<br>    hint.ai_addr = <span class="hljs-literal">NULL</span>;<br>    hint.ai_next = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-keyword">if</span> ((err = getaddrinfo(host, <span class="hljs-string">&quot;ruptime&quot;</span>, &amp;hint, &amp;ailist)) != <span class="hljs-number">0</span>) &#123;<br>        syslog(LOG_ERR, <span class="hljs-string">&quot;ruptimed: getaddrinfo error: %s&quot;</span>,gai_strerror(err));<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span> (aip = ailist; aip != <span class="hljs-literal">NULL</span>; aip = aip-&gt;ai_next) &#123;<br>        <span class="hljs-keyword">if</span> ((sockfd = initserver(SOCK_STREAM, aip-&gt;ai_addr, aip-&gt;ai_addrlen, QLEN)) &gt;= <span class="hljs-number">0</span>) &#123;<br>            serve(sockfd);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>16-19.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netdb.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BUFLEN 128  </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TIMEOUT 20</span><br><br><span class="hljs-type">void</span> <br><span class="hljs-title function_">sigalrm</span><span class="hljs-params">(<span class="hljs-type">int</span> signo)</span><br>&#123;<br><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">print_uptime</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd, <span class="hljs-keyword">struct</span> addrinfo *aip)</span><br>&#123;<br>    <span class="hljs-type">int</span> n;;<br>    <span class="hljs-type">char</span> buf[BUFLEN];<br><br>    buf[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (sendto(sockfd, buf, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, aip-&gt;ai_addr, aip-&gt;ai_addrlen) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;sento error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    alarm(TIMEOUT);<br>    <span class="hljs-keyword">if</span> ((n = recvfrom(sockfd, buf, BUFLEN, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>)) &lt;<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-keyword">if</span> (errno != EINTR)<br>            alarm(<span class="hljs-number">0</span>);<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;recv error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    alarm(<span class="hljs-number">0</span>);<br>    write(STDOUT_FILENO, buf, n);<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">addrinfo</span> *<span class="hljs-title">ailist</span>, *<span class="hljs-title">aip</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">addrinfo</span> <span class="hljs-title">hint</span>;</span><br>    <span class="hljs-type">int</span> sockfd, err;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigaction</span> <span class="hljs-title">sa</span>;</span><br><br>    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">2</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;usage: ruptime hostname&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    sa.sa_handler = sigalrm;<br>    sa.sa_flags = <span class="hljs-number">0</span>;<br>    sigemptyset(&amp;sa.sa_mask);<br>    <span class="hljs-keyword">if</span> (sigaction(SIGALRM, &amp;sa, <span class="hljs-literal">NULL</span>) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;sigaction error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-built_in">memset</span>(&amp;hint, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(hint));<br>    hint.ai_socktype = SOCK_DGRAM; <span class="hljs-comment">//过滤模板</span><br>    hint.ai_canonname = <span class="hljs-literal">NULL</span>;<br>    hint.ai_addr = <span class="hljs-literal">NULL</span>;<br>    hint.ai_next = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">if</span> ((err = getaddrinfo(argv[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;ruptime&quot;</span>, &amp;hint, &amp;ailist)) != <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;getaddrinfo error :%s&quot;</span>,gai_strerror(err));<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span> (aip = ailist; aip != <span class="hljs-literal">NULL</span>; aip = aip-&gt;ai_next) &#123;<br>        <span class="hljs-keyword">if</span> ((sockfd = socket(aip-&gt;ai_family, SOCK_DGRAM, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>) &#123;<br>            err = errno;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            print_uptime(sockfd, aip);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t contact %s: %s\n&quot;</span>, argv[<span class="hljs-number">1</span>], strerror(err));<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>16-20.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netdb.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;syslog.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/resource.h&gt;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BUFLEN 128</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAXADDRLEN 256</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> HOST_NAME_MAX</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HOST_NAME_MAX 256</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-type">int</span> <span class="hljs-title function_">initserver</span><span class="hljs-params">(<span class="hljs-type">int</span> , <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> sockaddr *, <span class="hljs-type">socklen_t</span>, <span class="hljs-type">int</span>)</span>;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">daemonize</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *cmd)</span><br>&#123;<br>	<span class="hljs-type">int</span>					i, fd0, fd1, fd2;<br>	<span class="hljs-type">pid_t</span>				pid;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rlimit</span>		<span class="hljs-title">rl</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigaction</span>	<span class="hljs-title">sa</span>;</span><br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Clear file creation mask.</span><br><span class="hljs-comment">	 */</span><br>	umask(<span class="hljs-number">0</span>);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Get maximum number of file descriptors.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (getrlimit(RLIMIT_NOFILE, &amp;rl) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;%s: can&#x27;t get file limit&quot;</span>, cmd);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Become a session leader to lose controlling TTY.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> ((pid = fork()) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;%s: can&#x27;t fork&quot;</span>, cmd);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid != <span class="hljs-number">0</span>) <span class="hljs-comment">/* parent */</span><br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>	setsid();<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Ensure future opens won&#x27;t allocate controlling TTYs.</span><br><span class="hljs-comment">	 */</span><br>	sa.sa_handler = SIG_IGN;<br>	sigemptyset(&amp;sa.sa_mask);<br>	sa.sa_flags = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">if</span> (sigaction(SIGHUP, &amp;sa, <span class="hljs-literal">NULL</span>) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;%s: can&#x27;t ignore SIGHUP&quot;</span>, cmd);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>	<span class="hljs-keyword">if</span> ((pid = fork()) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;%s: can&#x27;t fork&quot;</span>, cmd);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid != <span class="hljs-number">0</span>) <span class="hljs-comment">/* parent */</span><br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Change the current working directory to the root so</span><br><span class="hljs-comment">	 * we won&#x27;t prevent file systems from being unmounted.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (chdir(<span class="hljs-string">&quot;/&quot;</span>) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;%s: can&#x27;t change directory to /&quot;</span>, cmd);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Close all open file descriptors.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (rl.rlim_max == RLIM_INFINITY)<br>		rl.rlim_max = <span class="hljs-number">1024</span>;<br>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; rl.rlim_max; i++)<br>		close(i);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Attach file descriptors 0, 1, and 2 to /dev/null.</span><br><span class="hljs-comment">	 */</span><br>	fd0 = open(<span class="hljs-string">&quot;/dev/null&quot;</span>, O_RDWR);<br>	fd1 = dup(<span class="hljs-number">0</span>);<br>	fd2 = dup(<span class="hljs-number">0</span>);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Initialize the log file.</span><br><span class="hljs-comment">	 */</span><br>	openlog(cmd, LOG_CONS, LOG_DAEMON);<br>	<span class="hljs-keyword">if</span> (fd0 != <span class="hljs-number">0</span> || fd1 != <span class="hljs-number">1</span> || fd2 != <span class="hljs-number">2</span>) &#123;<br>		syslog(LOG_ERR, <span class="hljs-string">&quot;unexpected file descriptors %d %d %d&quot;</span>,<br>		  fd0, fd1, fd2);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br>&#125;<br><br><span class="hljs-type">void</span> <br><span class="hljs-title function_">serve</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd)</span><br>&#123;<br>    <span class="hljs-type">int</span> n;<br>    <span class="hljs-type">socklen_t</span> alen;<br>    FILE *fp;<br>    <span class="hljs-type">char</span> buf[BUFLEN];<br>    <span class="hljs-type">char</span> abuf[MAXADDRLEN];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr</span> *<span class="hljs-title">addr</span> =</span> (<span class="hljs-keyword">struct</span> sockaddr *)abuf;<br><br>    set_cloexec(sockfd);<br>    <span class="hljs-keyword">for</span>(;;) &#123;<br>        alen = MAXADDRLEN;<br>        <span class="hljs-keyword">if</span> ((n = recvfrom(sockfd, buf, BUFLEN, <span class="hljs-number">0</span>, addr, &amp;alen)) &lt; <span class="hljs-number">0</span>) &#123;<br>            syslog(LOG_ERR, <span class="hljs-string">&quot;ruptimed: recvfrom error :%s&quot;</span>, strerror(errno));<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> ((fp = popen(<span class="hljs-string">&quot;/usr/bin/uptime&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>)) == <span class="hljs-literal">NULL</span>) &#123;<br>            <span class="hljs-built_in">sprintf</span>(buf, <span class="hljs-string">&quot;error: %s\n&quot;</span>, strerror(errno));<br>            sendto(sockfd, buf, <span class="hljs-built_in">strlen</span>(buf), <span class="hljs-number">0</span>, addr, alen);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (fgets(buf, BUFLEN, fp) != <span class="hljs-literal">NULL</span>)<br>                sendto(sockfd, buf, <span class="hljs-built_in">strlen</span>(buf), <span class="hljs-number">0</span>, addr, alen);<br>            pclose(fp);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">addrinfo</span> *<span class="hljs-title">ailist</span>, *<span class="hljs-title">aip</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">addrinfo</span> <span class="hljs-title">hint</span>;</span><br>    <span class="hljs-type">int</span> sockfd, err, n;<br>    <span class="hljs-type">char</span> *host;<br>    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;usage: ruptimed&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> ((n = sysconf(_SC_HOST_NAME_MAX)) &lt; <span class="hljs-number">0</span>)<br>        n = HOST_NAME_MAX;<br>    <span class="hljs-keyword">if</span> ((host = <span class="hljs-built_in">malloc</span>(n)) == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;malloc error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (gethostname(host, n) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;gethostname error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    daemonize(<span class="hljs-string">&quot;ruptimed&quot;</span>);<br>    <span class="hljs-built_in">memset</span>(&amp;hint, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(hint));<br>    hint.ai_flags = AI_CANONNAME;<br>    hint.ai_socktype = SOCK_DGRAM;<br>    hint.ai_canonname = <span class="hljs-literal">NULL</span>;<br>    hint.ai_addr = <span class="hljs-literal">NULL</span>;<br>    hint.ai_next = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">if</span> ((err = getaddrinfo(host, <span class="hljs-string">&quot;ruptime&quot;</span>, &amp;hint, &amp;ailist)) != <span class="hljs-number">0</span>)&#123;<br>        syslog(LOG_ERR, <span class="hljs-string">&quot;ruptimed: getaddrinfo error:%s&quot;</span>, gai_strerror(err));<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span> (aip = ailist; aip != <span class="hljs-literal">NULL</span>; aip = aip-&gt;ai_next) &#123;<br>        <span class="hljs-keyword">if</span> ((sockfd = initserver(SOCK_DGRAM, aip-&gt;ai_addr, aip-&gt;ai_addrlen, <span class="hljs-number">0</span>)) &gt;= <span class="hljs-number">0</span>)&#123;<br>            serve(sockfd);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="套接字选项"><a href="#套接字选项" class="headerlink" title="套接字选项"></a>套接字选项</h2><ul>
<li>通用选项</li>
<li>在套接字层次管理的选项，但是依赖于下层协议的支持</li>
<li>特定于某协议的选项，每个协议独有的</li>
</ul>
<h3 id="setsockopt"><a href="#setsockopt" class="headerlink" title="setsockopt"></a>setsockopt</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">setsockopt</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd, <span class="hljs-type">int</span> level, <span class="hljs-type">int</span> option, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *val, <span class="hljs-type">socklen_t</span> len)</span>;<br><span class="hljs-comment">//返回值：若成功，返回0；若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>level</code>：标识了选项应用的协议<ul>
<li>​	通用套接字层则为<code>SOL_SOCKET</code></li>
<li><code>TCP</code>为<code>IPPRTO_TCP</code></li>
<li><code>IP</code>为<code>IPPROTO_IP</code></li>
</ul>
</li>
</ul>
<p><img src="https://gitee.com/h0pe-ay/blogimages/raw/master/image-20230226202107691.png" srcset="/img/loading.gif" lazyload alt="image-20230226202107691"></p>
<ul>
<li><code>val</code>：根据选项的不同指向一个数据结构或者一个整数。<ul>
<li>选项是<code>on</code>&#x2F;<code>off</code>开关。若非零则启用，零则关闭</li>
</ul>
</li>
<li><code>len</code>：指定<code>val</code>指向的对象的大小</li>
</ul>
<h3 id="getsockopt"><a href="#getsockopt" class="headerlink" title="getsockopt"></a>getsockopt</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">getsockopt</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd, <span class="hljs-type">int</span> level, <span class="hljs-type">int</span> option, <span class="hljs-type">void</span> *<span class="hljs-keyword">restrict</span> val, <span class="hljs-type">socklen_t</span> *<span class="hljs-keyword">restrict</span> lenp)</span>;<br><span class="hljs-comment">//返回值：若成功，返回0；若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<h3 id="sockatmark"><a href="#sockatmark" class="headerlink" title="sockatmark"></a>sockatmark</h3><p>判断是否到达紧急标志</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">sockatmark</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd)</span>;<br><span class="hljs-comment">//返回值:若在标记处，返回-1；若没在标记处，返回0；若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<h1 id="高级进程间通信"><a href="#高级进程间通信" class="headerlink" title="高级进程间通信"></a>高级进程间通信</h1><h2 id="UNIX域套接字"><a href="#UNIX域套接字" class="headerlink" title="UNIX域套接字"></a>UNIX域套接字</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">socketpair</span><span class="hljs-params">(<span class="hljs-type">int</span> domain, <span class="hljs-type">int</span> type, <span class="hljs-type">int</span> protocol, <span class="hljs-type">int</span> sockfd[<span class="hljs-number">2</span>])</span>;<br><span class="hljs-comment">//返回值：若成功，返回0：若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<p><strong>17-2.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-type">int</span> <br><span class="hljs-title function_">fd_pipe</span><span class="hljs-params">(<span class="hljs-type">int</span> fd[<span class="hljs-number">2</span>])</span><br>&#123;<br>    <span class="hljs-keyword">return</span>(socketpair(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>, fd));<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>借助UNIX域套接字轮询XSI消息队列</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NQ 3</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAXMSZ 512</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KEY 0x123</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">threadinfo</span> &#123;</span><br>    <span class="hljs-type">int</span> qid; <span class="hljs-comment">//线程id</span><br>    <span class="hljs-type">int</span> fd; <span class="hljs-comment">//文件描述符</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mymesg</span> &#123;</span><br>    <span class="hljs-type">long</span> mtype; <span class="hljs-comment">//类型</span><br>    <span class="hljs-type">char</span> mtext[MAXMSZ]; <span class="hljs-comment">//字符串</span><br>&#125;;<br><br><span class="hljs-type">void</span> *<br><span class="hljs-title function_">helper</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    <span class="hljs-type">int</span> n;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mymesg</span> <span class="hljs-title">m</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">threadinfo</span> *<span class="hljs-title">tip</span> =</span> arg;<br><br>    <span class="hljs-keyword">for</span> (;;)&#123;<br>        <span class="hljs-built_in">memset</span>(&amp;m, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(m));<br>        <span class="hljs-keyword">if</span> ((n = msgrcv(tip-&gt;qid, &amp;m, MAXMSZ, <span class="hljs-number">0</span>, MSG_NOERROR)) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//检索消息队列中的第一条消息，标志位为MSG_NOERROR时，当消息大小超过msgze时被截断。</span><br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;msgrcv error!\n&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (write(tip-&gt;fd, m.mtext, n) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//不断地从队列中取出数据，并写入线程对应的文件描述符中</span><br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;write error!\n&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">int</span> i, n, err;<br>    <span class="hljs-type">int</span> fd[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span> qid[NQ];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pfd</span>[<span class="hljs-title">NQ</span>];</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">threadinfo</span> <span class="hljs-title">ti</span>[<span class="hljs-title">NQ</span>];</span><br>    <span class="hljs-type">pthread_t</span> tid[NQ];<br>    <span class="hljs-type">char</span> buf[MAXMSZ];<br><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; NQ; i++)&#123;<br>        <span class="hljs-keyword">if</span> ((qid[i] = msgget((KEY+i), IPC_CREAT | <span class="hljs-number">0666</span>)) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//创建队列</span><br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;msgget error\n&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;queue ID %d is %d\n&quot;</span>, i, qid[i]);<br><br>        <span class="hljs-keyword">if</span> (socketpair(AF_UNIX, SOCK_DGRAM, <span class="hljs-number">0</span>, fd) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//全双工的UINX域套接字</span><br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;pthread_create error&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        pfd[i].fd = fd[<span class="hljs-number">0</span>];<br>        pfd[i].events = POLLIN; <span class="hljs-comment">//感兴趣的事件</span><br>        ti[i].qid = qid[i];<br>        ti[i].fd = fd[<span class="hljs-number">1</span>];<br>        <span class="hljs-keyword">if</span> ((err = pthread_create(&amp;tid[i], <span class="hljs-literal">NULL</span>, helper, &amp;ti[i])) != <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;pthread create error!&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br><br>    &#125;<br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-keyword">if</span> (poll(pfd, NQ, <span class="hljs-number">-1</span>) &lt; <span class="hljs-number">0</span>)<span class="hljs-comment">//监听指定的事件</span><br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;poll error&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; NQ; i++) &#123;<br>            <span class="hljs-keyword">if</span> (pfd[i].revents &amp; POLLIN) &#123; <span class="hljs-comment">//判断到指定的描述符中有数据</span><br>                <span class="hljs-keyword">if</span> ((n = read(pfd[i].fd, buf, <span class="hljs-keyword">sizeof</span>(buf))) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//则从描述符中读取数据到缓存区中</span><br>                &#123;<br>                    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;read error&quot;</span>);<br>                    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>                &#125;<br>                buf[n] = <span class="hljs-number">0</span>;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;queue id %d, message %s\n&quot;</span>, qid[i], buf);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>17-4.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAXMSZ 512</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mymesg</span> &#123;</span><br>    <span class="hljs-type">long</span> mtype; <span class="hljs-comment">//消息类型</span><br>    <span class="hljs-type">char</span> mtext[MAXMSZ]; <span class="hljs-comment">//消息</span><br>&#125;;<br><br><span class="hljs-type">int</span> <br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>    <span class="hljs-type">key_t</span> key;<span class="hljs-comment">//关键值</span><br>    <span class="hljs-type">long</span> qid;<br>    <span class="hljs-type">size_t</span> nbytes;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mymesg</span> <span class="hljs-title">m</span>;</span><br><br>    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">3</span>) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span> ,<span class="hljs-string">&quot;usage: sendmsg KEY message\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    key = strtol(argv[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> ((qid = msgget(key, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t open queue key %s\n&quot;</span>, argv[<span class="hljs-number">1</span>]);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-built_in">memset</span>(&amp;m, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(m));<br>    <span class="hljs-built_in">strncpy</span>(m.mtext, argv[<span class="hljs-number">2</span>], MAXMSZ<span class="hljs-number">-1</span>);<br>    nbytes = <span class="hljs-built_in">strlen</span>(m.mtext);<br>    m.mtype = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (msgsnd(qid, &amp;m, nbytes, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t send message\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>17-5.c 命名UNIX域套接字</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/un.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span>	</span><br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>    <span class="hljs-type">int</span> fd, size;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_un</span> <span class="hljs-title">un</span>;</span>  <br><br>    un.sun_family = AF_UNIX; <br>    <span class="hljs-built_in">strcpy</span>(un.sun_path, <span class="hljs-string">&quot;foo.socket&quot;</span>); <span class="hljs-comment">//设置绑定路径</span><br>    <span class="hljs-keyword">if</span> ((fd = socket(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//创建套接字</span><br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;socket failed&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    size = offsetof(<span class="hljs-keyword">struct</span> sockaddr_un, sun_path) + <span class="hljs-built_in">strlen</span>(un.sun_path); <span class="hljs-comment">//计算路径长度 </span><br>    <span class="hljs-keyword">if</span> (bind(fd, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;un, size) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//绑定本地路径</span><br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;bind failed&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;UNIX domain socket bound\n&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="唯一连接"><a href="#唯一连接" class="headerlink" title="唯一连接"></a>唯一连接</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;apue.h&quot;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">serv_listen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span>;<br><span class="hljs-comment">//返回值：若成功，返回要监听的文件描述符； 若出差，返回负值</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">serv_acceptt</span><span class="hljs-params">(<span class="hljs-type">int</span> listenfd, <span class="hljs-type">uid_t</span> *uidptr)</span>;<br><span class="hljs-comment">//返回值：若成功，返回新文件描述符；若出差，返回负值</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">cli_conn</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span>;<br><span class="hljs-comment">//返回值：若成功，返回文件描述符；若出错，返回负值</span><br></code></pre></td></tr></table></figure>

<h3 id="serv-listen"><a href="#serv-listen" class="headerlink" title="serv_listen"></a>serv_listen</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/un.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span>	</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> QLEN 10</span><br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">serv_listern</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span><br>&#123;<br>    <span class="hljs-type">int</span> fd, len, err, rval;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span>  <span class="hljs-title">sockaddr_un</span> <span class="hljs-title">un</span>;</span><br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strlen</span>(name) &gt;= <span class="hljs-keyword">sizeof</span>(un.sun_path))<br>    &#123;<br>        errno = ENAMETOOLONG;<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> ((fd = socket(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-2</span>);<br><br>    unlink(name); <span class="hljs-comment">//删除文件名为name的文件</span><br><br>    <span class="hljs-built_in">memset</span>(&amp;un, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(un));<br>    un.sun_family = AF_UNIX;<br>    <span class="hljs-built_in">strcpy</span>(un.sun_path, name);<br>    len = offsetof(<span class="hljs-keyword">struct</span>  sockaddr_un, sun_path) + <span class="hljs-built_in">strlen</span>(name);<br><br>    <span class="hljs-keyword">if</span> (bind(fd, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;un, len) &lt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">//绑定sun_path路径</span><br>        rval = <span class="hljs-number">-3</span>;<br>        <span class="hljs-keyword">goto</span> errout;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (listen(fd, QLEN) &lt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">//开启监听</span><br>        rval = <span class="hljs-number">-4</span>;<br>        <span class="hljs-keyword">goto</span> errout;<br>    &#125;<br>    <span class="hljs-keyword">return</span>(fd);<br><br>errout:<br>    err = errno;<br>    close(fd);<br>    errno = err;<br>    <span class="hljs-keyword">return</span>(rval);<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="serv-accept"><a href="#serv-accept" class="headerlink" title="serv_accept"></a>serv_accept</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/un.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span>	</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STALE 30</span><br><br><span class="hljs-type">int</span> <br><span class="hljs-title function_">serve_accept</span><span class="hljs-params">(<span class="hljs-type">int</span> listenfd, <span class="hljs-type">uid_t</span> *uidptr)</span><br>&#123;<br>    <span class="hljs-type">int</span> clifd, err, rval;<br>    <span class="hljs-type">socklen_t</span> len;<br>    <span class="hljs-type">time_t</span> staletime;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">statbuf</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_un</span> <span class="hljs-title">un</span>;</span><br>    <span class="hljs-type">char</span> *name;<br><br>    <span class="hljs-keyword">if</span> ((name = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(un.sun_path) + <span class="hljs-number">1</span>)) == <span class="hljs-literal">NULL</span>)<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    len = <span class="hljs-keyword">sizeof</span>(un);<br>    <span class="hljs-keyword">if</span> ((clifd = accept(listenfd, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;un, &amp;len)) &lt; <span class="hljs-number">0</span>)&#123; <span class="hljs-comment">//等到客户端的请求</span><br>        <span class="hljs-built_in">free</span>(name);<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-2</span>);<br>    &#125;<br><br>    len -= offsetof(<span class="hljs-keyword">struct</span> sockaddr_un, sun_path);<br>    <span class="hljs-built_in">memcpy</span>(name, un.sun_path, len); <span class="hljs-comment">//客户端的地址</span><br>    name[len] = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (stat(name, &amp;statbuf) &lt; <span class="hljs-number">0</span>) &#123; <br>        rval = <span class="hljs-number">-3</span>;<br>        <span class="hljs-keyword">goto</span> errout;<br>    &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> S_ISSOCK</span><br>    <span class="hljs-keyword">if</span> (S_ISSOCK(statbuf.stmode) == <span class="hljs-number">0</span>) &#123;<br>        rval = <span class="hljs-number">-4</span>;<br>        <span class="hljs-keyword">goto</span> errout;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> </span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        S_IRWXG：(S_IRGRP | S_IWGRP | S_IXGRP)</span><br><span class="hljs-comment">        S_IRGRP：文件的组所有者的读取权限位。通常是040</span><br><span class="hljs-comment">        S_IWGRP：文件的组所有者的写许可权位。通常为020</span><br><span class="hljs-comment">        S_IXGRP：执行或搜索文件组所有者的权限位。通常是010</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        S_IRWXO：(S_IROTH | S_IWOTH | S_IXOTH)</span><br><span class="hljs-comment">        S_IROTH：其他用户的读取权限位。通常是04</span><br><span class="hljs-comment">        S_IWOTH：其他用户的写许可权位。通常是02</span><br><span class="hljs-comment">        S_IXOTH：对其他用户执行或搜索权限位。通常是01</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        S_IRWXU：(S_IRUSR | S_IWUSR | S_IXUSR)</span><br><span class="hljs-comment">        S_IRUSR：文件所有者的读取权限位。在许多系统上，该位为0400</span><br><span class="hljs-comment">        S_IWUSR：文件所有者的写许可权位。通常为0200</span><br><span class="hljs-comment">        S_IXUSR：对文件所有者执行（对于普通文件）或搜索（对于目录）权限位。通常为0100。</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">if</span> ((statbuf.st_mode &amp; (S_IRWXG | S_IRWXO)) ||<br>        (statbuf.st_mode &amp; S_IRWXU) != S_IRWXU) &#123;<br>            rval = <span class="hljs-number">-5</span>;<br>            <span class="hljs-keyword">goto</span> errout;<br>        &#125;<br>    <br>    staletime = time(<span class="hljs-literal">NULL</span>) - STALE;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        atime:最后访问时间</span><br><span class="hljs-comment">        ctime:最后修改时间</span><br><span class="hljs-comment">        mtime:文件状态修改时间</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">if</span> (statbuf.st_atime &lt; staletime || <br>        statbuf.st_ctime &lt; staletime ||<br>        statbuf.st_mtime &lt; staletime) &#123;<br>            rval = <span class="hljs-number">-6</span>;<br>            <span class="hljs-keyword">goto</span> errout;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (uidptr != <span class="hljs-literal">NULL</span>)<br>        *uidptr = statbuf.st_uid;<br>    unlink(name); <span class="hljs-comment">//删除客户端的地址</span><br>    <span class="hljs-built_in">free</span>(name);<br>    <span class="hljs-keyword">return</span>(clifd);<br><br>errout:<br>    err = errno;<br>    close(clifd);<br>    <span class="hljs-built_in">free</span>(name);<br>    errno = err;<br>    <span class="hljs-keyword">return</span>(rval);<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="cli-conn"><a href="#cli-conn" class="headerlink" title="cli_conn"></a>cli_conn</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/un.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span>	</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CLI_PATH <span class="hljs-string">&quot;/var/tmp&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CLI_PERM S_IRWXU    </span><br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">cli_conn</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span><br>&#123;<br>    <span class="hljs-type">int</span> fd, len, err, rval;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_un</span> <span class="hljs-title">un</span>, <span class="hljs-title">sun</span>;</span><br>    <span class="hljs-type">int</span> do_unlink = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strlen</span>(name) &gt;= <span class="hljs-keyword">sizeof</span>(un.sun_path)) &#123;<br>        errno = ENAMETOOLONG;<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> ((fd = socket(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//创建套接字</span><br>        <span class="hljs-keyword">return</span> (<span class="hljs-number">-1</span>);<br>    <br>    <span class="hljs-built_in">memset</span>(&amp;un, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(un));<br>    un.sun_family = AF_UNIX;<br>    <span class="hljs-built_in">sprintf</span>(un.sun_path, <span class="hljs-string">&quot;%s%05ld&quot;</span>, CLI_PATH, (<span class="hljs-type">long</span>)getpid()); <span class="hljs-comment">//创建客户端的地址</span><br>    len = offsetof(<span class="hljs-keyword">struct</span> sockaddr_un, sun_path) + <span class="hljs-built_in">strlen</span>(un.sun_path);<br><br>    unlink(un.sun_path); <span class="hljs-comment">//防止文件已经存在</span><br>    <span class="hljs-keyword">if</span> (bind(fd, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;un, len) &lt; <span class="hljs-number">0</span>) &#123;<br>        rval = <span class="hljs-number">-2</span>;<br>        <span class="hljs-keyword">goto</span> errout;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (chmod(un.sun_path, CLI_PERM) &lt; <span class="hljs-number">0</span>) &#123;<br>        rval = <span class="hljs-number">-3</span>;<br>        do_unlink = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">goto</span> errout;<br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(&amp;sun, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(sun));<br>    sun.sun_family = AF_UNIX;<br>    <span class="hljs-built_in">strcpy</span>(sun.sun_path, name);<br>    len = offsetof(<span class="hljs-keyword">struct</span> sockaddr_un, sun_path) + <span class="hljs-built_in">strlen</span>(name);<br>    <span class="hljs-keyword">if</span> (connect(fd, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;sun, len) &lt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">//连接服务器的地址</span><br>        rval = <span class="hljs-number">-4</span>;<br>        do_unlink = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">goto</span> errout;<br>    &#125;<br>    <span class="hljs-keyword">return</span>(fd);<br><br>errout:<br>    err = errno;<br>    close(fd);<br>    <span class="hljs-keyword">if</span> (do_unlink)<br>        unlink(un.sun_path);<br>    errno = err;<br>    <span class="hljs-keyword">return</span>(rval);   <br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="传送文件描述符"><a href="#传送文件描述符" class="headerlink" title="传送文件描述符"></a>传送文件描述符</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;apue.h&quot;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">send_fd</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">int</span> fd_to_send)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">send_err</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">int</span> status, <span class="hljs-type">char</span> *errmsg)</span>;<br><span class="hljs-comment">//若成功，返回0；若出错，返回-1</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">recv_fd</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">ssize_t</span> (*userfunc)(<span class="hljs-type">int</span>, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *, <span class="hljs-type">size_t</span>))</span>;<br><span class="hljs-comment">//返回值：若成功，返回文件描述符；若出错，返回负值</span><br></code></pre></td></tr></table></figure>

<p><strong>msghdr结构体</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msghdr</span> &#123;</span><br>    <span class="hljs-type">void</span> *msg_name; <span class="hljs-comment">/* 可选地址 */</span><br>    <span class="hljs-type">socklen_t</span> msg_namelen; <span class="hljs-comment">/* 地址长度 */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> *<span class="hljs-title">msg_iov</span>;</span> <span class="hljs-comment">/* I/O缓冲区列表 */</span><br>    <span class="hljs-type">int</span> msg_iovlen; <span class="hljs-comment">/* 列表的个数 */</span><br>    <span class="hljs-type">void</span> *msg_control; <span class="hljs-comment">/* 辅助数据 */</span><br>    <span class="hljs-type">socklen_t</span> msg_controllen; <span class="hljs-comment">/* 辅助字节数 */</span><br>    <span class="hljs-type">int</span> msg_flags; <span class="hljs-comment">/* 收到消息的标志 */</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p><strong>msg_control字段指向cmsghdr</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> &#123;</span><br>    <span class="hljs-type">socklen_t</span> cmsg_len; <span class="hljs-comment">/* 数据字节数， 包括头部 */</span><br>    <span class="hljs-type">int</span> cmsg_level; <span class="hljs-comment">/* 协议 */</span><br>    <span class="hljs-type">int</span> cmsg_type; <span class="hljs-comment">/* 协议指定类型 */</span><br>    <span class="hljs-comment">/* followed by the actual control message data */</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="访问控制数据"><a href="#访问控制数据" class="headerlink" title="访问控制数据"></a>访问控制数据</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">CMSG_DATA</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> cmsghdr *cp)</span>;<br><span class="hljs-comment">//返回值：返回一个指针，指向与cmsghdr结构相关联的数据</span><br><span class="hljs-keyword">struct</span> cmsghdr *<span class="hljs-title function_">CMSG_FIRSTHDR</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> msghdr *mp)</span>;<br><span class="hljs-comment">//返回值：返回一个指针，指向与msghdr结构相关联的第一个cmsghdr结构;若无这样的结构，返回NULL</span><br><span class="hljs-keyword">struct</span> cmsghdr *<span class="hljs-title function_">CMSG_NXTHDR</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> msghdr *mp, <span class="hljs-keyword">struct</span> cmsghdr *cp)</span>;<br><span class="hljs-comment">//返回值：返回一个指针，指向与msghdr结构相关联的下一个cmsghdr结构，该msghdr结构给出了当前的cmsghdr结构;若当前cmsghdr结构已是最后一个，返回NULL</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">CMSG_LEN</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nbytes)</span>;<br><span class="hljs-comment">//返回值：返回为nbytes长的数据对象分配的长度</span><br></code></pre></td></tr></table></figure>

<p><strong>17-13.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(SCM_CREDS)			<span class="hljs-comment">/* BSD interface */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CREDSTRUCT		cmsgcred</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SCM_CREDTYPE	SCM_CREDS</span><br><span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(SCM_CREDENTIALS)	<span class="hljs-comment">/* Linux interface */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CREDSTRUCT		ucred</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SCM_CREDTYPE	SCM_CREDENTIALS</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RIGHTSLEN	CMSG_LEN(sizeof(int))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CREDSLEN	CMSG_LEN(sizeof(struct CREDSTRUCT))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>	CONTROLLEN	(RIGHTSLEN + CREDSLEN)</span><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span>	*<span class="hljs-title">cmptr</span> =</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">send_fd</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">int</span> fd_to_send)</span> <span class="hljs-comment">//用于发送文件描述符</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">iov</span>[1];</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msghdr</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">2</span>];<br><br>    iov[<span class="hljs-number">0</span>].iov_base = buf;<br>    iov[<span class="hljs-number">0</span>].iov_len = <span class="hljs-number">2</span>;<br>    msg.msg_iov = iov;<br>    msg.msg_name = <span class="hljs-literal">NULL</span>;<br>    msg.msg_namelen = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (fd_to_send &lt; <span class="hljs-number">0</span>) &#123;<br>        msg.msg_control = <span class="hljs-literal">NULL</span>;<br>        msg.msg_controllen = <span class="hljs-number">0</span>;<br>        buf[<span class="hljs-number">1</span>] = -fd_to_send;<br>        <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">1</span>] == <span class="hljs-number">0</span>)<br>            buf[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (cmptr = <span class="hljs-literal">NULL</span> &amp;&amp; (cmptr = <span class="hljs-built_in">malloc</span>(CONTROLLEN)) == <span class="hljs-literal">NULL</span>)<br>            <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>        cmptr-&gt;cmsg_level = SOL_SOCKET;<br>        cmptr-&gt;cmsg_type = SCM_RIGHTS;<br>        cmptr-&gt;cmsg_len = CONTROLLEN;<br>        msg.msg_control = cmptr;<br>        msg.msg_controllen = CONTROLLEN;<br>        *(<span class="hljs-type">int</span> *)CMSG_DATA(comptr) = fd_to_send;<br>        buf[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>    &#125;<br><br>    buf[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (sendmsg(fd, &amp;msg, <span class="hljs-number">0</span>) != <span class="hljs-number">2</span>)<br>        reurn(<span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">return</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>17-14.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CONTROLLEN CMSCG_LEN(sizeof(int))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAXLINE 256</span><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> *<span class="hljs-title">cmptr</span> =</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">recv_fd</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">ssize_t</span> (*userfunc)(<span class="hljs-type">int</span>, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *, <span class="hljs-type">size_t</span>))</span> <span class="hljs-comment">//fd是域套接字</span><br>&#123;<br>    <span class="hljs-type">int</span> newfd, nr, status;<br>    <span class="hljs-type">char</span> *ptr;<br>    <span class="hljs-type">char</span> buf[MAXLINE];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span>  <span class="hljs-title">iovec</span> <span class="hljs-title">iov</span>[1];</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msghdr</span> <span class="hljs-title">msg</span>;</span><br><br>    status = <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        iov[<span class="hljs-number">0</span>].iov_base = buf;<br>        iov[<span class="hljs-number">0</span>].iov_len = <span class="hljs-keyword">sizeof</span>(buf);<br>        msg.msg_iov = iov;<br>        msg.msg_iovlen = <span class="hljs-number">1</span>;<br>        msg.msg_name = <span class="hljs-literal">NULL</span>;<br>        msg.msg_namelen = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (cmptr == <span class="hljs-literal">NULL</span> &amp;&amp; (cmptr = <span class="hljs-built_in">malloc</span>(CONTROLLEN)) == <span class="hljs-literal">NULL</span>)<br>            <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>        msg.msg_control = cmptr;<br>        msg.msg_controllen = CONTROLLEN;<br>        <span class="hljs-keyword">if</span> ((nr = recvmsg(fd, &amp;msg, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;recvmsg error\n&quot;</span>);<br>            <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nr == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;connection closed by servver&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        <span class="hljs-keyword">for</span> (ptr = buf; ptr &lt; &amp;buf[nr];) &#123;<br>            <span class="hljs-keyword">if</span> (*ptr++ == <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">//读取状态</span><br>                <span class="hljs-keyword">if</span> (ptr != &amp;buf[nr<span class="hljs-number">-1</span>])<br>                &#123;<br>                    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;message format error&quot;</span>);<br>                    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>                &#125;<br>                status = *ptr &amp; <span class="hljs-number">0xFF</span>;<br>                <span class="hljs-keyword">if</span> (status == <span class="hljs-number">0</span>)&#123;<br>                    <span class="hljs-keyword">if</span> (msg.msg_controllen &lt; CONTROLLEN)<br>                    &#123;<br>                        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;status = 0 but no fd&quot;</span>);<br>                        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>                    &#125;<br>                    newfd = *(<span class="hljs-type">int</span> *)CMSG_DATA(cmptr);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    newfd = -status;<br>                &#125;<br>                nr -= <span class="hljs-number">2</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (nr &gt; <span class="hljs-number">0</span> &amp;&amp; (*userfunc)(STDERR_FILENO, buf, nr) != nr)<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">if</span> (status &gt;= <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>(newfd);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在<code>FreeBSD</code>中，将证书作为<code>cmsgcred</code>结构传送</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMGROUP_MAX 16</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsgcred</span> &#123;</span><br>    <span class="hljs-type">pid_t</span> cmcred_pid; <span class="hljs-comment">/* sender’s process ID */</span><br>    <span class="hljs-type">uid_t</span> cmcred_uid; <span class="hljs-comment">/* sender’s real UID */</span><br>    <span class="hljs-type">uid_t</span> cmcred_euid; <span class="hljs-comment">/* sender’s effective UID */</span><br>    <span class="hljs-type">gid_t</span> cmcred_gid; <span class="hljs-comment">/* sender’s real GID */</span><br>    <span class="hljs-type">short</span> cmcred_ngroups; <span class="hljs-comment">/* number of groups */</span><br>    <span class="hljs-type">gid_t</span> cmcred_groups[CMGROUP_MAX]; <span class="hljs-comment">/* groups */</span><br>    <span class="hljs-type">short</span> cmcred_ngroups; <span class="hljs-comment">/*组数*/</span><br>    <span class="hljs-type">gid_t</span> cmcred_groups[CMGROUP_MAX];  <span class="hljs-comment">/*组*/</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>在<code>Linux</code>中，将证书作为<code>ucred</code>结构传送</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ucred</span>&#123;</span><br>    <span class="hljs-type">pid_t</span> pid;<br>    <span class="hljs-type">uid_t</span> uid;<br>    <span class="hljs-type">gid_t</span> gid;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p><strong>17-15.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(SCM_CREDS)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CREDSTRUCT cmsgcred</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SCM_CREDTYPE SCM_CREDS</span><br><span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(SCM_CREDENTIALS)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CREDSTRUCT ucred</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SCM_CREDTYPE SCM_CREDENTIALS</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RIGHTSLEN CMSG_LEN(sizeof(int))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CREDSLEN CMSG_LEN(sizeof(struct CREDSTRUCT))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CONTROLLEN (RIGHTSLEN + CREDSLEN)</span><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> *<span class="hljs-title">cmptr</span> =</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">send_fd</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">int</span> fd_to_send)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">CREDSTRUCT</span> *<span class="hljs-title">credp</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> *<span class="hljs-title">cmp</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">iov</span>[1];</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msghdr</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">2</span>];<br><br>    iov[<span class="hljs-number">0</span>].iov_base = buf;<br>    iov[<span class="hljs-number">0</span>].iov_len = <span class="hljs-number">2</span>;<br>    msg.msg_iov = iov;<br>    msg.msg_controllen = <span class="hljs-number">1</span>;<br>    msg.msg_name = <span class="hljs-literal">NULL</span>;<br>    msg.msg_namelen = <span class="hljs-number">0</span>;<br>    msg.msg_flags = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (fd_to_send &lt; <span class="hljs-number">0</span>) &#123;<br>        msg.msg_control = <span class="hljs-literal">NULL</span>;<br>        msg.msg_controllen = <span class="hljs-number">0</span>;<br>        buf[<span class="hljs-number">1</span>] = -fd_to_send;<br>        <span class="hljs-keyword">if</span>(buf[<span class="hljs-number">1</span>] == <span class="hljs-number">0</span>)<br>            buf[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (cmptr == <span class="hljs-literal">NULL</span> &amp;&amp; (cmptr = <span class="hljs-built_in">malloc</span>(CONTROLLEN)) == <span class="hljs-literal">NULL</span>)<br>            <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>        msg.msg_control = cmptr;<br>        msg.msg_controllen = CONTROLLEN;<br>        cmp = cmptr;<br>        cmp-&gt;cmsg_level = SOL_SOCKET; <span class="hljs-comment">//用于设置获取socket属性</span><br>        cmp-&gt;cmsg_type = SCM_RIGHTS; <span class="hljs-comment">//用于传送访问权</span><br>        cmp-&gt;cmsg_len = RIGHTSLEN;<br>        *(<span class="hljs-type">int</span> *)CMSG_DATA(cmp) = fd_to_send;<br>        cmp = CMSG_NXTHDR(&amp;msg, cmp); <span class="hljs-comment">//获取下一个控制消息</span><br>        cmp-&gt;cmsg_level = SOL_SOCKET;<br>        cmp-&gt;cmsg_type = SCM_CREDTYPE; <span class="hljs-comment">//用于在UNIX系统中传递进程的用户和组的凭据信息</span><br>        cmp-&gt;cmsg_len = CREDSLEN;<br>        credp = (<span class="hljs-keyword">struct</span> CREDSTRUCT *)CMSG_DATA(cmp); <span class="hljs-comment">//增加证书信息</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(SCM_CREDENTIALS)</span><br>        credp-&gt;uid = geteuid(); <br>        credp-&gt;gid = getegid();<br>        credp-&gt;pid = getpid();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>        buf[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>    &#125;<br><br>    buf[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (sendmsg(fd, &amp;msg, <span class="hljs-number">0</span>) != <span class="hljs-number">2</span>)<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">return</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>17-16.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/un.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(SCM_CREDS)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CREDSTRUCT cmsgcred</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CR_UID</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SCM_CREDTYPE SCM_CREDS</span><br><span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(SCM_CREDENTIALS)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CREDSTRUCT ucred</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CR_UID uid</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CREDOPT SO_PASSCRED</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SCM_CREDTYPE SCM_CREDENTIALS</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RIGHTSLEN CMSG_LEN(sizeof(int))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CREDSLEN CMSG_LEN(sizoef(struct  CREDSTRUCT))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CONTROLLEN (RIGHTSLEN + CREDSLEN)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAXLINE 256</span><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> *<span class="hljs-title">cmptr</span> =</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">recv_ufd</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">uid_t</span> *uidptr, <span class="hljs-type">ssize_t</span> (*userfunc)(<span class="hljs-type">int</span>, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *, <span class="hljs-type">size_t</span>))</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> *<span class="hljs-title">cmp</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">CREDSTRUCT</span> *<span class="hljs-title">credp</span>;</span><br>    <span class="hljs-type">char</span> *ptr;<br>    <span class="hljs-type">char</span> buf[MAXLINE];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">iov</span>[1];</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msghdr</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-type">int</span> nr;<br>    <span class="hljs-type">int</span> newfd = <span class="hljs-number">-1</span>;<br>    <span class="hljs-type">int</span> status = <span class="hljs-number">-1</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(CREDOPT)</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> on = <span class="hljs-number">1</span>;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        setsockopt(int sockfd, int level, int optname, const void *optval, socklen_t optlen);</span><br><span class="hljs-comment">        表示套接字可以在进程间传递用户和组标识</span><br><span class="hljs-comment">        sockfd：标识一个打开的套接字。</span><br><span class="hljs-comment">        level：选项定义的层次；SOL_SOCKET 表示基础套接字选项，IPPROTO_TCP 表示 TCP 协议选项等等。</span><br><span class="hljs-comment">        optname：需要访问的选项名。</span><br><span class="hljs-comment">        optval：指向存放选项值的缓冲区。</span><br><span class="hljs-comment">        optlen：缓冲区长度</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">if</span> (setsockopt(fd, SOL_SOCKET, CREDOPT, &amp;on, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>)) &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;setsockopt error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        iov[<span class="hljs-number">0</span>].iov_base = buf;<br>        iov[<span class="hljs-number">0</span>].iov_len = <span class="hljs-keyword">sizeof</span>(buf);<br>        msg.msg_iov = iov;<br>        msg.msg_iovlen = <span class="hljs-number">1</span>;<br>        msg.msg_name = <span class="hljs-literal">NULL</span>;<br>        msg.msg_namelen = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (cmptr == <span class="hljs-literal">NULL</span> &amp;&amp; (cmptr = <span class="hljs-built_in">malloc</span>(CONTROLLEN)) == <span class="hljs-literal">NULL</span>)<br>            <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>)<br>        msg.msg_control = cmptr;<br>        msg.msg_controllen = CONTROLLEN;<br>        <span class="hljs-keyword">if</span> ((nr = recvmsg(fd, &amp;msg, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;recvmsg error&quot;</span>);<br>            <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nr == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;connection closed by server&quot;</span>);<br>            <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (ptr = buf; ptr &lt; &amp;buf[nr]; ) &#123;<br>            <span class="hljs-keyword">if</span> (*ptr++ == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">if</span> (ptr != &amp;buf[nr<span class="hljs-number">-1</span>])<br>                &#123;<br>                    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;message format error&quot;</span>);<br>                    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>                &#125;<br>            &#125;<br>            status = *ptr &amp; <span class="hljs-number">0xFF</span>;<br>            <span class="hljs-keyword">if</span> (status == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">if</span> (msg.msg_controllen != CONTROLLEN)<br>                &#123;<br>                    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;status = 0 but no fd&quot;</span>);<br>                    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>                &#125;<br><br>                <span class="hljs-keyword">for</span> (cmp = CMSG_FIRSTHDR(&amp;msg);<br>                cmp != <span class="hljs-literal">NULL</span>; cmp = CMSG_NXTHDR(&amp;msg, cmp)) &#123;<br>                    <span class="hljs-keyword">if</span> (cmp-&gt;cmsg_level != SOL_SOCKET)<br>                        <span class="hljs-keyword">continue</span>;<br>                    <span class="hljs-keyword">switch</span> (cmp-&gt;cmsg_type)<br>                    &#123;<br>                    <span class="hljs-keyword">case</span> SCM_RIGHTS:<br>                        newfd = *(<span class="hljs-type">int</span> *)CMSG_DATA(cmp);<br>                        <span class="hljs-keyword">break</span>;<br>                    <span class="hljs-keyword">case</span> SCM_CREDTYPE:<br>                        credp = (<span class="hljs-keyword">struct</span>  CREDSTRUCT *)CMSG_DATA(cmp);<br>                        *uidptr = credp-&gt;CR_UID;<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                newfd = -status;<br>            &#125;<br>            nr -= <span class="hljs-number">2</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (nr &gt; <span class="hljs-number">0</span> &amp;&amp; (*userfunc)(STDERR_FILENO, buf, nr) != nr)<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">if</span> (status &gt;= <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>(newfd);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>17-21.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/uio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;include/apue.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CL_OPEN <span class="hljs-string">&quot;open&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAXLINE 256</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAXARG 50</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> WHITE <span class="hljs-string">&quot;\t\n&quot;</span></span><br><br><span class="hljs-type">char</span> errmsg[MAXLINE];<br><span class="hljs-type">int</span> oflag;<br><span class="hljs-type">char</span> *pathname;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">cli_args</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">char</span> **)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">handle_request</span><span class="hljs-params">(<span class="hljs-type">char</span> *, <span class="hljs-type">int</span>, <span class="hljs-type">int</span>)</span>;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">buf_args</span><span class="hljs-params">(<span class="hljs-type">char</span> *buf, <span class="hljs-type">int</span> (*optfunc)(<span class="hljs-type">int</span>, <span class="hljs-type">char</span> **))</span><br>&#123;<br>    <span class="hljs-type">char</span> *ptr, *argv[MAXARG];<br>    <span class="hljs-type">int</span> argc;<br><br>    <span class="hljs-keyword">if</span> (strtok(buf, WHITE) == <span class="hljs-literal">NULL</span>) <span class="hljs-comment">//定位\t\n</span><br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    argv[argc = <span class="hljs-number">0</span>] = buf;<span class="hljs-comment">//重新调整参数</span><br>    <span class="hljs-keyword">while</span> ((ptr = strtok(<span class="hljs-literal">NULL</span>, WHITE)) != <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-keyword">if</span> (++argc &gt;= MAXARG - <span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>        argv[argc] = ptr;<br>    &#125;<br>    argv[++argc] = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-keyword">return</span>((*optfunc)(argc, argv));<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">cli_args</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">3</span> || <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">0</span>], CL_OPEN) !=<span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">strcpy</span>(errmsg, <span class="hljs-string">&quot;usage: &lt;pathname&gt; &lt;oflag&gt; \n&quot;</span>);<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    pathname = argv[<span class="hljs-number">1</span>];<br>    oflag = atoi(argv[<span class="hljs-number">2</span>]);<br>    <span class="hljs-keyword">return</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">handle_request</span><span class="hljs-params">(<span class="hljs-type">char</span> *buf, <span class="hljs-type">int</span> nread, <span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-type">int</span> newfd;<br><br>    <span class="hljs-keyword">if</span> (buf[nread<span class="hljs-number">-1</span>] != <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">//结尾不是截断符</span><br>        <span class="hljs-built_in">snprintf</span>(errmsg, MAXLINE<span class="hljs-number">-1</span>,<br>        <span class="hljs-string">&quot;request not null terminated: %*.*s\n&quot;</span>, nread, nread, buf);<br>        send_err(fd, <span class="hljs-number">-1</span>, errmsg);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (buf_args(buf, cli_args) &lt; <span class="hljs-number">0</span>) &#123;<br>        send_err(fd, <span class="hljs-number">-1</span>, errmsg);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> ((newfd = open(pathname, oflag)) &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">snprintf</span>(errmsg, MAXLINE - <span class="hljs-number">1</span>, <span class="hljs-string">&quot;can&#x27;t open %s: %s\n&quot;</span>, pathname, strerror(errno));<br>        send_err(fd, <span class="hljs-number">-1</span>, errmsg);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (send_fd(fd, newfd) &lt; <span class="hljs-number">0</span>)<br>        err_sys(<span class="hljs-string">&quot;send_fd error&quot;</span>);<br>    close(newfd);<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> nread;<br>    <span class="hljs-type">char</span> buf[MAXLINE];<br><br>   <span class="hljs-keyword">for</span>(;;) &#123;<br>        <span class="hljs-keyword">if</span> ((nread = read(STDIN_FILENO, buf, MAXLINE)) &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;read error on stream pipe&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">break</span>;<br>        handle_request(buf, nread, STDOUT_FILENO);<br>   &#125;<br>   <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>opend.h</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;include/apue.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CS_OPEN <span class="hljs-string">&quot;/tmp/opend.socket&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CL_OPEN  <span class="hljs-string">&quot;open&quot;</span></span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-type">int</span> debug;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">char</span> errmsg[];<br><span class="hljs-keyword">extern</span> <span class="hljs-type">int</span> oflag;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">char</span> *pathname;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-comment">/* data */</span><br>    <span class="hljs-type">int</span> fd;<br>    <span class="hljs-type">uid_t</span> uid;<br>&#125; Client;<br><br><span class="hljs-keyword">extern</span> Client *client;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">int</span> client_size;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">cli_args</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">char</span> **)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">client_add</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">uid_t</span>)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">client_del</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">loop</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">handle_request</span><span class="hljs-params">(<span class="hljs-type">char</span> *, <span class="hljs-type">int</span>, <span class="hljs-type">int</span>, <span class="hljs-type">uid_t</span>)</span>;<br></code></pre></td></tr></table></figure>

<p><strong>17-27.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;opend.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NALLOC 10</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">client_alloc</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> i;<br><br>    <span class="hljs-keyword">if</span> (client == <span class="hljs-literal">NULL</span>)<br>        client = <span class="hljs-built_in">malloc</span>(NALLOC * <span class="hljs-keyword">sizeof</span>(Client));<br>    <span class="hljs-keyword">else</span>    <br>        client = <span class="hljs-built_in">realloc</span>(client, (client_size+NALLOC)*<span class="hljs-keyword">sizeof</span>(Client));<br>    <span class="hljs-keyword">if</span> (client == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t alloc for client array&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);       <br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (i = client_size; i &lt; client_size + NALLOC; i++)<br>        client[i].fd = <span class="hljs-number">-1</span>;<br>    client_size += NALLOC;  <br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">client_add</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">uid_t</span> uid)</span><br>&#123;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">if</span> (client == <span class="hljs-literal">NULL</span>)<br>        client_alloc();<br>again:<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; client_size; i++) &#123;<br>        <span class="hljs-keyword">if</span> (client[i].fd == <span class="hljs-number">-1</span>) &#123;<br>            client[i].fd = fd;<br>            client[i].uid = uid;<br>            <span class="hljs-keyword">return</span>(i);<br>        &#125;<br>    &#125;<br><br>    client_alloc();<br>    <span class="hljs-keyword">goto</span> again;<br>&#125;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">client_del</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; client_size; i++) &#123;<br>        <span class="hljs-keyword">if</span> (client[i].fd == fd) &#123;<br>            client[i].fd = <span class="hljs-number">-1</span>;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<br>    log_quit(<span class="hljs-string">&quot;can&#x27;t find client entry for fd %d&quot;</span>, fd);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="命令处理"><a href="#命令处理" class="headerlink" title="命令处理"></a>命令处理</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">getopt</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *<span class="hljs-type">const</span> argv[], <span class="hljs-type">const</span> <span class="hljs-type">char</span> *options)</span>;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">int</span> optind, opterr, optopt;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">char</span> *optarg;<br><br><span class="hljs-comment">//返回值：若所有选项被处理完，返回-1；否则，返回下一个选项字符</span><br></code></pre></td></tr></table></figure>

<p><strong>17-28.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;opend.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;syslog.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/select.h&gt;</span></span><br><br><span class="hljs-type">int</span> debug, oflag, client_size, log_to_stderr;<br><span class="hljs-type">char</span> errmsg[MAXLINE];<br><span class="hljs-type">char</span> *pathname;<br>Client *clinet = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-type">void</span> <br><span class="hljs-title function_">loop</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> i, n, maxfd, maxi, listenfd, clifd, nread;<br>    <span class="hljs-type">char</span> buf[MAXLINE];<br>    <span class="hljs-type">uid_t</span> uid;<br>    fd_set rset, allset;<br>    FD_ZERO(&amp;allset);<br><br>    <span class="hljs-keyword">if</span> ((listenfd = serv_listen(CS_OPEN)) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//服务器监听本地文件</span><br>        log_sys(<span class="hljs-string">&quot;serv_listen error&quot;</span>);<br>    FD_SET(listenfd, &amp;allset); <span class="hljs-comment">//设置文件描述符的集合</span><br>    maxfd = listenfd;<br>    maxi = <span class="hljs-number">-1</span>;<br><br>    <span class="hljs-keyword">for</span> ( ; ; )&#123;<br>        rset = allset;<br>        <span class="hljs-keyword">if</span> ((n = select(maxfd + <span class="hljs-number">1</span>,  &amp;rset, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>)) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//监听读取套接字的集合</span><br>            log_sys(<span class="hljs-string">&quot;select error&quot;</span>);<br>        <span class="hljs-keyword">if</span> (FD_ISSET(listenfd, &amp;rset)) &#123; <span class="hljs-comment">//判断listenfd是否在rset集合中</span><br>            <span class="hljs-keyword">if</span> ((clifd = serv_accept(listenfd, &amp;uid)) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//获取与客户端通信的套接字，以及uid值</span><br>                log_sys(<span class="hljs-string">&quot;serv_accept error: %d&quot;</span>, clifd);<br>            i = client_add(clifd, uid);<br>            FD_SET(clifd, &amp;allset);<br>            <span class="hljs-keyword">if</span> (clifd &lt; maxfd)<br>                maxfd = clifd;<br>            <span class="hljs-keyword">if</span> (i &gt; maxi)<br>                maxi = i;<br>            log_msg(<span class="hljs-string">&quot;new connection: uid %d, fd %d&quot;</span>, uid, clifd);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt;=maxi; i++) &#123;<br>            <span class="hljs-keyword">if</span> ((clifd = client[i].fd) &lt; <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">continue</span>;<br>            <span class="hljs-keyword">if</span> (FD_ISSET(clifd, &amp;rset)) &#123;<br>                <span class="hljs-keyword">if</span> ((nread = read(clifd, buf, MAXLINE)) &lt; <span class="hljs-number">0</span>)&#123;<br>                    log_sys(<span class="hljs-string">&quot;read error on fd %d&quot;</span>, clifd);<br>                &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)&#123;<br>                    log_msg(<span class="hljs-string">&quot;closed: uid %d, fd %d&quot;</span>, client[i].uid, clifd);<br>                    client_del(clifd);<br>                    FD_CLR(clifd, &amp;allset);<br>                    close(clifd);<br>                &#125;<span class="hljs-keyword">else</span> &#123;<br>                    handle_request(buf, nread, clifd, client[i].uid);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>    <span class="hljs-type">int</span> c;<br>    log_open(<span class="hljs-string">&quot;open.serv&quot;</span>, LOG_PID, LOG_USER);<br><br>    opterr = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> ((c = getopt(argc, argv, <span class="hljs-string">&quot;d&quot;</span>)) != EOF) &#123;<br>        <span class="hljs-keyword">switch</span>(c) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;d&#x27;</span>:<br>                debug = log_to_stderr = <span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;?&#x27;</span>:<br>                err_quit(<span class="hljs-string">&quot;unrecognized option: -%c&quot;</span>, optopt);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (debug == <span class="hljs-number">0</span>)<br>        daemonize(<span class="hljs-string">&quot;opend&quot;</span>);<br>    loop();<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>17-30.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;opend.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NALLOC 10</span><br><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> pollfd *<br><span class="hljs-title function_">grow_pollfd</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pollfd *pfd, <span class="hljs-type">int</span> *maxfd)</span><br>&#123;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-type">int</span> oldmax = *maxfd;<br>    <span class="hljs-type">int</span> newmax = oldmax + NALLOC;<br><br>    <span class="hljs-keyword">if</span> ((pfd = <span class="hljs-built_in">realloc</span>(pfd, newmax * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pollfd))) == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;realloc error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (i = oldmax; i &lt; newmax; i++) &#123;<br>        pfd[i].fd = <span class="hljs-number">-1</span>;<br>        pfd[i].events = POLLIN;<br>        pfd[i].revents = <span class="hljs-number">0</span>;<br>    &#125;<br>    *maxfd = newmax;<br>    <span class="hljs-keyword">return</span>(pfd);<br><br>&#125;<br><br><span class="hljs-type">void</span> <br><span class="hljs-title function_">loop</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> i, listenfd, clifd, nread;<br>    <span class="hljs-type">char</span> buf[MAXLINE];<br>    <span class="hljs-type">uid_t</span> uid;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> *<span class="hljs-title">pollfd</span>;</span><br>    <span class="hljs-type">int</span> numfd = <span class="hljs-number">1</span>;<br>    <span class="hljs-type">int</span> maxfd = NALLOC;<br><br>    <span class="hljs-keyword">if</span> ((pollfd = <span class="hljs-built_in">malloc</span>(NALLOC * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pollfd))) == <span class="hljs-literal">NULL</span>)<br>        err_sys(<span class="hljs-string">&quot;malloc error&quot;</span>);<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; NALLOC; i++) &#123;<br>        pollfd[i].fd = <span class="hljs-number">-1</span>;<br>        pollfd[i].events = POLLIN; <span class="hljs-comment">//关注读事件</span><br>        pollfd[i].revents = <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> ((listenfd = serv_listen(CS_OPEN)) &lt; <span class="hljs-number">0</span>) <br>        log_sys(<span class="hljs-string">&quot;serv_listen error&quot;</span>);<br>    client_add(listenfd, <span class="hljs-number">0</span>);<br>    pollfd[<span class="hljs-number">0</span>].fd = listenfd;<br><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-keyword">if</span> (poll(pollfd, numfd, <span class="hljs-number">-1</span>) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//监听服务端的文件</span><br>            log_sys(<span class="hljs-string">&quot;poll error&quot;</span>);<br>        <br>        <span class="hljs-keyword">if</span> (pollfd[<span class="hljs-number">0</span>].revents &amp; POLLIN) &#123;<br>            <span class="hljs-keyword">if</span> ((clifd = serv_accept(listenfd, &amp;uid)) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//得到客户端的套接字</span><br>                log_sys(<span class="hljs-string">&quot;serv_accept&quot;</span>);<br>            client_add(clifd, uid); <span class="hljs-comment">//将客户端的套接字以及uid添加进去</span><br><br>            <span class="hljs-keyword">if</span> (numfd == maxfd)<br>                pollfd = grow_pollfd(pollfd, &amp;maxfd);<br>            pollfd[numfd].fd = clifd;<br>            pollfd[numfd].events = POLLIN;<br>            pollfd[numfd].revents = <span class="hljs-number">0</span>;<br>            numfd++;<br>            log_msg(<span class="hljs-string">&quot;new connection: uid %d, fd %d&quot;</span>, uid, clifd);<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt; numfd; i++) &#123;<br>            <span class="hljs-keyword">if</span> (pollfd[i].revents &amp; POLLHUP) &#123; <span class="hljs-comment">//客户端连接断开</span><br>                <span class="hljs-keyword">goto</span> hungup;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pollfd[i].revents &amp; POLLIN) &#123; <span class="hljs-comment">// 从客户端读取数据</span><br>                <span class="hljs-keyword">if</span> ((nread = read(pollfd[i].fd, buf, MAXLINE)) &lt; <span class="hljs-number">0</span>) &#123;<br>                    log_sys(<span class="hljs-string">&quot;read error on fd %d&quot;</span>, pollfd[i].fd);<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>) &#123;<br>hungup:<br>                    log_msg(<span class="hljs-string">&quot;closed: uid %d, fd %d&quot;</span>, client[i].uid, pollfd[i].fd);<br>                    client_del(pollfd[i].fd);<br>                    close(pollfd[i].fd);<br>                    <span class="hljs-keyword">if</span> (i &lt; (numfd - <span class="hljs-number">1</span>)) &#123;<br>                        pollfd[i].fd = pollfd[numfd<span class="hljs-number">-1</span>].fd;<br>                        pollfd[i].events = pollfd[numfd<span class="hljs-number">-1</span>].events;<br>                        pollfd[i].revents = pollfd[numfd<span class="hljs-number">-1</span>].revents;<br>                        i--;<br>                    &#125;<br>                    numfd--;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    handle_request(buf, nread, pollfd[i].fd, client[i].uid);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="终端I-x2F-O"><a href="#终端I-x2F-O" class="headerlink" title="终端I&#x2F;O"></a>终端I&#x2F;O</h1><p><strong>程序禁用中断字符，并将文件结束符设置为Ctrl+B</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;termios.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br>isatty(<span class="hljs-type">int</span> fd)<br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">termios</span>	<span class="hljs-title">ts</span>;</span><br><br>	<span class="hljs-keyword">return</span>(tcgetattr(fd, &amp;ts) != <span class="hljs-number">-1</span>); <span class="hljs-comment">//获取属性</span><br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">termios</span> <span class="hljs-title">term</span>;</span><br>    <span class="hljs-type">long</span> vdisable;<br><br>    <span class="hljs-keyword">if</span> (isatty(STDIN_FILENO) == <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;standard input is not a terminal device&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> ((vdisable = fpathconf(STDIN_FILENO, _PC_VDISABLE)) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//表示获取标准输入文件描述符的禁用字符值</span><br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;fpathconf error or _POSIX_VDISABLE not in effect&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (tcgetattr(STDIN_FILENO, &amp;term) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;tcgetattr error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    term.c_cc[VINTR] = vdisable; <span class="hljs-comment">//设置中断信号</span><br>    term.c_cc[VEOF] = <span class="hljs-number">2</span>; <span class="hljs-comment">//设置文件结束符</span><br>    <span class="hljs-comment">//TCSAFLUSH 表示在设置终端属性后，刷新终端输入输出队列中尚未处理的数据</span><br>    <span class="hljs-keyword">if</span> (tcsetattr(STDIN_FILENO, TCSAFLUSH, &amp;term) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//设置属性</span><br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;tcsetattr error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="获得和设置终端属性"><a href="#获得和设置终端属性" class="headerlink" title="获得和设置终端属性"></a>获得和设置终端属性</h2><p>获得和设置<code>termios</code>结构，调用<code>tcgetattr</code>和<code>tcsetattr</code>函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;termios.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">tcgetattr</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-keyword">struct</span> termios *termptr)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">tcsetattr</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">int</span> opt, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> termios *termptr)</span>;<br><br><span class="hljs-comment">//两个函数的返回值：若成功，返回0；若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>fd</code>：引用终端设备</li>
<li><code>opt</code>参数<ul>
<li><code>TCSANOW</code>：更改立即发生</li>
<li><code>TCSADRAIN</code>：发送了所有输出后更改才发生。若更改输出参数则应使用此选项。</li>
<li><code>TCSAFLUSH</code>：发送了所有输出后更改才发生。更进一步，在更改发生时未读的所有输入数据都被丢弃（冲洗）。</li>
</ul>
</li>
</ul>
<h2 id="终端选项标志"><a href="#终端选项标志" class="headerlink" title="终端选项标志"></a>终端选项标志</h2><p><strong>18-11.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;termio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">termios</span> <span class="hljs-title">term</span>;</span><br><br>    <span class="hljs-keyword">if</span> (tcgetattr(STDIN_FILENO, &amp;term) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;tcgetattr error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">switch</span> (term.c_cflag &amp; CSIZE) &#123;<br>        <span class="hljs-keyword">case</span> CS5:<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;5 bits/byte\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> CS6:<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;6 bits/byte\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> CS7:<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;7 bits/byte\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> CS8:<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;8 bits/byte\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;unknown bits/byte\n&quot;</span>);<br>    &#125;<br><br>    term.c_cflag &amp;= ~CSIZE; <span class="hljs-comment">//将CSIZE标志位取消</span><br>    term.c_cflag |= CS8; <span class="hljs-comment">//标记上CS8</span><br>    <span class="hljs-keyword">if</span> (tcsetattr(STDIN_FILENO, TCSANOW, &amp;term) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//设置属性,TCSANOW表示修改立即生效</span><br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;tcsetattr error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="stty命令"><a href="#stty命令" class="headerlink" title="stty命令"></a>stty命令</h2><p>在程序中使用<code>tcgetattr</code>和<code>tcsetattr</code>函数进行检查和更改。在命令行中用<code>stty</code>命令进行检查和更改。</p>
<h2 id="波特率函数"><a href="#波特率函数" class="headerlink" title="波特率函数"></a>波特率函数</h2><p>波特率表示为位&#x2F;秒</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;termios.h&gt;</span></span><br><br><span class="hljs-type">speed_t</span> <span class="hljs-title function_">cfgetispeed</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> termios *temptr)</span>;<br><span class="hljs-type">speed_t</span> <span class="hljs-title function_">cfgetospeed</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> termios *termptr)</span>;<br><span class="hljs-comment">//两个函数的返回值：波特率值</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">cfsetispeed</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> termios *termptr, <span class="hljs-type">speed_t</span> speed)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">cfsetospeed</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> termios *termptr <span class="hljs-type">speed_t</span> speed)</span>;<br><span class="hljs-comment">//两个函数的返回值：若成功，返回0；出错，返回-1</span><br></code></pre></td></tr></table></figure>

<h2 id="行控制函数"><a href="#行控制函数" class="headerlink" title="行控制函数"></a>行控制函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;termios.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">tcdrain</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">tcflow</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">int</span> action)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">tcflush</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">int</span> <span class="hljs-built_in">queue</span>)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">tcsendbreak</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">int</span> duration)</span>;<br><br><span class="hljs-comment">//4个函数的返回值：若成功，返回0；若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>tcdrain</code>函数等待所有输出都被传递</li>
<li><code>tcflow</code>函数用于对输入和输出流控制进行控制，<code>action</code>参数<ul>
<li><code>TCOOFF</code>：输出被挂起</li>
<li><code>TCOON</code>：重新启动以前被挂起的输出。</li>
<li><code>TCIOFF</code>：系统发送一个<code>STOP</code>字符，这将使终端设备停止发送数据。</li>
<li><code>TCION</code>：系统发送一个<code>START</code>字符，这将使终端设备恢复发送数据</li>
</ul>
</li>
<li><code>tcflush</code>函数冲洗输入缓冲区或输出缓冲区。<code>queue</code>参数必定是下列3个常量之一<ul>
<li><code>TCIFLUSH</code>冲洗输入队列</li>
<li><code>TCOFLUSH</code>冲洗输出队列</li>
<li><code>TCIOFLUSH</code>冲洗输入队列和输出队列</li>
</ul>
</li>
<li><code>tcsendbreak</code>函数在一个指定的时间区间内发送连续的0值位流。若<code>duration</code>参数为0，则此种传递延续0.25~0.5。<code>POSIX.1</code>说明若<code>duration</code>非0，则传递时间依赖于实现。</li>
</ul>
<h2 id="终端标识"><a href="#终端标识" class="headerlink" title="终端标识"></a>终端标识</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">char</span> *<span class="hljs-title function_">ctermid</span><span class="hljs-params">(<span class="hljs-type">char</span> *ptr)</span>;<br><br><span class="hljs-comment">//返回值：若成功，返回指向控制终端名的指针；若出错，返回指向空字符串的指针</span><br></code></pre></td></tr></table></figure>

<p><strong>ctermid函数的实现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">char</span> ctermid_name[L_ctermid];<br><br><span class="hljs-type">char</span> *<br><span class="hljs-title function_">ctermid</span><span class="hljs-params">(<span class="hljs-type">char</span> *str)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (str == <span class="hljs-literal">NULL</span>)<br>        str = ctermid_name;<br>    <span class="hljs-keyword">return</span>(<span class="hljs-built_in">strcpy</span>(str, <span class="hljs-string">&quot;/dev/tty&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>若文件描述符引用一个终端设备则<code>isatty</code>返回真。<code>ttyname</code>返回的是在该文件描述符上打开的终端设备的路径名。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">isatty</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span>;<br><span class="hljs-comment">//返回值：若为终端设备，返回1（真）；否则，返回0（假）</span><br><br><span class="hljs-type">char</span> *<span class="hljs-title function_">ttyname</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span>;<br><span class="hljs-comment">//返回值：指向终端路径名的指针；若出错，返回NULL</span><br></code></pre></td></tr></table></figure>

<p><strong>isatty函数的实现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;termios.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <br><span class="hljs-title function_">isatty</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">termios</span> <span class="hljs-title">ts</span>;</span><br><br>    <span class="hljs-keyword">return</span>(tcgetattr(fd, &amp;ts) != <span class="hljs-number">-1</span>);<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fd 0: %s\n&quot;</span>, isatty(<span class="hljs-number">0</span>) ? <span class="hljs-string">&quot;tty&quot;</span> : <span class="hljs-string">&quot;not a tty&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fd 1: %s\n&quot;</span>, isatty(<span class="hljs-number">1</span>) ? <span class="hljs-string">&quot;tty&quot;</span> : <span class="hljs-string">&quot;not a tty&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fd 2: %s\n&quot;</span>, isatty(<span class="hljs-number">2</span>) ? <span class="hljs-string">&quot;tty&quot;</span> : <span class="hljs-string">&quot;not a tty&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>ttyname函数的实现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;dirent.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;limits.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;termio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">devdir</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">devdir</span> *<span class="hljs-title">d_next</span>;</span><br>    <span class="hljs-type">char</span> *d_name;<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">devdir</span> *<span class="hljs-title">head</span>;</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">devdir</span> *<span class="hljs-title">tail</span>;</span><br><span class="hljs-type">static</span> <span class="hljs-type">char</span> pathname[_PC_PATH_MAX + <span class="hljs-number">1</span>];<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">char</span> *dirname)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">devdir</span> *<span class="hljs-title">ddp</span>;</span><br>    <span class="hljs-type">int</span> len;<br><br>    len = <span class="hljs-built_in">strlen</span>(dirname); <span class="hljs-comment">//判断目录名长度</span><br><br>    <span class="hljs-keyword">if</span> ((dirname[len - <span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;.&#x27;</span>) &amp;&amp; (dirname[len - <span class="hljs-number">2</span>] == <span class="hljs-string">&#x27;/&#x27;</span> ||<br>    (dirname[len - <span class="hljs-number">2</span>] == <span class="hljs-string">&#x27;.&#x27;</span> &amp;&amp; dirname[len<span class="hljs-number">-3</span>] == <span class="hljs-string">&#x27;/&#x27;</span>))) <br>        <span class="hljs-keyword">return</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(dirname, <span class="hljs-string">&quot;/dev/fd&quot;</span>) == <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>;<br>    <span class="hljs-keyword">if</span> ((ddp = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> devdir))) == <span class="hljs-literal">NULL</span>)<br>        <span class="hljs-keyword">return</span>;<br>    <span class="hljs-keyword">if</span> ((ddp-&gt;d_name = strdup(dirname)) == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-built_in">free</span>(ddp);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    ddp-&gt;d_next = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">if</span> (tail == <span class="hljs-literal">NULL</span>) &#123;<br>        head = ddp;<br>        tail = ddp;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        tail-&gt;d_next = ddp;<br>        tail = ddp;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">cleanup</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">devdir</span> *<span class="hljs-title">ddp</span>, *<span class="hljs-title">nddp</span>;</span><br>    ddp = head;<br>    <span class="hljs-keyword">while</span> (ddp != <span class="hljs-literal">NULL</span>) &#123;<br>        nddp = ddp-&gt;d_next;<br>        <span class="hljs-built_in">free</span>(ddp-&gt;d_name);<br>        <span class="hljs-built_in">free</span>(ddp);<br>        ddp = nddp;<br>    &#125;<br>    head = <span class="hljs-literal">NULL</span>;<br>    tail = <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">char</span> *<br><span class="hljs-title function_">searchidr</span><span class="hljs-params">(<span class="hljs-type">char</span> *dirname, <span class="hljs-keyword">struct</span> stat *fdstatp)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">devstat</span>;</span><br>    DIR *dp;<br>    <span class="hljs-type">int</span> devlen;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dirent</span> *<span class="hljs-title">dirp</span>;</span><br><br>    <span class="hljs-built_in">strcpy</span>(pathname, dirname);<br>    <span class="hljs-keyword">if</span> ((dp = opendir(dirname)) == <span class="hljs-literal">NULL</span>) <span class="hljs-comment">//打开指定的目录</span><br>        <span class="hljs-keyword">return</span>(<span class="hljs-literal">NULL</span>);<br>    <span class="hljs-built_in">strcat</span>(pathname, <span class="hljs-string">&quot;/&quot;</span>); <br>    devlen = <span class="hljs-built_in">strlen</span>(pathname);<br>    <span class="hljs-keyword">while</span> ((dirp = readdir(dp)) != <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-built_in">strcpy</span>(pathname + devlen, dirp-&gt;d_name);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(pathname, <span class="hljs-string">&quot;/dev/stdin&quot;</span>) == <span class="hljs-number">0</span> ||<br>        <span class="hljs-built_in">strcmp</span>(pathname, <span class="hljs-string">&quot;/dev/stdout&quot;</span>) == <span class="hljs-number">0</span> ||<br>        <span class="hljs-built_in">strcmp</span>(pathname, <span class="hljs-string">&quot;/dev/stderr&quot;</span>) == <span class="hljs-number">0</span>) <span class="hljs-comment">//跳过终端</span><br>        <span class="hljs-keyword">continue</span>;<br><br>        <span class="hljs-keyword">if</span> (stat(pathname, &amp;devstat) &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">continue</span>;<br>        <span class="hljs-keyword">if</span> (S_ISDIR(devstat.st_mode)) &#123; <span class="hljs-comment">//判断是否为目录</span><br>            add(pathname); <span class="hljs-comment">//增加目录项</span><br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (devstat.st_ino == fdstatp-&gt;st_ino &amp;&amp;<br>        devstat.st_dev == fdstatp-&gt;st_dev) &#123; <span class="hljs-comment">//找到对应目录项</span><br>            closedir(dp);<br>            <span class="hljs-keyword">return</span>(pathname);<br>        &#125;<br>    &#125;<br><br>    closedir(dp);<br>    <span class="hljs-keyword">return</span>(<span class="hljs-literal">NULL</span>);<br>&#125;<br><br><br><span class="hljs-type">char</span> *<br><span class="hljs-title function_">ttyname</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">fdstat</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">devdir</span> *<span class="hljs-title">ddp</span>;</span><br>    <span class="hljs-type">char</span> *rval;<br><br>    <span class="hljs-keyword">if</span> (isatty(fd) == <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>(<span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">if</span> (fstat(fd, &amp;fdstat) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>(<span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">if</span> (S_ISCHR(fdstat.st_mode) == <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>(<span class="hljs-literal">NULL</span>);<br>    <br>    rval = searchidr(<span class="hljs-string">&quot;/dev&quot;</span>, &amp;fdstat); <span class="hljs-comment">//搜索/dev下的目录判断是否符合</span><br>    <span class="hljs-keyword">if</span> (rval == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-keyword">for</span> (ddp = head; ddp != <span class="hljs-literal">NULL</span>; ddp = ddp-&gt;d_next)<br>            <span class="hljs-keyword">if</span> ((rval = searchidr(ddp-&gt;d_name, &amp;fdstat)) != <span class="hljs-literal">NULL</span>)<br>                <span class="hljs-keyword">break</span>;<br>    &#125;<br>    cleanup();<br>    <span class="hljs-keyword">return</span>(rval);<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> *name;<br>    <span class="hljs-keyword">if</span> (isatty(<span class="hljs-number">0</span>)) &#123;<br>        name = ttyname(<span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (name == <span class="hljs-literal">NULL</span>)<br>            name = <span class="hljs-string">&quot;undefined&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        name = <span class="hljs-string">&quot;not a tty&quot;</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fd 0: %s\n&quot;</span>, name);<br><br>    <span class="hljs-keyword">if</span> (isatty(<span class="hljs-number">1</span>)) &#123;<br>        name = ttyname(<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">if</span> (name == <span class="hljs-literal">NULL</span>)<br>            name = <span class="hljs-string">&quot;undefined&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        name = <span class="hljs-string">&quot;not a tty&quot;</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fd 1: %s\n&quot;</span>, name);<br><br>    <span class="hljs-keyword">if</span> (isatty(<span class="hljs-number">2</span>)) &#123;<br>        name = ttyname(<span class="hljs-number">2</span>);<br>        <span class="hljs-keyword">if</span> (name == <span class="hljs-literal">NULL</span>)<br>            name = <span class="hljs-string">&quot;undefined&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        name = <span class="hljs-string">&quot;not a tty&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fd 2: %s\n&quot;</span>, name);<br><br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;dirent.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;limits.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;termio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">devdir</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">devdir</span> *<span class="hljs-title">d_next</span>;</span><br>    <span class="hljs-type">char</span> *d_name;<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">devdir</span> *<span class="hljs-title">head</span>;</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">devdir</span> *<span class="hljs-title">tail</span>;</span><br><span class="hljs-type">static</span> <span class="hljs-type">char</span> pathname[_PC_PATH_MAX + <span class="hljs-number">1</span>];<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">char</span> *dirname)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">devdir</span> *<span class="hljs-title">ddp</span>;</span><br>    <span class="hljs-type">int</span> len;<br><br>    len = <span class="hljs-built_in">strlen</span>(dirname); <span class="hljs-comment">//判断目录名长度</span><br><br>    <span class="hljs-keyword">if</span> ((dirname[len - <span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;.&#x27;</span>) &amp;&amp; (dirname[len - <span class="hljs-number">2</span>] == <span class="hljs-string">&#x27;/&#x27;</span> ||<br>    (dirname[len - <span class="hljs-number">2</span>] == <span class="hljs-string">&#x27;.&#x27;</span> &amp;&amp; dirname[len<span class="hljs-number">-3</span>] == <span class="hljs-string">&#x27;/&#x27;</span>))) <br>        <span class="hljs-keyword">return</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(dirname, <span class="hljs-string">&quot;/dev/fd&quot;</span>) == <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>;<br>    <span class="hljs-keyword">if</span> ((ddp = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> devdir))) == <span class="hljs-literal">NULL</span>)<br>        <span class="hljs-keyword">return</span>;<br>    <span class="hljs-keyword">if</span> ((ddp-&gt;d_name = strdup(dirname)) == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-built_in">free</span>(ddp);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    ddp-&gt;d_next = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">if</span> (tail == <span class="hljs-literal">NULL</span>) &#123;<br>        head = ddp;<br>        tail = ddp;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        tail-&gt;d_next = ddp;<br>        tail = ddp;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">cleanup</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">devdir</span> *<span class="hljs-title">ddp</span>, *<span class="hljs-title">nddp</span>;</span><br>    ddp = head;<br>    <span class="hljs-keyword">while</span> (ddp != <span class="hljs-literal">NULL</span>) &#123;<br>        nddp = ddp-&gt;d_next;<br>        <span class="hljs-built_in">free</span>(ddp-&gt;d_name);<br>        <span class="hljs-built_in">free</span>(ddp);<br>        ddp = nddp;<br>    &#125;<br>    head = <span class="hljs-literal">NULL</span>;<br>    tail = <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">char</span> *<br><span class="hljs-title function_">searchidr</span><span class="hljs-params">(<span class="hljs-type">char</span> *dirname, <span class="hljs-keyword">struct</span> stat *fdstatp)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">devstat</span>;</span><br>    DIR *dp;<br>    <span class="hljs-type">int</span> devlen;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dirent</span> *<span class="hljs-title">dirp</span>;</span><br><br>    <span class="hljs-built_in">strcpy</span>(pathname, dirname);<br>    <span class="hljs-keyword">if</span> ((dp = opendir(dirname)) == <span class="hljs-literal">NULL</span>) <span class="hljs-comment">//打开指定的目录</span><br>        <span class="hljs-keyword">return</span>(<span class="hljs-literal">NULL</span>);<br>    <span class="hljs-built_in">strcat</span>(pathname, <span class="hljs-string">&quot;/&quot;</span>); <br>    devlen = <span class="hljs-built_in">strlen</span>(pathname);<br>    <span class="hljs-keyword">while</span> ((dirp = readdir(dp)) != <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-built_in">strcpy</span>(pathname + devlen, dirp-&gt;d_name);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(pathname, <span class="hljs-string">&quot;/dev/stdin&quot;</span>) == <span class="hljs-number">0</span> ||<br>        <span class="hljs-built_in">strcmp</span>(pathname, <span class="hljs-string">&quot;/dev/stdout&quot;</span>) == <span class="hljs-number">0</span> ||<br>        <span class="hljs-built_in">strcmp</span>(pathname, <span class="hljs-string">&quot;/dev/stderr&quot;</span>) == <span class="hljs-number">0</span>) <span class="hljs-comment">//跳过终端</span><br>        <span class="hljs-keyword">continue</span>;<br><br>        <span class="hljs-keyword">if</span> (stat(pathname, &amp;devstat) &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">continue</span>;<br>        <span class="hljs-keyword">if</span> (S_ISDIR(devstat.st_mode)) &#123; <span class="hljs-comment">//判断是否为目录</span><br>            add(pathname); <span class="hljs-comment">//增加目录项</span><br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (devstat.st_ino == fdstatp-&gt;st_ino &amp;&amp;<br>        devstat.st_dev == fdstatp-&gt;st_dev) &#123; <span class="hljs-comment">//找到对应目录项</span><br>            closedir(dp);<br>            <span class="hljs-keyword">return</span>(pathname);<br>        &#125;<br>    &#125;<br><br>    closedir(dp);<br>    <span class="hljs-keyword">return</span>(<span class="hljs-literal">NULL</span>);<br>&#125;<br><br><br><span class="hljs-type">char</span> *<br><span class="hljs-title function_">ttyname</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">fdstat</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">devdir</span> *<span class="hljs-title">ddp</span>;</span><br>    <span class="hljs-type">char</span> *rval;<br><br>    <span class="hljs-keyword">if</span> (isatty(fd) == <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>(<span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">if</span> (fstat(fd, &amp;fdstat) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>(<span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">if</span> (S_ISCHR(fdstat.st_mode) == <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>(<span class="hljs-literal">NULL</span>);<br>    <br>    rval = searchidr(<span class="hljs-string">&quot;/dev&quot;</span>, &amp;fdstat); <span class="hljs-comment">//搜索/dev下的目录判断是否符合</span><br>    <span class="hljs-keyword">if</span> (rval == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-keyword">for</span> (ddp = head; ddp != <span class="hljs-literal">NULL</span>; ddp = ddp-&gt;d_next)<br>            <span class="hljs-keyword">if</span> ((rval = searchidr(ddp-&gt;d_name, &amp;fdstat)) != <span class="hljs-literal">NULL</span>)<br>                <span class="hljs-keyword">break</span>;<br>    &#125;<br>    cleanup();<br>    <span class="hljs-keyword">return</span>(rval);<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> *name;<br>    <span class="hljs-keyword">if</span> (isatty(<span class="hljs-number">0</span>)) &#123;<br>        name = ttyname(<span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (name == <span class="hljs-literal">NULL</span>)<br>            name = <span class="hljs-string">&quot;undefined&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        name = <span class="hljs-string">&quot;not a tty&quot;</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fd 0: %s\n&quot;</span>, name);<br><br>    <span class="hljs-keyword">if</span> (isatty(<span class="hljs-number">1</span>)) &#123;<br>        name = ttyname(<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">if</span> (name == <span class="hljs-literal">NULL</span>)<br>            name = <span class="hljs-string">&quot;undefined&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        name = <span class="hljs-string">&quot;not a tty&quot;</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fd 1: %s\n&quot;</span>, name);<br><br>    <span class="hljs-keyword">if</span> (isatty(<span class="hljs-number">2</span>)) &#123;<br>        name = ttyname(<span class="hljs-number">2</span>);<br>        <span class="hljs-keyword">if</span> (name == <span class="hljs-literal">NULL</span>)<br>            name = <span class="hljs-string">&quot;undefined&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        name = <span class="hljs-string">&quot;not a tty&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fd 2: %s\n&quot;</span>, name);<br><br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="规范模式"><a href="#规范模式" class="headerlink" title="规范模式"></a>规范模式</h2><p><strong>getpass函数实现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;termio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_PASS_LEN  8</span><br><br><span class="hljs-type">char</span> *<br><span class="hljs-title function_">getpass</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *prompt)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">char</span> buf[MAX_PASS_LEN + <span class="hljs-number">1</span>];<br>    <span class="hljs-type">char</span> *ptr;<br>    <span class="hljs-type">sigset_t</span> sig, osig;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">termios</span> <span class="hljs-title">ts</span>, <span class="hljs-title">ots</span>;</span><br>    FILE *fp;<br>    <span class="hljs-type">int</span> c;<br>    <span class="hljs-comment">//ctermid函数会返回当前的终端的字符串的指针</span><br>    <span class="hljs-keyword">if</span> ((fp = fopen(ctermid(<span class="hljs-literal">NULL</span>), <span class="hljs-string">&quot;r+&quot;</span>)) == <span class="hljs-literal">NULL</span>) <span class="hljs-comment">//打开当前终端</span><br>        <span class="hljs-keyword">return</span>(<span class="hljs-literal">NULL</span>);<br>    setbuf(fp, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">//禁用缓冲</span><br><br>    sigemptyset(&amp;sig);<br>    sigaddset(&amp;sig, SIGINT); <span class="hljs-comment">//代表中断信号</span><br>    sigaddset(&amp;sig, SIGTSTP); <span class="hljs-comment">// 代表终端停止信号</span><br>    sigprocmask(SIG_BLOCK, &amp;sig, &amp;osig); <span class="hljs-comment">//阻塞两个信号</span><br><br>    tcgetattr(fileno(fp), &amp;ts); <span class="hljs-comment">//获取当前终端的属性</span><br>    ots = ts;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        ECHO：如果设置了该标志位，则终端将回显所有输入字符。默认情况下，该标志位是开启的。</span><br><span class="hljs-comment">        ECHOE：如果设置了该标志位，则终端将在接收到退格字符（^H）时，将光标移回前一个字符，并用空格符将该字符覆盖掉。默认情况下，该标志位是开启的。</span><br><span class="hljs-comment">        ECHOK：如果设置了该标志位，则终端将在接收到换行符（\n）时，将行清空。默认情况下，该标志位是关闭的。</span><br><span class="hljs-comment">        ECHONL：如果设置了该标志位，则终端将在接收到换行符（\n）时，回显该字符。默认情况下，该标志位是关闭的。</span><br><span class="hljs-comment">    */</span><br>    ts.c_lflag &amp;= ~(ECHO | ECHOE | ECHOK | ECHONL); <span class="hljs-comment">//关闭回显</span><br>    tcsetattr(fileno(fp), TCSAFLUSH, &amp;ts); <span class="hljs-comment">//TCSAFLUSH 是一个参数常量，用于 tcsetattr() 函数中。它表示在设置终端属性之前，将已经存在的输入数据丢弃，并等待所有输出数据传输完成后再进行设置。具体来说，TCSAFLUSH 参数的含义如下：</span><br>    <span class="hljs-built_in">fputs</span>(prompt, fp);<br><br>    ptr = buf;<br>    <span class="hljs-keyword">while</span> ((c = getc(fp)) != EOF &amp;&amp; c != <span class="hljs-string">&#x27;\n&#x27;</span>)<br>        <span class="hljs-keyword">if</span> (ptr &lt; &amp;buf[MAX_PASS_LEN])<br>            *ptr++ = c;<br>    *ptr = <span class="hljs-number">0</span>;<br>    putc(<span class="hljs-string">&#x27;\n&#x27;</span>, fp);<br>    tcsetattr(fileno(fp), TCSAFLUSH, &amp;ots);<br>    sigprocmask(SIG_SETMASK, &amp;osig, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">//恢复原来的信号</span><br>    fclose(fp);<br>    <span class="hljs-keyword">return</span>(buf);<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> *ptr;<br><br>    <span class="hljs-keyword">if</span> ((ptr = getpass(<span class="hljs-string">&quot;Enter password:&quot;</span>)) == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;getpass error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;password: %s\n&quot;</span>, ptr);<br><br>    <span class="hljs-keyword">while</span> (*ptr != <span class="hljs-number">0</span>)<br>        *ptr++ = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="非规范模式"><a href="#非规范模式" class="headerlink" title="非规范模式"></a>非规范模式</h2><p><strong>18-20.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;termio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_PASS_LEN  8</span><br><br><span class="hljs-type">char</span> *<br><span class="hljs-title function_">getpass</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *prompt)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">char</span> buf[MAX_PASS_LEN + <span class="hljs-number">1</span>];<br>    <span class="hljs-type">char</span> *ptr;<br>    <span class="hljs-type">sigset_t</span> sig, osig;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">termios</span> <span class="hljs-title">ts</span>, <span class="hljs-title">ots</span>;</span><br>    FILE *fp;<br>    <span class="hljs-type">int</span> c;<br>    <span class="hljs-comment">//ctermid函数会返回当前的终端的字符串的指针</span><br>    <span class="hljs-keyword">if</span> ((fp = fopen(ctermid(<span class="hljs-literal">NULL</span>), <span class="hljs-string">&quot;r+&quot;</span>)) == <span class="hljs-literal">NULL</span>) <span class="hljs-comment">//打开当前终端</span><br>        <span class="hljs-keyword">return</span>(<span class="hljs-literal">NULL</span>);<br>    setbuf(fp, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">//禁用缓冲</span><br><br>    sigemptyset(&amp;sig);<br>    sigaddset(&amp;sig, SIGINT); <span class="hljs-comment">//代表中断信号</span><br>    sigaddset(&amp;sig, SIGTSTP); <span class="hljs-comment">// 代表终端停止信号</span><br>    sigprocmask(SIG_BLOCK, &amp;sig, &amp;osig); <span class="hljs-comment">//阻塞两个信号</span><br><br>    tcgetattr(fileno(fp), &amp;ts); <span class="hljs-comment">//获取当前终端的属性</span><br>    ots = ts;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        ECHO：如果设置了该标志位，则终端将回显所有输入字符。默认情况下，该标志位是开启的。</span><br><span class="hljs-comment">        ECHOE：如果设置了该标志位，则终端将在接收到退格字符（^H）时，将光标移回前一个字符，并用空格符将该字符覆盖掉。默认情况下，该标志位是开启的。</span><br><span class="hljs-comment">        ECHOK：如果设置了该标志位，则终端将在接收到换行符（\n）时，将行清空。默认情况下，该标志位是关闭的。</span><br><span class="hljs-comment">        ECHONL：如果设置了该标志位，则终端将在接收到换行符（\n）时，回显该字符。默认情况下，该标志位是关闭的。</span><br><span class="hljs-comment">    */</span><br>    ts.c_lflag &amp;= ~(ECHO | ECHOE | ECHOK | ECHONL); <span class="hljs-comment">//关闭回显</span><br>    tcsetattr(fileno(fp), TCSAFLUSH, &amp;ts); <span class="hljs-comment">//TCSAFLUSH 是一个参数常量，用于 tcsetattr() 函数中。它表示在设置终端属性之前，将已经存在的输入数据丢弃，并等待所有输出数据传输完成后再进行设置。具体来说，TCSAFLUSH 参数的含义如下：</span><br>    <span class="hljs-built_in">fputs</span>(prompt, fp);<br><br>    ptr = buf;<br>    <span class="hljs-keyword">while</span> ((c = getc(fp)) != EOF &amp;&amp; c != <span class="hljs-string">&#x27;\n&#x27;</span>)<br>        <span class="hljs-keyword">if</span> (ptr &lt; &amp;buf[MAX_PASS_LEN])<br>            *ptr++ = c;<br>    *ptr = <span class="hljs-number">0</span>;<br>    putc(<span class="hljs-string">&#x27;\n&#x27;</span>, fp);<br>    tcsetattr(fileno(fp), TCSAFLUSH, &amp;ots);<br>    sigprocmask(SIG_SETMASK, &amp;osig, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">//恢复原来的信号</span><br>    fclose(fp);<br>    <span class="hljs-keyword">return</span>(buf);<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> *ptr;<br><br>    <span class="hljs-keyword">if</span> ((ptr = getpass(<span class="hljs-string">&quot;Enter password:&quot;</span>)) == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;getpass error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;password: %s\n&quot;</span>, ptr);<br><br>    <span class="hljs-keyword">while</span> (*ptr != <span class="hljs-number">0</span>)<br>        *ptr++ = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="终端窗口大小"><a href="#终端窗口大小" class="headerlink" title="终端窗口大小"></a>终端窗口大小</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">winsize</span> &#123;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> ws_row; <span class="hljs-comment">//终端窗口的行数，可显示的文本行数</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> ws_col; <span class="hljs-comment">//终端窗口的列数，可显示的文本列数</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> ws_xpixel; <span class="hljs-comment">//终端窗口的宽度</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> ws_ypixel; <span class="hljs-comment">//终端窗口的高度</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p><strong>18-22.c获取窗口大小</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;termio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> TIOCGWINSZ</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">pr_winsize</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">winsize</span> <span class="hljs-title">size</span>;</span><br>    <br>    <span class="hljs-keyword">if</span> (ioctl(fd, TIOCGWINSZ, (<span class="hljs-type">char</span> *)&amp;size));<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;TIOCGWINSZ error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d rows, %d columns\n&quot;</span>, size.ws_row, size.ws_col);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">sig_winch</span><span class="hljs-params">(<span class="hljs-type">int</span> signo)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;SIGWINCH received\n&quot;</span>);<br>    pr_winsize(STDIN_FILENO);<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (isatty(STDIN_FILENO) == <span class="hljs-number">0</span>)<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">if</span> (signal(SIGWINCH, sig_winch) == SIG_ERR)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;signal error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    pr_winsize(STDIN_FILENO);<br><br>    <span class="hljs-keyword">for</span> ( ; ; )<br>        pause();<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="打开伪终端设备"><a href="#打开伪终端设备" class="headerlink" title="打开伪终端设备"></a>打开伪终端设备</h2><p>打开主设备</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">posix_openpt</span><span class="hljs-params">(<span class="hljs-type">int</span> oflag)</span>;<br><span class="hljs-comment">//返回值：若成功，返回下一个可用的PTY主设备文件描述符；若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>oflag</code>：打开标志</li>
</ul>
<p><code>grantpt</code>获取访问从设备的权限，<code>unlockpt</code>解除限制</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">grantpt</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">unlockpt</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span>;<br><br><span class="hljs-comment">//两个函数的返回值：若成功，返回0；若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<p>获取从设备的路径</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-type">char</span> *<span class="hljs-title function_">ptsname</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span>;<br><br><span class="hljs-comment">//返回值：若成功，返回指向PTY从设备名的指针；若出错，返回NULL</span><br></code></pre></td></tr></table></figure>

<p><code>ptym_open</code>打开<code>PTY</code>主设备文件描述符，<code>ptys_open</code>打开<code>PTY</code>从设备文件描述符</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;apue.h&quot;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">ptym_open</span><span class="hljs-params">(<span class="hljs-type">char</span> *pts_name, <span class="hljs-type">int</span> pts_namesz)</span>;<br><span class="hljs-comment">//返回值：若成功，返回PTY主设备文件描述符；若出错，返回-1</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">ptys_open</span><span class="hljs-params">(<span class="hljs-type">char</span> *pts_name)</span>;<br><span class="hljs-comment">//返回值：若成功，返回PTY从设备问而建描述符：若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<p><strong>19-9</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(SOLARIS)</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stropt.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">int</span> <br><span class="hljs-title function_">ptym_open</span><span class="hljs-params">(<span class="hljs-type">char</span> *pts_name, <span class="hljs-type">int</span> pts_namesz)</span><br>&#123;<br>    <span class="hljs-type">char</span> *ptr;<br>    <span class="hljs-type">int</span> fdm, err;<br><br>    <span class="hljs-keyword">if</span> ((fdm = posix_openpt(O_RDWR)) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//打开pty设备</span><br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">if</span> (grantpt(fdm) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//授予访问从设备的权限</span><br>        <span class="hljs-keyword">goto</span> errout; <br>    <span class="hljs-keyword">if</span> (unlockpt(fdm) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//解锁从设备</span><br>        <span class="hljs-keyword">goto</span> errout;<br>    <span class="hljs-keyword">if</span> ((ptr = ptsname(fdm)) == <span class="hljs-literal">NULL</span>) <span class="hljs-comment">//获取从设备路径</span><br>        <span class="hljs-keyword">goto</span> errout;<br>    <br>    <span class="hljs-built_in">strncpy</span>(pts_name, ptr, pts_namesz); <span class="hljs-comment">//存放从设备的路径</span><br>    pts_name[pts_namesz - <span class="hljs-number">1</span>] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>    <span class="hljs-keyword">return</span>(fdm);<br><br>errout:<br>    err = errno;<br>    close(fdm);<br>    errno = err;<br>    <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <br><span class="hljs-title function_">ptys_open</span><span class="hljs-params">(<span class="hljs-type">char</span> *pts_name)</span><br>&#123;<br>    <span class="hljs-type">int</span> fds;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(SOLARIS)</span><br>    <span class="hljs-type">int</span> err, setup;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-keyword">if</span> ((fds = open(pts_name, O_RDWR)) &lt; <span class="hljs-number">0</span>) <br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(SOLARIS)</span><br>    <span class="hljs-keyword">if</span> ((setup = ioctl(fds, I_FIND, <span class="hljs-string">&quot;ldterm&quot;</span>)) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">goto</span> errout;<br>    <br>    <span class="hljs-keyword">if</span> (setup == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">if</span> (ioctl(fds, I_PUSH, <span class="hljs-string">&quot;pterm&quot;</span>) &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">goto</span> errout;<br>        <span class="hljs-keyword">if</span> (ioctl(fds, I_PUSH, <span class="hljs-string">&quot;ldterm&quot;</span>) &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">goto</span> errout;<br>        <span class="hljs-keyword">if</span> (ioctl(fds, I_PUSH, <span class="hljs-string">&quot;ttcompat&quot;</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>errout:<br>    err = errno;<br>    close(fds);<br>    errno = err;<br>    <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-keyword">return</span>(fds);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="pty-fork"><a href="#pty-fork" class="headerlink" title="pty_fork"></a>pty_fork</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;apue.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;termios.h&gt;</span></span><br><br><span class="hljs-type">pid_t</span> <span class="hljs-title function_">pty_fork</span><span class="hljs-params">(<span class="hljs-type">int</span> *ptrfdm, <span class="hljs-type">char</span> *slave_name, <span class="hljs-type">int</span> slave_namesz,</span><br><span class="hljs-params">              <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> termios *slave_termios,</span><br><span class="hljs-params">              <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> winsize *slave_winsize)</span>;<br><br><span class="hljs-comment">//返回值：子进程中返回0；父进程中返回子进程的进程ID；若出错，返回-1</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>slave_name</code>：  存放从设备名</li>
<li><code>slave_termios</code>：若不为空，则初始化为设备的终端行规程，若为空，则把从设备<code>termios</code>结构设置成实现定义的初始状态</li>
<li><code>slave_winsize</code>：若不为空，则根据指针指向的结构体初始化设备的窗口大小。若为空，<code>winsize</code>结构体被初始化为0</li>
</ul>
<p><strong>19-10.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;termio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(SOLARIS)</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stropt.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">int</span> <br><span class="hljs-title function_">ptym_open</span><span class="hljs-params">(<span class="hljs-type">char</span> *pts_name, <span class="hljs-type">int</span> pts_namesz)</span><br>&#123;<br>    <span class="hljs-type">char</span> *ptr;<br>    <span class="hljs-type">int</span> fdm, err;<br><br>    <span class="hljs-keyword">if</span> ((fdm = posix_openpt(O_RDWR)) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//打开pty设备</span><br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">if</span> (grantpt(fdm) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//授予访问从设备的权限</span><br>        <span class="hljs-keyword">goto</span> errout; <br>    <span class="hljs-keyword">if</span> (unlockpt(fdm) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//解锁从设备</span><br>        <span class="hljs-keyword">goto</span> errout;<br>    <span class="hljs-keyword">if</span> ((ptr = ptsname(fdm)) == <span class="hljs-literal">NULL</span>) <span class="hljs-comment">//获取从设备路径</span><br>        <span class="hljs-keyword">goto</span> errout;<br>    <br>    <span class="hljs-built_in">strncpy</span>(pts_name, ptr, pts_namesz); <span class="hljs-comment">//存放从设备的路径</span><br>    pts_name[pts_namesz - <span class="hljs-number">1</span>] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>    <span class="hljs-keyword">return</span>(fdm);<br><br>errout:<br>    err = errno;<br>    close(fdm);<br>    errno = err;<br>    <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <br><span class="hljs-title function_">ptys_open</span><span class="hljs-params">(<span class="hljs-type">char</span> *pts_name)</span><br>&#123;<br>    <span class="hljs-type">int</span> fds;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(SOLARIS)</span><br>    <span class="hljs-type">int</span> err, setup;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-keyword">if</span> ((fds = open(pts_name, O_RDWR)) &lt; <span class="hljs-number">0</span>) <br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(SOLARIS)</span><br>    <span class="hljs-keyword">if</span> ((setup = ioctl(fds, I_FIND, <span class="hljs-string">&quot;ldterm&quot;</span>)) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">goto</span> errout;<br>    <br>    <span class="hljs-keyword">if</span> (setup == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">if</span> (ioctl(fds, I_PUSH, <span class="hljs-string">&quot;pterm&quot;</span>) &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">goto</span> errout;<br>        <span class="hljs-keyword">if</span> (ioctl(fds, I_PUSH, <span class="hljs-string">&quot;ldterm&quot;</span>) &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">goto</span> errout;<br>        <span class="hljs-keyword">if</span> (ioctl(fds, I_PUSH, <span class="hljs-string">&quot;ttcompat&quot;</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>errout:<br>    err = errno;<br>    close(fds);<br>    errno = err;<br>    <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-keyword">return</span>(fds);<br>&#125;<br><br><span class="hljs-type">pid_t</span> <br><span class="hljs-title function_">pty_fork</span><span class="hljs-params">(<span class="hljs-type">int</span> *ptrfdm, <span class="hljs-type">char</span> *slave_name, <span class="hljs-type">int</span> slave_namesz,</span><br><span class="hljs-params">        <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> termios *slave_termios,</span><br><span class="hljs-params">        <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> winsize *slave_winsize)</span><br>&#123;<br>    <span class="hljs-type">int</span> fdm, fds;<br>    <span class="hljs-type">pid_t</span> pid;<br>    <span class="hljs-type">char</span> pts_name[<span class="hljs-number">20</span>];<br><br>    <span class="hljs-keyword">if</span> ((fdm = ptym_open(pts_name, <span class="hljs-keyword">sizeof</span>(pts_name))) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//打开主设备，会将从设备路径存放在pts_name</span><br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t open master pty: %s, error %d&quot;</span>, pts_name, fdm);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (slave_name != <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-built_in">strncpy</span>(slave_name, pts_name, slave_namesz);<br>        slave_name[slave_namesz - <span class="hljs-number">1</span>] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> ((pid = fork()) &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">//子进程</span><br>        <span class="hljs-keyword">if</span> (setsid() &lt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">//设置进程的用户ID</span><br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;setsid error&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> ((fds = ptys_open(pts_name)) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//打开从设备</span><br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t open slave pty&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        close(fdm);<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(BSD)</span><br>    <span class="hljs-keyword">if</span> (ioctl(fds, TIOCSCTTY, (<span class="hljs-type">char</span> *)<span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;TIOCSCTTY error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>        <span class="hljs-keyword">if</span> (slave_termios != <span class="hljs-literal">NULL</span>) &#123;<br>            <span class="hljs-keyword">if</span> (tcsetattr(fds, TCSANOW, slave_termios) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//终端的行为</span><br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;tcsetattr error on slave pty&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (slave_winsize != <span class="hljs-literal">NULL</span>) &#123;<br>                <span class="hljs-keyword">if</span> (ioctl(fds, TIOCGWINSZ, slave_winsize) &lt; <span class="hljs-number">0</span>)<br>                &#123;<br>                    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;TIOCSWINSZ error on slave pty&quot;</span>);<br>                    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (dup2(fds, STDIN_FILENO) != STDIN_FILENO)<br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;dup2 error to stdin&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (dup2(fds, STDOUT_FILENO) != STDOUT_FILENO)<br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;dup2 error to stdout&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (dup2(fds, STDERR_FILENO) != STDERR_FILENO)<br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;error to stderr&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (fds != STDIN_FILENO &amp;&amp; fds != STDOUT_FILENO &amp;&amp; fds != STDERR_FILENO)<br>                close(fds);<br>            returnr(<span class="hljs-number">0</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            *ptrfdm = fdm;<br>            <span class="hljs-keyword">return</span>(pid);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>19-11.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;termio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> LINUX</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> OPTSTR <span class="hljs-string">&quot;+d:eiv&quot;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> OPTSTR <span class="hljs-string">&quot;d:einv&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> </span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">set_noecho</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">do_driver</span><span class="hljs-params">(<span class="hljs-type">char</span> *)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">loop</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">int</span>)</span>;<br><br><span class="hljs-keyword">extern</span> <span class="hljs-type">int</span> optind, opterr, optopt;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">char</span> *optarg;<br><br><span class="hljs-type">int</span> <br><span class="hljs-title function_">ptym_open</span><span class="hljs-params">(<span class="hljs-type">char</span> *pts_name, <span class="hljs-type">int</span> pts_namesz)</span><br>&#123;<br>    <span class="hljs-type">char</span> *ptr;<br>    <span class="hljs-type">int</span> fdm, err;<br><br>    <span class="hljs-keyword">if</span> ((fdm = posix_openpt(O_RDWR)) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//打开pty设备</span><br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">if</span> (grantpt(fdm) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//授予访问从设备的权限</span><br>        <span class="hljs-keyword">goto</span> errout; <br>    <span class="hljs-keyword">if</span> (unlockpt(fdm) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//解锁从设备</span><br>        <span class="hljs-keyword">goto</span> errout;<br>    <span class="hljs-keyword">if</span> ((ptr = ptsname(fdm)) == <span class="hljs-literal">NULL</span>) <span class="hljs-comment">//获取从设备路径</span><br>        <span class="hljs-keyword">goto</span> errout;<br>    <br>    <span class="hljs-built_in">strncpy</span>(pts_name, ptr, pts_namesz); <span class="hljs-comment">//存放从设备的路径</span><br>    pts_name[pts_namesz - <span class="hljs-number">1</span>] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>    <span class="hljs-keyword">return</span>(fdm);<br><br>errout:<br>    err = errno;<br>    close(fdm);<br>    errno = err;<br>    <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <br><span class="hljs-title function_">ptys_open</span><span class="hljs-params">(<span class="hljs-type">char</span> *pts_name)</span><br>&#123;<br>    <span class="hljs-type">int</span> fds;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(SOLARIS)</span><br>    <span class="hljs-type">int</span> err, setup;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-keyword">if</span> ((fds = open(pts_name, O_RDWR)) &lt; <span class="hljs-number">0</span>) <br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(SOLARIS)</span><br>    <span class="hljs-keyword">if</span> ((setup = ioctl(fds, I_FIND, <span class="hljs-string">&quot;ldterm&quot;</span>)) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">goto</span> errout;<br>    <br>    <span class="hljs-keyword">if</span> (setup == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">if</span> (ioctl(fds, I_PUSH, <span class="hljs-string">&quot;pterm&quot;</span>) &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">goto</span> errout;<br>        <span class="hljs-keyword">if</span> (ioctl(fds, I_PUSH, <span class="hljs-string">&quot;ldterm&quot;</span>) &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">goto</span> errout;<br>        <span class="hljs-keyword">if</span> (ioctl(fds, I_PUSH, <span class="hljs-string">&quot;ttcompat&quot;</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>errout:<br>    err = errno;<br>    close(fds);<br>    errno = err;<br>    <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-keyword">return</span>(fds);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">termios</span> <span class="hljs-title">save_termios</span>;</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> ttysavefd = <span class="hljs-number">-1</span>;<br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">enum</span>&#123;</span> RESET, RAW, CBREAK&#125; ttystate = RESET;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">tty_cbreak</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span> <span class="hljs-comment">//设置非规范模式</span><br>&#123;<br>    <span class="hljs-type">int</span> err;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">termios</span> <span class="hljs-title">buf</span>;</span><br><br>    <span class="hljs-keyword">if</span> (ttystate != RESET)<br>    &#123;<br>        errno = EINVAL;<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (tcgetattr(fd, &amp;buf) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    save_termios = buf;<br>    buf.c_lflag &amp;= ~(ECHO | ICANON); <span class="hljs-comment">//ICANON是一个标志，用于控制是否以规范模式处理输入</span><br><br>    buf.c_cc[VMIN] = <span class="hljs-number">1</span>; <span class="hljs-comment">//要求读取的最小字符数</span><br>    buf.c_cc[VTIME] = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (tcsetattr(fd, TCSAFLUSH, &amp;buf) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    <br>    <span class="hljs-keyword">if</span> (tcgetattr(fd, &amp;buf) &lt; <span class="hljs-number">0</span>) &#123;<br>        err = errno;<br>        tcsetattr(fd, TCSAFLUSH, &amp;save_termios);<br>        errno = err;<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> ((buf.c_cflag &amp; (ECHO | ICANON)) || buf.c_cc[VMIN] != <span class="hljs-number">1</span> ||<br>    buf.c_cc[VTIME] != <span class="hljs-number">0</span>) &#123;<br>        tcsetattr(fd, TCSAFLUSH, &amp;save_termios);<br>        errno = EINVAL;<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    ttystate = CBREAK;<br>    ttysavefd = fd;<br>    <span class="hljs-keyword">return</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">tty_raw</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-type">int</span> err;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span>  <span class="hljs-title">termios</span> <span class="hljs-title">buf</span>;</span><br><br>    <span class="hljs-keyword">if</span> (ttystate != RESET) &#123;<br>        errno = EINVAL;<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (tcgetattr(fd, &amp;buf) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    save_termios = buf;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        启用IEXTEN后，可以实现特定的输入处理扩展功能</span><br><span class="hljs-comment">        启用ISIG后，终端驱动程序将对一些特殊字符做出响应，例如Ctrl-C和Ctrl-Z等信号字符。这些信号字符可以用于通知正在运行的程序或shell执行特定的操作或响应事件。</span><br><span class="hljs-comment">    */</span><br>    buf.c_lflag &amp;= ~(ECHO | ICANON | IEXTEN | ISIG);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        启用BRKINT后，当终端接收到中断信号（通常是Ctrl-C）或结束信号（通常是Ctrl-D）时，终端驱动程序将发送一个中断信号给正在运行的进程</span><br><span class="hljs-comment">        启用ICRNL后，输入回车字符（\r）将被翻译为新行字符（\n）</span><br><span class="hljs-comment">        启用INPCK后，输入数据将进行奇偶校验</span><br><span class="hljs-comment">        启用ISTRIP后，输入数据的高位（最高位）将被丢弃，只保留低7位。这通常被称为&quot;字符剥离&quot;（character stripping），可用于去除输入数据中的奇怪字符或无用信息</span><br><span class="hljs-comment">        启用IXON后，终端驱动程序将为输出数据中的暂停字符（通常是Ctrl-S）和重新开始字符（通常是Ctrl-Q）启用软件流控制。</span><br><span class="hljs-comment">    */</span><br>    buf.c_iflag &amp;= ~(BRKINT | ICRNL | INPCK | ISTRIP | IXON);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        它用于设置终端数据位的大小。CSIZE通常与另外两个标志CSTOPB和PARODD一起使用，以确定终端设备的通信参数。</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        CSIZE标志有三个可能的值：CS5、CS6、CS7和CS8。分别代表使用5、6、7或8位作为数据位。选择使用哪个值通常取决于具体的使用情况和需求。</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        需要注意的是，CSIZE标志只是终端设置中的一部分。要正确设置终端设备的通信参数，需要考虑其他设置标志，如波特率、停止位和奇偶校验等。</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        启用PARENB后，终端驱动程序将启用奇偶校验功能，并在输出数据和输入数据中添加奇偶校验位   </span><br><span class="hljs-comment">    */</span><br>    buf.c_cflag &amp;= ~(CSIZE | PARENB);<br><br>    buf.c_cflag |= CS8;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        启用OPOST后，终端驱动程序将对输出数据进行后处理，以便在发送给终端设备之前进行转换和修改。</span><br><span class="hljs-comment">    */</span><br>    buf.c_oflag &amp;= ~(OPOST);<br><br>    buf.c_cc[VMIN] = <span class="hljs-number">1</span>;<br>    buf.c_cc[VTIME] = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (tcsetattr(fd, TCSAFLUSH, &amp;buf) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">if</span> (tcgetattr(fd, &amp;buf) &lt; <span class="hljs-number">0</span>) &#123;<br>        err = errno;<br>        tcsetattr(fd, TCSAFLUSH, &amp;save_termios);<br>        errno = err;<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> ((buf.c_lflag &amp; (ECHO | ICANON | IEXTEN | ISIG)) ||<br>    (buf.c_iflag &amp; (BRKINT | ICRNL | INPCK | ISTRIP | IXON)) ||<br>    (buf.c_cflag &amp; (CSIZE | PARENB | CS8)) != CS8 ||<br>    (buf.c_oflag &amp; OPOST) || buf.c_cc[VMIN] != <span class="hljs-number">1</span> ||<br>    buf.c_cc[VTIME] != <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">//检查是否将标志位删除</span><br>        tcsetattr(fd, TCSAFLUSH, &amp;save_termios);<br>        errno = EINVAL;<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    ttystate = RAW;<br>    ttysavefd = fd;<br>    <span class="hljs-keyword">return</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <br><span class="hljs-title function_">tty_reset</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (ttystate == RESET)<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (tcsetattr(fd, TCSAFLUSH, &amp;save_termios) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    ttystate = RESET;<br>    <span class="hljs-keyword">return</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">tty_atexit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (ttysavefd &gt;= <span class="hljs-number">0</span>)<br>        tty_reset(ttysavefd);<br>&#125;<br><br><span class="hljs-keyword">struct</span> termios *<br><span class="hljs-title function_">tty_termios</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">return</span>(&amp;save_termios);<br>&#125;<br><br><br><span class="hljs-type">pid_t</span> <br><span class="hljs-title function_">pty_fork</span><span class="hljs-params">(<span class="hljs-type">int</span> *ptrfdm, <span class="hljs-type">char</span> *slave_name, <span class="hljs-type">int</span> slave_namesz,</span><br><span class="hljs-params">        <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> termios *slave_termios,</span><br><span class="hljs-params">        <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> winsize *slave_winsize)</span><br>&#123;<br>    <span class="hljs-type">int</span> fdm, fds;<br>    <span class="hljs-type">pid_t</span> pid;<br>    <span class="hljs-type">char</span> pts_name[<span class="hljs-number">20</span>];<br><br>    <span class="hljs-keyword">if</span> ((fdm = ptym_open(pts_name, <span class="hljs-keyword">sizeof</span>(pts_name))) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//打开主设备，会将从设备路径存放在pts_name</span><br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t open master pty: %s, error %d&quot;</span>, pts_name, fdm);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (slave_name != <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-built_in">strncpy</span>(slave_name, pts_name, slave_namesz);<br>        slave_name[slave_namesz - <span class="hljs-number">1</span>] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> ((pid = fork()) &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">-1</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">//子进程</span><br>        <span class="hljs-keyword">if</span> (setsid() &lt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">//设置进程的用户ID</span><br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;setsid error&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> ((fds = ptys_open(pts_name)) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//打开从设备</span><br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t open slave pty&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        close(fdm);<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(BSD)</span><br>    <span class="hljs-keyword">if</span> (ioctl(fds, TIOCSCTTY, (<span class="hljs-type">char</span> *)<span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;TIOCSCTTY error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>        <span class="hljs-keyword">if</span> (slave_termios != <span class="hljs-literal">NULL</span>) &#123;<br>            <span class="hljs-keyword">if</span> (tcsetattr(fds, TCSANOW, slave_termios) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//终端的行为</span><br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;tcsetattr error on slave pty&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (slave_winsize != <span class="hljs-literal">NULL</span>) &#123;<br>                <span class="hljs-keyword">if</span> (ioctl(fds, TIOCGWINSZ, slave_winsize) &lt; <span class="hljs-number">0</span>)<br>                &#123;<br>                    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;TIOCSWINSZ error on slave pty&quot;</span>);<br>                    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (dup2(fds, STDIN_FILENO) != STDIN_FILENO)<br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;dup2 error to stdin&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (dup2(fds, STDOUT_FILENO) != STDOUT_FILENO)<br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;dup2 error to stdout&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (dup2(fds, STDERR_FILENO) != STDERR_FILENO)<br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;error to stderr&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (fds != STDIN_FILENO &amp;&amp; fds != STDOUT_FILENO &amp;&amp; fds != STDERR_FILENO)<br>                close(fds);<br>            returnr(<span class="hljs-number">0</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            *ptrfdm = fdm;<br>            <span class="hljs-keyword">return</span>(pid);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BUFFSIZE 512</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">sig_term</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span>;<br><span class="hljs-type">static</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">sig_atomic_t</span> sigcaught;<br><br><span class="hljs-type">void</span> <br><span class="hljs-title function_">loop</span><span class="hljs-params">(<span class="hljs-type">int</span> ptym, <span class="hljs-type">int</span> ignoreeof)</span><br>&#123;<br>    <span class="hljs-type">pid_t</span> child;<br>    <span class="hljs-type">int</span> nread;<br>    <span class="hljs-type">char</span> buf[BUFFSIZE];<br><br>    <span class="hljs-keyword">if</span> ((child = fork()) &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;fork error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (child == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">for</span> ( ; ; ) &#123;<br>            <span class="hljs-keyword">if</span> ((nread = read(STDIN_FILENO, buf, BUFFSIZE)) &lt; <span class="hljs-number">0</span>)<br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;read error from stdin&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">if</span> (writen(ptym, buf, nread) != nread) <span class="hljs-comment">//写入pty设备</span><br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;write error to master pty&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (ignoreeof == <span class="hljs-number">0</span>)<br>                kill(getppid(), SIGTERM);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (signal_intr(SIGTERM, sig_term) == SIG_ERR)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;signal_intr error for SIGTERM&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> ( ; ;) &#123;<br>            <span class="hljs-keyword">if</span> ((nread = read(ptym, buf, BUFFSIZE)) &lt;= <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">if</span> (writen(STDOUT_FILENO, buf, nread) != nread)<br>            &#123;<br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;writen error to stdout&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (sigcaught == <span class="hljs-number">0</span>)<br>            kill(child, SIGTERM);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <br><span class="hljs-title function_">sig_term</span><span class="hljs-params">(<span class="hljs-type">int</span> signo)</span><br>&#123;<br>    sigcaught = <span class="hljs-number">1</span>;<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>    <span class="hljs-type">int</span> fdm, c, ignoreeof, interactive, noecho, verbose;<br>    <span class="hljs-type">pid_t</span> pid;<br>    <span class="hljs-type">char</span> *driver;<br>    <span class="hljs-type">char</span> slave_name[<span class="hljs-number">20</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">termios</span> <span class="hljs-title">orig_termios</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">winsize</span> <span class="hljs-title">size</span>;</span><br><br>    interactive = isatty(STDIN_FILENO);<br>    ignoreeof = <span class="hljs-number">0</span>;<br>    noecho = <span class="hljs-number">0</span>;<br>    verbose = <span class="hljs-number">0</span>;<br>    driver = <span class="hljs-literal">NULL</span>;<br><br>    opterr = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> ((c = getopt(argc, argv, OPTSTR)) != EOF) &#123; <span class="hljs-comment">//+号的意思是将参数存储在optarg中</span><br>        <span class="hljs-keyword">switch</span> (c)<br>        &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-comment">/* constant-expression */</span><br>            <span class="hljs-string">&#x27;d&#x27;</span>:<br>            driver = optarg;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-comment">/* code */</span><br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;e&#x27;</span>:<br>                noecho = <span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;i&#x27;</span>:<br>                ignoreeof = <span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;n&#x27;</span>:<br>                interactive = <span class="hljs-number">0</span>;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;v&#x27;</span>:<br>                verbose = <span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">break</span>;<br>                <span class="hljs-comment">//若getopt的参数不能识别或缺少参数则会返回？</span><br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;?&#x27;</span>: <br>                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;unrecognized option: -%c&quot;</span>, optopt);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (optind &gt;= argc)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;usage: pty [ -d driver -einv ] program [ arg ... ]&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (interactive) &#123;<br>        <span class="hljs-keyword">if</span> (tcgetattr(STDIN_FILENO, &amp;orig_termios) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//获取与终端相关的的参数</span><br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;tcgetattr error on stdin&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (ioctl(STDIN_FILENO, TIOCGWINSZ, (<span class="hljs-type">char</span> *)&amp;size) &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;TIOCGWINSZ error&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        pid = pty_fork(&amp;fdm, slave_name, <span class="hljs-keyword">sizeof</span>(slave_name),<br>            &amp;orig_termios, &amp;size);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        pid = pty_fork(&amp;fdm, slave_name, <span class="hljs-keyword">sizeof</span>(slave_name), <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (pid &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;fork error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">if</span> (noecho)<br>            set_noecho(STDIN_FILENO);<br>        <br>        <span class="hljs-keyword">if</span> (execvp(argv[optind], &amp;argv[optind]) &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;can&#x27;t execute: %s&quot;</span>, argv[optind]);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (verbose) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;slave name = %s\n&quot;</span>, slave_name);<br>        <span class="hljs-keyword">if</span> (driver != <span class="hljs-literal">NULL</span>)<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;driver = %s\n&quot;</span>, driver);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (interactive &amp;&amp; driver == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-keyword">if</span> (tty_raw(STDIN_FILENO) &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;tty_raw error&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (atexit(tty_atexit) &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;atexit error&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (driver)<br>        do_driver(driver); <span class="hljs-comment">//执行驱动程序</span><br>    loop(fdm, ignoreeof); <span class="hljs-comment">//fdm是主设备号，对pty设备进行读写</span><br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">set_noecho</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span>  <span class="hljs-title">termios</span> <span class="hljs-title">stermios</span>;</span><br><br>    <span class="hljs-keyword">if</span> (tcgetattr(fd, &amp;stermios) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;tcgetaattr error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    stermios.c_cflag &amp;= ~(ECHO | ECHOE | ECHOK | ECHONL);<br>    stermios.c_oflag &amp;= ~(ONLCR);<br><br>    <span class="hljs-keyword">if</span> (tcsetattr(fd, TCSANOW, &amp;save_termios) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;tcsetattr error&quot;</span>);<br>        exix(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="数据库函数库"><a href="#数据库函数库" class="headerlink" title="数据库函数库"></a>数据库函数库</h1><p>打开数据库</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;apue_db.h&quot;</span></span><br><br>DBHANDLE <span class="hljs-title function_">db_open</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname, <span class="hljs-type">int</span> oflag, ...<span class="hljs-comment">/*int mode */</span>)</span>;<br><span class="hljs-comment">//返回值：若成功，返回数据库句柄；若失败，返回NULL</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">db_close</span><span class="hljs-params">(DBHANDLE db)</span>;<br></code></pre></td></tr></table></figure>

<p>数据插入</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;apue_db.h&quot;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">db_store</span><span class="hljs-params">(DBHANDLE db, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *data, <span class="hljs-type">int</span> flag)</span>;<br><span class="hljs-comment">//返回值：若成功，返回0；若出错，返回非0值</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>flag</code>为插入选项<ul>
<li><code>DB_INSERT</code>：插入一条新纪录</li>
<li><code>DB_REPLACE</code>：替换一条已有的记录</li>
<li><code>DB_STORE</code>：插入一条新记录或替换一条已有的记录</li>
</ul>
</li>
</ul>
<p>指定键从数据库中获取一条记录</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;apue_db.h&quot;</span></span><br><br><span class="hljs-type">char</span> *<span class="hljs-title function_">db_fetch</span><span class="hljs-params">(DBHANDLE db, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key)</span>;<br><br><span class="hljs-comment">//返回值：若成功，返回指向数据的指针；若没有找到记录，则返回NULL</span><br></code></pre></td></tr></table></figure>

<p>删除一条记录</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;apue_db.h&quot;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">db_delete</span><span class="hljs-params">(DBHANDLE db, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key)</span>;	<br><span class="hljs-comment">//返回值：若成功，返回0；若没有找到记录，返回-1</span><br></code></pre></td></tr></table></figure>

<p>回滚数据库以及逐条读每条记录</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;apue_db.h&quot;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">db_rewind</span><span class="hljs-params">(DBHANDLE db)</span>;<br><span class="hljs-type">char</span> *<span class="hljs-title function_">db_nextrec</span><span class="hljs-params">(DBHANDLE db, <span class="hljs-type">char</span> *key)</span>;<br><br><span class="hljs-comment">//返回值：若成功，返回指向数据的指针；若到达数据库文件的尾端，返回NULL</span><br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/UNIX%E7%BC%96%E7%A8%8B/" class="category-chain-item">UNIX编程</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E7%BC%96%E7%A8%8B/">#编程</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>UNIX环境高级编程笔记</div>
      <div>https://h0pe-ay.github.io/UNIX环境高级编程/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>hope</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年6月28日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/kernel-pwn/" title="Kernel-Pwn">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Kernel-Pwn</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86--%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5/" title="逆向工程核心原理--代码注入">
                        <span class="hidden-mobile">逆向工程核心原理--代码注入</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
